2010-04-28  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_got_info): Double the buffer size to avoid an assert.

2009-11-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoDebugOptions): Add 'explicit_null_checks' option.

	* method-to-ir.c: Add support for generating explicit null checks.

2010-06-19  Zoltan Varga  <vargaz@gmail.com>
	* tramp-amd64.c (mono_arch_create_generic_trampoline): Increase the buf len a little,
	to avoid an assert.

2010-06-12  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (compile_method): Add a 'depth' parameter to add_generic_class too
	to fix infinite generic recursion. Fixes #612702.

2010-06-09  Levi Bard  <levi@unity3d.com>

	* debugger-agent.c: Clear unloaded types on appdomain unload.

2010-06-08  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c (visit_bb): Make the component vregs of long vars volatile as well.
	Fixes #612206.

	* exceptions.cs: Add a test.

2010-06-03  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c: Update after the mono_debug_lookup_locals () changes.

	* debugger-agent.c (method_commands_internal): Ditto. Return scope information for
	locals.

2010-06-03  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (appdomain_unload): Clear all breakpoint instances in the dying
	appdomain.

2010-05-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390x.c (mono_arch_output_basic_block): Applied patch from Aurelien Minvielle
	. Fix OP_ATOMIC_EXCHANGE_I4 on s390x. Fixes #609023.

2010-05-31  Martin Baulig  <martin@ximian.com>

	Fix #608271.

	* debugger-agent.c (breakpoints_cleanup): Iterate over `event_requests', call
	clear_breakpoint() on all breakpoint events and remove them from the list.

2010-05-27  Martin Baulig  <martin@ximian.com>

	Fix #605698.

	* debugger-agent.c (method_commands, type_commands): Temporarily
	set the appdomain while executing this method; do all metadata
	calls in the debuggee's appdomain where user assemblies are loaded.

2010-05-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Propagate exceptions in one more place.

2010-05-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Propagate exceptions from
	mono_runtime_class_init_full ().
	(mono_jit_runtime_invoke): Ditto. Fixes #608073.

2010-05-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_output_basic_block): Use ins->inst_c1 instead of p1, the
	two are not the same on ilp32.

2010-05-20  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Collect all information about a PLT entry into a separate MonoPltEntry
	structure. Make the labels to plt entries local symbols instead of assembler local
	labels, since tha latter causes problems for the iphone linker.

2010-05-12  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (set_breakpoint): Fix setting of pending breakpoints in
	other domains.

2009-12-25  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (find_extra_method): Call mono_aot_wrapper_name only once,
	instead of once for each module.

2010-05-10  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (insert_breakpoint): Print a more descriptive error message
	if a breakpoint cannot be inserted.

2010-05-09 Jonathan Chambers  <joncham@gmail.com>

	* mini.c (mono_sigsegv_signal_handler): Use PLATFORM_WIN32 define instead of 
	HOST_WIN32. HOST_WIN32 was added after 2.6.

	Code is contributed under MIT/X11 license.

2010-05-07  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_free_jit_domain_info): Fix the seq_points/arch_seq_points hash
	tables.

2010-05-07  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (frame_commands): Return an error instead of asserting if
	no JIT info is found for the method.

2010-05-05 Jonathan Chambers  <joncham@gmail.com>

	* debugger-agent.c (mono_debugger_agent_thread_interrupt): Protect against a NULL sigctx
	in debug printf.

2010-05-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_prolog): Fix full-aot support for thread
	attach.

2010-05-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_decompose_long_opts): Fix LNEG.

2010-05-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_emit_exceptions): Initialize exc_throw_pos/found
	explicitly, this seems to be required by some gcc versions at -O2.

	* mini-arm.c: Ditto.

2010-05-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): Fix full-aot support for
	has_target delegate invokes.

2010-05-01  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoAotTrampInfo): Rename this to MonoTrampInfo, add patches/unwind
	info fields.

	* aot-compiler.c (mono_aot_tramp_info_create): Rename to mono_tramp_info_create,
	add patches/unwind info arguments, move to mini.c.

	* mini-<ARCH>.c aot-compiler.c: Update after the above changes.

2010-04-29  Zoltan Varga  <vargaz@gmail.com>

	* tramp-x86.c (mono_arch_create_generic_class_init_trampoline_full): Set the
	code_size output variable.

	* mini-x86.c (mono_arch_emit_prolog): Compute the GOT addr before calling
	mono_get_lmf_addr.
	
2010-04-29  Zoltan Varga  <vargaz@gmail.com>

2010-04-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_prolog): Remove a disable_aot which is not needed.
	(mono_arch_cpu_optimizazions): Make this a no-op when running with full aot.
	(mono_arch_cpu_enumerate_simd_versions): Ditto.

2010-04-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_prolog): Avoid an assert in full-aot mode.

2010-04-29  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_function): Use TARGET_X86 instead of __i386__.

2010-04-27  Zoltan Varga  <vargaz@gmail.com>

        * tramp-x86.c exceptions-x86.c mini-x86.c aot-compiler.c aot-runtime.c:
        Implement full-aot support on x86.

        * method-to-ir.c: Always use a got var on x86 too, just like on ppc, because the
        trampolines depend on it. Use MONO_ARCH_GOT_REG as the got register, instead of
        the first register returned by get_global_int_regs ().

        * cpu-x86.md: Fix the length of insertx_u1_slow.

        * iltests.il.in: Disable tail call tests when running with full-aot.

2010-04-30  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (type_commands): Add a new CMD_TYPE_GET_SOURCE_FILES_2
	command which returns full path names.

2010-04-29  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (asm_writer_emit_alignment): Use ilog2 for alignments for the
	apple assembler.

2010-04-28  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_got_info): Double the buffer size to avoid an assert.

2010-04-26  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_op_to_op_imm_noemul): Fix a warning.

2010-04-20  Jonathan Pryor  <jpryor@novell.com>

	* exceptions-arm.c: Remove platform checks in favor of configure checks.

2010-04-19  Jonathan Pryor  <jpryor@novell.com>

	* exceptions-arm.c: Add Android support for sigcontext structure.

2010-04-16  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Avoid calling
	mono_marshal_method_from_wrapper () for native func wrappers. Fixes #597189.

2010-04-16  Zoltan Varga  <vargaz@gmail.com>

	* genmdesc.c (inst_name): Define this as a copy of mono_inst_name in helpers.c,
	so the latter can be #ifndef DISABLE_JIT-ed.

	* helpers.c: Comment out the opstr array if DISABLE_JIT is set.

2010-04-15  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (type_commands): Call mono_class_setup_methods () before
	calling mono_class_num_methods (). Fixes #592244.

2010-04-13  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Disable generic sharing for constrained
	calls where the constrained class needs a context. Fixes #595863.

	* iltests.il.in: Add a test.

2010-04-10  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (thread_commands): Add a GET_ID command to get the
	MonoInternalThread belonging to the thread.

2010-04-08  Kornel Pal  <kornelpal@gmail.com>

	* method-to-ir.c (mini_emit_inst_for_method): Fix a typo that caused
	CompareExchange not to be inlined for I8.

	Contributed under MIT/X11 license.

	Backport of r155039.

2010-04-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c: Fix tests/load-exceptions.cs

2010-03-05  Martin Baulig  <martin@ximian.com>

	**** Backport of r153335 ****

	Add support for aborting invocations.

	* debugger-agent.c
	(InvokeData): Added `InvokeData *last_invoke'.
	(DebuggerTlsData): Renamed `invoke' into `pending_invoke' and
	added a new `invoke' field to keep the `InvokeData *' throughout
	the invocation.
	(ErrorCode): Added `ERR_NO_INVOCATION'.
	(CmdVM): Added `CMD_VM_ABORT_INVOKE'.
	(mono_debugger_agent_handle_exception): Don't report any exception
	if an abort was requested.
	(invoke_method): Store the `InvokeData *' in `tls->invoke'; reset
	a thread abort if necessary.
	(vm_commands): Implement `CMD_VM_ABORT_INVOKE'.

2010-04-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir): Handle call to virtual final methods
	of marshalbyref classes.

	Fixes #515884.

2010-04-01  Zoltan Varga  <vargaz@gmail.com>

	* decompose.c (mono_decompose_opcode): Set the cfg exception if the unsupported
	float conv.ovf.un opcodes are encountered, instead of asserting later.
	Fixes #566296.

2010-04-01  Zoltan Varga  <vargaz@gmail.com>

	* decompose.c (mono_decompose_opcode): Add OP_ICONV_TO_U4_UN as a no-op.

	* iltests.il.in: Add a test.

2010-04-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_call): Fail compilation if an argument is too
	large. Fixes #567040.

	* method-to-ir.c: Call CHECK_CFG_EXCEPTION after emitting a call.

2010-04-01  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (handle_ccastclass): Call save_cast_details (). Fixes
	#592711.

2010-03-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_aot_trampoline): Remove some dead code.

	* aot-runtime.c (mono_aot_patch_plt_entry): New helper function, which only
	does the patching if the callee is in the same domain.

	* aot-runtime.c mini-trampolines.c: Call mono_aot_patch_plt_entry instead
	of mono_arch_patch_plt_entry ().

2010-03-29  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (jit_end): Send type loads for types loaded before the VMStart
	event is sent. Fixes #591733.

2010-03-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-posix.c (SIG_HANDLER_SIGNATURE): Handle the case when ctx is NULL on
	OpenBSD.

2010-03-26  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (bin_writer_emit_writeout): Fix the size of the got.plt
	section. Fixes #591000.

2010-03-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.h: Applied patch from Robert Nagy (Robert@openbsd.org).
	Use sigaction on OpenBSD too.

2010-03-22  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (event_req_matches_assembly): Handle request modifiers too.

2010-03-21  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (SIG_HANDLER_SIGNATURE): Fix the build on platforms without sigaction
	(openbsd+amd64 ?).

2010-03-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_emit_exceptions): Avoid an assert in ppc_patch () for
	some large methods with lots of exception handlers. Fixes #440924.

2010-03-19  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (clear_event_requests_for_assembly): New helper function.
	(assembly_unload): Clear all event requests referencing the to-be unloaded
	assembly.

2010-03-16  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Simplify the way breakpoints are processed by removing
	the 'pending' flag. This fixes support for appdomains too.


2010-03-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_build_imt_thunk): Always save and restore r11 since it
	is needed even when fail_tramp!=NULL.

2010-03-17  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (insert_breakpoint): Write a log message.

2010-03-16  Zoltan Varga  <vargaz@gmail.com>

	* iltests.il.in: Disable the fconv_to_i test on sparc too.

2010-03-11  Martin Baulig  <martin@ximian.com>

	* debugger-agent.c (type_commands): Add NULL check to
	`CMD_TYPE_GET_SOURCE_FILES'.

2010-03-09  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_peephole_ins): Fix the OP_FMOVE optimization. Fixes
	#586664.

	* iltests.il.in: Add a test.

2010-03-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c: Store the initial basic block returned by mono_basic_block_split
	so we can release the whole list and not just the first one. Free
	it in more places as well.

2010-03-07  Zoltan Varga  <vargaz@gmail.com>

	* branch-opts.c (mono_if_conversion): Disable one of the cases when deadce
	is disabled. Fixes #582322.

	* iltests.il.in: Add a test.

2010-03-06  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_create_monitor_exit_trampoline_full): Delegate
	the handling of obj->synchronization == null and owner != current thread to
	mono_monitor_exit ().

	* tramp-x86.c (mono_arch_create_monitor_exit_trampoline_full): Ditto.

Sat Mar 6 18:14:15 CET 2010 Paolo Molaro <lupus@ximian.com>

	* mini.c: change the way emulated opcode info is stored and save about
	4 KB of runtime memory.

2010-03-04  David S. Miller  <davem@davemloft.net>

       * mini-sparc.h: Always use MONO_ARCH_USE_SIGACTION.  Linux kernels
       that don't provide the siginfo in the second signal handler argument
       are buggy, and this has been fixed for years.
       * mini.h (GET_CONTEXT): Remove __sparc__ special case.
       (SIG_HANDLER_SIGNATURE, SIG_HANDLER_PARMS): Likewise.

2010-03-04  Zoltan Varga  <vargaz@gmail.com>

2010-03-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (find_symbol): Fix a leak.
	(decode_patch): Ditto.

2010-03-02  Levi Bard  <levi@unity3d.com>

	* debugger-agent.c: Invalidate thread stacks on domain unload.

2010-02-26  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (MonoDebuggerInfo): Added `abort_runtime_invoke'.

	* debug-mini.c
	(MonoDebuggerThreadInfo): Added `internal_flags'.
	(MonoDebuggerInternalThreadFlags): New enum.
	(_mono_debugger_throw_exception): Don't signal the debugger if a
	type abort was requested.
	(_mono_debugger_unhandled_exception): Likewise.
	(mono_debugger_abort_runtime_invoke): New method to abort an invocation.
	(mono_debugger_runtime_invoke): If the debugger requested a thread
	abort during the invocation, reset it here.

2010-03-02  Zoltan Varga  <vargaz@gmail.com>

	* cpu-<ARCH>.md: dummy_use was missing src1:i.

2010-03-01  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Add a log message printing the protocol version.

2010-03-01  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Add a new command to communicate the protocol version used
	by the client. This could be used to allow newer runtimes to communicate with
	older clients.

2010-03-01  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (domain_commands): Add a new command to create a boxed value.

2010-03-01  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (type_commands): Fix the setting of fields with a reference
	type.

2010-02-26  Robert Jordan  <robertj@gmx.net>

	* tasklets.c (continuation_store): Return from an error condition
	immediately.

2010-02-25  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (do_invoke_method): Fix invoking of static methods on vtypes.
	Fixes #582991.

2010-02-24  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (notify_thread): Skip terminated threads, since their tls
	data is not freed yet. Fixes #582460.

2010-02-23  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Add support for the caught/uncaught flags on exception
	event requests. Bump protocol minor version.

2010-02-22  Zoltan Varga  <vargaz@gmail.com>

	* decompose.c (mono_decompose_long_opts): Handle OP_LCONV_TO_OVF_I8 here too.

2010-02-22  Zoltan Varga  <vargaz@gmail.com>

	* decompose.c (mono_decompose_opcode): Handle OP_LCONV_TO_OVF_I8. Fixes
	#581950.

	* iltests.il.in: Add a test.

2010-02-22  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_method_check_inlining): Use !mono_method_get_header_summary
	instead of mono_method_get_header as it doesn't decode locals
	so the called method can have unresolved dependencies that will only
	be satisfied after the current method is JIT'd.

	Fixes #550968.

2010-02-20  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_create_remoting_trampoline): Call
	mono_create_specific_trampoline () instead of
	mono_arch_create_specific_trampoline ().

	* mini-trampolines.c tramp-arm.c: Disable more stuff when DISABLE_JIT is set.

2010-02-20  Geoff Norton  <gnorton@novell.com>

	* aot-runtime.c: Ensure we dont leak a held lock when unwinding exceptions.

2010-02-20  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (mono_debugger_agent_handle_exception): Receive two contexts,
	one for the throw and one for the catch. Mark uncaught exceptions by a NULL
	CATCH_TXT. Send normal exception events for unhandled exceptions too.
	(mono_debugger_agent_handle_unhandled_exception): Remove this, merged into
	handle_exception.

2010-02-18  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (mono_arch_get_restore_context): Changes this so it restores
	edx/ecx too. This is needed to support OP_SEQ_POINT.

2010-02-18  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Fix SIZEOF in dynamic methods.

2010-02-13  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (load_profile_files): Update after the profiler changes.

2010-02-13  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Avoid passing icall wrappers to
	mono_profiler_method_end_jit, since the profiler has no way to process wrappers.

	* aot-runtime.c mini.c: Resurrect the aot pagefault profiling stuff, it is useful
	for mtouch.

2010-02-13 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* debugger-agent.c: handle incomplete reads and EINTR in
	recv()/send(). This could have been causing random
	disconnections.

2010-02-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_allocate_vars): Allocate the seq point related vars first
	so they have small offsets. Fixes #566311.

2010-02-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_check_inlining): Check for loader errors.

2010-02-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-generic-sharing.c (mini_type_get_underlying_type): Handle byref as well
	by returning native int. Fixes #577984.

2010-02-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c mini.c linear-scan.c: Disable more stuff when DISABLE_JIT is used.

2010-02-10  Geoff Norton  <gnorton@novell.com>

	* aot-compiler.c: Make the number of IMT trampolines configurable as well.

2010-02-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mini_jit_info_table_find): Search the root domain as well,
	since mono_jit_info_table_find () doesn't do it anymore.

	* mini-generic-sharing.c debugger-agent.c: Call mini_jit_info_table_find ()
	instead of mono_jit_info_table_find ().

2010-02-07  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Place a seq point just before a RET.
	Fixes #564538.

2010-02-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mini_method_verify): Report the method which failed to verify.

	backport of r150889.

2010-02-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir): Use the new basic block formation pass
	to avoid JIT'ng dead basic blocks. This is the same behavior as the
	runtime MS verifier.

	backport of r150888.

2010-02-04  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (decode_value): Fix decoding of vtype instances. Fixes
	#561962.

2010-02-04  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (type_commands): Return the enumness if the type as well.

2010-02-03  Bill Holmes  <billholmes54@gmail.com>

	* debugger-agent.c : Fixing MSVC builds.

	Code is contributed under MIT/X11 license.

2010-02-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Initialize lmf->rsp in the prolog too
	so async stack walks don't crash.

2010-02-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): Fix a problem where the callsite
	was not patched if the callee needed an rgctx trampoline.

2010-01-28  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (mono_debugger_agent_init): Call appdomain_unload at the
	end of the appdomain unload process, after assemblies have been unloaded.
	Fixes #574842.

2010-01-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c: Make the soft debugger work on platforms without MAP_32BIT.
	Fixes #573988.

2010-01-26  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (emit_type): Treat MONO_TYPE_PTR as 'I' not 'I4'.

2010-01-26  Geoff Norton  <gnorton@novell.com>

	* aot-compiler.c: Fix a logic error introduced when guarding against enums
	with struct marshalability.

2010-01-21  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-amd64.c (mono_arch_notify_pending_exc): Avoid a crash if the
	thread has not fully started yet.

2010-01-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (can_marshal_struct): Allow marshalling enums.

2010-01-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-posix.c (SIG_HANDLER_SIGNATURE): Avoid
	"Thread (nil) may have been prematurely finalized" messages if this is called
	on a thread not registered with the runtime.

	* mini-exceptions.c (mono_handle_native_sigsegv): Ditto.

2010-01-19  Zoltan Varga  <vargaz@gmail.com>

	* jit-icalls.c (mono_array_new_3): New jit icall.

	* aot-compiler.c aot-runtime.c: Add support for ElementAddr wrappers.

	* arrays.cs: Add a test for 3 dimensional arrays.

2010-01-18  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoCompile): Add 'disable_out_of_line_bblocks' flag.

	* branch-opts.c (mono_optimize_branches): Honor the new flag.

	* mini.c (mini_method_compile): Set the new flag when running under the
	debugger.

2010-01-18  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Avoid reading cfg->prof_options
	after cfg has been freed.

2010-01-17  Zoltan Varga  <vargaz@gmail.com>

	* branch-opts.c (mono_branch_optimize_exception_target): Stop the optimization
	if a clause is skipped because it uses the exception object, since it could
	have caught the exception.

	* exceptions.cs: Add a test.

2010-01-16  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (decode_value): Fix the decoding of I/U/PTR.

2010-01-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (emit_call_body): Always use near calls when AOTing even if
	NOMAP32BIT or optimize_for_xen is set.


Wed Jan 13 15:54:53 CET 2010 Paolo Molaro <lupus@ximian.com>

	* jit.h, method-to-ir.c: added ability to set the policy for
	inserting breakpoints from the break IL instruction or the
	Debugger.Break () API call.

2010-01-11  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (mono_debugger_agent_parse_options): Allow onthrow without
	an argument which matches any exception.

2010-01-10  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_emit_method_call_full): Avoid the virt->nonvirt
	optimization if the called method is gshared and marshalbyref, since gshared
	methods can' have wrappers. Fixes #569390.

	* generics.cs: Add a test.

2010-01-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_print_thread_dump_from_ctx): New helper function
	callable from gdb.

2010-01-10  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_print_method_from_ip): Fix the lookup of trampolines.

2010-01-09  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (transport_connect): comment out freeaddrinfo calls under win32,
	since it is not supported in win2000.

2010-01-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm-cpp.cpp (mono_llvm_create_ee): Add an ugly hack to fix #564695.
	If LLVM decides to set the code model to Large, reset it to Default.

2010-01-07  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_xdebug_flush): Export it so it is present in
	stripped binaries as well.

2010-01-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_compile_is_broken): Skip methods from serialization's
	internal assembly.

	Backport of r149053.

2010-01-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_convert_imt_slot_to_vtable_slot): Call
	mono_method_get_vtable_slot () instead of accessing imt_method->slot directly,
	to fix an AOT case.

2009-01-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mini_method_compile): Verify the method before calling
	mono_compile_create_vars as this might crash since it uses method
	information.

	Fixes #560196.

	Backport of r149045.

2009-12-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c:
	* method-to.ir.c:
	* mini-*.c: Properly handle generic enums.

	Fixes #566294

	Backport of r148941.

2009-12-28  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Handle the failure of mono_class_vtable ()
	in a few more places.

2009-12-27  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Don't use dyn runtime invoke for methods with
	nullable parameters. Fixes #567351.

2009-12-26  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-trampolines.c (common_call_trampoline): Add assert for NULL resolved generic method.

	Backport of r148905.

2009-12-24  Sebastien Pouliot  <sebastien@ximian.com>

	* method-to-ir.c (mono_method_to_ir): Avoid SIGSEGV when
	mono_method_get_signature returns NULL. Fix #567084
	[Backport r148889]

2009-12-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_create_llvm_imt_trampoline): Fix the LLVM build on
	platforms without mono_arch_get_llvm_imt_trampoline ().

2009-12-22  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (decode_klass_ref): Avoid a crash if a decode_klass_ref () call
	fails. Fixes #566689.

2009-12-21  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (AM_CFLAGS): Include LLVM_CFLAGS.

	* mini-llvm.c: Avoid defining the __STDC_... macros if already defined.

2009-12-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_argument_info): Allocate memory for CallInfo using
	alloca as g_malloc is not signal safe.

2009-12-17  Marek Habersack  <mhabersack@novell.com>

	* mini.c (mono_get_runtime_build_info): include Mono version in
	the returned value.

	* driver.c (mono_main): VERSION is now included in the string
	returned from mono_get_runtime_build_info()

2009-12-17  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Add support for CALLI with unmanaged
	signatures. Fixes #565143.

	* jit-icalls.c (mono_get_native_calli_wrapper): New JIT icall.

2009-12-16 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.h: Forgot to add a 0x to MONO_ARCH_MAX_FRAME_SIZE define
	making max stack 10x smaller.

	Backport of r148570.

2009-12-15 Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mini_emit_memcpy): Assert if size is too big.

	Backport of r148504.

2009-12-15 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (mono_arch_allocate_vars): Fail compilation if the frame size is
	bigger than MONO_ARCH_MAX_FRAME_SIZE.

	* mini-x86.c (mono_arch_emit_prolog): Handle huge frames.

	* mini-x86.h: Define MONO_ARCH_MAX_FRAME_SIZE to be 1Mb.

	* mini-amd64.c / mini-amd64.h: Same fixes as of above.

	* mini.c (mini_method_compile): Check if mono_arch_allocate_vars failed
	the compilation.

	Backport of r148502.

2009-12-14  Miguel de Icaza  <miguel@novell.com>
 
 	* method-to-ir.c (mono_method_to_ir): CEE_UNUSUED opcodes now
 	raise an invalid program exception.   
 
 	For other opcodes that we might not handle use a g_warning and
 	raise the exception.   Beats termination.
 
 	Fixes #561724

2009-12-14  Geoff Norton  <gnorton@novell.com>

	* debugger-agent.c: The end_runtime_invoke guard isn't working on 
	AMD64 as __builtin_frame_address (1) returns NULL.  Disable the 
	behaviour by default, and make it runtime configurable.
	
2009-12-13 Jonathan Chambers <joncham@gmail.com>

	* debugger-agent.c (mono_debugger_agent_thread_interrupt): Handle a NULL
	sigctx being passed in, as we have no CONTEXT available in the APC.
	
	(mono_debugger_agent_cleanup): Use explicit cond wait implementation
	for now.

	Code contributed under MIT/X11 license.

2009-12-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Allocate the 'pindexes' array with the
	proper size.

2009-12-12  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Encode the this argument of vtype methods as a struct, not
	as a primitive type.

2009-12-11  Zoltan Varga  <vargaz@gmail.com>

	* driver.c: Applied patch from Matt McClellan (matt@mc-c.net). Add a check
	for 2 parameter sched_setaffinity in older glibc versions. Fixes
	#564000.

2009-12-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Avoid generating synchronized wrappers for
	generic methods.

2009-12-09  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (start_runtime_invoke): Fix a crash if this is called
	on the debugger thread.

2009-12-08  Geoff Norton  <gnorton@novell.com>

	* debugger-agent.c:  Refactor the mono_runtime_invoke guarding against
	stepping out into native code.  There were issues with nested invokes
	like .cctors.

2009-12-08  Sebastien Pouliot  <sebastien@ximian.com>

	* driver.c: Fail gracefully with --compile-all if mono_method_signature
	returns NULL (e.g. a bad assembly).

2009-12-07  Geoff Norton  <gnorton@novell.com>

	* debugger-agent.c:  Darwin can colesce signals, so we need to handle
	the interrupt_count slightly differently.  Native threads were never
	marked as resumed.

2009-12-05  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (buffer_add_value): Treat I/U as a valuetype, so the
	client can distinguish between intptrs and longs.

2009-12-04  Geoff Norton  <gnorton@novell.com>

	* debugger-agent.c: When doing a func-eval invoke on a suspended runtime, 
	we need to track the original suspend count so the thread properly
	wakes up in resume_thread.

2009-12-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_create_static_rgctx_trampoline): Use a cache
	keyed on the method+addr pair, since addr could be either the method addr or
	an unbox trampoline in the AOT case. Fixes #560246.

2009-12-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Call handle_exception_clauses () in the same
	place it was called before too.

2009-12-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_runtime_invoke): Avoid the call to mono_class_setup_vtable ()
	if no security manager is present, to speed up the AOT case. Call
	mono_class_vtable () full with raise_on_error == TRUE instead.

2009-12-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Call handle_exception_clauses earlier so
	the local optimization passes can take its result into account. Fixes
	#559876.

	* exceptions.cs: Add a test.

2009-01-24  Steven Munroe  <munroesj@us.ibm.com>

	This patch is contributed under the terms of the MIT/X11 license

        * cpu-ppc64.md (load_memindex): Add loadi8_memindex.

2009-12-03  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Rework the handling of stack traces of running threads to
	avoid crashes if compute_frames () tries to walk the stack of running thread.

	* mini.c (mono_print_method_from_ip): Use mini_jit_info_table_find.

	* mini-exceptions.c (mono_jit_walk_stack_from_ctx_in_thread): Set frame->lmf.

	* mini.h (StackFrameInfo): Add an 'lmf' field.

2009-12-02  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (suspend_current): Always set really_suspended.

2009-12-02  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (clear_event_request): Clear method entry/exit requests too.

	* exceptions-x86.c (mono_arch_get_restore_context): Restore EAX too.

2009-12-01  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (vm_commands): Don't allow invokes on threads which are not
	really suspended.

2009-12-01  Zoltan Varga  <vargaz@gmail.com>

	* cpu-ppc64.md (store_memindex): Add storei8_memindex.

2009-12-01 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-trampolines.c: Fix MSVC build.

	Backport of r147245.

2009-12-01 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-trampolines.c: Check for mono_method_get_vtable_slot failures.

	Backport of r147220.

2009-11-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_lowering_pass): Fix an assert which is hit when
	the instruction following an OP_FCOMPARE is optimized away.

2009-11-29  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Add an option to set the number of static rgctx trampolines
	generated.

2009-11-27  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_globals_table): Use temp_prefix instead of .L in a few
	places.

2009-11-24  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Avoid infinite recursion when generic virtual recursion is
	encountered.

2009-11-27  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_globals_table): Emit a hash table for the globals, to
	avoid linear searches at runtime.

	* aot-runtime.c (find_symbol): Update this to use the hash.

	* mini.h: Bump AOT file format version.

2009-11-25  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (vm_commands): Implement EXIT by invoking Environment.Exit ()
	on a random thread if possible.

2009-11-24  Geoff Norton  <gnorton@novell.com>

	* mini-darwin.c: Work around apple bug rdar://7209349  See
	http://openradar.appspot.com/7209349 for details.  Synopsis,
	CoreFoundation SIGTRAP's if you dlopen it off the main thread if its
	never been initialized before.

2009-11-24  Zoltan Varga  <vargaz@gmail.com>

	* tramp-arm.c: Use blx instead of mov pc, reg to improve support for thumb.

	* mini-arm.c (mono_arm_thumb_supported): New helper function.

2009-11-24  Zoltan Varga  <vargaz@gmail.com>

	* cfold.c (mono_constant_fold_ins): Fix a problem in the previous change,
	OP_SHL_IMM is not 32 bit.

2009-11-24  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Sync this with the version of HEAD to make backporting
	easier.

	* debugger-agent.c (resume_vm): Signal the suspend_cond even if suspend_count
	> 0 since some threads can resume if their resume_count is > 0.
	(invoke_method): Avoid reading freed memory.

2009-11-24  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (process_suspend): Extract the suspend code from
	process_single_step_inner () to a separate function. Rework the code to prevent
	races between this function and thread interrupts.

2009-11-24  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (suspend_current): Check the resume_count field instead
	of resume_one so suspends+resumes during single threaded invokes work
	correctly.

2009-11-22  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Fix the cygwin build.

2009-11-23  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Implement single threaded invokes.

2009-11-23  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (inline_method): Prevent infinite recursion. Fixes
	#557606.

	* generics.cs: Add a test.

2009-11-21  Zoltan Varga  <vargaz@gmail.com>

	* cfold.c (mono_constant_fold_ins): Fix constant folding of shr_imm. Fixes
	#557262.

	* basic.cs: Add a test.

2009-11-20  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ppc.c (mono_arch_create_generic_class_init_trampoline_full): These
	receive their argument in MONO_ARCH_VTABLE_REG, not in the first argument reg.

2009-11-20  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (create_event_list): Fix a crash if an empty assembly list
	was used as an assembly filter.

2009-11-19  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (assembly_commands): Implement GET_NAME command.

2009-11-18  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (mono_debugger_agent_handle_exception): Pass a MonoJitInfo to
	create_event_list () so assembly filters can be used.

2009-11-17  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_instances): Emit instances of common generic
	classes for char/bool too.

	* debugger-agent.c (DebuggerTlsData): Honor the DISABLE_SOFT_DEBUG option.

	* debugger-agent.c (DebuggerTlsData): Add a 'really_suspended' flag, not yet
	used.

	* debugger-agent.c: Add some definitions to make backporting to 2.6 easier.
	Fix warnings.

2009-11-17  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (DebuggerTlsData): Add a 'really_suspended' flag, not yet
	used.

	* debugger-agent.c: Add some definitions to make backporting to 2.4 easier.
	Fix warnings.

2009-11-15  Andreas Faerber  <andreas.faerber@web.de>

	* debugger-agent.c (mono_debugger_agent_thread_interrupt): Signature fix.
	
	Code contributed under MIT/X11 license.

2009-11-14  Zoltan Varga  <vargaz@gmail.com>

	(mono_debugger_agent_thread_interrupt): Save the context so stacktraces for
	threads in native code work.

	* debugger-agent.c: Pass the 'flags' argument to VM_INVOKE_METHOD earlier in
	the parameter list, so it can be acted upon by vm_commands (). Bump protocol
	version.

2009-11-13 Jonathan Chambers <joncham@gmail.com>

	* debugger-agent.c: Implementation for Windows platform.

	* mini-x86.c: Add support for Windows. Use mono-* synchronization
	primitives. Use SEH to implement breakpoints and single stepping.

	* mini-x86.h: Enable soft debugger on Windows.

	Code contributed under MIT/X11 license.

2009-11-13  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (mono_debugger_agent_single_step_event): Avoid a crash if
	this is called on the debugger thread.

2009-11-10  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-arm.c (mono_arch_get_call_filter_full): Update after the
	LDMIA->LDM macro name change.

2009-11-09  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_allocate_vars): Fix the previous change by passing
	&align to mini_type_stack_size_full ().

2009-11-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c: Compute the stack space used by arguments using
	mini_type_stack_size_full ().

2009-11-07  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_jit_parse_options): New public API function to parse options
	as done by the runtime executable.

	* debugger-agent.c (buffer_add_cattrs): Fix reading an uninitialized variable
	when handling named arguments.

2009-11-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c debugger-agent.c: Android changes from Koushik K. Dutta
	(koush@koushikdutta.com).

	* mini-arm.c (handle_thunk): Add a domain argument to control the domain
	where the thunk memory should be allocated from. Fixes appdomain unloading
	on arm.

2009-11-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c exceptions-arm.c: Make ctx->regs map directly to the 16 hardware
	registers, instead of r4..r11,ip,lr. Make restore_context () restore r0..r3 too.

2009-11-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* debugger-agent.c: Fix windows build.

2009-11-05  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Don't allow OP_SEQ_POINT in
	AOT, as it is not implemented yet.

	* mini-x86.c (mono_arch_output_basic_block): Ditto.

2009-11-05  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (debugger_thread): Call mono_set_is_debugger_attached ()
	after the client connects/disconnects.

	* debugger-agent.c: Add an 'onthrow' option to start the debugger agent
	when an exception of a given type is thrown.

	* debugger-agent.c: Add a 'onuncaught' option to start the debugger agent
	only on an uncaught exception.

	* mini-exceptions.c: Notify the debugger agent on an uncaught exception.

	* debugger-agent.c: Add a 'launch' option.

2009-11-05  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Add a 'timeout' option.

2009-11-04 Jonathan Chambers <joncham@gmail.com>

	* simd-intrinsics.c (simd_intrinsic_emit_setter): Unfix my fix.

	Code contributed under MIT/X11 license.

2009-11-04 Jonathan Chambers <joncham@gmail.com>

	* simd-intrinsics.c (simd_intrinsic_emit_setter): Fix windows build.

	Code contributed under MIT/X11 license.

2009-11-05  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Implement the 'server' and 'suspend' options supported by
	the JDWP agent.

2009-11-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c: Fix the arm build.

2009-11-04 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* debugger-agent.c: defer including mono-mutex.h until we know the
	agent is supported.

2009-11-04 Jonathan Chambers <joncham@gmail.com>

	* debugger-agent.c: Changes to build on windows. Use mono-mutex instead
	of pthreads directly. 
	
	* mini.c (mono_sigfpe_signal_handler): Changed signature of Windows
	exception handlers. Pass info argument.
	
	* mini.h: Adjust signatures of soft debugger functions to pass void*
	instead of siginfo_t. Adjust SIG_HANDLER_SIGNATURE on Windows.
	
	* mini-amd64.c (mono_arch_is_single_step_event): Adjust signature to pass void*
	instead of siginfo_t. Value is EXCEPTION_RECORD on Windows.
	(mono_arch_is_breakpoint_event): Adjust signature to pass void*
	instead of siginfo_t. Value is EXCEPTION_RECORD on Windows.
	
	* mini-amd64.h: Adjust MonoW32ExceptionHandler signature.
	
	* mini-x86.c (mono_arch_is_single_step_event): Adjust signature to pass void*
	instead of siginfo_t. Value is EXCEPTION_RECORD on Windows.
	(mono_arch_is_breakpoint_event): Adjust signature to pass void*
	instead of siginfo_t. Value is EXCEPTION_RECORD on Windows.
	
	* mini-x86.h: Adjust MonoW32ExceptionHandler signature.
	
	* exceptions-x86.c: Adjust W32_SEH_HANDLE_EX for new signature.
	
	* exceptions-amd64.c: Adjust W32_SEH_HANDLE_EX for new signature.
	
	* mono-semaphore.h: Skeleton implementation for Windows.
	
	Code contributed under MIT/X11 license.

2009-11-04 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* aot-compiler.c: don't leak the value returned from
	mono_type_full_name().

2009-11-05  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c (set_breakpoint): Emit a log message.

2009-11-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_xdebug_info): Bump the threshold for flushing
	debug info to 100 because 10 still slows down gdb too much.

2009-11-03  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (load_simd_vreg): Add extra argument to signal if
	the value was loaded from memory.

	* simd-intrinsics.c (simd_intrinsic_emit_setter): Store back to memory if
	the value was loader from there.

	* simd-intrinsics.c (simd_intrinsic_emit_shuffle): Fail correctly for Shuffle
	without constant swizzle.

	Backport of r145283.

2009-11-03  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Refactor some code into a new helper
	function mono_aot_get_array_helper_from_wrapper ().

	* aot-compiler.c (add_generic_class): Refactor the code a bit, really emit
	array helper methods.

2009-11-03  Zoltan Varga  <vargaz@gmail.com>

	* debugger-agent.c: Include netinet/in.h to fix the bsd build.

	* debugger-agent.c: Add support for filtering events by assemblies.

	* debugger-agent.c (mono_debugger_agent_thread_interrupt): Return false if
	the agent is not enabled.

2009-11-02 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* exceptions-x86.c: hopefully last change to fix the windows build.
	This one courtesy of Jonathan Chambers.

2009-11-02 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* debugger-agent.c: remove unused function.

2009-11-02 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* debugger-agent.c: add #ifdefs for a few header files.
	* mini-x86.h: disable the soft debugger in windows.
	Step 1 of 2 to make this compile on windows with gcc.

2009-07-01  Zoltan Varga  <vargaz@gmail.com>

	Merge the soft debugger branch.

	* debugger-agent.h debugger-agent.c: New files containing the soft
	mode debugger module.

	* method-to-ir.c (mono_method_to_ir): Generate OP_SEQ_POINT opcodes
	at the appropriate locations.

	* mini-<ARCH>.c (mono_arch_output_basic_block): Handle OP_SEQ_POINT
	opcode.

	* mini-<ARCH>.c: Add new arch-specific functions to set/clear breakpoints,
	enable/disable single stepping.

	* exceptions-<ARCH>.c (mono_arch_find_jit_info_ext): New stack unwinding api
	which returns all information in a StackFrameInfo structure, and can handle the
	LMF frames added by the debugger.

	* mini-<ARCH>.h (MonoLMFExt): New structure containing additional information
	about an LMF frame.

	* mini-exceptions.c (mono_jit_walk_stack_from_ctx_in_thread): New stack
	walker function which works on a specific thread and passes a StackFrameInfo
	structure to its callback.

	* mini.c (mini_init): Initialize the debugger agent.

	* aot-compiler.c aot-runtime.c: Add soft-debug support.

	* mini-ops.h: Add OP_SEQ_POINT opcode.

	* driver.c (mono_main): Add new '--debugger-agent' option for passing
	arguments to the debugger agent.

2009-11-02  Zoltan Varga  <vargaz@gmail.com>

	* tramp-x86.c (mono_arch_get_llvm_imt_trampoline): Implement this for x86.

	* mini.c (mini_init): Avoid using the IMT trampoline in the LLVM case.

	* mini-trampolines.c (mono_llvm_vcall_trampoline): Add a static rgctx trampoline
	if needed.
	(mono_create_llvm_imt_trampoline): New function to create a trampoline which
	sets the IMT argument and makes a virtual call.

	* mini-llvm.c: Enable interface calls using the llvm imt trampoline.

2009-11-01  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (llvm_sources): Enable the llvm option since it no longer breaks
	the windows build.

2009-10-30  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_cleanup): Call profiler shutdown before shutting down the
	runtime. Fixes #551228.

2009-10-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_output_basic_block): Fix % 1. Fixes #550970.

	* basic.cs: Add a test.

	* method-to-ir.c (mono_method_to_ir): Use EMIT_NEW_LOAD_MEMBASE_TYPE to
	load vtypes instead if OP_LOADV_MEMBASE in the implementation of
	CONSTRAINED. Fixes #550964.

	* generics.cs: Add a test.

2009-10-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-posix.c (add_signal_handler): Delay the GC suspend signal while
	executing a SIGSEGV handler on an altstack, since libgc can't handle that.

2009-10-24  Zoltan Varga  <vargaz@gmail.com>

    	* mini-exceptions.c (mini_jit_info_table_find): Add an 'out_domain' argument
    	which will contain the domain where the method was found.

    	* exceptions-<ARCH>.c mini-exceptions.c: Update callers of
    	mini_jit_info_table_find ().

	* aot-compiler.c (xdebug_end_emit): Remove so stray debug code.

	* branch-opts.c (mono_if_conversion): Avoid running deadce if it is disabled.

2009-10-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_prolog): Disable aot for methods with save_lmf
	set, its not supported yet.

2009-10-22  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Avoid asserting if a array generic
	iface wrapper is not found.
	(mono_aot_get_method): Ditto for GetGenericValueImpl.

2009-10-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Fix support for the IList<T> wrappers,
	which have a different name.

	* aot-runtime.c (mono_aot_get_method): Special case the array generic iface
	wrappers and Array.GetGenericValueImpl ().

	* aot-compiler.c: Avoid emitting some wrappers which are not needed anymore
	because of the change above.

	* generics.cs: Add a test for full aot + generic array ifaces.

2009-10-19  Sebastien Pouliot  <sebastien@ximian.com>

	* aot-compiler.c (emit_plt): Remove duplicate 'debug_sym' variable 
	that hides the previous one.
	[Backport r144402]

2009-10-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (can_marshal_struct): Allow some System.dll structs to be
	marshalled. Fixes #541623.

2009-10-16  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_extra_methods): Remove some asserts which are not needed.

2009-10-15  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_op_imm_to_op): Handle OP_AND/OR/XOR_IMM.

2009-10-13  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_debugger_trampoline_compiled): Add
	`const guint8 *trampoline' argument; send both the old and the new
	notification.

2009-10-13  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_xdebug_info): Group methods into groups of 10 to
	avoid registering 1 symbol file per method with gdb.

2009-10-11  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_xdebug_info): Emit a symbol for the method which
	can be used to set breakpoints in gdb.

	* image-writer.c (bin_writer_emit_writeout): Add support for setting the text
	segment to an absolute address.

2009-10-13  Bill Holmes  <billholmes54@gmail.com>

	* aot-compiler.c : Fix the MSVC builds

	Code is contributed under MIT/X11 license.

2009-10-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_trampoline_xdebug_info): Implement this for the
	gdb mode.

2009-10-09  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (parse_debug_options): Add a 'gdb' option.

	* mini.c (mini_parse_debug_options): Add a 'gdb' option.

	* image-writer.c: Add support for emitting the image into a memory buffer.

	* dwarfwriter.c: Add support for sharing one IL file between multiple images.

	* aot-compiler.c: Add support for registering debug info with GDB using the
	new JIT debugging interface in GDB 7.0. It can be turned on by setting
	MONO_XDEBUG to 'gdb'.

2009-10-09  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (bin_writer_emit_writeout): Fix a copy paste error causing
	the LOC section to overwrite the LINE section.

2009-10-06  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_class): Add an instance of GenericComparer<T> for
	each instance of Comparer<T>.

	* generics.cs: Add a new test.

2009-10-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_class): Only add GetGenericValueImpl wrappers
	when using full-aot.

2009-09-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_create_vars): Make the component vars of a long ret
	variable volatile. Fixes #541577.

	* basic-calls.cs: Add a new test.

	* basic-long.cs: Remove tests which are now in basic-calls.cs.

2009-10-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_emit_setret): Emit long return values using OP_LMOVE.
	(mono_arch_create_vars): Instead of allocating a stack slot by hand, allocate
	a variable to hold the stack slot used by the int<->float conversion opcodes.

	* mini-sparc.c (mono_arch_build_imt_thunk): Implement support for fail_tramp.

2009-09-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_allocate_vars): Use mono_class_from_mono_type ()
	instead of using type->data.klass as the later doesn't work with generics.

2009-09-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c: Fix the handling of enums with base type long.

	* mini-sparc.c (mono_arch_output_basic_block): Fix IREM_UN_IMM.

	* mini-sparc.c (mono_arch_allocate_vars): Use mono_class_from_mono_type ()
	instead of using type->data.klass as the later doesn't work with generics.

2009-09-30  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Add a runtime invoke wrapper which is used by
	mono_runtime_capture_context () without calling mono_runtime_invoke ().
	(can_marshal_struct): Skip structures with auto layout.

	* tramp-arm.c (GEN_TRAMP_SIZE): Increase this by 4.

2009-09-24  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (emit_debug_info_end): Disable this as it doesn't seem to
	work/required with recent iphone sdk versions.

	* aot-compiler.c (add_wrappers): Generate PtrToStructure wrappers for more
	structures.

	* decompose.c (mono_decompose_vtype_opts): Avoid reading uninitialized memory
	in the VCALL decomposition code.

2009-09-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_output_basic_block): Fix ISHR/ISHR_IMM.

	* basic.cs: Add a test.

	* mini-ia64.c (mono_arch_build_imt_thunk): Implement support the virtual
	generic invokes.

	* mini-exceptions.c (mini_jit_info_table_find): New helper function which
	searches all the domains of the current thread.

	* exceptions-<ARCH>.c: Use it. Fixes #539394.

2009-09-21  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-arm.c (mono_arm_throw_exception): Set ctx->ebp to fp instead of sp
	so catching exceptions thrown in the same method works. Fixes exception17.exe.

	* tramp-arm.c (mono_arch_create_trampoline_code_full): Store NULL into lmf->method
	for non-jit trampolines.

	* mini.c (mono_jit_runtime_invoke): Allow string ctors with dyn runtime invoke.

	* aot-compiler.c (add_wrappers): Ditto.

	* mini-arm.c: Implement support for passing vtypes and floats, and increase
	the size of the param area used by dyn_call to 6 which covers the majority of
	methods.

	* mini.c aot-compiler.c: Allow dyn_call for string methods except ctors.

	* mini-arm.c: Implement support for passing/receiving
	longs and receiving floats in the dyn_call code.

	* mini-amd64.c: Implement support for receiving vtypes in registers in
	the dyn_call code.

	* mini.c mini-amd64.c: Implement partial support for passing vtypes in
	the dyn_call code.

2009-09-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (get_call_info): Return more precise information in
	ArgInfo->regtype.
	(dyn_call_supported): Use the information in CallInfo.

	* mini-arm.c: Enable support for returning vtypes in the dyn_call code.

	* mini.c mini-amd64.c: Enable support for returning vtypes in the dyn_call
	code.

	* mini-arm.c: Update after the dyn_call api changes.

	* mini.c (mini_create_jit_domain_info): Register a destructor function
	for the runtime_invoke_hash.

	* mini-amd64.c (mono_arch_get_dyn_call_args): Rename this to
	'mono_arch_dyn_call_start'. Pass the pointer to the return value buffer to
	this function.
	(mono_arch_get_dyn_call_ret): Rename this to 'mono_arch_dyn_call_finish'.
	(dyn_call_supported): Simplify this by using get_call_info ().
	(mono_arch_dyn_call_free): New destructor function.

	* generics.cs: Remove a printf.

	* method-to-ir.c (mono_method_to_ir): Allocate some param area for DYN_CALL.

	* mini-arm.c: Add support for enum return values and passing a few arguments
	on the stack.
	
	* mini.c (mono_jit_runtime_invoke): Add support for enum return values to
	dyn invoke.

	* mini-amd64.c (mono_arch_get_dyn_call_ret): Ditto.

	* aot-compiler.c (add_wrappers): Add a few restrictions for the use of
	the dynamic invoke wrappers.

	* mini-arm.c: Implement OP_DYN_CALL for arm.

	* aot-compiler.c (add_wrappers): Avoid aot-ing runtime invoke wrappers
	supported by the dynamic runtime invoke wrapper.

	* aot-compiler.c aot-runtime.c: Add support for encoding the dynamic
	runtime invoke wrapper.

	* mini.c (mono_jit_runtime_invoke): Use the dynamic runtime invoke wrappers
	if possible when running with full-aot.

	* mini-ops.h: Add OP_DYN_CALL opcode.

	* mini-amd64.c method-to-ir.c: Add infrastructure for making method calls
	with dynamic arguments lists similar to libffi.

2009-09-19  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c: Fix the previous change on 64 bit platforms.
	
	* method-to-ir.c: Applied patch from Rodrigo Kumpera. Allow an i8 argument
	to NEWARR.

	* iltests.il.in: Add a new test.
	
2009-09-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_instances): Add more instances of
	GenericEqualityComparer.

2009-09-18  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c: Add asserts for mono_class_vtable calls that are not meant to fail.

2009-09-18  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c: Handle failures from mono_class_vtable. Added some
	comments on some functions that now can fail.

2009-09-17  Andrew Jorgensen  <ajorgensen@novell.com>

	* Makefile.am: Add Info.plist to EXTRA_DIST

2009-09-16  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Allow AOT for CEE_LDTOKEN in
	static synchronized wrappers. Fixes #539500.

2009-09-14  Rodrigo Kumpera  <rkumpera@novell.com>

	* jit-icalls.c (mono_class_static_field_address): handle vtable failure
	properly.

2009-09-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_exception_internal): Store the computed
	lmf before calling filter clauses as well. Fixes #539550.

	* exceptions.cs: Add a test.
	
2009-09-14  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_class): Add instances of
	Array.GetGenericValueImpl as well.

	* Makefile.am (fullaotcheck): Copy and aot more assemblies so linq
	can be tested too.

	* generics.cs: Add a fullaot linq test.

2009-09-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (arch_emit_static_rgctx_trampoline): Don't clobber argument
	reg r1 on arm.

2009-09-10  Bill Holmes  <billholmes54@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline) : Call
	  mono_cominterop_get_invoke if the delegate target object
	  is a COM object.

	Code is contributed under MIT/X11 license.

2009-09-09  Sebastien Pouliot  <sebastien@ximian.com>

	* method-to-ir.c: For CoreCLR throw a SecurityException if an 
	internal call is defined outside platform code. Reduce code 
	duplication with existing [Method|Field]AccessException

2009-09-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (mono_arch_emit_call): Don't reduce stack usage by 4
	if the return value is a small struct passed on regs.

2009-09-09  Zoltan Varga  <vargaz@gmail.com>

	* cpu-arm.md mini-arm.c: Remove unused opcodes.

	* mini-codegen.c: Enable the cpu description validation for arm.

2009-09-08  Zoltan Varga  <vargaz@gmail.com>

	* basic-calls.cs: Move the test_0_float_load_and_store_with_big_offset ()
	test which depends on structs to objects.cs.
	
	* basic-calls.cs: Remove calls to Console.WriteLine and throws, since those
	require object model related stuff working.

	* cpu-x86.md mini-x86.c: Remove more unused opcodes.

	* mini-ops.h: Fix OP_BIGMUL instruction descriptions.

	* mini-codegen.c (mono_local_regalloc): Validate the cpu description 
	against the instruction metadata in mini-ops.h. amd64 only for now.

	* mini-ops.h: Fix some instruction descriptions.

	* mini-ops.h mini-x86.c mini-amd64.c cpu-<ARCH>.md: Remove some
	unused instructions.

2009-09-06  Zoltan Varga  <vargaz@gmail.com>

	* exceptions.cs: Add a new test.

2009-09-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (needs_stack_frame): OSX requires full frames to keep proper alignment.

2009-09-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Add a few more missing casts,
	skip empty phi opcodes.
	
	* mini-llvm.c (mono_llvm_emit_method): Handle unsigned volatile variables
	correctly by zero extending after loads. Skip methods containing calls
	to the monitor enter/exit trampolines.

	* tramp-x86.c (mono_arch_create_trampoline_code): Align the stack
	when calling mono_thread_force_interruption_checkpoint ().

	* mini.c (mini_method_compile): Disable llvm when AOT compiling.

	* tramp-amd64.c (mono_arch_patch_callsite): Add support for 32 bit ->
	64 bit thunks.
	(mono_arch_nullify_class_init_trampoline): Read 'buf' instead of 'code'.

	* mini-llvm.c (mono_llvm_emit_method): Add a few missing conversions so a 
	bootstrap could run.

2009-09-04  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Set callbacks.get_runtime_build_info ().

2009-09-03  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_nullify_class_init_trampoline): Pass the start
	of the method to
	mono_breakpoint_clean_code () when using LLVM as the prologues generated by
	LLVM might be very short.

	* mini-x86.c (mono_arch_output_basic_block): Maintain stack alignment
	in OP_THROW/RETHROW.

	* exceptions-x86.c: Rewrite the throw trampolines so they maintain stack
	alignment on osx.

2009-09-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_get_vcall_slot): Pass the start of the method to
	mono_breakpoint_clean_code () when using LLVM as the prologues generated by
	LLVM might be very short.

2009-09-01  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (throw_exception): Fix the previous change by substracting
	the alignment for the value of sp.

2009-09-01  Geoff Norton  <gnorton@novell.com>

	* mini.c (mono_get_lmf_addr): Fix jit_thread_attach for native to 
	managed wrappers in full aot.

2009-08-31  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (get_throw_exception): Align the stack on osx.

2009-08-28  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm-cpp.cpp mini-llvm.c: Update to latest llvm api.

2009-08-25  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_exception_debug_info): Emit ei->flags too.

	* aot-runtime.c (decode_exception_debug_info): Decode ei->flags from the
	saved info.

	* mini.h (MONO_AOT_FILE_VERSION): Bump this.

	* aot-runtime.c aot-compiler.c: Emit exception causes fully so we don't
	depend on the info MonoMethodHeader which could be missing in IL stripped
	assemblies.

2009-08-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (add_general): Fix the passing of 64 bit values on darwin, where
	they are only 4 byte aligned.

2009-08-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_allocate_vars): Use FP as the frame pointer as
	was done previously, since using SP causes too many problems.

	* exceptions-arm.c: Fix the handling of sp/fp so unwinding through
	frames without a frame pointer works.

        * mini-arm.c (mono_arch_get_global_int_regs): Avoid using V5 as a
        global register in methods with calls, since the calls can go through
        a static rgctx trampoline which doesn't save it.

2009-08-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_context_get_int_reg): Handle SP as well.

2009-08-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_instances): Fix the net 1.1 build.

2009-08-18  Christian Hergert  <chris@dronelabs.com>

	* method-to-ir.c: Fix warnings for uninitialized variables.

2009-08-18  Christian Hergert  <chris@dronelabs.com>

	* mini-exceptions.c:
	* aot-compiler.c: Fix printf warnings.

2009-08-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_instances): Add string[] wrapper methods.
	Add GetGenericValueImpl<string>.
	
	* aot-compiler.c (add_generic_instances): Add instances of
	GenericEqualityComparer<T> for primitive types. Only emit the array
	wrappers into the mscorlib image.

2009-08-15  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_method): Rename 'aot_module' -> 'amodule'. Allocate
	the methods_loaded array using amodule->info->nmethods.

	* mini.h (MonoAotFileInfo): Add an 'nmethods' field.
	(MONO_AOT_FILE_VERSION): Bump this.

	* aot-compiler.c: Emit more generic instances allowing some parts of linq
	to work.

	* aot-runtime.c (mono_aot_get_unwind_info): Handle the case when the
	MonoJitInfo doesn't belong to its methods aot image.

2009-08-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_allocate_vars): Use SP as the default frame reg.

	* mini-arm.c: Fix warnings.
	
	* mini-arm.c (mono_arm_emit_load_imm): Only emit a movt if needed.

	* mini-arm.c (mono_arm_emit_load_imm): Use movt/movw if the cpu
	supports it.

2009-08-12  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (arch_emit_imt_thunk): Rework the arm code to
	avoid clobbering IP.

	* mini-trampolines.c (mono_magic_trampoline): Allocate a local to
	hold the trampoline argument, so its initial value is available during
	debugging.

2009-08-11 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* exceptions-arm.c:
	* exceptions-hppa.c:
	* mini.c:
	* exceptions-s390x.c:
	* exceptions-mips.c:
	* exceptions-ppc.c:
	* exceptions-sparc.c:
	* exceptions-alpha.c:
	* aot-runtime.c:
	* mini-trampolines.c:
	* exceptions-x86.c:
	* exceptions-s390.c: add and use #define's instead of sizeof()
	for MonoJitInfo and MonoJitInfoTable.

2009-08-10 Gonzalo Paniagua Javier <gonzalo@novell.com>

	* tramp-arm.c:
	* tramp-amd64.c:
	* tramp-ppc.c:
	* tramp-x86.c: use a #define instead of sizeof() for a few
	structures that use a zero-length array.

2009-08-07  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir/CEE_CONSTRAINED_): Handle the
	case when the method is dynamic. Fixes #529238.

2009-08-06  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Throw an exception instead
	of asserting when a method is JIT compiled in full-aot mode.

2009-08-03  Jerry Maine  <crashfourit@gmail.com>
	
	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.
	
	* fixed wrong dates in changelog.

2009-08-03  Jerry Maine  <crashfourit@gmail.com>
	
	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.

	* basic-simd.cs: added test for packed double square root.
	* cpu-amd64.md: added opcode info for packed double square root.
	* cpu-x86.md: added opcode info for packed double square root.
	* mini-ops.h: added IR opcode for packed double square root.
	* mini-x86.c: added IR to native translation code for packed double square root.
	* mini-amd64.c: removed todo for packed double square root.
	* simd-intrinsics.c: added method to IR opcode converstion for
	packed double square root.

2009-08-03 Jerry Maine <crashfourit@gmail.com>

	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.

	* mini-amd64.c: Added a change to help tell the difference as 
	to what perpose	the xmm register is being used--mainly to help
	with debuging.
	* mini-amd64.h: Changed callee regs to use 15 out of 16 
	(one used for special cases) xmm registers for both fp
	and simd ops. Added define to turn on new feature in the regalloc
	that allows fp and simd ops to share the xmm regs happily.
	* codegen.c: Added code to detect for which perpose an xmm reg is
	being used (fp or simd)	and to translate back and forth to the
	correct logical reg bank (fp or simd) for 'spill load's.

2009-08-03 Jerry Maine <crashfourit@gmail.com>

	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.

	* basic-simd.cs: Added tests for stressing the regalloc when running with
	16 simd regs and when simd and fp ops share the same reg bank.

2009-08-01  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mini_emit_stobj): If we call mono_value_copy()
	in shared generic code, we might have to look up the class in the
	RGCTX.  If we use the class directly, compute its GC descriptor.

2009-07-31  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_jit_runtime_invoke): Fix a warning.

2009-07-31  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_jit_runtime_invoke): Initialize the class and
	check for errors. Fixed the case when the class with the Main
	method is broken.

2009-07-31 Jerry Maine <crashfourit@gmail.com>

	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.

	* cpu-amd64.md: Fixed simple bug in machine discrition file.

2009-07-31  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_output_basic_block): Implement OP_IREM_UN_IMM.

2009-08-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c: Fix naming of stelem and ldelem.

2009-07-30  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (main_thread_handler): Check that the assembly loaded
	matches the filename when doing AOT.

2009-07-30  Mark Probst  <mark.probst@gmail.com>

	* mini.c: get_ip_from_sigctx installer has been removed, so don't
	call it anymore.

	* mini-x86.h, mini-amd64.h, mini-ppc.h: UCONTEXT macros moved (to
	utils/mono-sigcontext.h).

	* exceptions-amd64.c: Use the UCONTEXT_GREGS macro instead of an
	#ifdef.

2009-07-29  Massimiliano Mantione  <massi@ximian.com>

	* mini.c (mono_codegen):
	Call profiler hook to keep track of method code buffers.

2009-07-27  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Invoke write barriers for the
	Interlocked.(Compare)Exchange JIT intrinsics.

2009-07-26  Raja R Harinath  <harinath@hurrynot.org>

	* Makefile.am (version.h): Fix issues when built out of tree.
	Remove some redundant 'grep's piped through 'sed's.

Fri Jul 24 17:28:37 CEST 2009 Steven Munroe  <munroesj@us.ibm.com>

	This patch is contributed under the terms of the MIT/X11 license

	* mini-ppc.c (mono_arch_output_basic_block):
	(OP_STOREI1_MEMBASE_REG): Handle 32-bit offsets combining addis
	for bits 32-47 with signed load/store diplacements for bits
	48-63.  Use prefered base/offset order for indexed form.
	(OP_STOREI2_MEMBASE_REG, OP_STORE_MEMBASE_REG): Same.
	(OP_LOAD_MEMBASE, OP_LOADI4_MEMBASE, OP_LOADU4_MEMBASE,
	OP_LOADI1_MEMBASE, OP_LOADU1_MEMBASE, OP_LOADU2_MEMBASE,
	OP_LOADI2_MEMBASE): Same.
	(OP_STORER8_MEMBASE_REG, OP_LOADR8_MEMBASE,
	OP_STORER4_MEMBASE_REG, OP_LOADR4_MEMBASE): Same.
	(OP_STOREI1_MEMINDEX): Use prefered base/offset order for
	indexed form.
	(OP_STOREI2_MEMINDEX, OP_STORE_MEMINDEX): Same.
	(OP_LOAD_MEMINDEX, OP_LOADI4_MEMINDEX, OP_LOADU4_MEMINDEX,
	OP_LOADU2_MEMINDEX, OP_LOADI2_MEMINDEX, OP_LOADU1_MEMINDEX,
	OP_LOADI1_MEMINDEX): Same
	(OP_LOADR4_MEMINDEX, OP_LOADR8_MEMINDEX, OP_STORER4_MEMINDEX,
	OP_STORER8_MEMINDEX): Same
	(OP_JMP): Use addis/addi sequence for int cfg->stack_usage
	computations.
	(mono_arch_emit_prolog): Handle 32-bit offsets combining addis
	for bits 32-47 with signed load/store diplacements for bits
	48-63.  Use prefered base/offset order for indexed form.

Fri Jul 24 16:57:12 CEST 2009 Steven Munroe  <munroesj@us.ibm.com>

This patch is contributed under the terms of the MIT/X11 license

	* mini-ppc.c: Define PPC_MOVE_FPR_GPR and PPC_ISA_64.
	(mono_arch_get_vcall_slot): Fx pointer to int cast warning.
	(mono_arch_decompose_opts): Make OP_ICONV_TO_R4 and
	OP_ICONV_TO_R8 decompose conditional on !PPC_ISA_64.
	(mono_arch_output_basic_block) [OP_JMP]: Use ppc_load32 for
	cfg->stack_usage to avoid size warnings.
	(mono_arch_output_basic_block) [__mono_ppc64__]: Replace
	store/load sequence with mffgpr if PPC_MOVE_FPR_GPR is true.
	(mono_arch_output_basic_block) [!__mono_ppc64__]: For
	OP_ICONV_TO_R4 or OP_ICONV_TO_R8 and PPC_ISA_64 use fcfid
	to convert.
	(mono_arch_emit_prolog): Move mono_emit_unwind_op_def_cfa 
	after code varible is initialized.
	Add g_assert ppc_is_imm16 for ainfo->offset. Handle
	ainfo->size == 8 when ainfo->offset !ppc_is_imm16.
	(mono_arch_emit_epilog): 
	Move Use ppc_load32 for cfg->stack_usage to avoid size
	warnings.

2009-07-24  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: The write barrier doesn't do the store anymore,
	so we have always to emit it.  Also, emit the wbarrier after the
	store.

2009-07-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_get_delegate_invoke_impls): Add a trampoline
	for argument count 3 too.

2009-07-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_with_opt): Add an 'ex' argument to let
	the caller handle the exceptions.
	(mono_jit_runtime_invoke): Handle exceptions thrown while compiling the
	method. Fixes #524498.

2009-07-22  Geoff Norton  <gnorton@novell.com>

	* mini-exceptions.c: Fix build on ia64.

2009-07-22  Mark Probst  <mark.probst@gmail.com>

	* mini-exceptions.c (ves_icall_get_frame_info): Use write
	barriers.

2009-07-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_emit_prolog): Fix thread attaching in aot
	code.

2009-07-20  Zoltan Varga  <vargaz@gmail.com>

	* basic-simd.cs (Main): Pass args to the test driver.

2009-07-20  Geoff Norton  <gnorton@novell.com>

	* mini-x86.h: Fix the x86 version guards to use Apple's
	properly defined macros.

2009-07-20  Geoff Norton  <gnorton@novell.com>

	* mini-x86.c: Fix --trace on darwin-x86 and other systems which require
	aligned access.

2009-07-20  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_runtime_invoke): Speed this up by adding a hash to
	MonoJitDomainInfo which maps MonoMethod's to a structure containing all
	the information which is needed for invokes, so only one locking+hash table
	lookup is needed.

	* aot-compiler.c: Add a 'tool-prefix' option to be used when cross-compiling.
	
	* aot-compiler.c (add_generic_instances): Emit instances of 
	GenericComparer<T> for primitive types.

2009-07-19 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-posix.c: Fix linux build.

2009-07-19  Geoff Norton  <gnorton@novell.com>

	* mini.h: Add prototypes for mono_runtime_syscall_fork and
	mono_gdb_render_native_backtraces
	* mini-darwin.c: Apple's syscall(SYS_fork) is very weird on x86,
	so we implement the sane semantics to the runtime here
	(mono_gdb_render_native_backtraces).  Apple also uses an ancient gdb
	so we need to call it differently (mono_gdb_render_native_backtraces)
	* mini-posix.c: Move the old semantics from mini.c to the prototypes
	here for default implementations.
	* mini.c: Refactor mono_handle_native_sigsegv so that we can properly
	support Apple's weird syscall (SYS_fork) implementation and not busy
	loop in abort() on native crashes on OSX anymore.

2009-07-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_method): Change the handling of the
	MONO_LASTAOT env variable so MONO_LASTAOT=0 means that no aot methods
	are used.

	* mini.c (mono_patch_info_equal): Really fix the handling of RGCTX_FETCH.

2009-07-17  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_patch_info_equal): Revert the last change for now as it
	seems to break the aot tests.
	
	* mini.c (mono_patch_info_equal): Fix the handling of 
	MONO_PATCH_INFO_RGCTX_FETCH.

2009-07-16  Zoltan Varga  <vargaz@gmail.com>

	* unwind.c: Use TARGET_AMD64 instead of __x86_64__.

	* mini.c (mono_patch_info_hash): Fix the handling of 
	MONO_PATCH_INFO_INTERNAL_METHOD.
	(mono_patch_info_equal): Ditto.

2009-07-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Use module instead of ctx->module
	in a few places.
	
	* mini-llvm.c: Add some infrastructure for AOT support.

2009-07-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm-cpp.c: Update to the latest llvm api.
	
	* mini-llvm-cpp.cpp (mono_llvm_create_ee): Set the EnablePrettyStackTrace
	option to false to prevent llvm from installing signal handlers which
	trip up the gc.
	
2009-07-15 Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md:
	* cpu-amd64.md: Revert previous change as those instructions
	take 2 separate arguments. Remember to read the arch docs more
	carefully next time.

2009-07-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm-cpp.cpp (mono_llvm_build_alloca): Update to latest llvm api.

Wed Jul 15 17:20:27 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: exploit multiple load/store units if available (rest of
	the change from Steven Munroe (<munroesj@us.ibm.com>) first patch at 
	http://bugzilla.novell.com/show_bug.cgi?id=487846).

Wed Jul 15 16:24:57 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: integrate most of Steven Munroe (<munroesj@us.ibm.com>)
	first patch at http://bugzilla.novell.com/show_bug.cgi?id=487846.

2009-07-14 Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Fix missing clobbering from trancendental simd
	ops.

	* cpu-amd64.md: Same.

2009-07-14 Jerry Maine <crashfourit@gmail.com>

	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.

	* basic-simd.cs: Added tests for single and doulble indexers.

	* cpu-amd64.md: Added simd opcode information.

	* mini-amd64.c: Added IR to native simd generation code.
	Added simd register names and function that returns them.

	* mini-amd64.h: Added marcos to turn on simd code compilation in
	amd64. Added max simd register count marco. Added caller/callee
	register mask marcos. Added marcos to use simd register bank.

	* mini.h: Added helper marco for shufling dwords and simple
	floats.

2009-07-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm-cpp.cpp: Update to latest llvm SVN api.

	* Makefile.am (mono_LDADD): Pass LLVM_LDFLAGS to the linked.

	* unwind.c (mono_unwind_get_ops_from_fde): Make this return
	the length of the native code as well.

        * basic-simd.cs: Add a test for #521662.

Mon Jul 13 17:58:50 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixed bug introduced by Steven's TLS changes.

2009-07-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Register function for getting the IP from a signal
	context with metadata.

2009-07-13  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): When calling a gshared method,
	call a generic class init trampoline if needed. Fixes #519336.

	* generics.cs: Add a test.
	
2009-07-09  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: When doing a call which might be remote from
	shared generic code to other shared code with open type arguments,
	get the remoting invoke wrapper from the RGCTX and do an indirect
	call to it.

2009-07-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (get_unbox_trampoline): Add an rgctx trampoline
	after the unbox trampoline in the full-aot case.

2009-07-02  jonas echterhoff <jonas@unity3d.com>
	
	* mini.c: Move initialization of jit_mutex before debugger initialization
	
	to avoid crashes.
	
	
	* Info.plist: added Info.plist and link flag to enable the mono executable
	to access other processes. Requires codesigning of the executable to work.
	
	* mdb-debug-info32-darwin.s: The same as mdb-debug-info32.s, changed to 
	
	compile on OS X.
	

2009-06-30  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mini_regression): Handle loading errors. Fixes #508869.

2009-06-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (get_generic_context_from_stack_frame): Fix the case
	when the generic instance is an instantiation of a subclass of the
	methods class. Fixes #517166.

2009-06-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Fix thread attaching in AOTed
	code.

	* mini.c (mono_jit_thread_attach): Allow domain to be NULL for calls from
	AOTed code.

	* CMakeLists.txt: Add minimal support for installation.

2009-06-25  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_and_reloc_code): Factor out the code to
	determine whenever a method is directly callable to a separate function.

	* mini-<ARCH>.c tramp-<ARCH>.c: Remove needless casts and add new
	needed ones as a result of the previous change.

	* mini-<ARCH>.c tramp-<ARCH>.c: Use mgreg_t* as the
	type of register arrays.

	* mini-trampolines.c tramp-<ARCH>.c aot-runtime.c: Use mgreg_t* as the
	type of register arrays.

2009-06-24  Jerry Maine  <crashfourit@gmail.com>
	
	Contributed under the terms of the MIT/X11 license by
	Jerry Maine <crashfourit@gail.com>.

	* mini-amd64.c: Added code to convert simd IR to native amd64 sse.

2009-06-24  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_plt): Define debug labels for most plt entries.

2009-06-24  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c: Correct LCONV_TO_Ix and ICONV_TO_Ix routines. Fix leave_method
	dump of structure return value. Fix some formatting.
	* cpu-s390x.md: Fix lengths of instruction sequences.
	* mini-s390.c: Minor formatting changes.

2009-06-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.h: Applied patch from Romain Tartiere (romain@blogreen.org).
	Use sigaction on freebsd as well.

2009-06-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Don't define MONO_ARCH_HAVE_TLS_GET to 0, as some code
	uses #ifdef on it.
	
	* mini.c (mini_init): Revert a change which breaks cross-compilation.

2009-06-22  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c, cpu-ppc.md: Enable TLS on Darwin/G4.

2009-06-22  Mark Probst  <mark.probst@gmail.com>

	* mini.c, mini.h: Tell the runtime whether we support MONO_TLS.

2009-06-20  Martin Baulig  <martin@ximian.com>

	* debug-mini.c
	(MonoDebuggerThreadFlags): New enum typedef.
	(MonoDebuggerThreadInfo): Added `guint32 thread_flags'.
	(mono_debugger_thread_created): Added `gpointer func' argument;
	initialize the new `thread_flags' field.

2009-06-18  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerRuntimeFlags): New enum typedef.
	(MonoDebuggerInfo): Renamed the `dummy' field info `runtime_info'.

	* debug-debugger.c
	(mini_debugger_set_attach_ok): New function; sets the attach-ok
	flag in `MONO_DEBUGGER__info.runtime_info'.

	* driver.c
	(mono_main): Call mini_debugger_set_attach_ok() if generics
	sharing is disabled.

2009-06-22  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Fix a warning.

	* mini-ppc.c tramp-ppc.c exceptions-ppc.c aot-compiler.c: Update after
	the ppc load/store macro changes.

2009-06-21  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ppc.c (mono_arch_patch_plt_entry): Implement this.

	* aot-compiler.c (mono_compile_assembly): Sanitize the plt symbol too,
	not just the got symbol.

	* mini-ppc.c aot-compiler.c unwind.c: Implement generation of unwind info
	on ppc.

	* aot-compiler.c unwind.c: Add infrastructure for unwind support on
	ppc.
	
	* aot-compiler.c: Remove some fixmes.

	* driver.c (mono_main): Print a helpful message when cross-compiling.

	* mini.c (mini_init): Disable signal handlers when cross-compiling.

	* method-to-ir.c (initialize_array_data): Do the optimization if the
	target byte order is little endian, instead of the host byte order.

	* aot-compiler.c: Emit sizes for most symbols, only emit runtime-invoke
	wrappers into the mscorlib image, Emit a unique plt symbol for each
	image, emit symbols for plt entries.

	* image-writer.c (img_writer_emit_symbol_size): New function to emit
	a .size directive.
	
2009-06-20  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Avoid calling 
	mono_marshal_get_type_info () since it can assert for some types.

	* method-to-ir.c (mono_method_to_ir): Disable aot when some forms of 
	ldtoken are used inside wrappers.

	* helpers.c: Add support for prefixing tools with the arch name.

	* mini.h (OP_LOADR_MEMBASE): New opcodes to load/store pointer sized
	quantities when using ilp32.

	* mini-codegen.c: Use OP_LOADR_MEMBASE/OP_STORER_MEMBASE for loading/storing
	spill slots. Use sizeof(mgreg_t) for the spill slot size.

	* image-writer.c: Use .long on ilp32.

	* aot-compiler.c: Use 32 bit loads on ilp32.
	
2009-06-19  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ppc.c (mono_arch_create_trampoline_code): Fix the ppc build.

	* mini-ops.h: Use TARGET_POWERPC define for consistency.

	* patch-info.h: Add 'MSCORLIB_GOT_ADDR' patch type.

	* aot-compiler.c aot-runtime.c: Put the mscorlib got address into the 
	second got slot of every aot image.
	
	* aot-compiler.c aot-runtime.c mini-trampolines.c: Add support for
	aot on platforms with function pointers.

	* mini-ppc.h mini-ppp.c cpu-ppc.md exceptions-ppc.c tramp-ppc.c: Add
	support for aot/full aot on ppc/ppc64.
	
	* tramp-<ARCH>.c (mono_arch_patch_plt_entry): Add 'got' and 'regs'
	arguments which are needed on ppc.

	* tramp-arm.c (mono_arch_nullify_class_init_trampoline): Add 'regs'
	argument.

	* mini-trampolines.c aot-runtime.c: Update after the above changes.
	
	* liveness.c (BITS_PER_CHUNK): Use MONO_BITSET_BITS_PER_CHUNK.

	* regalloc2.c (BITS_PER_CHUNK): Ditto.	

	* aot-compiler.c (emit_got_info): Fix reading unused memory.

	* ir-emit.h (alloc_dreg): Add a 'return -1' to quiet some compilers.

2009-06-17  Geoff Norton  <gnorton@novell.com>

	* aot-compiler.c: Ensure we dont try to close a null dwarf writer.

2009-06-17  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (mono_dwarf_writer_create): Add an 'appending' parameter
	to control whenever the dwarf writer is in xdebug or aot mode.
	(emit_class_dwarf_info): Use a separate abbrev for structures without
	children.

	* aot-compiler.c: Pass the appending parameter to 
	mono_dwarf_writer_create ().

	* branch-opts.c (mono_merge_basic_blocks): Fix the case when bbn
	falls through to its next bblock. Fixes #513931.

	* iltests.il: Add a test.

	* dwarfwriter.c (mono_dwarf_writer_emit_base_info): Emit some line number
	infor even if emit_line is FALSE, as the apple linker seems to require it.

	* image-writer.c (asm_writer_emit_symbol_diff): Call get_label ().

	* dwarfwriter.c (emit_cie): Emit a separate symbol for the cie start, as
	gcc does.
	(emit_fde): Ditto.

2009-06-15  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-mips.c (mono_arch_get_throw_exception_by_name): Fix the
	mips build.

2009-06-13  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (struct MonoBasicBlock): Add 'has_jump_table' and 
	'has_call_handler' fields.

	* method-to-ir.c (mono_method_to_ir): Set them if needed.

	* branch-opts.c (mono_merge_basic_blocks): Avoid iterating through the
	first bblock if not needed. Fixes #512790.
	
2009-06-11  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_compile_assembly): Fix a warning.
	
	* aot-compiler.c (add_wrappers): Don't emit remoting-invoke-with-check
	wrappers.

	* aot-runtime.c (mono_aot_get_method): Use the original method's code for
	remoting-invoke-with-check wrappers, which are not needed when running with
	full-aot, since it doesn't support remoting.
	
2009-06-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_got_info): Don't emit offsets for the plt got entries.

	* aot-compiler.c aot-runtime.c: Don't emit the first got offset in the
	method info, it is not used anymore.

	* mini.h: Bump AOT file format version.
	
	* aot-compiler.c (arch_emit_plt_entry): Make the arm plt entries one
	word smaller.

	* aot-runtime.c (mono_aot_get_plt_info_offset): Update after the
	change above.
	
	* tramp-arm.c (mono_arch_patch_plt_entry): Ditto.

	* mini.h: Bump AOT file format version.
	
2009-06-10  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (asm_writer_emit_symbol_diff): Disable the 
	TARGET_ASM_APPLE stuff for now, as it doesn't seem to work on the
	iphone.

	* mini-arm.c (mono_arch_output_basic_block): Fix the implementation
	of CKFINITE and FBGE for VFP.

2009-06-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Don't align code to 16 bytes on arm.
	
	* aot-compiler.c (emit_method_code): Emit the unbox trampolines right
	before the methods they belong to.

	* aot-runtime.c (mono_aot_plt_resolve): Avoid creating trampolines in
	the full-aot case if possible, since the trampoline will be called right 
	away.

	* aot-compiler.c (mono_compile_assembly): Decrease the number of full aot
	trampolines to 1024 after the change above.

	* aot-compiler.c (arch_emit_specific_trampoline): Rework the arm
	trampoline to save 8 bytes per trampoline.

	* tramp-arm.c (mono_arch_create_trampoline_code_full): Update after the
	change above.

2009-06-08  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Use acfg->temp_prefix instead of .L to prefix labels.

2009-06-08  Martin Baulig  <martin@ximian.com>

	* debug-mini.c
	(MonoDebuggerExceptionAction): Moved into debug-mini.h.
	(_mono_debugger_throw_exception): Don't make this static.
	(_mono_debugger_unhandled_exception): Likewise.
	(mono_debugger_handle_exception): Moved to mini-exceptions.c

	* debug-mini.c
	(MonoDebuggerExceptionAction): Moved here from debug-mini.c.
	(_mono_debugger_throw_exception): Add function prototype.
	(_mono_debugger_unhandled_exception): Likewise.

	* mini-exceptions.c
	(mono_handle_exception_internal): Added `MonoJitInfo **out_ji'
	arg; return the first exception handler if the exception is caught
	and we're running inside the debugger.
	(mono_debugger_handle_exception): Moved here from debug-mini.c;
	improve exception handle inside runtime-invoke, check whether the
	exception is actually caught in the method being invoked and not
	by the runtime-invoke-wrapper.

2009-06-08  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c: Improve support for the osx assembler.

	* dwarfwriter.c: Avoid the usage of subsections if the assembler doesn't
	support them.

2009-06-08  Martin Baulig  <martin@ximian.com>

	* debug-mini.c
	(MonoDebuggerExceptionAction): Moved into debug-mini.h.
	(_mono_debugger_throw_exception): Don't make this static.
	(_mono_debugger_unhandled_exception): Likewise.
	(mono_debugger_handle_exception): Moved to mini-exceptions.c

	* debug-mini.c
	(MonoDebuggerExceptionAction): Moved here from debug-mini.c.
	(_mono_debugger_throw_exception): Add function prototype.
	(_mono_debugger_unhandled_exception): Likewise.

	* mini-exceptions.c
	(mono_handle_exception_internal): Added `MonoJitInfo **out_ji'
	arg; return the first exception handler if the exception is caught
	and we're running inside the debugger.
	(mono_debugger_handle_exception): Moved here from debug-mini.c;
	improve exception handle inside runtime-invoke, check whether the
	exception is actually caught in the method being invoked and not
	by the runtime-invoke-wrapper.

2009-06-07  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (append_subsection): Don't align subsections of the
	debug_line section as a workaround.

	* dwarfwriter.c: Emit line number info in the AOT case as well.

2009-06-06  Steven Munroe  <munroesj@us.ibm.com>

	This patch is contributed under the terms of the MIT/X11 license

       * mini-ppc.c (mono_arch_emit_exceptions): Change assert to
       code_len <= code_size

2009-06-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-mips.c (mips_emit_exc_by_name): Fix the mips build.

2009-06-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Delete references to static rgctx
	invoke wrappers, we now use trampolines instead.

2009-06-04  Mark Probst  <mark.probst@gmail.com>

	* mini-darwin.c: The exception thread must not be registered with
	the GC.

2009-06-04  Mark Probst  <mark.probst@gmail.com>

	* mini-gc.c: Disable the code because it makes SGen crash.

2009-06-03  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_compile_assembly): Handle file open errors gracefully
	instead of asserting.

2009-05-31  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_compile_assembly): Move the creation of the
	output file after the code has been compiled.

2009-05-30  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ppc.c (mono_arch_get_static_rgctx_trampoline): Fix 64 bit support.

2009-05-31  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Get rid of the shared/non-shared got
	entries distinction to simplify the code.

	* mini.h: Bump AOT file format version.
	
2009-05-28  Zoltan Varga  <vargaz@gmail.com>

	* objects.cs: Fix the signature of one of the tests.

	* mini.c (mini_create_ftnptr): New helper function, moved here from
	object.c.
	(mini_get_addr_from_ftnptr): Ditto.
	(mini_init): Install the new helpers.

2009-05-28  Martin Baulig  <martin@ximian.com>

	Correctly initialize the debugger when embedding Mono.

	* mdb-debug-info32.s, mdb-debug-info64.s: Add a global variable
	`MONO_DEBUGGER__using_debugger' to the `.mdb_debug_info' section;
	see documentation in mini_debug_running_inside_mdb().

	* debug-debugger.c
	(mini_debug_running_inside_mdb): New function to check whether
	we're running inside mdb.

	* mini.c (mini_init): Call mini_debugger_init() if we're running
	inside the debugger.

	* driver.c (mono_main): Moved the call to mini_debugger_init()
	into mini_init() to make this work when embedding Mono.

	* debug-debugger.c (mini_debugger_init): Warn about duplicate
	calls to mini_debugger_init().

	* mini.h: Rename mono_debugger_init() -> mini_debugger_init(),
	mono_debugger_main() -> mini_debugger_main() and put them inside a
	`MONO_DEBUGGER_SUPPORTED' conditional.

2009-05-26 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-trampolines.c: Kill mono_find_delegate_trampoline_by_addr as
	this is no longer in use.
	* mini.h: Same.

2009-05-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (add_outarg_load): Fix the sparc build.

	* aot-compiler.c (emit_method_code): Always write out C style symbols for
	methods.

2009-05-27  Martin Baulig  <martin@ximian.com>

2009-05-25 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (mono_arch_output_basic_block): Fix the precision of
	long_conv_to_r_un to 64 bits.

	* cpu-x86.md: Increase the instruction size due to the changes.

	* iltests.il.in: Add regression test.

	Fixes #467201.

2009-05-25 Rodrigo Kumpera  <rkumpera@novell.com>

	* objects.cs: Move the previous test from basic.cs to here.

2009-05-25 Rodrigo Kumpera  <rkumpera@novell.com>

	* basic.cs: Add regression test for #506915.

2009-05-25 Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir): When doing the ldobj+stobj
	optimization we must check the bb of the first byte of stobj as
	it's the only one set in cil_offset_to_bb.

	Fixes #506915.	

2009-05-25  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c: Fix pointer directive on ppc64.

2009-05-24  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (asm_writer_emit_section_change): Avoid using
	.bss subsections on ppc too.

2009-05-23  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c: Fix the definition of TARGET_ASM_....
	
	* image-writer.c: Fix the emission of assembler directives in the last
	change.

	* mini-ppc.c (mono_arch_emit_exceptions): Increase the size of the
	exception throwing code to accomodate ppc64.

	* tramp-ppc.c (mono_arch_get_nullified_class_init_trampoline): Increase the
	size to work on ppc64 too.

	* mini-ppc.h (MonoCompileArch): Enable static rgctx trampolines on ppc64
	too.

	* image-writer.c: Clean up the #ifdef hell a bit by adding defines for
	the assembler dialect instead of using platform specific defines.

2009-05-22  Geoff Norton  <gnorton@novell.com>

	* mini-arm.c (get_call_info): If a structure is split between the stack
	and argument registers, we should not advance the stack pointer by the entire
	native size, but just by the amount that spilled.

2009-05-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (get_call_info): Handle structures with alignment requirements
	correctly.

2009-05-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_extra_methods): Encode direct runtime invoke
	wrappers normally.
	
	* aot-compiler.c (add_extra_method): Fix up the collection of extra
	methods so wrapper don't get added twice.
	(add_generic_instances): Don't add methods of arrays.

	* generics.cs: Mark one test as !FULLAOT.

2009-05-21 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (emit_move_return_value): Remove unused vars.

2009-05-21 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (mono_arch_emit_call): The decompose code now supports
	decomposing 8 bytes structs into a LCALL.

	* mini-x86.c (emit_move_return_value): We no longer push the vtype
	pointer for where to store the returned regs.

	* decompose.c (mono_decompose_vtype_opts): Fix the comment to properly
	state the concern.

	Fixes #471747, #471751 and #4734530 (in fact, it's a bunch of dups).

2009-05-20  Miguel de Icaza  <miguel@novell.com>

	* aot-runtime.c (mono_aot_init): Use g_getenv to work on systems
	without getenv.

2009-05-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Add StructureToPtr/PtrToStructure wrappers.

	* basic.cs: Move the test_2_cprop_bug () test to generics.cs as it involves
	generics.

2009-05-20 Rodrigo Kumpera  <rkumpera@novell.com>

	* local-propagation.c (mono_local_cprop): Avoid local propagation
	across paired add/sub if the first instruction dest reg is it's
	source reg. For example:

	int_add_imm R12 <- R12 [1] clobbers: 1
	int_sub_imm R42 <- R12 [1] clobbers: 1

	The cprop pass would wrongly const prop + 1 to int_sub_imm which doesn't
	maintain the math identify.

	Fixes #505375.

2009-05-20  Andreia Gaita  <avidigal@novell.com>

	* Makefile.am: avoid going on the network just to get the revision,
	use git log instead

2009-05-19  Massimiliano Mantione  <massi@ximian.com>

	Fixed estimate for short branches on amd64 (they were off mark, and
	enabling call prolog-epilog instrumentations caused assertions).
	* mini.h (struct MonoBasicBlock): added max_length field to hold the
	estimate for the maximum length of this basic block.
	* mini-amd64.c:
	- mono_arch_emit_prolog: compute max_length for each basic block
	  (instead of max_offset), and inflate size estimate also for entry bb
	  in case of code instrumentation.
	- mono_arch_output_basic_block: get rid of "cpos" (the current
	  estimated "position" in the code), and always use "offset" instead,
	  which is accurate; at the beginning of the function quickly recompute
	  max_offset for all the remaining blocks, starting from the current
	  cfg->code_len (which is correct, and not estimated) and using the
	  estimated block lengths computed previously.

2009-05-17  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-ppc.c: Remove the caching from the trampoline creation 
	functions, it is already done in the caller.

	* mini-trampolines.c (mono_llvm_vcall_trampoline): Fix the llvm build.

	* mini-ppc.h mini-arm.h mini-x86.h mini-amd64.h: Add 
	MONO_ARCH_GSHARED_SUPPORTED define.

	* mini.c (mini_init): Use the MONO_ARCH_GSHARED_SUPPORTED define.

	* mini-arm.c mini.c: Get rid of the unused mono_arch_fixup_jinfo ()
	function.

2009-05-16  Zoltan Varga  <vargaz@gmail.com>

	* jit-icalls.c (mono_helper_compile_generic_method): Get rid of the 
	call to mono_marshal_get_rgctx_invoke ().

	* mini.c method-to-ir.c mini-trampolines.c: Get rid of the usage of
	mono_marshal_get_static_rgctx_invoke (), all platforms which support
	gshared use the static rgctx trampolines now.
	
	* mini.c (mini_init): Call mono_set_generic_sharing_supported () if the
	platform supports it.

2009-05-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_allocate_vars): Correctly save R5 when using AOT.

	* aot-compiler.c (emit_method_code): Avoid duplicate labels for methods.

2009-05-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_emit_exceptions): Nullify the processed patches.

	* tramp-ppc.c (mono_arch_nullify_class_init_trampoline): Implement this
	for ppc.

2009-05-15  Massimiliano Mantione  <massi@ximian.com>

	Made it possible for mono_arch_instrument_epilog to preserve
	argument registers, otherwise instrumenting the "epilogue" before
	a tail call would clobber them.
	* mini.h: Added "mono_arch_instrument_epilog_full" prototype, which
	if like mono_arch_instrument_epilog but with an additional parameter
	that states if argument registers must be preserved.
	* mini.c: implemented mono_arch_instrument_epilog as a call to
	mono_arch_instrument_epilog_full without asking to preserve argument
	registers (this makes the existing code work as usual).
	* mini-amd64.c:
	- mono_arch_instrument_epilog: add parameter to transform it into
	mono_arch_instrument_epilog_full, and preserve argument registers
	when required.
	- mono_arch_output_basic_block, OP_TAILCALL case: call
	mono_arch_instrument_epilog_full.
	* mini-alpha.c, mini-arm.c, mini-hppa.c, mini-ia64.c, mini-mips.c,
	mini-ppc.c, mini-s390.c, mini-s390x.c, mini-sparc.c, mini-x86.c:
	only transformed mono_arch_instrument_epilog into
	mono_arch_instrument_epilog_full.

2009-05-15  Geoff Norton  <gnorton@novell.com>

	* mini-darwin.c: This works on arm now.

2009-05-14  Geoff Norton  <gnorton@novell.com>

	* jit.h, driver.c: Allow full-aot to be decided programatically by the
	embedding api.

2009-05-15  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_method_code): Skip a few more characters in the debug
	label names.

	* mini-trampolines.c (mono_magic_trampoline): Handle static rgctx invoke
	wrappers during full aot mode correctly.

	* aot-runtime.c (mono_aot_get_unbox_trampoline): Handle shared generic
	methods correctly.

	* aot-compiler.c (mono_aot_method_hash): Use our internal version of
	mono_metadata_type_hash ().

2009-05-14  Massimiliano Mantione  <massi@ximian.com>

	* mini.h, mini-codegen.c, mini-alpha.c, mini-amd64.c, mini-arm.c,
	mini-hppa.h, mini-hppa.c, mini-ia64.c, mini-mips.h, mini-mips.c,
	mini-ppc.c, mini-s390.c, mini-s390x.c, mini-sparc.c, mini-886.c:
	Removed MONO_INST_BRLABEL from the instruction flags, and the
	remaining code that used it, because we do not support branches inside
	basic blocks (and branch target labels) anymore.
	* Makefile.am: As part of the above cleanup, remove reference to
	BURG files which don't exist anymore.

2009-05-14  Zoltan Varga  <vargaz@gmail.com>

	* image-writer.c (asm_writer_emit_local_symbol): Make this a nop on
	osx.

	* mini-mips.c mini-mips.h exceptions-mips.c: Transition the mips backend
	to use mono_arch_throw_corlib_exception.

	* mini-ppc.c mini-ppc.h exceptions-ppc.c: Use 
	mono_arch_throw_corlib_exception for throwing corlib exceptions.

	* aot-runtime.c (decode_patch): Allocate the data for R4/R8 from the
	domain mempool.

	* mini.c (mono_patch_info_dup_mp): Copy the table of switch targets too.

	* aot-compiler.c: Emit a local symbol prefixed with the assembly name 
	for the got to make debugging easier and to avoid confusing it with the
	system got.
	
	* aot-compiler.c (emit_method_code): Emit a C style symbol for each
	method so a breakpoint can be set when using gdb.

2009-05-13  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_aot_method_hash): Implement this properly based
	on mono_method_get_imt_slot ().

	* aot-runtime.c (find_extra_method_in_amodule): Get rid of the
	num_decodes variables.

	* aot-compiler.c (mono_aot_method_hash): Revert part of the last
	change as it doesn't seem to work.
	
	* aot-compiler.c (mono_aot_method_hash): Improve the hashing of
	wrappers.

2009-05-12  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c mini.c mini-amd64.h mini-arm.h: Kill 
	MONO_ARCH_FULL_AOT_IMT_SUPPORTED define, both platforms now support imt.

	* mini.c (mini_init): Install mono_aot_get_imt_thunk as the IMT thunk
	builder when using full aot.

	* mini-amd64.c (mono_arch_build_imt_thunk): Don't handle the full-aot case
	here, it is already handled.
	
	* mini-arm.c (mono_arch_emit_imt_argument): Pass the dynamic imt arg
	correctly for IMT.

	* aot-compiler.c (arch_emit_imt_thunk): Implement this for ARM.

	* mini-arm.h: Enable IMT for full aot.
	
	* aot-compiler.c (mono_compile_assembly): Don't emit imt thunk if the
	arch doesn't support it.

	* mini.c (mini_init): Don't disable IMT for full aot if the
	architecture supports it.

	* mini.h (MonoAotTrampoline): New enum containing the different types
	of 'numerous' trampolines.
	(MONO_AOT_FILE_VERSION): Bump this.

	* aot-compiler.c aot-runtime.c: Unify the handling of specific and
	static rgctx trampolines. Add support for full-aot IMT thunks.

	* mini-amd64.h: Enable IMT for full aot.

	* TestDriver.cs: Add a CategoryAttribute class and an --exclude option
	to exclude tests belonging to a category.

	* generics.cs: Mark some tests with a !FULLAOT category.

	* Makefile.am (fullaotcheck): Run tests with --exclude !FULLAOT. Include
	generics tests.

2009-05-11  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_and_reloc_code): Move the implementation of
	MONO_PATCH_INFO_GOT_OFFSET to a separate arch-specific function.
	(emit_plt): Fix a warning.

2009-05-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Fix the build by moving is_shared_got_patch
	back into aot-compiler.c to a place where the other functions shared by
	the runtime and aot compiler are.
	
	* aot-compiler.c aot-runtime.c: Emit the got addr using a separate symbol,
	as done previously, instead of in MonoAotFileInfo, since pointers might have
	alignment requirements.

	* mini.h: Bump AOT file format version.

2009-05-10  Miguel de Icaza  <miguel@novell.com>

	* aot-runtime.c (mono_aot_is_shared_got_patch): Move this routine
	that is used at runtime from the aot-compiler.c, this makes it
	work on setups that remove the AOT compiler from the output
	image. 

2009-05-09  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ppc.c (mono_arch_get_static_rgctx_trampoline): Implement this for
	PPC.

	* mini-ppc.h: Enable static rgctx trampolines for ppc.

	* mini-<ARCH>.h: Kill the MONO_ARCH_ENABLE_EMIT_STATE_OPT define.

	* decompose.c (mono_decompose_long_opts): Move the ppc/sparc specific 
	stuff to mono_arch_decompose_long_opts ().
	(mono_decompose_opcode): Remove some dead code.

2009-05-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir): Fix boostrap of non amd64 builds
	cmethod can be null for quite a some reasons.

2009-05-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir): Fix non amd64 builds.

2009-05-08  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (arch_emit_got_access): Fix the aot-not-supported build.

2009-05-08  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_emit_call_args): Add a 'tail' flag argument.
	(mono_method_to_ir): Use MONO_ARCH_USE_OP_TAIL_CALL macro to determine
	whenever to make tail calls using OP_TAIL_CALL. Enable support for tail
	calls returning structures by addr on amd64.

	* mini-amd64.h (MONO_ARCH_USE_OP_TAIL_CALL): New arch-specific macro.

	* iltests.il.in: Restructure the tail call tests a bit.
	
2009-05-07  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Add remoting-invoke-with-check wrappers
	for virtual methods too.

2009-05-06  Raja R Harinath  <harinath@hurrynot.org>

	* method-to-ir.c (mono_method_to_ir): Revert change of 2009-05-02
	due to regression in verifying System.dll.

2009-05-06  Zoltan Varga  <vargaz@gmail.com>

	* debug-mini.c (mono_debugger_method_has_breakpoint): Allow breakpoints
	in dynamic methods.

	* dwarfwriter.c (emit_class_dwarf_info): Add support for generic
	instances.

	* aot-compiler.c aot-runtime.c: Use our own hash function instead of
	g_str_hash () which can change.

	* driver.c (mini_regression): Disable optimizations not supported by
	the cpu. Fixes #500019.

	* aot-runtime.c (mono_aot_get_unwind_info): Fix the --enable-minimal=aot
	build.

2009-05-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Update the OP_TLS_GET implementation
	to the latest LLVM code.

2009-05-05  Zoltan Varga  <vargaz@gmail.com>

	* genmdesc.pl (load_opcodes): Fix this after the TARGET_... changes.

2009-05-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Implement TLS support on 
	x86/amd64.

	* aot-compiler.c (encode_patch_list): Simplify this considerably as we are
	no longer saving offsets, so just save the patch types along with the other
	info.
	* aot-runtime.c (load_patch_info): Update after the changes to 
	encode_patch_list ().
	(decode_got_entry): Removed, merged into load_patch_info ().
	(is_shared_got_patch): Removed, call the same function from
	aot-compiler.c.

	* mini.h: Bump aot file format version.
	
	* aot-compiler.c aot-runtime.c: Resurrect static linking support. Kill the
	half-finished no-dlsym code.

	* aot-runtime.c (load_method): Kill the old and bit-rotten use_loaded_code
	option.

	* mini-<ARCH>.h mini-trampolines.c aot-runtime.c: Kill the 
	MONO_ARCH_HAVE_CREATE_TRAMPOLINE_FROM_TOKEN define.

2009-05-02  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_get_static_rgctx_trampoline): Increase the
	buffer length to work with AOT code.

	* method-to-ir.c (mono_method_to_ir): Handle loading errors in the
	ldfld/stfld opcodes.

	* exceptions-x86.c (mono_arch_get_throw_exception_by_name): Simplify this
	as it is not used.

	* mini-llvm.c mini-x86.c: Implement 32 bit and x86 support.

	* ssa.c (mono_ssa_compute): Don't skip I8 values when using LLVM.

	* mini-llvm-cpp.cpp (mono_llvm_create_ee): Update to the latest
	LLVM API.

	* mini.c (mini_method_compile): Set the from_llvm flag in MonoJitInfo
	if needed. Don't decompose long operations when using llvm.

2009-05-01  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Use mono_pagesize () instead of the
	PAGESIZE constant.

	* aot-runtime.c (load_aot_module): Get rid of another mprotect call.

2009-05-03  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (debugger_insert_source_breakpoint): Don't call
	mono_debugger_insert_method_breakpoint() since the class init
	handler we're inserting at the top of the method already gives us
	a notification.

2009-04-30  Zoltan Varga  <vargaz@gmail.com>

	* decompose.c (mono_decompose_long_opts): Move the implementation of LNEG
	to mono_arch_decompose_long_opts () for x86 and arm.

2009-04-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_regstate_alloc_int): Use __x86_64__ instead of
	TARGET_AMD64 here.

2009-04-28  Zoltan Varga  <vargaz@gmail.com>

	* *.h *.c: Use TARGET_<ARCH> defines instead of __<arch>__ defines in the
	JIT code.

2009-04-26  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_create_specific_trampoline): Add a stat for the
	number of trampolines used in full-aot mode.

	* aot-compiler.c: Add an ntrampolines option to set the number of 
	trampolines emitted in full-aot mode.

2009-04-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Implement OP_CHECK_THIS using
	a volatile load. Get rid of get_tempname (), llvm assigns names
	automatically.

	* mini-llvm-cpp.cpp (mono_llvm_build_volatile_load): New instruction
	builder function.

	* mini-llvm.c (mono_llvm_emit_method): Don't call LLVMGetParam on
	a value.

	* abcremoval.c (REPORT_ABC_REMOVAL): Don't output messages at verbose
	level 1.

	* mini-codegen.c (mono_local_regalloc): Prevent sreg1/dreg to be allocated
	to the same register as a fixed sreg2. Fixes #497271.

	* iltests.il.in: Add a new test.

2009-04-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c: Use moves instead of pushes for passing arguments on the
	stack, since pushes complicate exception handling.

	* exceptions-amd64.c (mono_arch_find_jit_info): Don't pop the arguments of
	the stack if they are passed using moves.

	* mini-trampolines.c (mono_llvm_vcall_trampoline): Add an assert.

	* method-to-ir.c (mono_method_to_ir): Disable fast virtual generic methods
	when using llvm.

	* mini-llvm.c (mono_llvm_emit_method): Call jit icall wrappers, not the 
	icalls themselves. Convert arguments of FCOMPARE. Convert the destination
	of FMOVE if it is an R4.

2009-04-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Add OP_LLVM_OUTARG_VT opcode.

	* mini.h (LLVMCallInfo): New structure to store calling convention 
	information for the LLVM back end similar to the CallInfo structures in 
	the back-ends.

	* mini-amd64.c (mono_arch_get_llvm_call_info): New arch function to return
	call information in a format usable by LLVM.
	(mono_arch_emit_call): Move the LLVM handling code to mono_llvm_emit_call ().

	* method-to-ir.c (mono_emit_call_args): Emit calls using 
	mono_llvm_emit_call () when compiling using LLVM.

	* mini-llvm.c: Implement support for passing/receiving valuetypes. Add
	comments to all functions. Fix memory leaks. Add a public init/cleanup
	function.

	* mini.c: Call the llvm init/cleanup functions in mini_init()/cleanup().

	* method-to-ir.c (handle_array_new): Disable llvm when calling the vararg
	mono_array_new_va () jit icall.
	
Fri Apr 24 16:44:08 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, genmdesc.c, genmdesc.pl: tiny refactor to allow
	multiple machine description files to be specified.
	* mini-ops.h: fixes for cross-compilation.

2009-04-22  Miguel de Icaza  <miguel@novell.com>

	* aot-runtime.c (make_writable): Use mono_mprotect to simplify
	some porting work.

2009-04-22  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Force init_locals to be TRUE
	to prevent asserts in various passes. Fixes #497220.

2009-04-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_generic_class_init_trampoline): Remove
	a racy assert.

	* aot-compiler.c aot-runtime.c: Emit the unwind info into a separate
	table to avoid duplicates.

	* mini.h (MONO_AOT_FILE_VERSION): Bump this.
	
	* aot-compiler.c (emit_method_code): Avoid writing symbols if the nodebug
	option is used.

2009-04-20 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mini_method_verify): Fail fulltrust code if the exception
	is for method or field access.

2009-04-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm-cpp.cpp (mono_llvm_dump_value): New helper function to print
	a Value to stdout.

	* mini-llvm.c (mono_llvm_emit_method): Use it.
	
	* mini-llvm.c (type_to_llvm_type): Fix the mapping of enums.
	(mono_llvm_emit_method): Add support for CAS. Fix handling of CSET opcodes
	on volatile values.

	* mini-trampolines.c (mono_llvm_vcall_trampoline): Add support for 
	synchronized methods.

	* mini.c (mini_method_compile): Disable LLVM for dynamic methods.

	* mini.c (mini_method_compile): Enable ABCREM when running with LLVM.

	* mini-llvm.c (mono_llvm_emit_method): Add support for OP_LOADI4_MEM/
	OP_LOADI8_MEM.

	* mini-llvm-cpp.cpp (mono_llvm_create_ee): Add a MONO_LLVM env variable
	allowing some options to be set dynamically.

2009-04-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Handle compares followed by an
	unconditional branch.

	* mini.h (MonoTrampolineType): Add new trampoline type 
	'MONO_TRAMPOLINE_LLVM_VCALL' which handles virtual calls made from LLVM
	compiled code.

	* mini-trampolines.c (mono_llvm_vcall_trampoline): New C trampoline 
	function.

	* mini-trampolines.c (mono_create_llvm_vcall_trampoline): New trampoline
	creation function.

	* mini.c (mini_init): Avoid using the common vtable trampoline when LLVM
	is enabled. Instead, use the llvm vcall trampoline.
	
	* mini-trampolines.c (mono_get_vcall_slot_addr): New helper function.

	* mini-trampolines.c tramp-amd64.c tramp-x86.c: Use it.
	
	* mini-<ARCH>.c: Get rid of the identical mono_arch_get_vcall_slot_addr ()
	functions.

	* mini-<ARCH>.h mini-trampolines.c mini.c: Get rid of 
	MONO_ARCH_COMMON_VTABLE_TRAMPOLINE, it is supported by all archs.

	* mini-ia64.c (mono_arch_lowering_pass): Null out the sregs of the
	OP_IA64_CSET opcode.

	* mini.c: Fix a warning.

	* mini-llvm.c (mono_llvm_emit_method): Convert arguments of SWITCH and
	THROW to the appropriate llvm type.

2009-04-18  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Add statistics for methods JITted
	with/without LLVM.

2009-04-17  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c: Fix the computation of ins_sreg_counts for ia64
	OP_IA64_CMP_<cond>_IMM opcodes.

2009-04-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (emit_cond_system_exception): Implement throwing of
	corlib exceptions.

	* dwarfwriter.c (mono_dwarf_writer_emit_method): Handle --regression
	correctly.

	* mini-llvm.c (type_to_llvm_type): Avoid accessing t->data.klass for
	GENERICINST.

2009-04-17  Atsushi Enomoto  <atsushi@ximian.com>

	* mini-exceptions.c : add thread id to EXCEPTION trace message.

2009-04-17  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_get_static_rgctx_trampoline): Fix AOT
	support.

	* tramp-x86.c (mono_arch_get_unbox_trampoline): Implement static
	rgctx invoke trampolines for x86.

	* mini-x86.c (mono_arch_output_basic_block): Add a few nops before
	indirect calls to simplify get_vcall_slot_addr (). Fixes #494567.
	(mono_arch_get_vcall_slot): Simplify this.

2009-04-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_get_delegate_invoke_impl): Move the calls to
	mono_debug_add_delegate_trampoline () to get_delegate_invoke_impl ().

2009-04-14  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c tramp-arm.c mini-arm.c: Implement static rgctx 
	trampolines for ARM. Add full-aot support for delegate invokes for ARM.

	* mini-trampolines.c (mono_magic_trampoline): Fix the build.

	* liveness.c (visit_bb): Remove a needless assert.

2009-04-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_create_delegate_trampoline): Delegate the
	full aot support to the arch specific code.

	* mini-amd64.c (mono_arch_get_delegate_invoke_impl): Add full-aot support.

	* aot-compiler.c (emit_trampolines): Emit delegate invoke impl trampolines.

	* aot-compiler.c (emit_named_code): Rename this to 'emit_trampoline'.
	
	* mini-amd64.c (mono_arch_get_delegate_invoke_impls): New function to
	collect information about the delegate invoke impl trampolines.

	* mini.h (MonoAotTrampInfo): New structure collecting the information needed
	to save trampolines during full-aot mode.

	* mini-trampolines.c (mono_create_static_rgctx_trampoline): New trampoline
	creation function which returns a trampoline which sets the rgctx
	argument.
	(mono_magic_trampoline): Use the rgctx trampoline instead of an rgctx
	wrapper if possible.
	(mono_delegate_trampoline): Ditto.

	* mini.c (mono_jit_runtime_invoke): Ditto.

	* tramp-amd64.c: Add an implemention of static rgctx trampolines for AMD64.
	
	* aot-compiler.c aot-runtime.c: Add support for static rgctx trampolines.

	* mini.h (MONO_AOT_FILE_VERSION): Bump this.
	
2009-04-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_lowering_pass): Use NULLIFY_INS instead of
	just setting the opcode to OP_NOP.

2009-04-11  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Put the last change inside an 
	#ifdef MONO_ARCH_HAVE_LIVERANGE_OPS.
	
	* mini.c (mini_method_compile): Disable sharing of stack slots/registers
	and extend live ranges to cover the whole method when using xdb.

	* jit-icalls.c (ldvirtfn_internal): Avoid creating rgctx wrappers here,
	do it in the trampolines.

	* mini-trampolines.c (mono_magic_trampoline): Add an rgctx wrapper if
	needed.

	* mini-trampolines.c (mono_delegate_trampoline): Ditto.
	
	* method-to-ir.c (mono_method_to_ir): Avoid using the fast virtual method
	call code in full-aot mode since IMT is disabled there.
	(mono_method_to_ir): Inline ldfld wrappers which return structures too, the
	new JIT no longer has that restriction.

	* mini.h (MONO_AOT_FILE_VERSION): Bump this.

	* aot-compiler.c (emit_extra_methods): Emit the wrapper method names in
	a more compact format.
	(mono_aot_wrapper_name): New function to return a unique name for a
	wrapper method, also used by the AOT runtime.

	* aot-runtime.c (find_extra_method_in_amodule): Update after the changes to
	aot-compiler.c.

	* aot-compiler.c (add_generic_class): Add the helper methods from T[]
	when a ICollection<T> etc is encountered.
	(add_generic_instances): Process method arguments/locals too.
	(emit_trampolines): Emit unbox trampolines for extra methods too. Shorten
	trampoline names.

	* aot-runtime.c (mono_aot_get_unbox_trampoline): Handle extra methods too.
	
2009-04-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Disable the AOT compiler if the JIT is disabled.

	* dwarfwriter.c (emit_type): Emit byref to reference types as 'int' for now.

	* decompose.c (mono_decompose_opcode): Make this return a MonoInst*
	representing the result of the decomposition. Nullify instructions
	instead of setting them to OP_NOP since nops can't have registers
	set.

2009-04-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_compile_assembly): Split this huge function into
	smaller parts. Add 'nodebug' option to prevent generation of DWARF debug
	info. Strip 'mapping symbols' on ARM.

	* iltests.il.in (test_0_fconv_to_i): Disable this on ARM too.
	
	* genmdesc.pl: Applied patch by Martin Fuzzey (mfuzzey@parkeon.com). Sync
	this with the native genmdesc.

2009-04-08  Bill Holmes  <billholmes54@gmail.com>

	* aot-runtime.c:  Fixing the MSVC build.

	Code is contributed under MIT/X11 license.

2009-04-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Pass i1/i2 arguments as i4 since 
	JITted code depends on it.

2009-04-08  Raja R Harinath  <harinath@hurrynot.org>

	* aot-compiler.c: Use new MonoGenericParam accessors.

2009-04-08  Raja R Harinath  <harinath@hurrynot.org>

	Reduce memory usage and improve correctness wrt MonoGenericParam
	* aot-runtime.c (decode_klass_ref): Simplify generic parameter
	handing.  Avoid allocating MonoGenericParams, but use the ones in
	the container itself.

2009-04-07  Miguel de Icaza  <miguel@novell.com>

	* tasklets.c: Return exceptions in the out argument.

2009-04-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Fix alignment in the LOCALLOC_IMM
	opcode. Use pointer types in more places instead of casting them to 
	integers.

	* mini-llvm-cpp.cpp (mono_llvm_create_ee): Create a pass manager to run
	optimizations.
	(mono_llvm_optimize_method): New helper function to optimize a method.

	* method-to-ir.c (mono_emit_widen_call_res): Extract the call result 
	widening code so it could be called from more places.
	(mono_method_to_ir): Call mono_emit_widne_call_res () in several more
	code paths in the call opcodes.

Mon Apr 6 14:19:54 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* exceptions-amd64.c, mini-amd64.h: amd64 support code for continuations.

2009-04-06  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c: Use _ to separate class name 
	components as gdb can't handle '.'. Represent reference variables
	as 'class <NAME>&'.
	
	* mini.h (MonoCompile): Add locals_min_stack_offset/locals_max_stack_offset.

	* mini-amd64.c (mono_arch_allocate_vars): Save min/max stack offset.
	
	* mini-gc.c: New file, contains the SGEN GC related parts of the JIT.

	* gc-test.cs: New file with GC stack marking tests.
	
	* mini-arm.c (mono_arch_output_basic_block): Fix int->float conversion of
	negative numbers for vfp.

	* basic-float.cs: Add a test.
	
Mon Apr 6 14:12:10 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* exceptions-x86.c, mini-x86.h: x86 support code for continuations.

Mon Apr 6 14:09:53 CEST 2009 Paolo Molaro <lupus@ximian.com>

	* tasklets.h, tasklets.c, mini.h, mini.c, Makefile.am: arch-indep
	part of tasklet/continuation support.

2009-04-05  Zoltan Varga  <vargaz@gmail.com>

	* mini-llvm.c (mono_llvm_emit_method): Move the handling of
	amd64 opcodes inside an ifdef.

	* dwarfwriter.c: Emit inheritance information for classes, emit fields
	of complex types.
	
	* dwarfwriter.c (emit_type): Emit the class info for classes.

2009-04-04  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (AM_CXXFLAGS): Add GLIB_CFLAGS to this.

	* mini-llvm-cpp.h: New header file for mini-llvm-cpp.cpp.

	* mini-llvm.c: Remove unused fields from EmitContext, fix memory leaks.

	* ssa.c (mono_ssa_compute): Fix some memory leaks.

2009-04-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c mini-amd64.c method-to-ir.c: Use COMPILE_LLVM in a few more places.

	* mini-llvm.c: Update comments.

	* mini.h (COMPILE_LLVM): New macro.

	* decompose.c (mono_decompose_opcode): Use the COMPILE_LLVM macro.

	* ssa.c (mono_ssa_compute): Ditto.
	
	* unwind.c (mono_unwind_get_ops_from_fde): New helper function to extract
	the unwind ops from a DWARF FDE.

	* mini-llvm.c: Implement generation of unwind info for LLVM compiled
	methods by extracting the dwarf unwind ops from the unwind info generated
	by LLVM.
	
	* mini-llvm.c (mono_llvm_emit_method): Enable support for non-IMT virtual
	calls.

	* mini-amd64.c (mono_arch_get_vcall_slot): Handle more kinds of the SIB
	addressing modes.

2009-04-02  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (llvm_sources): Enable this.

	* mini.c (mini_method_compile): Add support for compiling with LLVM, 
	failing back to the JIT if something cannot be handled.

	* mini-amd64.c (mono_arch_emit_call): Emit the arguments more simple when
	compiling with LLVM.

	* decompose.c (mono_decompose_opcode): Avoid decomposing some opcodes when
	compiling with LLVM.

	* method-to-ir.c (mono_method_to_ir): Avoid decomposing SWITCH when 
	compiling with LLVM.

	* mini-ops.h: Add a few opcodes needed by LLVM.

	* dwarfwriter.c (mono_dwarf_writer_emit_method): Avoid crashes if the method
	has no unwind info.

	* mini-llvm.c mini-llvm-cpp.cpp: New files containing the experimental llvm
	backend.

	* mini-arm.c (mono_arch_output_basic_block): Fix the ARM_FPU_NONE build.

	* mini-arm.h mini-arm.c cpu-arm.md: Finish VFP support.

2009-04-01  Mark Probst  <mark.probst@gmail.com>

	* regalloc.h, mini-codegen.c: Make vassign members gint32 to fix
	ridiculously large methods.

2009-03-31  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (debugger_remove_breakpoint): Call
	mono_debugger_remove_class_init_callback ().

2009-03-31  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_compile_assembly): Call img_writer_emit_start ()
	right before emitting code, not at the start.

	* mini.c (mono_postprocess_patches): Extract this into a separate function
	from mono_codegen ().

	* ssa.c (mono_ssa_compute): Set ins->klass for every PHI node, handle
	byref types correctly.

2009-03-30  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (mono_dwarf_writer_emit_method): Fix a crash introduced
	by the last change.

2009-03-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Emit a few nops before 
	indirect calls, this avoids problems where get_vcall_slot () would get
	confused by the native code for the instruction preceeding the call.
	(mono_arch_get_vcall_slot): Simplify this.
	(mono_arch_emit_imt_argument): Remove this, it is no longer needed.

	* mini-ops.h: Fix the definitions of the OP_IA64 opcodes, since the local
	register allocator now seems to depend on them instead of the data in
	cpu-<ARCH>.md.

	* mini.c (mini_method_compile): Throw the correct type of exception if
	mono_method_get_header () fails because of a loading error.

2009-03-28  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Clear the loader error if the method
	header cannot be decoded.

	* mini-trampolines.c (mono_magic_trampoline): Handle generic virtual 
	interface methods on proxies correctly.

	* dwarfwriter.c (mono_dwarf_writer_emit_method): Fix handling of the
	this argument for vtype methods. Add precise liveness info for arguments.

	* mini-codegen.c (mono_print_ins_index): Print the vreg of the
	LIVERANGE_START/END opcodes.

	* method-to-ir.c (mono_spill_global_vars): Fix liverange calculation
	for arguments and values in registers.

2009-03-27  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Disable tail calls for calls which
	return a valuetype. Fixes #487518.

	* iltests.il: Add a test.
	
	* aot-compiler.c: Use mono_thread_create () to create helper threads.

	* mini-trampolines.c (mono_delegate_trampoline): Handle static delegates
	closed over a null reference correctly.

2009-03-26  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_handle_global_vregs): Fix support for ternary ops.

2009-03-25  Mark Probst  <mark.probst@gmail.com>

	* mini-codegen.c (mono_local_regalloc): Don't let sregs get
	allocated to the same registers as fixed sregs.

2009-03-24  Mark Probst  <mark.probst@gmail.com>

	* mini-ops.h: New ternary ATOMIC_CAS ops replace the old
	ATOMIC_CAS_IMM ops.

	* method-to-ir.c: Handle more cases for
	Interlocked.CompareExchange.

	* cpu-x86.md, mini-x86.c, mini-x86.h, cpu-amd64.md, mini-amd64.c,
	mini-amd64.h, cpu-ppc.md, cpu-ppc64.md, mini-ppc.c, mini-ppc.h:
	ATOMIC_CAS implementations for x86, AMD64, PPC and PPC64.

2009-03-23  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (decode_method_ref): Fix a warning.

	* unwind.c (mono_unwind_frame): Ditto.	

2009-03-22  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (arch_emit_unbox_trampoline): Fix the binary writer support.
	(mono_compile_assembly): Enable the binary writer for full-aot as well.

	* image-writer.c (do_reloc): Add support for the JUMP24 relocation,
	fix the handling of large values in the ALU_PC_G0_NC relocation.

2009-03-22  Zoltan Varga  <vargaz@gmail.com>

	* local-propagation.c method-to-ir.c local-propagation.c: Fix warnings.

2009-03-22  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_spill_global_vars): Support for ternary
	ops.

2009-03-22  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: MINI_OP3 needs a comma.

	* method-to-ir.c, mini.h, mini.c: Remove
	mono_init_op_sreg_counts ().

2009-03-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_output_basic_block): Fix aot support in
	OP_JMP.
	
	* mini-arm.c (mono_arch_build_imt_thunk): Disable the !fail_tramp
	assertion.

	* mini-ops.h: Fix arguments of the MEMINDEX opcodes.

	* mini-amd64.c (mono_arch_build_imt_thunk): Simplify the fail handling
	code somewhat.

2009-03-21  Mark Probst  <mark.probst@gmail.com>

	* cfold.c, cprop.c, decompose.c, genmdesc.c, helpers.c, ir-emit.h,
	liveness.c, local-propagation.c, method-to-ir.c, mini-codegen.c,
	mini.c, mini.h, simd-intrinsics.c, ssa.c: Support for ternary IR
	operations.

2009-03-20  Zoltan Varga  <vargaz@gmail.com>

	* driver.c: Change location of gc_wrapper.h.

	* method-to-ir.c (mono_find_block_region): Handle try clauses nested
	inside finally clauses correctly. Fixes #485721.

	* mini.c (mono_find_spvar_for_region): This needs to handle try regions
	after the change above.

	* exceptions.cs: Add a test.
	
2009-03-19  Zoltan Varga  <vargaz@gmail.com>

	* unwind.c (mono_unwind_ops_encode): Increase the size of the encode buffer.

	* mini-amd64.c (mono_arch_emit_epilog): Remove the encoding of stack size
	into cfg->used_int_regs, it is not needed with the dwarf unwinder.
	(mono_arch_compute_omit_fp): Remove the emit_epilog () workaround.

	* mini-amd64.c (mono_arch_compute_omit_fp): Add another check to avoid hitting
	the stack_alloc_size < (1 << 16) assertion in emit_prolog ().

2009-03-19  Sebastien Pouliot  <sebastien@ximian.com>

	* method-to-ir.c: Allow CoreCLR to throw FieldAccessException. 
	Simplify logic for ensure_method_is_allowed_to_call_method. 
	Handle wrappers on callers.

2009-03-19  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (fullaotcheck): Don't run the generics tests, some of
	them don't run yet.

	* basic-simd.cs: Fix the names of some test methods.

2009-03-18  Geoff Norton  <gnorton@novell.com>

	* mini.c: Only chain sigfpe if it wasn't generated in mangaed code.

2009-03-18  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (token_handler): Fix a crash caused by the last change.

2009-03-17  Jb Evain  <jbevain@novell.com>

	* driver.c: remove now uneeded call to mono_gc_base_init before
	mono_profiler_load.

2009-03-17  Jb Evain  <jbevain@novell.com>

	* dwarfwriter.c (token_handler): handle more cases.

2009-03-17  Sebastien Pouliot  <sebastien@ximian.com> 

	* method-to-ir.c: Remove more dead code (that was required only
	because of method_is_safe). Fix compiler warnings.

2009-03-17  Sebastien Pouliot  <sebastien@ximian.com>

	* method-to-ir.c: Remove unneeded/useless method_is_safe
	http://lists.ximian.com/archives/public/mono-devel-list/2009-March/031404.html

2009-03-16 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mini_method_compile): Print the method been compiled with
	verbose level 1 instead of 3 as this helps a lot debugging JIT crashes
	for people not familiar with the runtime.

2009-03-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (get_generic_info_from_stack_frame): Avoid returning
	a managed object which is later put into a GList. Return its class instead.

	* mini.c (mono_allocate_stack_slots_full): Avoid sharing ref and non-ref
	stack slots when using sgen.

2009-03-16  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (emit_line_number_info): Really fix the eglib build.

2009-03-14  Zoltan Varga  <vargaz@gmail.com>

	* local-propagation.c (reg_is_softreg_no_fpstack): Use >= instead of
	> so it works on the first vreg as well.

2009-03-13  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (emit_line_number_info): Disable an assert which seems to
	trigger randomly.

	* aot-compiler.c: Get rid of xdebug_lock (), use the loader lock instead.
	
	* dwarfwriter.c (emit_line_number_info): Fix eglib build as eglib doesn't
	implement GArray.

2009-03-12  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (emit_line_number_info): Optimize the computation of the
	native->IL offset mapping.

2009-03-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Fix % 1. Fixes #484323.

	* basic.cs: Add a test.

2009-03-11  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.c (mono_arch_output_basic_block): Use different
	registers in case the ones we want to overwrite are used by the
	other operand.  Fixes regression in #480807.

2009-03-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_compile_assembly): Make the output less verbose.

	* dwarfwriter.c (emit_line_number_info): The line number info for
	IL code was off by one. Fix that.

	* mini-s390x.c: Fix support for vtypes whose addresses are passed on the
	stack.

2009-03-09  Mark Probst  <mark.probst@gmail.com>

	Contributed under the terms of the MIT/X11 license by Steven
	Munroe <munroesj@us.ibm.com>.

	* mini-ppc.c: Correct handling of OP_LOADI4_MEMINDEX for ppc64.
	Fixes #483462.

2009-03-08  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (token_handler): Decode method references in non-wrappers
	as well.

2009-03-06  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Check for type load exceptions in
	the delegate ctor handling code. Fixes #482638.
	
	* method-to-ir.c (mini_emit_memset): Fix the handling of size '3'. Fixes
	#481458.

	* iltests.il.in: Add a test.
	
	* mini-darwin.c (mono_chain_signal): Remove this, it is already in
	mini-posix.c.

2009-03-05  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c (mono_create_jump_trampoline): If the method
	is shared generic code, return the trampoline, even if the method
	has already been compiled.  Fixes #479763.

	* mini.c, mini.h: New function
	mono_jit_find_compiled_method_with_jit_info() which is the same as
	mono_jit_find_compiled_method() but also returns the jit info.

2009-03-05  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Only force the vtable var
	for methods which actually have one.  For all other methods, make
	sure the this argument var is live the whole method.

	* mini.c (mini_method_compile): Every shared method has a
	this/vtable/mrgctx info.  Fixes #480807.

2009-03-05  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (mono_arch_build_imt_thunk): Add support for mixed
	generic/imt thunks where some entries branch through the vtable,
	while other entries branch directly.

2009-03-05  Zoltan Varga  <vargaz@gmail.com>

	* mini-darwin.c (mono_chain_signal): Define this to fix the build.

	* mini-windows.c: Ditto.
	
	* mini.c (mono_jit_runtime_invoke): Speed up the invoking of parameterless
	ctors.

2009-03-04  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (emit_line_number_info): Add some debug code to help track
	down an assert.

2009-03-04  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Don't inline methods that use JMP.  Fixes
	#481403.

2009-03-04  Mark Probst  <mark.probst@gmail.com>

	* exceptions-x86.c: Include debug-mini.h - fixes build.

2009-03-04  Martin Baulig  <martin@ximian.com>

	* debug-mini.c: Clean up the exception API and add documentation.
	(mono_debugger_handle_exception): New public method; this is
	called when throwing an exception or encountering an unhandled one.
	(mono_debugger_call_exception_handler): Formerly known as
	mono_debugger_handle_exception(); this is used to tell the
	debugger that we're about to invoke an exception handler.

2009-03-04  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_debugger_runtime_invoke): Moved here from
	../metadata/mono-debug-debugger.c; save and reset exception state.

2009-03-02  Martin Baulig  <martin@ximian.com>

	* debug-mini.c: Moved the debugger exception handling here from
	../metadata/mono-debug-debugger.c.

	* debug-mini.h
	(MonoDebuggerExceptionAction): New exception typedef.

	* debug-mini.c
	(MonoDebuggerThreadInfo): Added `MonoObject *last_exception'.

	* exceptions-amd64.c
	(mono_amd64_throw_exception): Use the new debugger exception
	handling code.

	* mini-exceptions.c
	(mono_handle_exception_internal): Don't call
	mono_debugger_unhandled_exception() here.

2009-03-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c aot-compiler.c: Update after the changes to 
	mono_marshal_get_runtime_invoke ().

	* mini-trampolines.c (mono_convert_imt_slot_to_vtable_slot): 
	Virtual generic methods might not have method->slot set, work around
	that.

	* generics.cs: Add a test.

2009-03-02  Geoff Norton  <gnorton@novell.com>

	* mini.c:
	* driver.c: Allow signal chaining of SIGFPE as well.

2009-03-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_generic_virtual_remoting_trampoline): Update
	this since it now receives the method not its generic context in the
	IMT reg.

	* mini-amd64.c (mono_arch_build_imt_thunk): Add support for mixed
	generic/imt thunks where some entries branch through the vtable, while
	other entries branch directly.

	* mini-x86.c (mono_arch_build_imt_thunk): Ditto.

	* method-to-ir.c (mono_method_to_ir): Enable fast virtual generic call 
	support for interface methods as well.

	* mini-trampolines.c: Add support for virtual generic methods in interfaces
	using the normal IMT thunks.

	generics.cs: Add new tests.
	
	* method-to-ir.c (mono_method_to_ir): Pass the method instead of
	the generic inst to the generic imt thunks. This fixes AOT support, 
	improves consistency with the normal IMT thunks, and makes it easier to
	add support for interface generic virtual methods later.

	* mini-trampolines.c (mono_magic_trampoline): Ditto.	
	
2009-02-28  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_set_signal_chaining): New public API function to enable
	signal chaining on POSIX platforms.

	* mini-posix.c mini.c: Applied a variant of a patch by Simon Rowland 
	(si@lindenlab.com) to implement signal chaining. The original patch was
	contributed under the MIT X/11 license:
	https://bugzilla.novell.com/show_bug.cgi?id=318894

2009-02-27  Zoltan Varga  <vargaz@gmail.com>

	* iltests.il.in (test_0_implicit_float_to_double_conversion): Disable this
	too until it can be made to run on amd64.

2009-02-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_this_arg_from_call): Avoid expensive calls
	to  get_generic_context_from_code () + get_call_info () if possible.

2009-02-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_native_sigsegv): Implement the
	suspend-on-sigsegv functionality.

	* mini.c (mini_parse_debug_options): Add a new 'suspend-on-sigsegv' option
	to suspend when a native SIGSEGV is received. This is useful for debugging
	crashes which don't happen under gdb, since a live process contains more
	information than a core file.

	* mini-exceptions.c (mono_print_thread_dump): Use 
	MONO_ARCH_HAVE_SIGCTX_TO_MONOCTX instead of platform defines.

	* mini-x86.h (MONO_ARCH_HAVE_SIGCTX_TO_MONOCTX): New define.

	* mini-amd64.h (MONO_ARCH_HAVE_SIGCTX_TO_MONOCTX): Ditto.
	
	* basic-float.cs: Disable the tests which currently fail on amd64.

	* tramp-amd64.c (mono_arch_nullify_class_init_trampoline): Pass a non-null 
	value to mono_arch_patch_callsite () to fix crashes.
	
	* tramp-amd64.c (mono_arch_nullify_class_init_trampoline): Fix a warning.

2009-02-23  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_nullify_class_init_trampoline): Replace the
	nop code by patching the call address to point to the nullified class init
	trampoline, as the former does not seem to be safe on SMP machines.

2009-02-23  Mark Probst  <mark.probst@gmail.com>

	* mini-ops.h: Fix the argument types for a few x86 opcodes where
	they were wrong.

2009-02-23  Zoltan Varga  <vargaz@gmail.com>

	* basic-float.cs basic-calls.cs: Fix warnings.

2009-02-22  Mark Probst  <mark.probst@gmail.com>

	* tramp-ppc.c (mono_arch_create_trampoline_code): Store the
	correct frame pointer in the LMF.  Should fix #478394.

2009-02-22  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (fullaotcheck): Copy Mono.Simd.dll as well.

	* image-writer.c: Make the binary writer less verbose.

2009-02-21  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Don't assert if string ctors
	are called from runtime invoke wrappers.

2009-02-20  Zoltan Varga  <vargaz@gmail.com>

	* cpu-ppc.md (store_memindex): Increase the size of this.

2009-02-20 Rodrigo Kumpera  <rkumpera@novell.com>

	Extracted from a patch by Kornel Pal <kornelpal@gmail.com>.

	* cpu-x86.md: Fix the sizes for long_conv_to_r_un and long_conv_to_r_un_2.

	* mini-x86.c (mono_arch_output_basic_block): Use only 64bits of precision for
	OP_LCONV_TO_R_UN.

	Last fix for of #467201.


2009-02-20 Rodrigo Kumpera  <rkumpera@novell.com>

	Extracted from a patch by Kornel Pal <kornelpal@gmail.com>.

	* cpu-x86.md: Fix the sizes for fcall(_reg,_membase), long_conv_to_r4_2
	and long_conv_to_r8_2:

	Fixed part of #467201.

2009-02-20 Rodrigo Kumpera  <rkumpera@novell.com>

	Extracted from a patch by Kornel Pal <kornelpal@gmail.com>.

	* mini-x86.c (mono_arch_output_basic_block): Adjust precision of int to float
	conversion to 32 bits.

	* cpu-x86.md: Increase the size of int_conv_to_r4.

	* basic-float.cs: Add a test for this.

	Fixed part of #467201.

2009-02-20 Rodrigo Kumpera  <rkumpera@novell.com>

	Extracted from a patch by Kornel Pal <kornelpal@gmail.com>.

	* mini-x86.c (mono_arch_output_basic_block): Adjust precision of long to double
	conversion to 64 bits.

	* basic-float.cs: Add a test for this.

	Fixed part of #467201.

2009-02-20 Rodrigo Kumpera  <rkumpera@novell.com>

	Extracted from a patch by Kornel Pal <kornelpal@gmail.com>.

	* mini-x86.c (emit_move_return_value): Don't reduce precision of functions returning float.
	This behavior is compatible with MS.

	* iltest.il.in: Add a test for this.

	Fixed part of #467201.

2009-02-20 Rodrigo Kumpera  <rkumpera@novell.com>

	Extracted from a patch by Kornel Pal <kornelpal@gmail.com>.

	* mini-x86.c (mono_arch_output_basic_block): Implement OP_FCONV_TO_R4, it must
	change the precision of the value.

	* cpu-x86.md: Define len for float_conv_to_r4.

	* basic-float.cs: Add a test for this.

	Fixed part of #467201.

2009-02-19 Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c: Adjust locking order to the new semantics where the loader lock
	comes first.

2009-02-18  Rodrigo Kumpera  <rkumpera@novell.com>

	* aot-runtime.c:
	* mini-amd64.c:
	* mini-arm.c:
	* mini-ia64.c:
	* mini-mips.c:
	* mini-ppc.c:
	* mini-sparc.c:
	* mini-trampolines.c:
	* mini-x86.c:
	* mini.c:
	* tramp-alpha.c:
	* tramp-amd64.c:
	* tramp-arm.c:
	* tramp-hppa.c:
	* tramp-ia64.c:
	* tramp-mips.c:
	* tramp-ppc.c:
	* tramp-s390.c:
	* tramp-s390x.c:
	* tramp-sparc.c:
	* tramp-x86.c: Use mono_domain_code_* functions instead of using MonoDomain::code_mp directly.

2009-02-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_local_regalloc): Remove a ! from if (!dest_sreg1)
	as it is incorrect.

2009-02-17  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_class): Only add rgctx invoke wrappers
	for cctors if needed.

2009-02-17  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Fix build on Darwin.

2009-02-17  Zoltan Varga  <vargaz@gmail.com>

	* dwarfwriter.c (mono_dwarf_writer_emit_base_info): Use 2 as the DWARF
	version instead of 3 as valgrind doesn't like version 3.

	* mini.h (MONO_AOT_FILE_VERSION): Bump this.

	* aot-compiler.c (mono_aot_method_hash): New function to return a hash
	usable for hashing methods.
	(emit_extra_methods): Use the new hash to avoid putting every method in the
	same hash bucket.

	* aot-runtime.c (find_extra_method_in_amodule): Use the new hash.

	* aot-runtime.c (can_method_ref_match_method): New function to quickly check
	whenever a method ref could match a method.
	
	* aot-runtime.c (load_image): Revert the previous change, it causes an AOT
	test to fail.
	
	* aot-runtime.c (find_extra_method_in_amodule): Add a cache for decoded 
	methods refs.

	* aot-runtime.c (load_image): Pass our basedir to mono_assembly_load.

	* aot-compiler.c (emit_exception_debug_info): Bump the maximum size of
	the encoding buffer.

	* method-to-ir.c (mono_method_check_inlining): Avoid calling 
	mono_method_get_header () on inflated methods as an optimization.

2009-02-16  Zoltan Varga  <vargaz@gmail.com>

	* ssa.c (fold_ins): Fix another crash if the instruction following the
	switch was optimized away.

2009-02-16  Mark Probst  <mark.probst@gmail.com>

	Contributed under the terms of the MIT/X11 license by Steven
	Munroe <munroesj@us.ibm.com>.

	* mini-ppc.c, mini-ppc.h: Implement TLS for PPC64.

2009-02-16  Zoltan Varga  <vargaz@gmail.com>

	* mini.c method-to-ir.c mini-trampolines.c aot-runtime.c: Remove locking
	around the mono_domain_alloc calls, it is now done by the functions
	themselves.

	* aot-compiler.c (compile_method): Only add wrappers referenced by
	the method if compiling with full AOT.
	(mono_compile_assembly): Error out if --aot=full is specified on
	a platform where it is not supported.

	* aot-compiler.c (emit_trampolines): Emit generic class init trampolines
	on ARM too.

	* tramp-arm.c (mono_arch_create_generic_class_init_trampoline_full): Add
	AOT support.

	* aot-runtime.c (load_named_code): Handle 
	mono_arm_throw_exception_by_token.

	* mini-arm.h: Add declaration of mono_arm_throw_exception_by_token.

	* image-writer.c (asm_writer_emit_pointer_unaligned): Make this really
	unaligned.

	* Makefile.am (fullaotcheck): Exit if a test fails.

	* aot-compiler.c (mono_compile_assembly): Use the ASM writer for full aot
	on ARM.
	(mono_compile_assembly): Handle the assembler failing.

	* image-writer.c (asm_writer_emit_section_change): Handle ARM gas not
	accepting subsections of .bss.

	* ssa.c (visit_inst): Fix a crash if the instruction following a switch
	was optimized away.

	* aot-compiler.c: Remove some unused includes.
	
	* aot-compiler.c (MonoAotCompile): Remove some unused fields which are
	now in MonoImageWriter.

	* mini-x86.c (mono_arch_get_vcall_slot): Handle yet another
	code sequence which matches a non-virtual call. Fixes #472654.

2009-02-15  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Use xdebug_lock ()/unlock () macros for locking in the
	xdebug code.
	
	* aot-compiler.c: Make the xdebug code not depend on the AOT compiler,
	use the image/dwarf writers directly.

	* image-writer.c (struct _MonoImageWriter): Remove the unused 'image'
	field.

	* aot-compiler.c (MonoAotCompile): Remove fields which are now in
	MonoDwarfWriter.

	* image-writer.h: Fix some typos.

	* dwarfwriter.h dwarfwriter.c: New files.
	
	* aot-compiler.c: Extract the DWARF info writing functionality into a 
	separate module.

	* tramp-amd64.c (mono_arch_create_trampoline_code_full): Add a 'out_unwind_ops'
	argument to return unwind info.

	* tramp-arm.c (mono_arch_create_trampoline_code_full): Ditto.

	* aot-compiler.c: Emit unwind info for trampolines in full-aot mode.
	
	* aot-runtime.c (decode_method_ref): Add a case for 
	MONO_AOT_METHODREF_WRAPPER_NAME.

	* mini.h: Add constants for the magic numbers used in encode_method_ref ()
	for AOT.

	* aot-compiler.c (encode_method_ref): Use the new constants.

	* aot-runtime.c (decode_method_ref): Ditto.

	* aot-compiler.c (compile_method): For generic icalls, queue the wrapper to
	be compiled, not the icall itself.

2009-02-14  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (find_extra_method_in_amodule): Avoid decoding wrapper names
	using decode_method_ref ().

	* method-to-ir.c (mini_emit_ldelema_1_ins): If the array index is a long,
	convert it to an in32. Fixes #475859.

	* arrays.cs: Add a test.

2009-02-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390x.c (mono_arch_output_basic_block): Fix the shift amounts in 
	OP_LCONV_TO_U2.

	* basic-long.cs: Add a test.

2009-02-12  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.c, mini-x86.h: Very simple frame pointer removal.  We
	remove the frame pointer in leaf methods which don't receive any
	arguments, don't throw exceptions and don't do dynamic stack
	allocations.

2009-02-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_build_imt_thunk): Fix size calculation after
	the fail_tramp changes. Hopefully fixes #475132.

2009-02-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_emit_method_call_full): Use mono_metadata_signature_dup_mempool
	instead of mono_metadata_signature_dup_full.

2009-02-12  Zoltan Varga  <vargaz@gmail.com>

	* ssa.c (fold_ins): Use MONO_IS_JUMP_TABLE () and MONO_JUMP_TABLE_FROM_INS ()
	for processing jump tables. Fixes #473787.

2009-02-11  Mark Probst  <mark.probst@gmail.com>

	* mini-generic-sharing.c: mini_method_get_context() just calls
	mono_method_get_context_general() now.

	* mini.c, mini.h: Moved get_object_generic_inst(),
	construct_object_context_for_method() and
	mono_domain_lookup_shared_generic() to metadata/generic-sharing.c.

2009-02-11  Zoltan Varga  <vargaz@gmail.com>

	* branch-opts.c (mono_if_conversion): Handle the case where the merged 
	basic block fell through to its successor bblock without a branch. Fixes
	#474718.

	* iltests.il.in: Add a test.
	
	* aot-compiler.c (encode_method_ref): Encode methods of array types.
	(can_encode_patch): We can now handle arrays of generic parameters and
	array methods.

	* aot-runtime.c (decode_method_ref_2): Handle methods of array types.

	* aot-compiler.c aot-runtime.c: Emit the size of specific trampolines into
	the AOT file to avoid some #ifdefs in aot-runtime.c

	* mini.h: Bump AOT file format version.

2009-02-10  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (fullaotcheck): Make this run the tests.

	* aot-compiler.c: Make the printing of skipped methods runtime configurable.

2009-02-10  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.c (mono_arch_context_get_int_reg): Handle all registers
	individually.  Fixes #473482.

2009-02-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_output_basic_block): Disable AOT for OP_JMP.

2009-02-09  Jeffrey Stedfast  <fejj@novell.com>

	* aot-compiler.c (arch_emit_plt_entry): Fixed to compile.
	(mono_compile_assembly): Hush compile warnings about
	uninitialized [tmp_]outfile_name variables in the !use_bin_writer
	code path.

2009-02-10  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-arm.c (mono_arch_find_jit_info): Fix aot support.

	* mini-arm.c: Checkin unwind related changes missing from an earlier commit.

	* aot-compiler.c: Fix arm support.

	* image-writer.c: Move the R_ARM constants to image-writer.h. Export a
	img_writer_emit_unset_mode () function.

	* unwind.c (mono_unwind_get_dwarf_data_align): New helper function.
	(mono_unwind_get_dwarf_pc_reg): Ditto.

	* aot-compiler.c (emit_dwarf_abbrev): Another large reorganization.
	Move almost all platform specific code to a set of arch_ functions, 
	and document them to ease porting.
	
	* aot-compiler.c (mono_xdebug_init): Fix xdebug support.

	* image-writer.h image-writer.c: New files, extracted from aot-compiler.c.

	* aot-compiler.c: Extract the image writing functionality into a separate
	module to reduce the size of this file.

2009-02-09  Geoff Norton  <gnorton@novell.com>

	* mini-s390.c: Fix the signature of emit_sig_cookie.

2009-02-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (is_shared_got_patch): Add MONO_PATCH_INFO_IMAGE.

	* aot-runtime.c (is_shared_got_patch): Ditto.

	* aot-runtime.c (load_named_code): Cope with the fact that 
	decode_got_entry () won't decode the patch fully if its corresponding got
	entry is already filled.
	
	* tramp-amd64.c (mono_arch_create_monitor_enter_trampoline_full): 
	Initialize *ji.
	(mono_arch_create_monitor_exit_trampoline_full): Ditto.

	* tramp-amd64.c (mono_arch_create_monitor_enter_trampoline_full): Use 'code'
	as the moving pointer instead of 'buf' for consistency with the rest of the
	codebase.
	(mono_arch_create_monitor_exit_trampoline): Ditto.

	* aot-compiler.c (emit_trampolines): Add throw_pending_exception/
	generic_class_init trampolines.
	(add_generic_class): Extract some code from add_generic_instances () into a
	separate function so it can be called from other places too.
	(compile_method): Call add_generic_class () for the classes of inflated methods
	referenced by the method.
	(can_encode_patch): Allow references to generic parameters.

	* aot-runtime.c: Add support the patches required by the new trampolines.
	
	* exceptions-amd64.c (mono_arch_get_throw_pending_exception_full): Add full-aot
	support.

	* tramp-amd64.c (mono_arch_create_generic_class_init_trampoline_full): Add
	full-aot support.

	* exceptions-amd64.c (mono_arch_get_throw_pending_exception_full): Rename
	this from get_throw_pending_exception, make the signature full aot compatible.

	* Makefile.am (fullaotcheck): New target to run full-aot tests.

	* method-to-ir.c (inline_method): Save/Restore cfg->ret_var_set too.

	* exceptions.cs: Add a test.

2009-02-07  Zoltan Varga  <vargaz@gmail.com>

	* unwind.c (mono_unwind_frame): Eliminate the data_align_factor argument,
	use the DWARF_DATA_ALIGN constant instead.

	* exception-<ARCH>.c: Update after the above change.

	* exceptions-arm.c (mono_arch_find_jit_info): Transition this to use the
	dwarf unwinder.

	* mini-arm.c: Enable the dwarf unwinder.

	* mini-trampolines.c (mono_magic_trampoline): Use mono_class_get_vtable_entry ()
	instead of mono_class_setup_vtable ().

2009-02-07  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (mono_arch_find_jit_info): Transition this to use the
	dwarf unwinder.

	* mini-x86.h: Enable the dwarf unwinder.

2009-02-06  Raja R Harinath  <harinath@hurrynot.org>

	Fix mcs/tests/test-7.cs
	* mini-amd64.c (mono_arch_allocate_vars): Revert change from
	2009-02-03.

2009-02-06  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (print_jit_stats): Remove some unused statistics.

2009-02-05  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_klass_info): Update after MonoClass changes.

2009-02-05  Mark Probst  <mark.probst@gmail.com>

	* jit-icalls.c (mono_helper_compile_generic_method): Don't inflate
	the method we get from mono_object_get_virtual_method() because
	that function does it properly, now.

2009-02-05  Zoltan Varga  <vargaz@gmail.com>

	* unwind.c (mono_unwind_ops_encode): Handle offsets greater than 32 between
	opcodes. Fixes #472775.

2009-02-05  Mark Probst  <mark.probst@gmail.com>

	* mini-exceptions.c (ves_icall_get_frame_info): Account for the
	fact that mono_find_jit_info() sometimes returns the context
	corresponding to the jit info in new_ctx.  Fixes #472600.

2009-02-05  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c mini-hppa.c mini.c trace.c mini-s390x.c aot-compiler.c
	mini-s390.c: Use mono_class_enum_basetype () instead of accessing
	klass->enum_basetype directly.

	* aot-compiler.c (emit_class_dwarf_info): Add support for all possible
	enum subtypes.

	* unwind.c: Avoid 0 sized arrays.

2009-02-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_setup_altstack): Use a more reasonable altstack
	size on systems with 64k pages. Fixes #471389.

2009-02-04  Mark Probst  <mark.probst@gmail.com>

	Contributed under the terms of the MIT/X11 license by Steven
	Munroe <munroesj@us.ibm.com>.

	* mini-ppc.c (mono_arch_output_basic_block): Generate better code
	for LOADI4_MEMBASE.  Use addi instead of addic if it's not
	necessary.

2009-02-04  Mark Probst  <mark.probst@gmail.com>

	Contributed under the terms of the MIT/X11 license by Steven
	Munroe <munroesj@us.ibm.com>.

	* exceptions-ppc.c (mono_arch_get_restore_context): Code size
	comparison fix.

	* tramp-ppc.c (mono_arch_create_generic_class_init_trampoline):
	The trampoline can be longer on PPC64.

2009-02-04  Mark Probst  <mark.probst@gmail.com>

	Contributed under the terms of the MIT/X11 license by Steven
	Munroe <munroesj@us.ibm.com>.

	* mini-ppc.c: Compiler warning fixes and trivial code
	simplifications.

2009-02-04  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_spill_global_vars): Fix problems caused by reading
	ins->dreg which could be a hardware register, not a vreg.

	* aot-compiler.c (emit_method_dwarf_info): Ditto.
	
	* mini.h (MonoCompile): Remove vreg_to_var_num array, it is no longer used.
	(struct MonoMethodVar): Add a vreg field, holding the vreg of variable.

	* mini.c (mono_compile_create_var_for_vreg): Set var->vreg.
	
	* mini-amd64.c (mono_arch_output_basic_block): Avoid reading cfg->varinfo[..]
	->dreg, that is not the vreg we are looking for.

	* mini-amd64.h mini-x86.h: Enable MONO_ARCH_LIVENESS_OPS again.

	* mini-x86.c (mono_arch_output_basic_block): Add support for LIVERANGE_START/
	LIVERANGE_END.

	* method-to-ir.c (mono_spill_global_vars): Add an assert to help track down
	strange crashes.

2009-02-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_prolog): Emit unwind info.

	* aot-compiler.c (emit_line_number_info): Fix line number emission when
	the line diff is 0.

	* aot-compiler.c: Add xdebug support on x86.

	* unwind.c: Add x86 support.
	
	* aot-compiler.c (emit_exception_debug_info): Control the emission of
	unwind info using a new MONO_ARCH_HAVE_XP_UNWIND define.

	* mini.c (mini_method_compile): Ditto.
	
	* mini-amd64.c (mono_arch_allocate_vars): Avoid setting cfg->ret->dreg to
	the variable index.

	* aot-compiler.c: Add emit_push_section ()/emit_pop_section () helper functions
	which mimic .push_section/.pop_section in GAS.
	
	* aot-compiler.c: Emit precise live range information for variables.

	* mini-amd64.c (mono_arch_output_basic_block): Add OP_LIVERANGE_START/END.

	* method-to-ir.c (mono_spill_global_vars): Compute the instructions marking
	the live ranges of variables, and emit OP_LIVERANGE_START/END opcodes for
	them.

	* mini-ops.h: Add OP_LIVERANGE_START/END opcodes to mark
	the live ranges of variables.

	* mini.h (struct MonoMethodVar): Add two fields containing the live range
	of the variable in terms of native offsets.

2009-02-03  Rodrigo Kumpera  <rkumpera@novell.com>

	* arrays.cs: Test for Get/SetValue of array with negate lower bounds.
	
2009-02-02  Mark Probst  <mark.probst@gmail.com>

	Contributed under the terms of the MIT/X11 license by Steven
	Munroe <munroesj@us.ibm.com>.

	* exceptions-ppc.c (restore_regs_from_context): Correct operand
	order (offset then base reg) for ppc_load_multiple_regs.
	(emit_save_saved_regs) Correct operand order for
	ppc_store_multiple_regs.
	(mono_arch_get_call_filter): Correct operand order for
	ppc_load_multiple_regs.

	* mini-ppc.c (emit_memcpy): Fix operand order for
	ppc_load_reg_update and ppc_store_reg_update.
	(mono_arch_output_basic_block): Correct operand order for ppc_lha.
	(mono_arch_emit_epilog): Correct operand order for
	ppc_load_multiple_regs.

	* tramp-ppc.c (mono_arch_create_trampoline_code): Correct operand
	order for ppc_store_multiple_regs and ppc_load_multiple_regs.

2009-02-02  Mark Probst  <mark.probst@gmail.com>

	* cpu-ppc64.md: Fixed storer4_memindex length.

2009-02-02  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_line_number_info): Optimize the size of the emitted
	line number info.
	
	* aot-compiler.c (emit_line_number_info): Optimize this.

2009-02-01  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Disassemble tokens in the IL disassembly.
	
	* aot-compiler.c: Add debug info for methods without debug info by
	emitting an IL file and having the line number info referencing that file.

	* aot-compiler.c: Optimize the size of the generated line number info.

	* aot-compiler.c: Emit line number info in xdebug mode.

	* aot-compiler.c (mono_save_xdebug_info): Receive a MonoCompile instead of a
	million arguments.

2009-01-31  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_method_dwarf_info): Emit names for local variables.

	* driver.c (mono_main): Enable debugging support automatically if XDEBUG
	is used.

2009-01-31  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-calls.cs: Test for the weird crash found on arm.
	
2009-01-31  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-arm.md: Increase the size of storer8_membase_reg and
	loadr8_membase_reg to 24 bytes to accomodate the extra add.

	* mini-arm.c (mono_arch_output_basic_block): Under FPA, when emitting
	OP_STORER8_MEMBASE_REG and OP_LOADR8_MEMBASE_REG, add the original
	reg to LR otherwise we'll be loading/storing from just the offset.

2009-01-30  Miguel de Icaza  <miguel@novell.com>

	Question: if we are storing gint32's inside the "*native_offset",
	should we change the signature to "gint32 *native_offset" to
	ensure that we do not have type definition problems?
	
	* mini-exceptions.c (ves_icall_get_frame_info): Cast the gint32 to
	an int * as this is what the other function expects, causes
	problems with Freescale's compiler that defined int32_t to be a
	long and makes int incompatible 

2009-01-30  Miguel de Icaza  <miguel@novell.com>

	* Rename generic-sharing.c to mini-generic-sharing.c to avoid the
	filename conflict with bjam.

2009-01-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-arm.md: Increase the size of storer8_membase_reg to 20 bytes
	as it might use decomposed ops.

2009-01-30  Zoltan Varga  <vargaz@gmail.com>

	* jit-icalls.c (mono_imul_ovf): Fix one of the literals.

	* mini.c (mini_init): Emulate mul.ovf opcodes if MONO_ARCH_EMULATE_MUL_OVF
	is defined.

	* mini-arm.h (MONO_ARCH_EMULATE_MUL_OVF): New define.

	* mini-arm.c (mono_arch_build_imt_thunk): Rewrite this to allow large vtable
	offsets.

	* mini-arm.c (mono_arch_context_get_int_reg): Adapt this to the "clever"
	way registers are stored in MonoContext on arm.

	* unwind.c: Rewrite the handling of the cached_info array to use hazard pointers
	instead of locking so mono_get_cached_unwind_info () becomes signal safe.

	* mini.c (mini_init): Emuate OP_FCONV_TO_I when using soft float.

	* mini-arm.c (emit_load_volatile_arguments): Avoid an unneccesary assert.

	* mini.c (mini_init): Register mono_isfinite.

	* jit-icalls.c (mono_isfinite): New jit icall.

	* method-to-ir.c (mono_decompose_soft_float): Add support for OP_CKFINITE.
	
	* exceptions-arm.c (mono_arch_find_jit_info): When unwinding using the LMF,
	set esp to ARMREG_FP instead of R12, since R12 stores the value of sp for
	the parent frame.

2009-01-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* exceptions-arm.c (mono_arch_find_jit_info): The frame layout on arm have
	separate frame and stack pointers, so we must use FP to find the register
	spill area.
	The FP reg is retrieved from the MonoContext::regs array.

2009-01-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-arm.c (mono_arch_output_basic_block): Emit two cond ops for OP_FBGE
	as FPA requires it.

2009-01-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-arm.c (mono_arch_emit_setret): Emit OP_FMOVE for methods that
	return R4 and R8 when not running under softfloat.

	Fixes basic-calls.exe

2009-01-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c: Implement some overflow opcodes.

2009-01-29  Miguel de Icaza  <miguel@novell.com>

	* ssa.c: handle another alloca.h

	* mini-exceptions.c (mono_handle_native_sigsegv): Do not use
	PLATFORM_WIN32 for detecting if we have sigaction.   Instead use
	MONO_ARCH_USE_SIGACTION. 

	* aot-runtime.c, mini-exceptions.c: Replace platform define with
	capability defines.

	* method-to-ir.c (mono_method_to_ir): Type cast fix on some platforms.

	* mini-ppc.h (MONO_ARCH_USE_SIGACTION): Do not define this for all
	PPC targets as sigaction does not exist on all platforms, define
	this on a per-platform basis.

	Instead of erroring out if the platform is not defined, include
	mini-ppc-os.h, and expect that the OS specific setting provides
	the required information.   

2009-01-30  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Fix --enable-minimal=aot.

2009-01-30  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-arm.c (mono_arch_get_throw_exception_generic): Fix the
	previous change.

2009-01-29  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-arm.c: Fix warnings.

	* tramp-arm.c aot-compiler.c unwind.h unwind.c: Implement xdebug support for
	ARM.

	* mini-x86.c: Fix --enable-minimal=jit build.

	* mini.c: Really fix --enable-minimal=jit build.
	
	* mini.c (construct_object_context_for_method): Move this outside
	the DISABLE_JIT block to fix the --enable-minimal=jit build.

	"Backported" of r124984 from 2.0 branch.
	
	* aot-compiler.c aot-runtime.c: Add full-aot support delegate BeginInvoke/EndInvoke.

	"Backport" of r124977 + r124978 from 2.0 branch.
	
	* exceptions-arm.c (mono_arm_throw_exception_by_token): New helper function
	to avoid calling mono_exception_from_token () from the throw trampoline.
	(mono_arch_get_throw_exception_generic): call throw_exception_by_token
	for throwing corlib exceptions, this fixes full-aot support for corlib
	exceptions.

	* aot-compiler.c (compile_method): Make a copy of cfg->locals to fix the build.

2009-01-29  Miguel de Icaza  <miguel@novell.com>

	* mini-darwin.c, mini-windows.c, mini-posix.c: Commit the first
	part of the changes to split the code in mini into operating
	system specific files.

	This patch was done by copying mini.c to the respective files to
	preserve SVN history.

2009-01-29  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_method_dwarf_info): Add minimal support for locals.

2009-01-28  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Avoid generic sharing for calls made to
	remoting-invoke-with-check wrappers of shared methods.

	* mini.c (print_jit_stats): Print out major gc count/time for libgc too.

2009-01-27  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (emit_stloc_ir): Only apply the reg-reg move
	optimization if the top of stack is the last instruction in the
	bblock.  Otherwise it might have been used after its definition.
	Fixes #469742.

2009-01-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): Print out the caller
	method as well when get_vcall_slot () fails to match a code sequence.

	* mini-arm.c: Fix the android build, which doesn't have
	__aeabi_read_tp.

2009-01-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390x.c: Remove a stray declaration of emit_sig_cookie () to fix
	the s390x build.

2009-01-26  Rodrigo Kumpera  <rkumpera@novell.com>

	* unwind.c (mono_unwind_cleanup): Don't crash if cached_info is NULL.

2009-01-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Save the unwind info generated by the JIT
	and put its id into jinfo->used_regs. This is only used on amd64,
	which is currently the only platform generating unwind info.

	* exceptions-amd64.c: Instead of unwinding based on a register mask, use
	the dwarf unwinder. This is required to correctly handle async exceptions
	like thread abort and stack overflows, which can happen while a method
	is in the middle of its prolog or epilog.
	
	* aot-runtime.c (mono_aot_get_unwind_info): New helper function to obtain
	the unwind info belonging to an AOTed method.

	* aot-compiler.c aot-runtime.c: Save/Load the unwind info emitted by the JIT
	into cfg->unwind_ops.
	
	* unwind.c (mono_unwind_frame): Use <= instead of < for the loop exit check.

	* mini.c (mini_init): Call mono_unwind_init ().
	(mini_cleanup): Call mono_unwind_cleanup ().

	* unwind.c: Add functions for managing a set of unwind info entries, allowing
	unwind info to be shared between methods.

	* mini-amd64.c (mono_arch_emit_prolog): Emit unwind info for the registers
	saved in the LMF.

	* exceptions-amd64.c (mono_arch_exceptions_init): Call 
	get_throw_pending_exception () to avoid initialization races.

	* mini-exceptions.c (mono_exceptions_init): Call an arch specific
	mono_arch_exceptions_init () function.

	* mini.h (MONO_INST_NEW): Remove duplicate setting of cil_code.

2009-01-25  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_get_domain_intrinsic): New helper function.
	(mono_get_thread_intrinsic): Ditto.

	* mini-arm.c mini-ia64.c: Use the new helper functions.
	
	* method-to-ir.c (mono_method_to_ir): Fix the comment for
	the last constrained_call change, since it is needed in the non-AOT
	case as well.

	* mini-arm.c: Implement OP_TLS_GET on arm eabi linux.
	
	* mini-arm.c (mono_arch_emit_prolog): Add an inlined version of 
	mono_get_lmf_addr () on arm eabi linux.

2009-01-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_get_vcall_slot): Handle yet another
	code sequence which matches a non-virtual call.

2009-01-23  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (mono_arch_context_get_int_reg): Allow access to the
	stack pointer (r1).

2009-01-23  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Treat delegate-invoke wrappers similarly to
	runtime-invoke wrappers, since they are also shared based on signature.

2009-01-22  Mark Probst  <mark.probst@gmail.com>

	* mini-exceptions.c (ves_icall_get_frame_info): Fetch the generic
	info from the (correct) context.

2009-01-22  Zoltan Varga  <vargaz@gmail.com>

	* unwind.c (mono_unwind_frame): Remove a stray g_free ().
	
	* unwind.c (mono_unwind_frame): New function to unwind through a frame
	using dwarf unwinding info. Not yet used.

	* mini.c (mini_init): When using xdebug, disable freeing of domains.

2009-01-21  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (mono_arch_delegate_invoke_impl): Return function
	descriptors.

	* mini-trampolines.c (mono_delegate_trampoline): Remove the PPC64
	special case and handle mono_arch_delegate_invoke_impl() returning
	function descriptors.

	* tramp-ppc.c (mono_arch_create_trampoline_code): Delegate
	trampolines return function descriptors, too.

2009-01-21  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (handle_alloc): Avoid generic instances in the
	out_of_line optimization.

2009-01-21  Martin Baulig  <martin@ximian.com>

	* mini.h
	(MonoCompile): Added `disable_deadce_vars' to disable removing
	unused variables.

	* mini.c
	(mini_method_compile): Set `cfg->disable_deadce_vars' when running
	inside the debugger.

	* liveness.c (mono_analyze_liveness): Don't remove any unused
	variables if `cfg->disable_deadce_vars' is set.

2009-01-21  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Only apply exception constructor optimization if
	the the method actually belongs to an exception class.  Fixes
	#467456.

2009-01-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline): Put back the previous
	change inside a #ifdef __mono_ppc64__.

	* aot-compiler.c (compile_method): Remove the previous limitation.

	* method-to-ir.c (method-to-ir.c): Add support for the constrained prefix
	on type variables in AOTed code.
	
	* aot-compiler.c (compile_method): Skip generic methods having type 
	constraints on their generic parameters.

	* aot-compiler.c (compile_method): Check for methods which cannot be
	encoded inside RGCTX_FETCH patches as well.

	* mini-exceptions.c (mono_print_thread_dump): Fix the windows
	build.

2009-01-20  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Force the vtable variable in shared generic code
	for the case that they might show up on a stack trace where they
	are needed.

	* mini-exceptions.c: Save and use generic sharing info as well as
	IP in stack traces to resolve shared generic instantiations.

2009-01-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline): Revert the change which
	added a mono_get_addr_from_ftnptr () as it breaks the ia64 build.

2009-01-20  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Do generic sharing for array constructors.

2009-01-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-exceptions.c (mono_print_thread_dump): Add information
	about the thread state using wapi_current_thread_desc.

2009-01-19  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for the new constructors. 

2009-01-19  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_EXPAND_*

	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.
	
	* simd-intrinsics.c (simd_intrinsic_emit_setter): Add support for single element constructors.

2009-01-19  Zoltan Varga  <vargaz@gmail.com>

	* iltests.il.in: Add a test for #467385.

2009-01-18  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mini_thread_cleanup): Don't cleanup TLS storage if the
	thread been cleaned up is not the same currently in execution.

	Fixes appdomain-unload crashes on windows, osx and linux variants
	without the __thread keyword.

2009-01-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_flush_icache): Applied patch from Koushik Dutta
	(koush@koushikdutta.com). Implement this for android.

	* helpers.c (mono_disassemble_code): Avoid assembler errors if the id
	begins with a digit.

	* method-to-ir.c: Call mono_gc_get_write_barrier () instead of
	mono_marshal_get_write_barrier ().

2009-01-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* decompose.c (mono_decompose_vtype_opts): Fix the decomposition
	of OP_VCALL_* ops for 8 bytes vtypes on 32 bits archs and platorms
	that pass them on a register pair.

	This affects windows, OSX and FreeBSD. The mono/tests/handleref.exe
	test was crashing due to that.

Fri Jan 16 15:21:21 CET 2009 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: tweaks from malc (OV-Soft) to fix the size of the
	trampoline code. Include ucontext.h only if available.

2009-01-15  Mark Probst  <mark.probst@gmail.com>

	* mini.c: mono_domain_lookup_shared_generic() takes an open method
	and doesn't check whether it's sharable, like it was before
	removing the shared generics hash.  This brings IronPython
	performance back to what it was before that change.

2009-01-14  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Handle delegate invocation optimization earlier,
	otherwise it would be handled (much more slowly) by the
	final/sealed optimization.

2009-01-13  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (SIG_HANDLER_SIGNATURE): Avoid crashes when the current thread or
	domain is not set. Fixes #465864.

2009-01-12  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Don't stop sharing of generic methods with catch
	clauses - we already handle those.

2009-01-12  Mark Probst  <mark.probst@gmail.com>

	* mini.c, mini.h: lookup_generic_method() is now
	mono_domain_lookup_shared_generic() and uses the jit_code_hash,
	making the shared_generics_hash obsolete.

2009-01-12  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c, exceptions-ppc.c, cpu-ppc.md, cpu-ppc64.md: Don't
	use the red zone.  Make room on the stack first and then use it,
	not the other way around.

2009-01-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Call mono_xdebug_init ().

	* aot-compiler.c (mono_xdebug_init): Make this non-static.

2009-01-11  Zoltan Varga  <vargaz@gmail.com>

	* TestDriver.cs: Add an --iter argument to run tests multiple times.

	* tramp-amd64.c (mono_arch_create_trampoline_code_full): Emit debug info for
	trampolines.

	* aot-compiler.c (mono_save_trampoline_xdebug_info): New function to emit
	debug+unwind info for trampolines.

	* mini.c (mono_create_unwind_op): New helper function.

	* unwind.h: Add macros for emitting unwind ops without a MonoCompile.

2009-01-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Fix the build.

2009-01-09  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am: Update dtrace-prelink.sh location.

2009-01-08  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Fix the check for the mscorlib ldstr 
	optimization. Fixes #464520.

2009-01-07  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c : Adding code to save/restore non-volatile registers
	   on Winx64.

	* exceptions-amd64.c : Adding code to save/restore non-volatile 
	  registers on Winx64.

	Contributed under MIT/X11 license.

2009-01-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_flush_icache): Use __GNUC_PREREQ instead of checking
	__GNUC_MINOR__ which can break when the major version changes.

2009-01-07  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for usage of the sizeof opcode.

2009-01-07  Geoff Norton  <gnorton@novell.com>

	* helpers.c:  Allow mono -v -v -v to work on darwin.

2009-01-05  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (mono_arch_get_vcall_slot) : Handle an additional instruction
	  pattern. 

	Contributed under MIT/X11 license.

2009-01-05  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_allocate_stack_slots_full2): Use mono_class_from_mono_type
	instead of directly accessing type->data.klass. Fixes #462016.
	(mono_allocate_stack_slots_full): Ditto.

	* mini-arm.c (mono_arch_flush_icache): Applied patch from Riku Voipio 
	<novell@kos.to>. Fix cache flush on kernels without OLDABI compat option.

	* aot-compiler.c (emit_plt): Fix ARM build.

2009-01-04  Zoltan Varga  <vargaz@gmail.com>

	* branch-opts.c (mono_if_conversion): Optimize this using ins->prev.
	
	* branch-opts.c (mono_if_conversion): Fix an assert introduced by the last
	change.

	* branch-opts.c (mono_if_conversion): Use branch->inst_true_bb/inst_false_bb
	instead of bblock->out_bb [0]/[1], the two might not be the same. Fixes
	#463357.

	* iltests.il.in: Add a regression test.

2009-01-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c (mono_print_ins_index): Pretty print XPHI and VPHI.

2009-01-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add a regression test for #462457.

2009-01-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add a definition of XPHI.

	* mini.h (MONO_IS_PHI): Make is aware of simd instrincs. 

	* ssa.c (op_phi_to_move): Handle XPHI.

	* ssa.c (mono_ssa_compute): Generate a XPHI for simd intrinsics instead of VPHI.

	Fixes #462457

2009-01-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_emit_rgctx_calli): Fix a warning.

2008-12-31  Geoff Norton  <gnorton@novell.com>

	* mini-ppc.c: The prolog size allocated can be too small for darwin
	ppc32 under certain circumstances.  Also fix a small logic bug.

2008-12-29  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Avoid holding the domain lock
	while loading AOT methods.

	* mini-exceptions.c: Check jit_tls->class_cast_from instead of class_cast_to
	since only the former is nulled out after a successful cast. This prevents
	crashes with rethrown exceptions when using --debug=casts.

2008-12-24  Mark Probst  <mark.probst@gmail.com>

	* mini.h: New macro for checking whether a method is final,
	i.e. whether the method or its class is marked final.

	* method-to-ir.c: Use the new macro for all final-checks
	consistently.  Fixes the crash in the System.ServiceModel tests.

2008-12-23  Mark Probst  <mark.probst@gmail.com>

	* mini-exceptions.c (get_exception_catch_class): Corrected another
	overly strict assertion.

2008-12-23  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (mono_arch_build_imt_thunk): Save and restore r11.
	Clobbering it is not allowed because the caller might use it as
	the vtable register in the interface call.

2008-12-19  Mark Probst  <mark.probst@gmail.com>

	* mini-exceptions.c (get_exception_catch_class): Corrected an
	overly strict assertion.

2008-12-18  Mark Mason	<mmason@upwardaccess.com>
	
	* method-to-ir.c: use SIZEOF_REGISTER instead of SIZEOF_VOID_P or sizeof(gpointer) when appropriate.

	* mini.h: Move typedef to mgreg_t up above include of mini-arch.h

	* local-propogation.c: use SIZEOF_REGISTER instead of SIZEOF_VOID_P when appropriate

	* cpu-mips.md: correct lengths for certain long_ opcodes.

	* mini-mips.h: Only emulate long operations when SIZEOF_REGISTER==4. Add missing func decl.

	* mini-mips.c: Add support for more long operations. Fix issues with stack frame layout for n32 (still not perfect yet). Add mips_emit_load_const().
	
2008-12-17  Mark Mason	<mmason@upwardaccess.com>

	* exceptions-mips.c (mono_arch_find_jit_info): decode sd instructions as well when looking for registers.
	
2008-12-17  Mark Mason	<mmason@upwardaccess.com>
	
	* mini-mips.c (mono_arch_output_basic_block): OP_JUMP_TABLE stores patch type in inst_c1, not inst_i1.
	
2008-12-16  Rodrigo Kumpera  <rkumpera@novell.com>

	* branch-opts.c (remove_block_if_useless): Even if BB0 falls through, don't add a br to the
	next basic block.
	
2008-12-16  Mark Mason	<mmason@upwardaccess.com>

	* mini.h: Allow MonoInst 'p' field to alias with the low-order bits of the 'const_val' fields correctly on big-endian systems when SIZEOF_VOID_P < SIZEOF_REGISTER

	* ir-emit.h: Change SIZEOF_VOID_P to SIZEOF_REGISTER, init instruction through inst_c* fields instead of inst_p* fields in case sizeof(inst_p) < sizeof(inst_c)
	
2008-12-15  Mark Mason	<mmason@upwardaccess.com>
	
	* trace.c (mono_trace_enter_method): correctly handle arguments smaller than the stack slot size on big endian systems.
	
2008-12-14  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c (mono_analyze_liveness): Avoid eliminating the 'this' var in
	gshared code. Fixes #458947.

	* generics.cs: Add a test.

2008-12-12  Mark Mason	<mmason@upwardaccess.com>
	
	* method-to-ir.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.
	
	* mini-mips.c: first pass n32 code generation.

	* mini-mips.h: datatypes and defines for n32 support.

	* exceptions-mips.c: first pass n32 code generation.
	
	* tramp-mips.c: first pass n32 code generation.
	
	* cpu-mips.md: add long_ opcodes.
	
2008-12-12  Mark Mason	<mmason@upwardaccess.com>

	* liveness.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.

	* cfold.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.
	
	* local-propogation.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.
	
	* regalloc2.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.

	* mini.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.

	* mini-codegen.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.

	* ssa.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.

	* decompose.c: replace SIZEOF_VOID_P with SIZEOF_REGISTER where needed.

	* helpers.c: for mips/n32, don't pass -mips32 to objdump

2008-12-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c tramp-arm.c: Fix calls to mono_arch_flush_icache.

2008-12-12  Andres G. Aragoneses  <aaragoneses@novell.com>

	* driver.c: Sync --help-trace with man page (EXPR,EXPR).

2008-12-12  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.h, exceptions-ppc.c, tramp-ppc.c: Create function
	descriptors for helper functions directly in front of the code.

2008-12-11  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Removed an unnecessary assertion.

2008-12-10  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c: Merge SGEN changes from the old JIT.

2008-12-10  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (compile_all_methods_thread_main): Handle failure of
	mono_get_method ().

2008-12-10  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Merged with mini-ppc64.c.

	* mini-ppc.h: Define PPC_MINIMAL_PARAM_AREA_SIZE on all targets.

	* Makefile.am: Use the same sources for PPC and PPC64.

	* mini-ppc64.c: Removed.

2008-12-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* branch-opts.c (remove_block_if_useless): Extract fall through detection
	code to mono_bb_is_fall_through.
	
	* branch-opts.c (mono_remove_critical_edges): Same.

2008-12-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* ssa.c (fold_ins): branch opt can kill dummy switch ops so we can't
	expect that an OP_BR_REG will be there.

2008-12-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* branch-opts.c (remove_block_if_useless): Use MONO_IS_BRANCH_OP instead of checking
	for the many branch ops. The original check miss OP_BR_REG.

	Fixes #457574.
	
2008-12-09  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.h mini-mips.c exceptions-mips.c tramp-mips.c: first round of changes necessary to eventually support n32.

2008-12-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_method): Avoid calling decode_exception_debug_info
	while holding the aot lock.

2008-12-09  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_output_basic_block): use mfc1/lwc1 instead of mfc1d/ldc1
	
2008-12-09  Bill Holmes  <billholmes54@gmail.com>

	* mini.c (mini_cleanup) : Adding a call to cominterop_release_all_rcws 
	  to release all runtime callable wrappers held by the runtime.

	Contributed under MIT/X11 license.

2008-12-09  Bill Holmes  <billholmes54@gmail.com>

	* tramp-amd64.c (mono_arch_create_trampoline_code_full) : Increase the code size for
	  for Winx64.

	Contributed under MIT/X11 license.

2008-12-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (decode_exception_debug_info): Acquire the domain
	lock when calling mono_domain_alloc (). Hopefully fixes #415608.

2008-12-09  Mark Mason   <mmason@upwardaccess.com>

	* cpu-mips.md: fix ckfinite length

	* mini-mips.c: at least recognize n32 ABI when used (not yet supported)
	(mono_arch_lowering_pass): cleanup, rearrange for clarity
	(mono_arch_output_basic_block): implement OP_CKFINITE, add more asserts
	
2008-12-08  Mark Mason   <mmason@upwardaccess.com>

	* exceptions-mips.c (mono_arch_find_jit_info): init new_ctx with ctx, dont' call setup_context.
	
2008-12-08  Geoff Norton  <gnorton@novell.com>

	* tramp-amd64.c: r120895 stores RAX, so we need to increase the window
	size by 8 bytes as well.

2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector16b.
	
2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector16sb.

2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector8us.
	
2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector8s.
	
2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector4ui.

2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector2l.

2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector2d.

2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (mono_emit_simd_intrinsics): Add support for intrinsics
	that are extension methods.

2008-12-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix method names for Vector4f.

2008-12-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_print_thread_dump): Mark threadpool threads
	as such. Fixes #456669.

2008-12-07  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_emit_call): narrow float arguments when passing as args.
	
2008-12-07  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_lowering_pass): don't handle OP_ICONV_TO_R* or OP_R*CONST
	(mono_arch_emit_setret): use OP_MIPS_CVTSD to return SP floats
	(mono_arch_output_basic_block): simplify FP load/store, handle OP_MIPS_FBLT_UN
	(mips_adjust_stackframe): handle FP spills
		
	* mini-ops.h: add mips_mtc1_s2
	
	* cpu-mips.md: add mips_mtc1_s2
	
2008-12-07  Zoltan Varga  <vargaz@gmail.com>

	* unwind.c: New file, move the unwind info encoding functions here from
	aot-compiler.c, so they could be used at runtime too.

2008-12-05  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_lowering_pass): handle OP_IMUL_IMM as well
	(mono_arch_output_basic_block): fix OP_LOCALLOC code generation
	
2008-12-05  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c: cleanup warnings
	(mono_arch_lowering_pass): handle OP_LOCALLOC_IMM
	(mips_adjust_stackframe): handle case of taking the address of stack locals
	
2008-12-05  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Implement a few functions missing from the asm writer.
	(emit_method_code): Only write symbols for methods when using the bin
	writer, since the assembler can't deal with the characters in our method
	names.

	* aot-compiler.c (is_plt_patch): ICALL_ADDR is also a plt patch.

	* method-to-ir.c (mono_method_to_ir): Transform aotconst+calli into a direct
	call.

	* tramp-amd64.c (mono_arch_create_trampoline_code_full): Rework the code
	a bit to also restore %rax.

2008-12-05  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Some simple merges from mini-ppc64.c.

2008-12-05  Zoltan Varga  <vargaz@gmail.com>

	* ssa.c (mono_ssa_compute): Only add an implicit reference at start for
	arguments.

2008-12-05  Mark Probst  <mark.probst@gmail.com>

	* exceptions-ppc.c: Merged with exceptions-ppc64.c.

	* mini-ppc.c, mini-ppc.h: Remove PPC_STACK_ALIGNMENT and use
	MONO_ARCH_FRAME_ALIGNMENT.  Struct for PPC64 function descriptors.

	* exceptions-ppc64.c: Removed.

	* Makefile.am: Use exceptions-ppc.c instead of exceptions-ppc64.c.

2008-12-05  Mark Probst  <mark.probst@gmail.com>

	* tramp-ppc.c, mini-ppc.c, mini-ppc.h: Merged tramp-ppc.c with
	tramp-ppc64.c.

	* Makefile.am: Use tramp-ppc.c instead of tramp-ppc64.c.

	* tramp-ppc64.c: Removed.

2008-12-05  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_instances): Skip non-generic classes in
	the TYPESPEC table.

2008-12-05  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.h: Merged mini-ppc64.h with mini-ppc.h.

	* exceptions-ppc64.c, tramp-ppc64.c, mini-arch.h, Makefile.am: Use
	mini-ppc.h instead of mini-ppc64.h.

	* mini-ppc64.h: Removed.

2008-12-04  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c: introduce USE_LDC_SDC: use ldc1/sdc1 to load/store doubles, disabled by default
	
	* mini-mips.c (mono_arch_emit_outarg_vt): fix offset calculation for memcpy in structure passing.
	
2008-12-05  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, exceptions-ppc64.c, tramp-ppc64.c:
	Removed FIRST/LAST_[GF]REG macros, to make merging PPC64 with PPC
	code easier.

2008-12-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for operator == and != on  Vector8us and Vector16b.

2008-12-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Add support for operator == and != to Vector8(u)s and Vector16(s)b.

2008-12-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for operator == and != on Vector4f.

2008-12-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (simd_intrinsic_emit_equality): Adapt to support Vector4f.

	* simd-intrinsics.c: Kill useless enum.

2008-12-04  Mark Mason   <mmason@upwardaccess.com>

	* cpu-mips.md: add long_conv_to_ovf_i4_2
	* mini-mips.c: update/add various _OVF_ opcodes to fix test failures

2008-12-04  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c: ifdef protect automatic promotions of R4 to R8.
	
	* mini-mips.c (mono_arch_emit_setret): handle R4 case with FCONV_TO_R4 instead of FMOVE

2008-12-04  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_output_basic_block): fix codegen for OP_OR_IMM/OP_IOR_IMM
	
2008-12-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for new methods.

2008-12-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Add support for operator == and !=
	on Vector4(u)i.

	* simd-methods.h: Add SN_op_Inequality and SN_op_Equality.

2008-12-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Remove ExtractByteMask intrinsics.

2008-12-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Add pinvoke wrappers.

	* mini.c (mono_resolve_patch_target): Allow pinvoke methods in 
	MONO_PATCH_INFO_ICALL_ADDR.

	* aot-runtime.c (MonoAotFileInfo): Correct order of fields.

	* aot-compiler.c: Resurrect full-aot support.

2008-12-04  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_lowering_pass): handle OP_COMPARE and OP_ICOMPARE
	
2008-12-04  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_output_basic_block): fix OP_IREM_UN code generation
	
2008-12-03  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix tests to work under ppc.
	Remove tests for methods that will be removed.

2008-12-03  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir): Handle ldtoken of an open
	generic type (via a typedef or typeref) correctly.

2008-12-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): Add some debugging code to help
	diagnose an assertion failure.

2008-12-02  Mark Probst  <mark.probst@gmail.com>

	* tramp-ppc64.c (mono_arch_create_rgctx_lazy_fetch_trampoline):
	Fix trampoline size.

	* mini-ppc64.c, mini-ppc64.h, cpu-ppc64.md: A few floating point
	conversion opcodes are implemented natively instead via emulation.

2008-12-01  Mark Mason   <mmason@upwardaccess.com>

	* cpu-mips.md: remove mips_xori

	* mini-ops.h:  remove mips_xori

	* mini-mips.h: replace OP_MIPS_XORI with OP_IXOR

	* mini-mips.c (mono_arch_decompose_long_opts): Add ladd_imm, lsub, lsub_imm, lneg, lsub_ovf, lsub_ovf_un.
	
	* mini-mips.c (mono_arch_lowering_pass, mono_arch_output_basic_block): fix IXOR handling
	
2008-12-01  Mark Mason   <mmason@upwardaccess.com>

	* cpu-mips.md: fix instruction lengths.

	* mini-mips.h: define MONO_ARCH_NO_IOV_CHECK

	* mini-mips.c: move most instruction rewriting into decompose_ops. Implement conditional branches and exceptions. Fix jump table patch handling. Implement add/sub OVF.

	* mini-ops.h: fix slti / sltiu op profiles.
	
2008-12-02  Martin Baulig  <martin@ximian.com>

	* method-to-ir.c (mono_method_to_ir): Disable debugging
	information for the init locals block to make the debugger stop
	after all locals have been initalized.

2008-12-02  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_method_compile): Disable MONO_OPT_DEADCE when
	running inside the debugger.

2008-12-01  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Only run local deadce if MONO_OPT_DEADCE
	is enabled.

	* method-to-ir.c (mono_method_to_ir): Fix invalid code generated by the 
	alu->alu imm optimization which only shows if deadce is disabled.

	* aot-compiler.c: Rename the function names for the binary and asm writers
	so they can coexist in the same process. Rework the xdebug code to use the
	asm writer. This avoids the need to call into the runtime to dump the
	debugging info. Add more debugging info for types.

	* mini-<ARCH>.h: Kill MONO_ARCH_HAVE_NORMALIZE_OPCODES define.

	* genmdesc.c genmdesc.pl mini.h: Don't put the CEE_ opcodes into the
	cpu description tables, they can't occur in cpu-<ARCH>.md.

	* method-to-ir.c (mono_method_to_ir): Set the type of the value pushed on
	the stack in CEE_LDFLDA. Fixes #450542.

	* generics.cs: Add a new test.

2008-12-01  Mark Mason   <mmason@upwardaccess.com>

	* mini-ops.h: updated MIPS opcodes
	* mini-mips.c: decompose long opts
	* mini-mips.h: decompose long opts
	
2008-11-29  Mark Mason   <mmason@upwardaccess.com>

	* cpu-mips.md: fix length on int_rem_un
	* mini-mips.c (mips_stackframe_adjust): fix insertion of spillvars region in MIPS stackframes.
	
2008-11-29  Zoltan Varga  <vargaz@gmail.com>

	* mini.h aot-runtime.c: Fix building with DISABLE_AOT.

	* mini-codegen.c (mono_print_ins_index): Handle OP_VOIDCALL_MEMBASE.

2008-11-29  Martin Baulig  <martin@ximian.com>

	* mini-exceptions.c (mono_handle_native_sigsegv): Check
	mono_debug_using_mono_debugger() in addition to the
	`no_gdb_backtrace' flag in the `MonoDebugOptions'.

2008-11-28  Mark Mason   <mmason@upwardaccess.com>

	* mini-ops.h: updated more MIPS opcodes
	* mini-mips.c: FP compare/branch working again, clean up last of CEE_ -> OP_ mappings
	* cpu-mips.md: Added MIPS versions of new FP compare/branch opcodes.
	
2008-11-28  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c: Patch the RGCTX fetch trampoline correctly.

2008-11-28  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c (mono_arch_emit_call): adding missing conversion to fp single when passing in integer arg register.
	* mini-mips.c (mips_adjust_stackframe): compensate for spill-down logic.
	* mini-ops.h: correct selected mips opcode entries
	
2008-11-28  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h: Enable generalized IMT thunks and
	make them work.

2008-11-28  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.h, tramp-ppc64.c: Make generic code sharing work.

2008-11-28  Mark Mason   <mmason@upwardaccess.com>

	* method-to-ir.c, mini-trampolines.c: protect IMG code with #ifdef MONO_ARCH_HAVE_IMT to fix compile errors.
	* mini-mips.c: Fixup stackframe assignments after allocation of spillvars.
	* mini-mips.h: disable IMT
	* tramp-mips.c (mono_arch_get_vcall_slot): fix offset extraction
	
2008-11-28  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h: Don't emulate long ops.

2008-11-28  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, exceptions-ppc64.c: Several fixes.

2008-11-28  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (handle_isinst): Use PCONST instead of ICONST for
	consistency.

2008-11-27  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (emit_array_extension_intrinsics): Add support
	for Set/GetVector aligned versions.

2008-11-27  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for Get/SetVector.

2008-11-27  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Removed g_slist_append_mempool().  Now in
	metadata/mempool.c.

2008-11-27  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (mono_emit_vector_ldelema): Extract the element
	size properly and make the bounds check optional.

	* simd-intrinsics.c (emit_array_extension_intrinsics): Add support
	for SetVector and IsAligned.

2008-11-27  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Remove unused mono_normalize_opcodes () function.

2008-11-26  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mini_emit_inst_for_method): Small fix: we're
	using the new atomic add ops now.

	* mini-ppc64.c, mini-ppc64.h, cpu-ppc64.md: Implemented atomic
	add.

2008-11-26  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c: Several fixes.

2008-11-25  Mark Mason   <mmason@upwardaccess.com>

	* cpu-mips.md: added jump_table
	* mini-mips.c: added jump_table. Eliminate compare-imm when lowering. Remove dead function.		

2008-11-25  Mark Mason   <mmason@upwardaccess.com>

	* mini-mips.c, mini-mips.h, tramp-mips.c, cpu-mips.md: Initial upgrade of MIPS port to new IR.

2008-11-25  Mark Mason   <mmason@upwardaccess.com>

	* mini-ops.h: corrected a handful of MIPS opcodes.

2008-11-25  Mark Mason   <mmason@upwardaccess.com>

	* aot-compiler.c: MIPS to use ELF writer

2008-11-25  Mark Mason   <mmason@upwardaccess.com>

	* mini-codegen.c: remove MIPS specific assert.

2008-11-25  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, tramp-ppc64.c, cpu-ppc64.md: Several
	fixes.  PPC64 now passes most of the runtime regressions.

2008-11-24  Zoltan Varga  <vargaz@gmail.com>

	* regalloc2.c: Distinguish between use/def positions. Optimize the creation of
	volatile intervals a bit.

2008-11-24  Mark Probst  <mark.probst@gmail.com>

	* basic-long.cs: New test case.

2008-11-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Disable globalra for large methods for 
	now.

	* regalloc2.c (order_moves): Add fp support.

	* branch-opts.c (mono_remove_critical_edges): Split non-critical edges whose
	source bblock ends with an OP_BR_REG.

	* ratests.cs: Add a new test.

2008-11-23  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, tramp-ppc64.c: Disable generic code
	sharing.  PPC64 now passes generics.exe.

2008-11-23  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c: Several fixes.  PPC64 now runs iltests.exe.

2008-11-23  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (mono_arch_find_jit_info): Avoid reading uninitialized
	memory when mono_jit_info_table_find () can't find the method in the
	LMF case.

	* aot-compiler.c (mono_save_xdebug_info): Emit complete debug info for
	AOTed code too.
	
	* aot-compiler.c (mono_save_xdebug_info): Make this work with the assembly
	writer too.

2008-11-23  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, exceptions-ppc64.c, cpu-ppc64.md:
	Several fixes.  PPC64 now runs exceptions.exe and
	devirtualization.exe.

2008-11-22  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, tramp-ppc64.c: Small fixes.  PPC64 now runs
	arrays.exe and basic-math.exe.

2008-11-22  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, exceptions-ppc64.c, tramp-ppc64.c,
	cpu-ppc64.md: Several fixes.  PPC64 now runs objects.exe.

2008-11-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Add support ArrayExtension intrinsics.

2008-11-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c: Move bounds checking macros to ir-emit.h

	* ir-emit.h: Move macros from method-to-ir.c to here.

2008-11-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Correct the long simd ops to use LREG.

2008-11-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Correct the dreg type of OP_LOADI8_MEMBASE.
	
	* mini-ops.h: Correct the dreg type of a few long opcodes.

	* mini-amd64.h: Applied patch from Mihai Chelaru <kefren@ngnetworks.ro>.
	Add netbsd support.

Fri Nov 21 12:52:23 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: remove negative stack references in epilog
	for platforms that don't support the red zone.

2008-11-21  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.h, cpu-ppc64.md: Fixed caller/callee saved floating
	point regs.  Now PPC64 passes basic-calls.exe.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for accessors of Vector2l.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_INSERTX_I8_SLOW,.

	* mini-x86.c (mono_arch_decompose_long_opts): Decompose OP_INSERTX_I8_SLOW.
	
	* simd-intrinsics.c: Add support for Vector2l and Vector2ul.

2008-11-21  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, cpu-ppc64.md: Several fixes.  Now
	PPC64 passes basic-long.exe.

2008-11-20  Mark Probst  <mark.probst@gmail.com>

	* decompose.c: Decompose carry and overflow add on PPC64 like on
	other 64 bit archs.  Don't decompose sub at all on PPC64.

	* mini-ppc64.c, exceptions-ppc64.c, tramp-ppc64.c, cpu-ppc64.md:
	Several fixes and new opcodes.  Now PPC64 runs (but doesn't pass)
	basic-long.exe.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for accessors of Vector2d.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_INSERTX_R8_SLOW,.

	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.
	
	* simd-intrinsics.c (simd_intrinsic_emit_setter): Add support for Vector2d.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for accessors of Vector4f.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_INSERTX_R4_SLOW,.

	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.
	
	* simd-intrinsics.c (simd_intrinsic_emit_setter): Add support for Vector4f.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add tests for accessors of Vector4i and Vector4ui.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_INSERTX_I4_SLOW,.

	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.
	
	* simd-intrinsics.c (simd_intrinsic_emit_setter): Add support for Vector4i and Vector4ui.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Use reasonable sizes for extractx_u2 and insertx_u1_slow.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Enable setters for Vector16sb.

2008-11-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_EXTRACTX_U2, OP_INSERTX_U1_SLOW.

	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.
	
	* simd-intrinsics.c (simd_intrinsic_emit_setter): Add support for Vector16b.

2008-11-19  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Implement setter for Vector8us.

2008-11-19  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_xdebug_info): Emit correct location info
	for dead variables.

Wed Nov 19 18:27:41 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: remove references to the red zone in the prolog
	(for systems that don't support it).

2008-11-19  Mark Probst  <mark.probst@gmail.com>

	* cpu-ppc64.md: Fixed a few instruction lengths.

	* mini-ppc64.c: Don't emit SETLRET.  PPC64 passes basic-float.exe,
	now.

2008-11-19  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, cpu-ppc64.md: Fixed some opcodes.  PPC64 passes
	basic.exe now.

2008-11-19  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_xdebug_info): Add more parameter types.

2008-11-18  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_INSERT_I2.

	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.
	
	* simd-intrinsics.c: Implement setter for Vector8s.

	* simd-methods.h: Add the names of get setters of Vector8s.

2008-11-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (mono_save_xdebug_info): Add support for parameters.
	
	* aot-compiler.c (mono_save_xdebug_info): Add preliminary support for
	parameters.

	* unwind.h (MonoUnwindOp): Change the 'val' to a signed type.

2008-11-18  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, tramp-ppc64.c, cpu-ppc64.md: Changes
	for PPC64.  An empty program runs now.

2008-11-18  Zoltan Varga  <vargaz@gmail.com>

	* unwind.h (MonoUnwindOp): Change the 'val' to a signed type.

	* aot-compiler.c mini.c mini.h: Add a JIT debugging mode modelled after
	a similar mode in Kaffe: When the the MONO_XDEBUG env var is set, debugging
	info for JITted code is emitted into a shared library, loadable into gdb.

2008-11-18  Mark Probst  <mark.probst@gmail.com>

	* Makefile.am: Changes to build PPC64.

	* mini-arch.h: Include mini-ppc64.h on PPC64.

2008-11-18  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, cpu-ppc64.md: Updated with changes
	in PPC code up to r119147.

2008-11-18  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, tramp-ppc64.c, exceptions-ppc64.c,
	cpu-ppc64.md: Changes for PPC64.

	Based on code submitted by andreas.faerber@web.de at
	https://bugzilla.novell.com/show_bug.cgi?id=324134 under the
	X11/MIT license.

2008-11-18  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc64.c, mini-ppc64.h, tramp-ppc64.c, exceptions-ppc64.c,
	cpu-ppc64.md: Copied from the corresponding PPC files from
	r118846.

2008-11-18  Scott Peterson  <lunchtimemama@novell.com>

	* mini-ops.h: Added OP_ROUND.

	* cpu-x86.md: Added round.

	* mini-x86.c: Added support for intrinsicing Math.Round (double).

	* basic-math.cs: Added test_0_round to test rounding.

	Contributed under MIT/X11 license.

2008-11-17  Bill Holmes  <billholmes54@gmail.com>

	* aot-compiler.c : Fix the Winx64 build.

	Contributed under MIT/X11 license.

2008-11-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-x86.c (mono_arch_output_basic_block): Use movsd instead of monvups
	in OP_EXTRACT_R8 to avoid possible stack corruption.

2008-11-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added OP_EXTRACT_R8/I8.

	* cpu-x86.md: Added extract_r8.

	* mini-x86.c (mono_arch_output_basic_block): Emmit OP_EXTRACT_R8.
	
	* mini-x86.c: Added mono_arch_decompose_long_opts to break OP_EXTRACT_I8 into
	a couple of OP_EXTRACT_I4.

	* mini-x86.h: Define MONO_ARCH_HAVE_DECOMPOSE_LONG_OPTS if simd is enabled.

	* simd-intrinsics.c: Implement getters for Vector2l/2ul/2d.

2008-11-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (vector2l_intrinsics): CompareGreaterThan requires sse 4.2
	and not 4.1. 

2008-11-17  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (handle_delegate_ctor): Emit the address of the delegate
	trampoline as an AOT const of the proper type instead of MONO_PATCH_INFO_ABS.

	* mini.c (mono_codegen): Remove the handling of delegate trampolines, they
	are not needed any more.

	* mini.h: Remove the unused INS_LIST macros.

	* mini.c (mini_method_compile): Remove a disable globalra case which is no
	longer needed.

	* *.h *.c: Remove duplicate MonoInst emission macros, use the ones in
	ir-emit.h.

	* regalloc.h *.c: Remove references to mono_regstate_next_int (), use
	mono_alloc_ireg () instead.

	* mini-<ARCH>.c: Include ir-emit.h. Remove duplicate MonoInst emission
	macros.

	* mini-amd64.c (emit_load_volatile_arguments): Removed, not needed
	on amd64.

	* aot-runtime.c (load_aot_module): Disable AOT when running under
	CAS.

	* mini-amd64.h: Change the monitor fastpath defines to check for
	!PLATFORM_WIN32 so they work on *bsd too.

	* mini.h mini.c mini-hhpa.c: Remove more unused code.

	* mini-s390.c mini-s390x.c: Remove !cfg->new_ir code.

	* mini.h (MonoCompile): Remove new_ir flag.

	* regalloc.h regalloc.c: Remove unused code.

	* cpu-*.md: Remove more unused opcodes.

	* simple-cee-ops.h simple-mini-ops.h: Removed.

	* mini-ops.h *.c cpu-<ARCH>.md: Remove more unused opcodes.
	
2008-11-17  Zoltan Varga  <vargaz@gmail.com>

	* aliasing.h: Removed.

	* *.c: Remove references to aliasing.h and inssel.h.

	* mini.c: Remove additional unused functions.

	* mini-ops.h cpu-*.md: Remove unused opcodes.

2008-11-16  Zoltan Varga  <vargaz@gmail.com>

	Remove the old JIT code.

	* inssel*.brg: Removed.

	* ssa.c abcremoval.c aliasing.c: Removed.

	* ssa2.c: Renamed to ssa.c.

	* abcremoval2.c: Renamed to abcremoval.c.

	* *.c: Removed all !cfg->new_ir code.

	* mini-<ARCH>.c: Removed mono_arch_call_opcode (), 
	mono_arch_emit_this_vret_args (), and mono_arch_get_inst_for_method ().

	* mini.c: Removed the old mono_method_to_ir () and all the code used by it.
	
2008-11-16  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Emit most of the non-table data in a structure
	to simplify the code and cut back on the number of global symbols in the AOT
	file.
	
	* aot-compiler.c aot-runtime.c: Get rid of the unused plt_jump_table.

2008-11-15  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c aot-compiler.c: Unify the plt_jump_table/plt_info tables
	with the got/got_info tables.

	* mini.h: Bump AOT file format version.
	
	* unwind.h: New file, contains definitions for stack unwinding.

	* mini.c (mono_emit_unwind_op): New helper function to append an unwind op
	to cfg->unwind_ops.
	
	* aot-compiler.c: Generalize the emitting of unwind information to use the
	information in cfg->unwind_ops.

	* mini-amd64.c (mono_arch_emit_prolog): Emit unwind info.

	* aot-compiler.c: Emit dwarf unwind information so gdb can unwind through
	AOT method frames. Enable writing symbols for methods by default.

2008-11-14  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (simd_intrinsic_emit_getter): Generalize this code
	and make it work with vectors of element sizes 1, 2 and 4.

	* simd-intrinsics.c: Enable getter for all vectors with element size
	1, 2 or 4.

	* simd-methods.h: Add the names of other getters.

	* mini-ops.h: Added OP_EXTRACT_I2/U2/I1/U1.

	* cpu-x86.md: Same.

	* mini-x86.c: Same.

Fri Nov 14 15:54:18 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h: portability fix.

Fri Nov 14 15:39:50 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, mini-ppc.c: avoid using the red zone as some kernels are
	buggy and will overwrite it.

2008-11-14  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Add functionality to emit local symbols to the elf writer.
	Use it to emit local symbols for all methods so AOTed methods show up with
	their full name in gdb/valgrind output.

Fri Nov 14 12:56:27 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: portability fixes.

2008-11-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): Move the patching of plt
	entries out of the if (!generic_shared...) code so it is always done.
	(mono_class_init_trampoline): Do the patching when running under valgrind
	too, newer versions of valgrind have no problems with it.

2008-11-13  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_writeout): Rework this to make it easier to add
	further sections.

2008-11-13  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c, cpu-ppc.md: Reserve space for the parameter area in
	filters.

2008-11-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Add getter support for Vector4i and Vector4ui. 

2008-11-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Kill diplicated ops OP_SHUFLEPS.

	* cpu-x86.md: Same.

	* mini-x86.c: Same.

	* simd-intrinsics.c: Same.

2008-11-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Enable constructor intrinsics for all types.

2008-11-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (simd_intrinsic_emit_ctor): Generalize this method
	to work with more Vector types.

2008-11-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (simd_intrinsic_emit_ctor): If the target is already a pointer
	store the elemens directly instead of using and intermediate.

2008-11-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (emit_call_body): Avoid aligning call sites in AOTed code.

	* tramp-x86.c (mono_arch_create_trampoline_code): Rework the return sequence
	to preserve %eax for aot plt trampolines.

	* aot-compiler.c (compile_method): Don't skip synchronized methods.
	(encode_method_ref): Flag synchronized methods so they won't go through
	the AOT trampoline.

	* aot-compiler.c: Additional work to support AOTing synchronized methods/
	wrappers.

	* cpu-ia64.md (jmp): Increase max length.

2008-11-12  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_method): Avoid calling runtime_class_init () for
	open generic classes.

	* aot-compiler.c: Enable the ELF writer on ELF platforms.

	* method-to-ir.c (mono_method_to_ir2): Revert the last change to the
	box+brtrue optimization since it causes test failures on x86.

2008-11-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Remove OP_PUSH_R4 and OP_LOADX_STACK.

	* cpu-x86.md: Same.

	* mini-x86.c: Same.

	* mini.h (struct MonoCompile): Add simd_ctor_var to be used as storage
	for simd ctor values. 

	* simd-intrinsics.c (simd_intrinsic_emit_ctor): Use simd_ctor_var for the constructor
	instead of directly pushing the values on stack. This saves about 15 bytes of generated code.

2008-11-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-methods.h: Rename SubWithSaturation, ArithmeticRightShift and
	LogicalRightShift.

	* simd-instrincs.c: Same.

	* basic-simd.cs: Same.

2008-11-12  Zoltan Varga  <vargaz@gmail.com>

	* ratests.cs: Add more tests.

	* regalloc2.c (add_spill_code): Handle more corner cases.

2008-11-11  Zoltan Varga  <vargaz@gmail.com>

	* regalloc2.c (INS_POS_INTERVAL): Decrease this to 8 to avoid overflows.
	(update_liveness): Avoid holes in the liveness ranges of hregs if they are
	both the source an destination of an instruction.

Tue Nov 11 19:30:50 CET 2008 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c, local-propagation.c, mini.c, ssa.c, ssapre.c, trace.c,
	wapihandles.c: more portability changes.

Tue Nov 11 18:56:33 CET 2008 Paolo Molaro <lupus@ximian.com>

	* aot-compiler.c, aliasing.c, abcremoval.c: portability changes.
	* mini.c mini.h, aot-runtime.c: the aot segfault-handling code is not
	safe to execute in a signal handler and the kernel provides better
	the info in /proc/self/smaps. Avoid the assert on sigaction during
	cleanup.

2008-11-11  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): In the box+brtrue optimization, only
	do the bblock linking hack if it is actually needed.

	* Makefile.am (patch-libtool): New helper target to patch libtool to speed
	up linking.

	* liveness.c (ENABLE_LIVENESS2): Reenable this for 64 bit archs as the
	crash problem is fixed.

	* branch-opts.c (mono_remove_critical_edges): Link up newly added
	bblocks.

	* mini.c (mini_method_compile): Compute unreachable bblocks properly even
	for catch clauses.
	(mini_method_compile): Set the starting value of next_vreg to 
	MAX_IREGS + MAX_FREGS when using globalra.

	* method-to-ir.c (mono_method_to_ir2): Mark bblocks starting
	filter clauses with BB_EXCEPTION_HANDLER.

	* regalloc2.c (assign_spill_slots): Set cfg->rgctx_var.

2008-11-10  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.c (mono_arch_get_argument_info): Don't align argument
	space for stdcall.  Fixes regressions on Win32.

2008-11-10  Zoltan Varga  <vargaz@gmail.com>

	* regalloc2.c (handle_reg_constraints): Avoid adding code to unreachable
	bblocks.
	(linear_scan): Remove an assert which doesn't seem to be needed.

	* local-propagation.c (mono_local_deadce): Avoid a call to
	MONO_DELETE_INS which would screw up the instruction linking.

	* mini.c (mono_decompose_op_imm): Make this work with globalra.

	* regalloc2.c: Upgrade to work the current JIT code.

2008-11-09  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (inline_method): Merge more basic blocks to help the AOT
	case.

	* aot-runtime.c: Remove some dead code.

	* tramp-arm.c: Use 'code' as the runnning pointer in code generation for
	consistency.
	(mono_arch_create_rgctx_lazy_fetch_trampoline_full): Implement aot support.

	* aot-runtime.c (load_named_code): Decode the offset of lazy fetch
	trampolines using sscanf since atoi doesn't work on large unsigned values.

	* tramp-amd64.c (mono_arch_create_rgctx_lazy_fetch_trampoline_full): 
	Initialize code_size.

2008-11-08  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mini_emit_inst_for_method): Make
	Interlocked.CompareExchange work for Int arguments on 32 bit
	archs, as well.

2008-11-07  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Fixed a funny commit error.

2008-11-06  Bill Holmes  <billholmes54@gmail.com>

	* main.c Fix MSVC build.

	Contributed under MIT/X11 license.

2008-11-06  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.c (mono_arch_allocate_vars): Make sure locals that need
	alignment larger than 8 bytes are aligned correctly, too.

	* mini.c: Honor the min_align field of MonoClass when laying out
	the stack.

2008-11-06  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Fix AOT support for CEE_SWITCH on arm.

	* aot-compiler.c (emit_plt): Fix a warning.
	
	* aot-compiler.c: Implement ARM support in the binary writer.

2008-11-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add test for getter with byref arg.
	Fix the naming of a few tests.
	Add missing checks to a test.

2008-11-05  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_plt): Make the arm code work with the binary writer.

	* aot-compiler.c aot-runtime.c mini-trampolines.c tramp-amd64.c: Implement
	most of the full-aot support for monitor enter/exit trampolines.

	* tramp-x86.c tramp_amd64.c: Add AOT compatible variants of the monitor
	enter/exit trampoline creation functions.

	* Makefile.am: Fix the generation of buildver.h so it is not invoked during
	make dist.

Wed Nov 5 16:28:53 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini.h, aot-compiler.c, method-to-ir.c, aot-runtime.c: remove the
	incorrectly added MONO_WRAPPER_MONITOR_* (in r117651-r117652) and
	implement the needed functionality without adding crap to the runtime.

2008-11-05  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_create_monitor_enter_trampoline): Fix the
	non-x86 builds.

	* mini.c (mono_build_date): New global version holding the build date in
	string format.
	
	* Makefile.am (buildver.c): Generate a file containing the build date.

	* main.c: Set the build date from the generated file.

	* mini.c (mono_get_runtime_build_info): New helper function returning build
	information in a string format.
	
	* driver.c (mono_main): Print the build date in --version.

	* aot-compiler.c aot-runtime.c: Embed the build information into the AOT
	file when the bind-to-runtime-version option is used.

2008-11-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Fix bug when using getters and byref args.	

2008-11-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-methods.h: Rename prefetch methods.

	* simd-intrinsics.c: Same.	

2008-11-05  Mark Probst  <mark.probst@gmail.com>

	* tramp-amd64.c: Enlarge the Monitor.Enter/Exit trampoline code
	sizes.

2008-11-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Use the bundled elf header files instead of depending on
	the system one.
	
	* aot-compiler.c (emit_symbol_diff): Allocate memory from the acfg
	mempool.

	* method-to-ir.c (mono_method_check_inlining): Avoid a getenv () call
	on every call.

2008-11-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Add store nta ops.

	* mini-ops.h: Same.

	* mini-x86.c: Same.

	* mini.h: Add an enum for simd prefetch modes.

	* simd-methods.h: Refactor the store_aligned code to handle multiple kinds
	of store. Use the changed code to support store nta.

	* simd-intrinsics.c: Add prefetch ops for all vector types.

2008-11-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Add an option for JIT compiling the methods by multiple 
	threads.
	
	* aot-compiler.c: Use statically allocated buffers for constructing symbol 
	names.

	* aot-runtime.c aot-compiler.c: Add support for the MONITOR_ENTER/EXIT
	trampolines.

2008-11-04  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.c: Fixed commit.

2008-11-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_plt): Align the plt section only on x86.

2008-11-04  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c, mini.h: Two new trampolines: MONITOR_ENTER
	and MONITOR_EXIT, for the ASM fastpaths.

	* method-to-ir.c: Use the ASM fastpath for Monitor.Enter/Exit if
	available.

	* mini.c, patch-info.h: Signature and patch infos for
	Monitor.Enter/Exit trampolines.

	* mini-amd64.c, mini-x86.c: Make emit_tls_get() non-static.

	* tramp-amd64.c, tramp-x86.c, mini-amd64.h, mini-amd64.h:
	Monitor.Enter/Exit ASM fastpath for Linux.

2008-11-04  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Fix soft-float support in Array.Get/Set.

	* objects.cs: Add a new test.
	
	* aot-compiler.c: Use mono_100ns_ticks () for computing the profiling info.

	* aot-runtime.c (load_method): Run class initialization in the PLT case even
	if MONO_LOG_LEVEL is set.

	* debug-mini.c (serialize_variable): Fix the encoding of dead variables.

	* aot-runtime.c (mono_aot_get_method): Skip out-of-date AOT modules.

	* aot-compiler.c (emit_and_reloc_code): Speed this up a little.
	
	* aot-compiler.c: Change the relocation code to use virtual addresses instead
	of file offsets. Align the sections belonging to the data segment to 
	PAGESIZE.

2008-11-03  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Simplify the elf writer by depending on the definitions in
	elf.h. Port it to amd64.

2008-11-03  Rodrigo Kumpera  <rkumpera@novell.com>

	* driver.c: Enable SIMD by default.

2008-11-03  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Add prefetch op.

	* mini-ops.h: Same.

	* mini-x86.c: Same.

	* mini.h: Add an enum for simd prefetch modes.

	* simd-methods.h: Add prefetch function names.

	* simd-intrinsics.c: Add prefetch ops for all vector types.

2008-11-03  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_bytes): Speed this up a little.

2008-11-02  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Add JIT time etc. statistics.
	
	* aot-compiler.c (compile_method): Fix the copying of the cfgs array.

	* mini.h (MonoCompile): Add 'got_offset' field.

	* aot-compiler.c: Store the got offset in MonoCompile, get rid of the
	method_got_offsets array.

	* aot-compiler.c aot-runtime.c: Add support for the monitor enter/exit
	wrappers.

	* aot-compiler.c (compile_method): Add generic method instances referenced
	by the method to the list of methods to be compiled, this is required so if
	A<T> references B<T>, and another assembly references A<int>, then it will
	also get a copy of B<int>.

	* method-to-ir.c (mini_emit_inst_for_method): Use the proper wrapper type
	when checking for monitor enter/exit.

2008-10-30  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mini_emit_inst_for_method): Use the IL fastpaths
	for Monitor.Enter and Monitor.Exit if enabled.

	* mini-x86.h, mini-amd64.h: Enable the IL fastpaths for Linux and
	Solaris.

2008-10-30  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (type_from_op): Convert CEE_CONV_U on OP_ICONV_TO_U instead
	of an OP_MOVE. Fixes #440046.

	* basic-long.cs: Add a new test.

2008-10-29  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.h: Add synchronization note for the managed counter-part.

	* simd-intrinsics.c: Add SimdRuntime.get_AccelMode intrinsic that
	returns the simd caps of the current cpu.

2008-10-29  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Remove Console.WriteLine.

2008-10-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: New tests for Vector2ul.

2008-10-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Add new vector type Vector2ul.

2008-10-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: New tests for Vector2l.

2008-10-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Add long version of most packed int ops.

	* mini-ops.h: Same.

	* mini-x86.h: Same.

	* simd-intrinsics.c: Add new vector type Vector2l.

2008-10-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Replace SN_op_BitwiseXor with SN_op_ExclusiveOr.

	* simd-methods.h: Remove SN_op_BitwiseXor.

2008-10-28  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_allocate_stack_slots_full): Align the size of vtypes to their
	alignment.

2008-10-27  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Test for Vector2d.

	* basic-simd.cs (test_vector8s_pack_signed_sat): Fixed broken
	value.

2008-10-27  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Add double version of all packed float ops.

	* mini-ops.h: Same.

	* mini-x86.h: Same.

	* simd-intrinsics.c: Add new vector type Vector2d.

	* simd-intrinsics.c (vector4f_intrinsics): Fix ordering.

	* simd-methods.h: Add Duplicate.

2008-10-27  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Test for packing with signed saturation.

2008-10-28  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_generic_instances): Add all methods of generic instances
	found in the TYPESPEC table.

2008-10-26  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Log not found methods for extra methods
	too.

	* mini.h (MONO_AOT_FILE_VERSION): Bump AOT file format version.

	* mini.c (mono_method_to_ir): For MONO_PATCH_INFO_RVA, save field the token
	instead of the RVA, since the RVA can be changed by tools like the cil 
	stripper.

	* method-to-ir.c (mono_method_to_ir2): Ditto.

	* debug-mini.c (serialize_variable): Handle ADDRESS_MODE_DEAD.
	(deserialize_variable): Ditto.

2008-10-25  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (write_variable): Use
	`MONO_DEBUG_VAR_ADDRESS_MODE_DEAD' for dead variables.

2008-10-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Add unsigned variants of packd and packw.

	* mini-ops.h: Same.

	* mini-x86.h: Emit the right instruction for packd and packw.
	Add unsigned variants of packd and packw.

	* simd-intrinsics.c: Packd and packw were used in place of their
	unsigned variants. Change that.
	Add intrinsics for (Signed)PackWithSignedSaturation.

	* simd-methods.h: Add (Signed)PackWithSignedSaturation.

2008-10-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (vector4i_intrinsics): New table of intrinsic type.

2008-10-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Remove dword packed add/sub with saturation ops.

	* cpu-x86.md: Remove dword packed add/sub with saturation ops.

	* simd-intrinsics.c (vector4ui_intrinsics): Remove methods without
	sse instructions.

	* simd-intrinsics.c (vector8s_intrinsics): Fix ordering.

2008-10-24  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c, mini.c: Special casing for the synchronized
	wrapper for the ldtoken+GetTypeFromHandle case.

2008-10-24  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_replace_ins): Move this to branch-opts.c.

	* mini.c (mono_replace_ins): Propagate has_array_access flag to the newly
	created/split bblocks.

2008-10-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add packed signed mul high.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* simd-methods.h: Add PackWithUnsignedSaturation and ShiftRightLogic.

	* simd-intrinsics.c (vector8s_intrinsics): New table of intrinsic type.

2008-10-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for Vector16sb.

2008-10-24  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (stmt): Fix OP_HARD_NOP rule.

2008-10-23  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add packed signed min, max and compare greater.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same. Add packed add/sub with
	saturation.

	* simd-methods.h: Add CompareGreaterThan.

	* simd-methods.h: Remove CompareEquals.

	* simd-intrinsics.c: Add new TODO entry and some cosmetic changes.

	* simd-intrinsics.c (vector16sb_intrinsics): New table of intrinsic type.

	* simd-intrinsics.c (vector4f_intrinsics): Rename CompareEquals to
	CompareEqual.

2008-10-23  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix tests due to change in the API.

2008-10-21  Zoltan Varga  <vargaz@gmail.com>

	* mini.c method-to-ir.c: Use mono_field_get_name () for accessing field->name.

2008-10-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Fix name change in Vector4f::CompareEqual.

	* simd-intrinsics.c (simd_intrinsic_emit_store_aligned): Don't use
	inst_offset as this has invalid values for LDADDR.

2008-10-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Test for SignedPackWithUnsignedSaturation.

	* simd-intrinsics.c (vector4ui_intrinsics): Add SignedPackWithUnsignedSaturation.

2008-10-21  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (initialize_array_data): Use mono_field_get_data ()
	for accessing field->data.

2008-10-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Test for SignedPackWithUnsignedSaturation.

2008-10-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-methods.h: Add SignedPackWithUnsignedSaturation.

	* simd-intrinsics.c (vector8us_intrinsics): Add SignedPackWithUnsignedSaturation.

2008-10-21  Zoltan Varga  <vargaz@gmail.com>

	* dominators.c (mono_compute_natural_loops): Allocate GList enties
	from the cfg mempool.

2008-10-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for new methods in Vector8us.

2008-10-20  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add multiply and store high.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* simd-methods.h: Same.

	* simd-intrinsics.c (vector8us_intrinsics): Add MultiplyStoreHigh
	and CompareEqual.

2008-10-19  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_emit_method_call_full): Remove a needless call to
	mono_class_setup_vtable ().

	* mini-trampolines.c (mono_convert_imt_slot_to_vtable_slot): Use
	mono_class_get_vtable_entry () for accessing klass->vtable.

	* aot-runtime.c (load_method): Avoid a crash when using MONO_LOG_LEVEL.

	* aot-compiler.c (add_generic_instances): Avoid a crash if a class is not
	found.

	* method-to-ir.c (mono_save_token_info): Don't save references made from
	wrappers.

	* aot-compiler.c (add_generic_instances): Add static rgctx wrappers for cctors
	of generic instances.

	* aot-runtime.c (find_extra_method): Search in all loaded AOT images.

2008-10-19  Mark Probst  <mark.probst@gmail.com>

	* cpu-ppc.md, mini-ppc.c: The length of the code generated for
	OP_JMP depends on the method signature.  Calculate it properly.

2008-10-19  Zoltan Varga  <vargaz@gmail.com>
	
	* aot-runtime.c (mono_aot_find_jit_info): Handle extra methods which are
	called directly.

	* aot-compiler.c (emit_and_reloc_code): Allow direct calling of generic
	instances.
	(emit_extra_methods): Add another table mapping method indexes to 
	offsets in the extra_method_info table.

	* mini.h: Bump AOT file format version.
	
	* aot-runtime.c: Merge most of the code from mono_aot_get_method
	and mono_aot_get_method_from_token () into one function.

2008-10-19  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (emit_load_volatile_arguments): Inner loop needs a
	separate counter.

2008-10-18  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c aot-runtime.c: Fix the hash function used for the extra
	methods.

	* method-to-ir.c (mono_method_to_ir2): Change a !compile_aot assert to
	disable_aot.

	* mini.c (mono_patch_info_equal): Compare the generic context as well.

	* mini.h: Bump aot file format version.

	* aot-compiler.c aot-runtime.c: Generalize the wrapper handling code so the
	AOT file can contain native code for methods which are not in the METHOD
	table. Generate code for non-sharable generic instances of generic methods
	found in the METHODSPEC table.
	
	* method-to-ir.c (mono_method_to_ir2): Remove the aot restriction when
	encoding generic type handles.

	* ir-emit.h (NEW_AOTCONST_TOKEN): Add a generic_context argument.
	(NEW_TYPE_FROM_HANDLE_CONST): Add a generic_context argument.

	* ir-emit.h: Rewrite the EMIT_NEW_XXXCONST macros to use the NEW_XXXCONST
	macros + MONO_ADD_INS.

	* mini.c (mono_jump_info_token_new2): New function which takes a generic
	context as well.

	* mini.h (MonoJumpInfoToken): Include fields for a generic context.

	* mini.h: Bump aot file format version.

	* aot-compiler.c aot-runtime.c: Update after changes to MonoJumpInfoToken.

2008-10-17  Mark Probst  <mark.probst@gmail.com>

	* mini-x86.h, mini-x86.c, exceptions-x86.c: Align stack on all
	platforms, with definable stack alignment value.  Set to 16 now
	for all platforms.

	* mini.c, mini.h, driver.c: Command line option for disabling
	stack alignment.

2008-10-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for new methods in Vector4ui.

2008-10-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add packed int shuffle.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* simd-intrinsics.c (vector4ui_intrinsics): Add compare equal,
	extract mask, max, min, shuffle.

	* simd-intrinsics.c (vector8us_intrinsics): Add max and min.

2008-10-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for new methods in Vector8us.

2008-10-17  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): "refanytype" produces a
	RuntimeTypeHandle, not a TypedReference.

Fri Oct 17 14:40:50 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* simd-intrinsics.c: remove relocations.

2008-10-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Port the IREM_IMM 
	optimizations from the x86 backend.

Fri Oct 17 12:00:51 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* simd-methods.h, simd-intrinsics.c: debloat method names and
	prepare for no relocations.

2008-10-16  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add packed min/equal and sum of absolute differences.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* simd-intrinsics.c (vector16b_intrinsics): Add average, compare equal,
	extract mask, max, min and sum of absolute differences.

	* simd-intrinsics.c: Increase SIMD_INTRINSIC_NAME_MAX due to new huge
	method name.

2008-10-16  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Test for the other mono_simd_simplify_indirection bug.
	Renamed one test for consistency.

2008-10-16  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (mono_simd_simplify_indirection): Apply the previous
	fix to the code that deal with other blocks.

2008-10-16  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Test for the mono_simd_simplify_indirection bug.

2008-10-16  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (mono_simd_simplify_indirection): Simplify the code
	that deals with vreg interference. Explicitly check for OP_LDADDR to be
	able to process the source reg.

2008-10-16  Martin Baulig  <martin@ximian.com>

	* mini-ops.h, cpu-amd64.md, cpu-x86.md: Added new `hard_nop' opcode.

	* inssel.brg: Add `OP_HARD_NOP'.

	* mini.h (MonoCompile): Added `keep_cil_nops' flag.

	* mini.c (mono_method_to_ir): In `CEE_NOP': generate a
	`OP_HARD_NOP' instruction when running inside the debugger.

	* method-to-ir.c (mono_method_to_ir2): In `CEE_NOP': generate a
	`OP_HARD_NOP' instruction when running inside the debugger.

2008-10-15  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (get_simd_vreg): Using sreg1 of OP_XMOVE
	now works. The issue with the regalloc tripping up no longer
	happens.

	* simd-intrinsics.c (load_simd_vreg): Same.

2008-10-15  Rodrigo Kumpera  <rkumpera@novell.com>
	
	* basic-simd.cs: Tests for new Vector8ui methods.

2008-10-15  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (get_simd_vreg): Simplify code and test
	only for type. This fixes crashes where MonoInst::klass is checked
	for ops of type != VTYPE or OBJ.

	* simd-intrinsics.c (load_simd_vreg): Same.

2008-10-15  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add ops for packed shuffle/max/avg and
	extract mask.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* simd-intrinsics.c (vector8us_intrinsics): Add avg, shuffle and
	extract mask.

	* simd-intrinsics.c (simd_intrinsic_emit_extract_mask): New function
	to emit extract mask op.

	* simd-intrinsics.c (simd_intrinsic_emit_shuffle): Retrofic this function
	to emit word shuffles.

2008-10-15  Mark Probst  <mark.probst@gmail.com>

	* mini.c (mono_allocate_stack_slots_full): Align stack frame to
	the largest alignment needed by a variable, but at least
	sizeof(gpointer).

2008-10-14  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for the fixes in the last commit.

2008-10-14  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (get_simd_vreg): Drop the is_this_ptr, this function
	no longer handles STACK_PTR input.

	* simd-intrinsics.c (get_simd_vreg): Don't crash when MonoInst::klass == -1.

	* simd-intrinsics.c (load_simd_vreg): New function that works like 
	get_simd_vreg 	but handles STACK_PTR input.

	* simd-intrinsics.c (simd_intrinsic_emit_getter): Use load_simd_vreg
	as the input can be an arbitrary pointer.

	* simd-intrinsics.c (simd_intrinsic_emit_ctor): Try the
	LDADDR local optimization directly otherwise use a store op.

2008-10-14  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for dup low and dup high.

2008-10-14  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add dup low and dup high ops.
	
	* cpu-x86.md: Same.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* simd-intrinsics.c (vector4f_intrinsics): Same.

2008-10-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Tests for recently added functionality.

2008-10-13  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Add remaining sse1 fp ops.
	
	* cpu-x86.md: Add remaining sse1 fp ops.

	* mini-x86.c (mono_arch_output_basic_block): Same.

	* mini.h: Add enum for simd FP compare conditions.

	* simd-intrinsics.c (vector4f_intrinsics): Add all new ops.

	* simd-intrinsics.c (simd_intrinsic_emit_binary): Set inst_c0 to flags
	so the backed can generate the appropriate op.

2008-10-13  Rodrigo Kumpera  <rkumpera@novell.com>
	This patch squeese one more byte from the SimdIntrinsc struct.

	* mini-x86.c (mono_arch_cpu_enumerate_simd_versions: Use the version number
	a a shift amount intead of simply or'ing it.

	* mini.h: Change SIMD_VERSION_* values to be sequential intead of masks.

	* simd-intrinsics.c (struct SimdIntrinsc): Squeese simd_version and simd_emit_mode into a single
	byte so we can have an aditional flags field without increasing struct size.

	* simd-intrinsics.c (emit_intrinsics): Use the value of simd_version as a shift amount before checking
	against the simd_supported_versions bitmask.

	* simd-intrinsics.c: Set SIMD_INTRINSIC_NAME_MAX to an appropriate value.

Mon Oct 13 10:58:10 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini.c: remove rawbuffer code (the only use here is unsafe because
	it takes locks during signal handling and the kernel now provides much
	better info in proc/pid/smaps these days).

2008-10-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Fix the changes to
	OP_X86_PUSH_OBJ. Fixes #434620.

	* objects.cs: Add a test.
	
2008-10-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Remove PackWithUnsignedSaturation tests as it turns out
	that the packuswb/packusdw don't work with unsigned numbers for what
	would be negative numbers in signed format.

	* cpu-x86.md: Add doubleword forms of many ops and packing ones.
	Fix the len of fconv_to_r8_x and xconv_r8_to_i4.

	* mini-ops.h: Add doubleword forms of many ops and packing ones.

	* mini-x86.c: Emit doubleword forms of many ops and packing ones.

	* simd-intrinsics.c (SimdIntrinsc): Rename the flags field to simd_version.

	* simd-intrinsics.c (vector4f_intrinsics): Use simd_version field for sse3 ops.

	* simd-intrinsics.c (vector4u_intrinsics): Rename to vector4ui_intrinsics and
	add more ops.

	* simd-intrinsics.c (simd_version_name): New function, returns the name of the
	version as the enum in mini.h.

	* simd-intrinsics.c (emit_intrinsics): Instead of having a special emit mode
	for sse3 ops, check the simd_version field if present. This way the code
	works with all versions of sse.

2008-10-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c: Fixed intrinsic name typo.

  	* mini.h: Added missing simd exported function.

	* basic-simd.cs: Added tests for Vector4ui.
	Fixed broken test for Vector16b.

2008-10-10  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_create_rgctx_lazy_fetch_trampoline_full): Increase
	the max length to 64.

2008-10-10  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Only do the fast virtual generic method call for
	non-wrapper methods.

	* mini.h, mini-trampolines.c: The new generic virtual remoting
	trampoline handles virtual method calls via the vtable (as done by
	the fast virtual generic method calls) to remoting proxies.

	* mini.c (mono_jit_create_remoting_trampoline): For generic
	methods reate a generic virtual remoting trampoline.

	* mini-amd64.h: Enable fast virtual generic method calls again.

2008-10-10  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Use SP (r1), not frame_reg (which might be r31) to
	restore registers when doing tail calls.

2008-10-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (emit_intrinsics): Vector4u was renamed to
	Vector4ui.

2008-10-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Add test for Vecto16b.PackWithUnsignedSaturation.

2008-10-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* simd-intrinsics.c (emit_intrinsics): Retrofit to new type names.

2008-10-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Retrofit for API changes.

2008-10-10  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Handle integer stack arguments for tail calls.

2008-10-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* optflags-def.h: Removed sse3 optimization.

	* driver.c: Same.

	* mini-x86.c (mono_arch_cpu_optimizazions): Remove detection of
	sse3.

	* mini-x86.c: Added mono_arch_cpu_enumerate_simd_versions.

	* mini.h: Added enumeration with simd versions.

	* simd-intrinsics.c (emit_intrinsics): Use the new static var
	for detecting SSE3.

	* simd-intrinsics.c: Added mono_simd_intrinsics_init.

	* mini.c (mini_init): Call mono_simd_intrinsics_init.

2008-10-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: Added tests for Vector8u and Vector16u.

	* basic-simd.cs: Fixed test naming.

2008-10-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-ops.h: Added ops for packed and saturated math, shifts
	and packing/unpacking.

	* cpu-x86.md: Added descriptors for the above ops.

	* mini-x86.c: Added code to emmit the above ops.

	* simd-intrinsics.c: Added support for Vector16u and Vector8u.

2008-10-08  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (compile_method): Enable AOT for generic code.

	* ir-emit.h (NEW_DOMAINCONST): Use domainvars in AOT code as well.

Wed Oct 8 16:35:43 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini.c: add a workaround for a common screwup that ends up blamed
	to mono (other processes blocking signal delivery).

2008-10-07  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Clear ins_flag on all code paths
	in the LDFLD/STFLD opcodes. Fixes #432673.

	* iltests.il.in: Add a new test.

Tue Oct 7 19:59:07 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: attach the thread in unmanaged->managed transitions
	using delegates (bug #433148).

2008-10-07  Rodrigo Kumpera  <rkumpera@novell.com>

       * basic-simd.cs: Use new ShuffleSel constants.

2008-10-07  Rodrigo Kumpera  <rkumpera@novell.com>

        * driver.c (opt_sets): Added combinations of simd, sse2 and sse3.

        * mini-x86.c (mono_arch_cpu_optimizazions): Detect sse3 and now
        only disable simd intrinsics if no sse2 is detected.

        * optflags-def.h: Added sse3.

        * simd-intrinsics.c: Avoid generated sse3 intrinsics if the optimization
        is disabled.

2008-10-07  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Fix Delegate/MulticastDelegate classes
	when adding delegate-invoke wrappers.

2008-10-07  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am: Reenable the simd tests.

2008-10-07  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (mono_arch_emit_outarg_vt) : In the ArgValuetypeAddrInIReg case,
	  add a call to mono_call_inst_add_outarg_reg for the arg->dreg to make sure that no
	  other vreg is allocated to that hreg.

	Contributed under MIT/X11 license.

2008-10-07  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am: Disable the simd tests for now as Mono.Simd is not
	yet checked in.

2008-10-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* basic-simd.cs: New test suite for SIMD intrinsics.

	* Makefile.am: Added new tests.

2008-10-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-x86.md: Added new instructions to handle float to int using SSE regs.

	* mini-ops.h: Same.

	* mini-x86.h: Enable mono_arch_decompose_opts if simd intrinsics are enabled.

	* mini-x86.c (mono_arch_decompose_opts): Decompose float to int conversion
	using SSE2 aware opcodes.

	* mini-x86.c (emit_float_to_int): Disable the SSE2 optimization if OPT_SIMD
	is enabled, this code path is only reachable if conversion ops are emmited after
	mono_method_to_ir.

	* mini.h: Added MonoCompile::fconv_to_r8_x_var to hold the float to int var.

	This optimization saves 6 bytes per conversion against the old version.

2008-10-06  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (compile_method): Don't skip methods referencing 
	generic methods without a corresponding entry in token_info_hash, since
	encode_method_ref () can handle all generic methods now.

	* method-to-ir.c (mono_save_token_info): Don't save the token info if a 
	generic context is set.
	
	* method-to-ir.c (mono_method_to_ir2): Put back a disable_aot for
	generic sharing of LDTOKEN.

2008-10-06  Mark Probst  <mark.probst@gmail.com>

	* mini-amd64.h: Temporarily disabled fast virtual generic method
	calls because it breaks the System.Runtime.Remoting tests.

2008-10-06  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Add delegate-invoke wrappers.

	* method-to-ir.c (check_inline_called_method_name_limit): Return TRUE
	so inlining actually works.
	(check_inline_caller_method_name_limit): Ditto.

Mon Oct 6 11:04:38 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: mono_arch_flush_icache () cast pointer using gsize for
	64 bit safety (from Olaf Hering and Andreas Farber).

2008-10-06  Zoltan Varga  <vargaz@gmail.com>
	
	* mini-trampolines.c (mono_aot_trampoline): Delegate processing to
	mono_magic_trampoline () if aot_get_method_from_token () fails. Remove
	unused virtual call support code.

	* aot-runtime.c (decode_method_ref): Add a 'no_aot_trampoline' out argument.
	
	* aot-runtime.c (mono_aot_get_method_from_vt_slot): Return NULL for methods
	which can't use aot trampolines.
	(decode_patch): Don't create aot trampolines for methods which can't use
	them.

	* aot-compiler.c (encode_method_ref): Add a marker for methods which can't
	use aot trampolines.

	* mini.h: Bump AOT image format version.
	
2008-10-05  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Pass cil_method instead of cmethod
	to save_token_info () since cmethod is inflated for constrained calls.

	* mini-<ARCH>.h mini-x86.c: Remove some unused defines.

2008-10-04  Andreas Farber  <andreas.faerber@web.de>

	* Makefile.am: Add build rules for ppc64.
	This avoids the build failing at pedump with unresolved symbols
	due to lack of arch_sources. Instead it will now fail earlier
	due to lack of cpu-ppc64.md.

	Contributed under MIT/X11 license.

2008-10-04  Mark Probst  <mark.probst@gmail.com>

	* mini-amd64.c (mono_arch_emit_call): Support stack arguments for
	tail calls.

	* iltests.il.in: Add test case for tail call with many arguments.

2008-10-03  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Add an !cfg->compile_aot assert
	to the fast virtual generic method code until the aot case is fixed.

2008-10-03  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c, mini-ppc.h: Implement generic virtual method thunks.

2008-10-03  Mark Probst  <mark.probst@gmail.com>

	* mini-amd64.c, mini-amd64.h: Implement generic virtual method
	thunks.

2008-10-03  Rodrigo Kumpera  <rkumpera@novell.com>
	
	* simd-intrinsics.c: Forgot to add this one.

	* mini-codegen.c: Fix macro in case SIMD is not supported.

2008-10-03  Rodrigo Kumpera  <rkumpera@novell.com>
	
	This patch land initial JIT support for simd intrinsics.

	* mini-x86.h: Added new define to make --enable_minimal work on x86.

	* Makefile.am: Added simd-intrinsics.c

	* simd-intrinsics.c: New file with simd instrinsic related
	code.

	* cfold.c (mono_constant_fold_ins2): Fold XZERO.

	* cpu-x86.md: Add simd related instructions.

	* driver.c: Added MONO_OPT_SIMD to the default set of optimizations.

	* driver.c: Added two new --regression variants.

	* ir-emit.h (MONO_EMIT_NEW_VZERO): Emit XZERO if the type is a simd intrinsic.

	* local-propagation.c (mono_local_cprop2): Eliminate useless XMOVE.

	* local-propagation.c (mono_local_deadce): Use new macro MONO_IS_NON_FP_MOVE and
	extract some complicated logic to helper functions.

	* method-to-ir.c (mono_type_to_regmove): Handle simd intrinsics.

	* method-to-ir.c (mini_emit_inst_for_method): Emit simd intrinsics.

	* method-to-ir.c (mono_handle_global_vregs): If a simd intrinsic was found, apply
	the specialized simplification pass.

	* method-to-ir.c (mono_spill_global_vars): Use new macro.

	* mini-codegen.c: Added SIMD constants to all regbanks arrays.

	* mini-codegen.c: Added reg_bank_table_init to initialize the reg desc -> bank
	table.

	* mini-codegen.c: Define a version of the reg_bank macro that uses desc_to_reg_type
	if MONO_ARCH_NEED_SIMD_BANK is defined.

	* mini-ops.h: Added the new simd ops.

	* mini-x86.c: Added mono_arch_xregname.

	* mini-x86.c (mono_arch_cpu_optimizazions): Disable MONO_OPT_SIMD if SSE3 is not detected.

	* mini-x86.c (mono_arch_output_basic_block): Add simd related opcodes.

	* mini-x86.h: Define simd related MONO_ARCH macros.

	* mini.c (mono_type_to_load_membase): Handle simd intrinsics.

	* mini.c (mono_type_to_store_membase): Handle simd intrinsics.

	* mini.h: Added new macros MONO_IS_NON_FP_MOVE, MONO_IS_REAL_MOVE, MONO_IS_ZERO and
	MONO_CLASS_IS_SIMD to deal with simd related IR.

	* mini.h (MonoInst): Added spill_var to the backend union.

	* mini.h (MonoCompile): Added uses_simd_intrinsics and iconv_raw_var.

	* mini.h: Added forward declarations of the new simd fuctions.

	* optflags-def.h: Added new optimization names SIMD.

	* regalloc.c (mono_regstate_reset): Set next vreg to be the max value of the 3 reg banks.

	* regalloc.h: Added support for working with 3 register banks.

	* regalloc.h (MonoRegState): Added xsymbolic field if a third regbank is required.

	* ssa2.c (mono_ssa_deadce2): Use new MONO_IS_ZERO macro.

Fri Oct 3 16:03:22 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: remove 64 bit related ifdef clutter.

2008-10-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_soft_stack_ovf): Unprotect two pages
	instead of one on 64 bit systems.

	* method-to-ir.c: Remove unused includes.

2008-10-02  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_exception_debug_info): Use jinfo->used_regs instead of
	cfg->used_int_regs, since the two are different on arm.

2008-10-02  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c, inssel.brg, mini-trampolines.c: Use
	mono_method_get_vtable_index() to get the vtable index.

2008-10-02  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Don't create native
	wrappers for array methods, because they're never called (and if
	they were called they wouldn't work).

2008-10-02  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Array methods are
	special-cased and must not be invoked indirectly via the (M)RGCTX
	when generic sharing is turned on.  Fixes #431413.

2008-10-01  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: When generic sharing is active, call
	non-interface virtual generic methods via the standard trampoline.

	* mini-trampolines.c: Handle virtual generic shared methods.

	* mini.h, mini-x86.c, mini-x86.h: New argument for
	mono_arch_build_imt_thunk() which is non-NULL for virtual generic
	method thunks and which is the trampoline to call if the lookup
	fails.  Enable the virtual generic method thunk for x86.

	* mini-amd64.c, mini-arm.c, mini-ia64.c, mini-sparc.c,
	mini-ppc.c (mono_arch_build_imt_thunk): Add the additional
	argument but assert that it's NULL, because these archs don't yet
	implement the virtual generic method thunk.  Changes in the IMT
	thunk data structures.

2008-10-01  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_globals): Avoid invalid characters in
	the static linking symbol.

	* objects.cs: Add a test for the range check optimization. Fix warnings.

	* branch-opts.c (mono_if_conversion): Add back the 'optimize range checks'
	optimization from the current JIT.

	* method-to-ir.c (mini_emit_inst_for_method): Decompose String.Length
	later in decompose_array_access_opts () to allow more optimizations.

	* method-to-ir.c (mono_handle_soft_float): Rename this to 
	mono_decompose_soft_float () for consistency.

	* mini-ops.h: Fix arguments of OP_STRLEN.

	* method-to-ir.c (save_cast_details): Extract the cast details saving code
	into a separate function.
	(reset_cast_details): Ditto.
	(handle_unbox): Save cast details. Fixes #431254.

	* method-to-ir.c: Remove some obsolete FIXMEs.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* ir-emit.h (alloc_dreg): Write a warning before crashing.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c: More work on macros to make them
	ready for multiple regbanks.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to.ir.c (mono_type_to_regmove): Remove static modifier.

	* mini.h: Export mono_type_to_regmove. Fix signature of mono_regname_full.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c (mono_spillvar_offset): Proper support for
	multiple regbanks.

2008-09-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_epilog): Remove some duplicated code from
	the stack overflow changes.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c: Make all bank macros depend on reg_bank.

	* mini-codegen.c (mono_local_regalloc): Make free mask
	initialization regbank aware.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c (mono_local_regalloc): Extract callee
	mask selection to a function and make it regbank aware.

2008-09-30  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c (mono_local_regalloc): Changed the cloberring
	code to deal with many regbanks.

2008-09-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c: More fp->regbank changes.

2008-09-29  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-codegen.c: Change asserts to use MONO_NUM_REGBANKS instead
	of a hardcoded constant.

2008-09-29  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (type_from_stack_type): Fix typo.

2008-09-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (emit_move_return_value): Convert float return values to
	double.

	* objects.cs: Add a new test.
	
	* mini-ia64.c (mono_arch_allocate_vars): Disable fp elimination for
	VARARG methods to fix an assert later.

	* mini-mips.h mini-mips.c mini-ops.h cpu-mips.md: Update the mips back
	end so it at least compiles.

2008-09-28  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (emit_optimized_ldloca_ir): Fix this.

2008-09-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_method_to_ir2): Extract the ldloca + initobj
	optimization to a new function (emit_optimized_ldloca_ir) and enable
	it for both ldloca and ldloca_s.

2008-09-28  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Remove an unnecessary assert in the
	gshared CASTCLASS code.

	* driver.c (mono_main): Add a workaround for shutdown crashes seen on
	amd64, where the libc stack unwinder encounters stack frames referring to
	native code in unmapped memory.

	* method-to-ir.c (mini_emit_check_array_type): Add support for generic
	sharing.

	* generics.cs: Add new test.

2008-09-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.h driver.c: Print the fp model when using --version on arm. Also,
	add a check that one of the ARM_FPU_ constants is defined.

	* mini-exceptions.c (mono_handle_soft_stack_ovf): Really fix the build.
	
	* mini-exceptions.c: Fix build on non-altstack platforms.

	* method-to-ir.c (mono_method_to_ir2): Fix aot support for the
	sharing of vtypes.

	* ir-emit.h: Add a comment to NEW_PCONST.

	* mini-exceptions.c (mono_altstack_restore_prot): Fix a warning.

	* mini.h (MonoJitDomainInfo): Move some fields here from MonoDomain.

	* mini.c aot-runtime.c method-to-ir.c driver.c mini-trampolines.c: Update
	after the changes to MonoJitDomainInfo.

2008-09-27  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c, tramp-ppc.c, mini-ppc.h: Implement generic code sharing.

2008-09-27  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Compiler warning fixes.

2008-09-27  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Special handling for 1/2 byte structs on Darwin only
	for pinvokes.

2008-09-27  Mark Probst  <mark.probst@gmail.com>

	* exceptions-ppc.c, mini-ppc.h: Compile
	mono_arch_handle_altstack_exception() on Darwin, too.

2008-09-27  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_emit_rgctx_method_call_full): Must also
	work on archs which don't have generic sharing implemented, only
	without the vtable_arg.

2008-09-26  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Added comment explaining why delegate ctor icall
	wrappers are compiled.

2008-09-26  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Don't produce trampolines to delegate ctor icall
	wrappers but compile them upfront.

Fri Sep 26 17:00:46 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini-amd64.c, mini-amd64.h, tramp-amd64.c: amd64 support code for calling a
	runtime-set function when going back to managed code. Currently this
	is used to set back the protection on the soft ovf pages and/or to
	throw the stack overflow exception that happened in unmanaged code.

Fri Sep 26 16:46:23 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* tramp-x86.c, mini-x86.h, mini-x86.c: x86 support code for calling a
	runtime-set function when going back to managed code. Currently this
	is used to set back the protection on the soft ovf pages and/or to
	throw the stack overflow exception that happened in unmanaged code.

Fri Sep 26 16:34:37 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, mini-trampolines.c, mini-exceptions.c: added
	the support code for restoring stack protection after stack overflows
	that happen in unmanaged code. Don't set the exec permission on the
	soft overflow area.

2008-09-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline): Add wrappers even if
	delegate->method_ptr is set. Fixes #428054.

2008-09-25  Zoltan Varga  <vargaz@gmail.com>

	* tests.cs: Rename to ratests.cs.

	* method-to-ir.c: Merge the emit_get_rgctx () calls into the 
	emit_get_rgctx_... functions.

2008-09-25  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Eliminated macro EMIT_GET_RGCTX.

2008-09-25  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): Unwrap wrappers
	before asserting that method is sharable.

2008-09-25  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c, mini.c, jit-icalls.c: New function for checking
	whether method needs a static RGCTX wrapper used instead of
	complex conditions.

	* generic-sharing.c, mini.h: A few functions moved to
	metadata/generic-sharing.c.

2008-09-25  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c, mini.c, mini-exceptions.c, mini-trampolines.c:
	Generic code sharing for value types, which essentially means
	treating value type methods like static methods.  The RGCTX is
	passed in the same way.

2008-09-25  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Avoid an assert in the NEWOBJ
	opcode when creating multi-dimensional arrays of open types.

	* generic-sharing.c (mono_method_check_context_used): Handle arrays of
	open generic types.

	* generics.cs: Add a test.

	* mini-codegen.c: Use macros everywhere for checking floats instead of == 'f'.

2008-09-24  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoCompile): Add 'disable_vreg_to_lvreg' flag.

	* mini.c (mini_method_compile): Set it when running under the debugger.	

	* method-to-ir.c (mono_handle_global_vregs): Disable global->local
	vreg optimization if the flag is set.

	* driver.c (mono_main): Add --attach= option to pass options to
	the attach agent.

	* mini.c (sigquit_signal_handler): Start the attach agent.

	* ssapre.c: Disable this to save space since it is not yet ported to
	linear IR.

	* regalloc2.c: Disable this to save space.

	* mini.h (MonoJitStats): Remove unused analyze_stack_repeat.

Wed Sep 24 16:01:49 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* decompose.c, method-to-ir.c, mini-codegen.c, regalloc2.c: make
	the -v option useful again.

2008-09-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Add support for
	--break-at-bb.

	* inssel.brg (mini_emit_castclass): Avoid the szarray!=array checks for
	arrays of arrays. Fixes #428406.

	* method-to-ir.c (mini_emit_castclass): Ditto.

	* objects.cs: Add new test.
	
2008-09-23  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (type_to_eval_stack_type): The code path for the new JIT
	was wrong at it choked against target_type_is_incompatible for byref types.

2008-09-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c: Use 'bank' macros instead of 'is_fp' macros in most 
	places.

Tue Sep 23 15:31:45 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: update a few more exceptions-related counters.

Tue Sep 23 15:28:29 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* aot-runtime.c, method-to-ir.c, mini.c, mini-trampolines.c: use the
	new functions to allocate from persistent mempools.

2008-09-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.h regalloc.h mini-codegen.c: Generalize the regalloc code to allow 
	multiple register banks in the future.

	* mini-codegen.c (mono_local_regalloc): Fix a warning.

2008-09-22  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (type_to_eval_stack_type): Remove duplicated function.

	* method-to-ir.c (type_to_eval_stack_type): Make this version compatible with both JIT.

	* mini.h: Export type_to_eval_stack_type.

	This function was nearly duplicated in method-to-ir.c and mini.c. The difference
	is only ins->klass of byref types.

2008-09-22  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mini_emit_memset): Use a default alignment of 4.
	(mini_emit_memcpy2): Ditto.

	* mini-amd64.c: Fix a warning.

2008-09-21  Mark Probst  <mark.probst@gmail.com>

	* exceptions-ppc.c (mono_arch_get_call_filter): Fixed stack frame
	linking.

2008-09-19  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c: Extract stloc micro-optimization to a
	function and apply it to all cases.

2008-09-19  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c: Don't fail generic code sharing in cases we
	already support.

2008-09-18  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Handle structs in tailcalls on Darwin.

Tue Sep 16 21:07:11 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* *.c, *.md, mini-ops.h: introduced relaxed_nop opcode for spin wait
	implementation.

Tue Sep 16 16:39:16 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* trace.c: make tracing more useful and correct, with per-thread
	id and indent info.

2008-09-15  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (mono_arch_emit_call): Convert floats to R4 when
	doing a method call and the argument is an R4.

2008-09-14  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Do not generate runtime invoke wrappers for
	generic methods.

2008-09-13  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Convert result to single for OP_ICONV_TO_R4.

2008-09-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MONO_IS_JUMP_TABLE): Handle GOT_ENTRY.
	(MONO_JUMP_TABLE_FROM_INS): Ditto.

2008-09-11  Zoltan Varga  <vargaz@gmail.com>

	* driver.c: Add a --agent argument (not supported yet) to load managed
	agent assemblies before loading the main assembly, similarly to how the
	Java VM handles agents.

2008-09-11  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (mono_arch_allocate_vars): Use arch-independent
	function to do stack layout of local variables.

2008-09-11  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c (calculate_sizes): Bugfix in sigcookie position
	calculation.

2008-09-11  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c ssa2.c mini.c mini-amd64.c decompose.c ssa.c abcremoval.c
	abcremoval2.c branch-opts.c driver.c dominators.c: Disable parts of the
	JIT if DISABLE_JIT is defined.

	* Makefile.am: Avoid compiling/linking in inssel.c if DISABLE_JIT is
	defined.

2008-09-10  Mark Probst  <mark.probst@gmail.com>

	* iltests.il.in: Disable the fconv test on PPC (the result is
	undefined according to ECMA).

2008-09-10  Mark Probst  <mark.probst@gmail.com>

	* iltests.il.in: Enable tail call tests for PPC.

	* mini.h: Add variable for storing incoming valuetype argument
	addresses for tail calls.

	* mini-ppc.c: Implement valuetype arguments and return values for
	tailcalls on Linux.

2008-09-09  Mark Probst  <mark.probst@gmail.com>

	* mini-ppc.c: Partially implement tail calls (struct arguments and
	return values not supported).

	* method-to-ir.c: Enable tail calls on PPC.

2008-09-08  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_wrapper_info): Omit the klass name from
	runtime-invoke wrappers to work around the problem of them getting
	assigned to a random class.

	* aot-runtime.c (mono_aot_get_method): Ditto.
	
2008-09-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c mini-mips.h mini-s390.h exceptions-mips.c: Kill
	the CUSTOM_EXCEPTION_HANDLING and CUSTOM_STACK_WALK defines.

2008-09-07  Mark Probst  <mark.probst@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Disable tail calls for PPC
	until they're implemented properly.

	* exceptions-ppc.c: Use arch-independent exception-handling code
	instead of custom one.

	* exceptions-ppc.c, mini-ppc.c, mini-ppc.h: Bug fixes and changes
	for Linear IR.

	* tramp-ppc.c, mini-ppc.c: Fixed warnings.

	* decompose.c, aot-runtime.c, aot-compiler.c: PPC code also
	applies when __powerpc__ is defined.

2008-09-06  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Add another cache mapping wrapper
	methods to their code to avoid computing the full name of wrappers and
	doing a lookup in a string hash table.

2008-09-05  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c: Remove the CHECK_BBLOCK () stuff it is not needed since
	we identify bblocks before method_to_ir () is ran.

	* branch-opts.c (mono_optimize_branches): Avoid nullifying the exit bblock.
	Also avoid optimizing branches pointing to themselves.

	* mini.c (mini_method_compile): Ditto. Fixes #422947.

2008-09-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* driver.c (mono_main): Enable the new verifier under core-clr and cas.

2008-09-05  Zoltan Varga  <vargaz@gmail.com>

	* tramp-arm.c (mono_arch_nullify_class_init_trampoline): Implement this.
	(mono_arch_patch_plt_entry): Fix the calculation of the jump_entry.
	(mono_arch_get_nullified_class_init_trampoline): Return 'code' instead of
	'buf'.

	* aot-compiler.c (emit_plt): Fix the arm plt entries, previously they all 
	jumped to the same entry in plt_jump_table.

2008-09-02  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (initialize_array_data): Handle field with RVA from
	dynamic images.

2008-08-31  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (handle_isinst): Do the assignment at the beginning, so the
	other assignment can be if converted. Saves 1.5% on corlib size and fixes
	#421807.

2008-08-29  Geoff Norton  <gnorton@novell.com>

        * aot-compiler.c: The Mach/ARM compiler doesn't understand the bss
        segment, and doesn't properly handle .space as .text.  Fixes
        AOT Mach/ARM

2008-08-29  Geoff Norton  <gnorton@novell.com>

	* mini.c: Disable the mach exception handler when running on 
	ARM

2008-08-29  Geoff Norton  <gnorton@novell.com>

	* aot-compiler.c: Patch from Renaldas Zioma to properly register 
	globals on Darwin/ARM

2008-08-28  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Avoid not initializing the runtime when doing AOT compilation, 
	since too many things depend on it. Instead, call 
	mono_runtime_set_no_exec ().
	
	* mini.c (mono_create_tls_get): Call mono_alloc_preg (cfg) when running with
	the new JIT.

	* aot-compiler.c: Add an 'asm-only' AOT option.

	* mini.c: Avoid initializing the runtime when doing AOT compilation.
		
	* aot-compiler.c (compile_method): Disable gshared support for now as it
	doesn't yet work.

2008-08-27  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.h : Fix a compiler warning.

	* exceptions-amd64.c (mono_arch_unwindinfo_install_unwind_info) :
	  Changed to use a callback function to retrieve the unwind info.
	  This avoids problems observed when code blocks were removed by
	  unloading an app domain.

	* mini-amd64.c (mono_arch_cpu_optimizazions) : Removing the peephole 
	  and branch excludes for Winx64.  The fix in exceptions-amd64.c allows them
	  to work properly.

	Contributed under MIT/X11 license.

2008-08-27  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block) : Fix the OP_X86_PUSH_OBJ
	  case to keep the stack aligned to 8.

	Contributed under MIT/X11 license.

2008-08-26  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Add a cache for wrapper names to
	avoid repeated linear searches.

2008-08-25  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (add_wrappers): Avoid calling get_runtime_invoke with
	methods it can't handle.
	
	* aot-compiler.c (add_method): Avoid adding a method twice.
	(add_wrappers): Add runtime invoke wrappers for all methods.

	* tramp-amd64.c (mono_arch_create_rgctx_lazy_fetch_trampoline_full): New
	function to create an aot-compatible version of this trampoline.

	* aot-compiler.c aot-runtime.c: Add support for AOT rgctx fetch trampolines.

2008-08-24  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (compile_method): Skip wrappers of generic icalls.

	* method-to-ir.c (mono_method_to_ir2): Replace an assert in UNBOX_ANY
	with a generic sharing failure.

	* aot-compiler.c (emit_klass_info): Call mono_class_get_nested_types ().

	* method-to-ir.c (mono_method_to_ir2): Rethrow the correct exception in
	CEE_RETHROW. Fixes #419634.

	* mini.c (mono_method_to_ir): Ditto.

	* exceptions.cs: Add a new test.
	
	* generic-sharing.c (mini_type_stack_size): Always pass TRUE as allow_open
	to mono_type_stack_size_internal () since some callers might not pass in
	an rgctx.

	* mini-x86.c (mono_arch_emit_prolog): Store the rgctx before calling
	instrument_prolog. Fixes #419878.

	* mini.c (mono_compile_create_var_for_vreg): Make the lvars representing
	doubles in soft float mode volatile.

2008-08-23  Zoltan Varga  <vargaz@gmail.com>

	* ir-emit.h (NEW_ARGSTORE): Use cfg->args and cfg->arg_types to fix the build.

	* method-to-ir.c (mono_save_args): Use ARGSTORE instead of TEMPSTORE
	to handle soft float correctly.

	* tramp-arm.c (mono_arch_create_rgctx_lazy_fetch_trampoline): Implement
	the fast path.

	* mini.h (struct MonoCallInst): Add dynamic_imt_arg boolean field.

	* exceptions-arm.c (mono_arch_find_jit_info): Set ctx->regs [ARMREG_R11]
	to sp, since the generics catch code requires it.

	* mini-arm.h (MONO_ARCH_VTABLE_REG): Use R0 for this to avoid needless
	copying.

	* method-to-ir.c (emit_imt_argument): Pass imt_arg to 
	mono_arch_emit_imt_argument ().

	* mini-<ARCH>.c (mono_arch_emit_imt_argument): Add an 'imt_arg' argument.

	* mini-arm.c tramp-arm.c: Generic sharing updates.

2008-08-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c: Fix the arm build.

	* generic-sharing.c (mini_type_get_underlying_type): New helper function
	handling enums, generic instances and generic sharing.
	(mini_type_stack_size_full): Ditto.

	* mini-amd64.c mini-x86.c mini-arm.c: Use the new functions.
	
	* mini.h (struct): Add 'uses_rgctx_reg' and 'uses_vtable_reg' fields.

	* method-to-ir.c: Set the new fields when using RGCTX_REG/VTABLE_REG.

	* tramp-arm.c: Implement the rgctx fetch and the generic class init 
	trampolines.

	* mini-arm.c: Various small generic sharing changes.

	* tramp-x86.c (mono_arch_create_generic_class_init_trampoline): Implement
	this for x86.
	(mono_arch_create_trampoline_code): Remove most of the GENERIC_CLASS_INIT
	custom code.

	* mini-trampolines.c (mono_create_generic_class_init_trampoline): New
	helper function to return a generic class init trampoline.

	* method-to-ir.c mini.c: Use it.
	
	* tramp-amd64.c (mono_arch_create_generic_class_init_trampoline): New
	arch-specfic function to return a generic class init trampoline.

	* tramp-amd64.c (mono_arch_create_trampoline_code_full): Remove most of
	the GENERIC_CLASS_INIT custom code.

	* method-to-ir.c (mono_method_to_ir2): If RGCTX_REG is not defined, that is
	a fatal error, not a sharing failure.

	* tramp-<ARCH>.c (mono_arch_get_rgctx_lazy_fetch_offset): Removed, no longer
	needed.

	* mini-trampolines.c (mono_rgctx_lazy_fetch_trampoline): Get the additional
	trampoline argument from MONO_ARCH_VTABLE_REG.

	* tramp-x86.c (mono_arch_create_rgctx_lazy_fetch_trampoline): Change the
	order of the arguments to the C trampoline: pass 'slot' as the trampoline
	argument, and pass the vtable in VTABLE_REG.

	* tramp-amd64.c (mono_arch_create_rgctx_lazy_fetch_trampoline): Change the
	order of the arguments to the C trampoline: pass 'slot' as the trampoline
	argument, and pass the vtable in VTABLE_REG.
	(mono_arch_create_trampoline_code_full): Remove some special casing for
	the rgctx fetch trampoline.

	* mini.c (mono_method_to_ir): Fix the STELEM_ANY+null value optimization.
	Fixes #419273.

	* iltests.il: Add a test for it.

2008-08-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (compile_method): Enable AOT support for generics sharing.

	* method-to-ir.c (mono_method_to_ir2): Remove an aot restriction which is
	no longer needed.

	* mini-trampolines.c (mono_magic_trampoline): Add a sync wrapper here,
	use mono_jit_info_table_find () to avoid recursion.
	(mono_delegate_trampoline): Add a sync wrapper here.

	* method-to-ir.c (mono_method_to_ir2): Don't call mono_ldftn_nosyc
	here.

	* mini.c (mono_method_to_ir): Ditto.
	
	* mini-trampolines.c (mono_create_jit_trampoline_in_domain): Remove
	add_sync_wrapper argument. Don't add a sync wrapper here.
	(mono_create_jump_trampoline): Don't add a sync wrapper here.

	* jit-icalls.c (mono_ldftn_nosync): Removed, no longer needed.
	
2008-08-20  Bill Holmes  <billholmes54@gmail.com>

	* exceptions-amd64.c (seh_handler):  For Winx64 adding missing copy 
	  of nonvolatile registers back from MonoContext to CONTEXT.

	Contributed under MIT/X11 license.

2008-08-20  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (mono_arch_get_delegate_invoke_impl):  When shifting the
	  arguments on Winx64 there are only 4 argument registers.  For this
	  logic to work the last argument must be pulled from the stack.  

	Contributed under MIT/X11 license.

2008-08-20  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MONO_AOT_FILE_VERSION): Bump aot file format version.

	* aot-runtime.c aot-compiler.c patch-info.h mini.c: Get rid of
	MONO_PATCH_INFO_WRAPPER, encode/decode wrapper methods like the others in
	encode/decode_method_ref ().

	* aot-compiler.c (encode_patch): Handle STATIC_RGCTX_INVOKE wrappers.

	* aot-runtime.c (decode_patch): Ditto.	

	* mini.c (mono_resolve_patch_target): Handle RGCTX_FETCH sub-patches of type
	MONO_PATCH_INFO_METHOD.

	* aot-runtime.c (decode_exception_debug_info): Decode the contents of
	MonoGenericJitInfo.

	* aot-compiler.c (emit_exception_debug_info): Emit the contents of
	MonoGenericJitInfo.

	* method-to-ir.c (emit_imt_argument): Fix AOT+gshared support.

	* mini-amd64.c (add_valuetype): Use a dummy gsctx if we didn't receive
	one from the caller.

	* aot-runtime.c (decode_generic_inst): New function to decode and
	return a interned generic inst.
	(decode_klass_ref): Use it.
	(decode_method_ref): Ditto.

	* aot-compiler.c (emit_exception_debug_info): Save 
	jinfo->has_generic_jit_info too.

2008-08-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_output_basic_block): Add OP_FCONV_TO_I.

	* iltests.il.in: Add a test for fconv_to_i.

	* liveness.c: Disable the liveness2 pass for now to save space.

	* regalloc2.c: Include mempool-internals.h to fix warnings.

	* aot-compiler.c (encode_method_ref): Encode the context of generic
	instance methods.

	* aot-runtime.c (decode_method_ref): Inflate generic methods using
	the context saved in the aot file.

	* mini.h (MONO_AOT_FILE_VERSION): Bump aot file format version.

	* mini-x86.c (mono_arch_output_basic_block): Disable AOT for OP_JMP.

	* method-to-ir.c (mono_method_to_ir2): When using CEE_JMP, make arguments
	volatile so they won't be optimized away.

2008-08-19  Rodrigo Kumpera  <rkumpera@novell.com>

	* ssa.c:
	* ssa2.c:
	* mini.c:
	* regalloc2.c:
	* dominators.c: Remove duplicated functions that now are in
	mempool-internals.h.

2008-08-19  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Fix warnings.

	* aot-runtime.c (decode_klass_ref): Add support for VARs/MVARs.

	* aot-compiler.c (encode_klass_ref): Encode is_method too for VARs/MVARs.

	* method-to-ir.c (emit_get_rgctx_method): Use MONO_PATCH_INFO_METHODCONST
	as the patch type.

	* mini.c (mono_resolve_patch_target): Ditto.
	
	* aot-compiler.c (encode_patch): Add support for RGCTX_FETCH.
	(encode_klass_ref): Add support for encoding VARs/MVARs.

	* mini.c (mono_patch_info_dup_mp): Handle RGCTX_FETCH.

	* aot-runtime.c (decode_patch_info): Rename to 'decode_patch'. Split out
	the handling of the got entries into a separate 'decode_got_entry' function.
	Add support for RGCTX_FETCH.

	* tramp-amd64.c mini-amd64.h: Change the VTABLE_REG to RDI since RAX is
	clobbered by the trampoline code.

	* tramp-amd64.c mini-amd64.h: Change the VTABLE_REG to RAX since that is
	not clobbered by the indirect calling code.

2008-08-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_patch_code): Handle RGCTX_FETCH/GENERIC_CLASS_INIT
	to fix the build.

2008-08-18  Rodrigo Kumpera  <rkumpera@novell.com>

	* method-to-ir.c (mono_emit_method_call_full): Alloc the constructor
	signature using the compilation mempool otherwise we would leak it.

2008-08-18  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Emit the generic class inits using
	mono_emit_abs_call ().

	* patch-info.h: Add GENERIC_CLASS_INIT.

	* mini.c (mono_resolve_patch_target): Handle GENERIC_CLASS_INIT.

	* mini-amd64.c (emit_call_body): Treat abs calls which have a patch info
	as their target as a near call.

	* mini.c (mono_codegen): Handle patches stored in cfg->abs_patches in the
	ABS handling code.
	(mono_resolve_patch_target): Add support for MONO_PATCH_INFO_RGCTX_FETCH.

	* method-to-ir.c (mono_emit_abs_call): New helper function which emits a
	call to a runtime function described by a patch.

	* method-to-ir.c: Emit rgctx entry fetches and class init trampolines using
	mono_emit_abs_call, this has the advantage that the ABS handling code in
	mono_codegen () can handle them both, and can handle other stuff in the
	future without additional code.

	* mini.h (struct MonoJumpInfoRgctxEntry): New structure describing an rgctx
	entry.
	(MonoCompile): Add 'abs_patches' hashtable, which contains patches describing
	abs addresses.

	* mini.h: Add missing bblock related prototypes.

	* mini.h (MonoCompile): Remove unused reverse_inst_list and
	reverse_inst_list_len fields.

	* mini.c: Refactor this file a bit by moving branch optimizations to 
	branch-opts.c.

	* method-to-ir.c: Merge generic sharing changes missed earlier.

	* aot-compiler.c (is_shared_got_patch): Add MONO_PATCH_INFO_METHODCONST.

	* aot-runtime.c (decode_patch_info): Refactor the code dealing with the
	shared patches. Process METHODCONST as a shared patch.

	* liveness.c (mono_analyze_liveness): Disable the liveness2 code for now
	as it crashes on the 2.0 mscorlib.

	* aot-compiler.c (is_shared_got_patch): Revert the last change as it seems
	to cause crashes.
	
	* aot-compiler.c: Use is_plt_patch () in a few additional places.
	(is_shared_got_patch): Add MONO_PATCH_INFO_METHODCONST, which is generated
	by IMT.

	* aot-compiler.c: Reorganize the got handling code to be a bit more
	understandable.

2008-08-17  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Make the patch_to_plt_offset hash table use 
	mono_patch_info_equals/hash, and use it to massively simplify
	get_plt_index ().

	* mini.c (mono_patch_info_hash): Simplify this and add support for
	more patch types.

	* patch-info.h: Rename RGCTX_LAZY_FETCH_TRAMPOLINE to just RGCTX_FETCH.

	* mini.c aot-compiler.c aot-runtime.c: Revert the LAZY_FETCH_TRAMPOLINE
	handling code, since an offset is not enough to identify a trampoline.

	* method-to-ir.c: Remove some g_assert (!cfg->compile_aot) lines.

2008-08-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c (mono_op_imm_to_op): Add case for OP_IMUL_IMM.

	* method-to-ir.c (mono_method_to_ir2): Decompose OP_CKFINITE.

	* mini-ops.h: Argument and result types for OVF_CARRY ops.

	* decompose.c: PPC decompositions for various ops.

	* cpu-ppc.md, inssel-ppc.brg, mini-ppc.c: PPC changes for Linear IL.

2008-08-17  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_create_rgctx_lazy_fetch_trampoline): Make this
	call the generic trampoline code using a call, instead of a jump, to
	remove some special casing from the generic trampoline code.

	* mini.c (mono_resolve_patch_target): Handle LAZY_FETCH_TRAMPOLINE.
	(mono_codegen): Ditto.

	* aot-compiler.c aot-runtime.c: Ditto.

	* patch-info.h: Add MONO_PATCH_INFO_RGCTX_LAZY_FETCH_TRAMPOLINE.

	* mini-trampolines.c (mono_find_rgctx_lazy_fetch_trampoline_by_addr): New
	helper function to find the offset corresponding to a lazy fetch trampoline.

	* mini.h (MonoCompile): Add 'orig_method' field to hold the original method
	when doing generic sharing.

	* aot-compiler.c: Use cfg->orig_method instead of cfg->method in a lot of
	places.
	
	* mini.c (mono_create_rgctx_lazy_fetch_trampoline): Move this to
	mini-trampolines.c to be with the other trampoline creation functions.

	* method-to-ir.c (mono_emit_method_call): Remove the 'signature' argument
	as it is equal to method->signature in most cases, add a 
	mono_emit_method_call_full variant which takes a signature and an imt
	argument as well.

2008-08-16  Zoltan Varga  <vargaz@gmail.com>

	* jit-icalls.c (mono_helper_compile_generic_method): Don't pass the context
	to this function, since it could be computed easily from the method 
	argument.
	(mono_helper_compile_generic_method_wo_context): Removed, not needed any
	more.

	* method-to-ir.c mini.c: Remove references to 
	compile_generic_method_wo_context.

	* method-to-ir.c (mono_method_to_ir2): Enable AOT for virtual
	generic method calls.
	
	* method-to-ir.c (mono_method_to_ir2): Use mono_array_new_1 for 1
	dimensional non-szarrays.

	* mini.c (mini_init): Register mono_array_new_1.

	* jit-icalls.c (mono_array_new_1): New jit icall.

	* mini-trampolines.c (mono_magic_trampoline): For jumps, patch the GOT entries
	pointing to the method.

	* aot-runtime.c (mono_aot_get_method_from_token): Register GOT slots holding
	method addresses belonging to METHOD_JUMP patches in the 
	jump_target_got_slot_hash.
	(mono_aot_load_method): Ditto.

	* aot-compiler.c (compile_method): Allow AOT compilation of methods with
	METHOD_JUMP patches.

	* mini.c (mini_create_jit_domain_info): New helper function which 
	initializes/frees domain->runtime_info.
	(mini_free_jit_domain_info): Ditto.
	(mini_init): Install the domain hook functions with the runtime.

	* mini.h (MonoJitDomainInfo): New structure which stores the domain specific
	information maintained by the JIT.

	* mini.c (mono_resolve_patch_target): For PATCH_INFO_METHOD_JUMP, move the
	insertion into jump_table_hash into mono_codegen (), also implement proper
	locking.

	* method-to-ir.c (mono_method_to_ir2): Don't disable AOT for CEE_JMP and
	tail calls, it is already done by the aot code.
	
	* method-to-ir.c (mono_method_to_ir2): Handle CEE_JMP using the tail call
	mechanism on amd64.

	* iltests.il.in: Make the jmp test a bit more complex.

	* aot-compiler.c (encode_method_ref): Handle references to normal methods of
	generic instances which doesn't have a token.

	* aot-runtime.c (decode_method_ref): Ditto.
	
	* method-to-ir.c (handle_unbox_nullable): Don't disable AOT, the aot code
	can handle this case now.
	(handle_box): Ditto.

2008-08-15  Geoff Norton  <gnorton@novell.com>

	* mini-x86.c: Fix alignment on Apple x86, and re-disable the alignment
	debugging check.

2008-08-15  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Allow AOT compilation of methods
	calling generic methods.

	* aot-compiler.c (encode_patch): Handle MONO_PATCH_INFO_METHOD_RGCTX.

	* aot-runtime.c (decode_patch_info): Ditto.

	* mini.c (mono_resolve_patch_target): Ditto.
	
	* patch-info.h: Add METHOD_RGCTX.

	* mini-amd64.c (mono_arch_output_basic_block): Optimize LOCALLOC_IMM.

2008-08-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_call): Nullify call->vret_var if returning
	arguments in registers.

	* decompose.c (mono_decompose_vtype_opts): Create a var for the vreg in
	OP_VCALL too, don't depend on OP_OUTARG_VTRETADDR doing it.

	* mini.c (mini_method_compile): Abort aot compilation for generic
	methods if generic sharing is disabled.
	
	* mini.c (mono_method_to_ir): Disable AOT for virtual calls requiring
	an mrgctx.

	* method-to-ir.c (mono_method_to_ir2): Disable AOT for virtual calls 
	requiring an mrgctx.

	* decompose.c (mono_decompose_vtype_opts): Emit the correct sized
	store instructions when converting a vcall to a normal call.

	* mini.c (sigprof_signal_handler): Call mono_find_jit_info instead of
	mono_arch_find_jit_info.

2008-08-13  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (check_inline_called_method_name_limit): Optimize this to
	avoid calling mono_method_full_name () for every method even if the
	env var is not set.
	(check_inline_caller_method_name_limit): Ditto.

2008-08-12  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (main_thread_handler): Allow AOT compilation of multiple 
	assemblies in one run.

	* aot-compiler.c (mono_compile_assembly): Only print out a count of
	skipped methods if it is not 0.

	* Makefile.am (aotcheck): AOT compile all test assemblies in one run.

2008-08-12  Bill Holmes  <billholmes54@gmail.com>

	* mini.c (mono_codegen):  Changing a preprocessor check from WIN64 to
	  MONO_ARCH_HAVE_UNWIND_TABLE.

	Contributed under MIT/X11 license.

2008-08-12  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (mono_arch_cpu_optimizazions):  Remove peephole and branch
	  from default optimizaton list on Winx64.

	* mini-amd64.c (emit_tls_get):  Added Winx64 specific implementation for GetTLS.

	* mini-amd64.c (mono_arch_emit_prolog):  Adding an offset on Winx64 to get
	  the LMF from the MonoJitTlsData structure.

	* mini-amd64.c (mono_arch_setup_jit_tls_data):  Added Winx64 implementation.

	Contributed under MIT/X11 license.

2008-08-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (sigsegv_signal_handler): Fix the build.

	* mini-amd64.c (emit_call_body): Use image->aot_module instead of 
	assembly->aot_module.

	* aot-runtime.c: Use image->aot_module instead of searching in the aot_modules
	hash table. This simplifies and speeds up a lot of code, and fixes support
	for .netmodules.

	* mini.c (SIG_HANDLER_SIGNATURE): Avoid crashes if the thread is not registered
	with the runtime.

	* mini-exceptions.c: Ditto.
	
	* exceptions-*c.c (mono_arch_find_jit_info): Remove unused 'trace' and
	'native_offset' argument, since these are computed in the 
	mono_find_jit_info () function.

	* mini-exceptions.c (mono_find_jit_info): Make this non-static, as it
	is used by exceptions-ppc.c.

	* exceptions-ppc.c: Call mono_find_jit_info () instead of 
	mono_arch_find_jit_info ().
	
	* mini-ppc.h exceptions-ppc.c mini-mips.h mini-mips.c exceptions-mips.c
	mini-exceptions.c: Get rid of the CUSTOM_STACK_WALK stuff, use the
	generic code in mini-exceptions.c.

2008-08-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_flush_register_windows): Add this for ppc.

	* aot-runtime.c (mono_aot_get_plt_info_offset): Fix a warning.
	
	* aot-runtime.c (mono_aot_get_method): Avoid doing all the loading inside
	the aot lock, to avoid deadlocks when mono_aot_get_class_from_name () is
	called while holding the loader lock. Fixes #415608.
	(mono_aot_get_method_from_token_inner): Ditto.

2008-08-09  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-ppc.c (mono_jit_walk_stack): Use MONO_INIT_CONTEXT_FROM_CURRENT
	to reduce differences between this and the generic implementation in
	mini-exceptions.c.
	(ves_icall_get_frame_info): Ditto.

	* mini-ppc.h (MONO_INIT_CONTEXT_FROM_CURRENT): Define this for ppc too.

	* mini-exceptions.c (mono_exceptions_init): Remove an #ifdef which is no
	longer neccesarry.

	* exceptions-ppc.c (arch_get_call_filter): Rename this to 
	mono_arch_get_call_filter () and make it non-static, for consistency with the
	other architectures.

2008-08-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c:
	* local-propagation.c:
	* mini-x86.c: Correct the name of arch defines.

2008-08-09  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_op_to_op_imm_noemul): Correct name of
	NO_EMULATE_LONG_SHIFT_OPS define.

2008-08-08  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Remove some code from CEE_MONO_LDPTR
	now that aot-ed icall wrappers use CEE_MONO_ICALL_ADDR.

	* aot-compiler.c aot-runtime.c: Add support for static aot compilation.
	MACH fixes. Merged from the 2.0 branch.

	* method-to-ir.c (mono_method_to_ir2): Handle CEE_MONO_ICALL_ADDR.

	* mini.c (mono_resolve_patch_target): Error out if an icall is not found.
	(mono_method_to_ir): Handle CEE_MONO_ICALL_ADDR.

	* exceptions-arm.c (mono_arch_get_throw_exception_generic): Add AOT support.

	* method-to-ir.c mini.c driver.c aot-compiler.c: Update after
	mono_marshal_get_native_wrapper () signature changes.

2008-08-07  Rodrigo Kumpera  <rkumpera@novell.com>

	* jit-icalls.c (mono_fconv_ovf_u8): Work around soft-float double to long
	conversion bug under arm.

2008-08-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-arm.md: Increase long_conv_to_ovf_i4_2 max length to 36.

	* mini-arm.c (mono_arch_output_basic_block): Implement long to int conversion
	with overflow checking.

2008-08-05  Marek Habersack  <mhabersack@novell.com>

	* Makefile.am (GENMDESC_PRG): when cross-compiling use full path
	to the genmdesc.pl file

2008-08-05  Zoltan Varga  <vargaz@gmail.com>

	* ir-emit.h (EMIT_NEW_ARGSTORE): Fix the usage of param_types and
	arg_array in the soft-float versions of the LOAD/STORE macros.

	* method-to-ir.c (mono_method_to_ir2): Fix a warning in the arm switch
	implementation.

	* ir-emit.h (NEW_VARLOADA): Handle SOFT_FLOAT correctly.

2008-08-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (add_valuetype): Only reserve half parameter slot for each member of
	a float HFA. Fixes #413621.

2008-08-02  Gert Driesen  <drieseng@users.sourceforge.net>

	* mini-x86.c (mono_arg_get_argument_info): Rename last occurrence of
	frame_size to args_size. Fixes build.

2008-08-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_argument_info): Rename frame_size to args_size,
	and don't align it to MONO_ARCH_FRAME_ALIGNMENT.

	* mini-x86.h: Change MONO_ARCH_FRAME_ALIGNMENT to 8 so doubles stored on
	the stack are not unaligned. Fixes #413247.
	
Fri Aug 1 18:46:42 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini.c: update jitted methods performance counters.

Fri Aug 1 16:30:37 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: increase the exceptions thrown performance
	counter in mono_handle_exception ().

2008-07-29  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c: Use MonoImage's as keys in the aot_modules hash so the aot
	can work with netmodules.

2008-07-28  Geoff Norton  <gnorton@novell.com>

	* mini-x86.h: Correct the frame alignment on OSX.  Fixes the jit 
	regression tests.

2008-07-28  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_call): Emi the osx stack alignment at the
	correct place.

2008-07-28  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (get_call_info): Winx64 fix for passing floats.
	  The float param registers and other param registers must be the 
	  same index on Windows x64.

	* mini-amd64.c (mono_arch_allocate_vars) : Implementing the 
	  ArgValuetypeAddrInIReg argument case.  Setting the argument
	  op to OP_VTARG_ADDR (OP_REGOFFSET)).

	* mini-amd64.c (mono_arch_call_opcode) : Winx64 fix.  Use the size
	  variable computed above as the copy length for arguments of storage
	  type ArgValuetypeAddrInIReg.

	* mini-amd64.c (mono_arch_emit_call) :  Implementing the 
	  ArgValuetypeAddrInIReg argument case.  This case will rely on
	  mono_arch_emit_outarg_vt to emit the correct code later in the process.

	* mini-amd64.c (mono_arch_emit_call) :  On Winx64 there always needs to be
	  a 32 byte stack allocation for all calls.  We will omit the adjustment for
	  jump and tail call instructoins as they do not follow the typical call behavior.

	* mini-amd64.c (mono_arch_emit_outarg_vt) :  Implementing the case for
	  ArgValuetypeAddrInIReg.  The code emitted will copy the argument to a 
	  local variable and pass the local variable by reference to the called method.

	* mini-amd64.c (mono_arch_emit_prolog, emit_load_volatile_arguments) :
 	  Implementing the ArgValuetypeAddrInIReg argument case.  When the address
 	  of a struct is passed in a register it must be saved with the other
 	  volatile argument on the stack.

	* mini-amd64.c (mono_arch_emit_prolog) : Winx64 fix.  When omitting the
	  frame pointer the stack adjustment value must be saved to the unwind 
	  info structure.

	Contributed under MIT/X11 license.

2008-07-28  Zoltan Varga  <vargaz@gmail.com>

	* inssel-x86.brg (stmt): Add missing OP_X86_OUTARG_ALIGN_STACK rule
	which got lost in the merge.

2008-07-27  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c: Make the helper_sig variables extern to fix the ppc
	build.

	* mini-amd64.c (emit_call_body): Add a no_patch case missed earlier.
	
	* mini-amd64.c (emit_call_body): Avoid aligning the call instruction on
	icalls, since they won't be patched.

	* exceptions-amd64.c (mono_arch_get_restore_context_full): Use a slightly
	different code sequence when running under valgrind to prevent some valgrind
	errors.

	* iltests.il.in: Add new regression test.

	* method-to-ir.c (mono_method_to_ir2): Fix handling of inlined methods which
	end with a throw.

	* method-to-ir.c (mono_method_to_ir2): Use get_vreg_to_inst () instead of
	accessing cfg->vreg_to_inst directly to prevent a crash in LDFLD.

	* iltests.il.in: Add new test.

	* aot-compiler.c: Fix some warnings.

	* decompose.c (mono_decompose_long_opts): Implement OP_ICONV_TO_OVF_I8_UN.
	Fixes #412494.

2008-07-27  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Fix the --gc=none build. Fixes #412482.
	(mini_usage_jitdeveloper): Add a missing --wapi option.

2008-07-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c: Simplify the is_fp macros.
	(free_up_ireg): Remove, use free_up_reg instead.
	(free_up_reg): Fix the fp case.

2008-07-26  Zoltan Varga  <vargaz@gmail.com>

	* cpu-arm.md (loadr8_membase): Increase the length of this as this is not
	lowered earlier.

	* exceptions-x86.c: Merge some changes which seemed to have got lost
	in the linear-ir merge.

	* liveness.c: Disable the liveness2 pass on 32 bit platforms.

	* method-to-ir.c (mono_handle_global_vregs): Make the component vregs of a
	long vreg volatile even if the variable was already created.

	* liveness.c (update_liveness2): Avoid eliminating dead definitions of
	volatile variables.

2008-07-26  Zoltan Varga  <vargaz@gmail.com>

	* cpu-x86.md (fcall_membase): Increase the size of the fcall opcodes.

	* mini.c (mono_jit_compile_method_inner): Add support for 
	MONO_EXCEPTION_BAD_IMAGE.

	* method-to-ir.c (mono_method_to_ir2): Avoid a crash if 
	mini_method_get_context () returns NULL. Fixes #356531.

	* mini.c (mono_method_to_ir): Ditto.
	
	* method-to-ir.c (mono_method_to_ir2): Create a variable if needed when
	accessing a field of a valuetype in LDFLD/STFLD. Fixes #412399.

2008-07-25  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Initialize an uninitialized variable
	in the LDFTN implementation.

2008-07-25  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): When sharing generic
	code, patch calls to icalls, too, even if they're not in the
	shared generic code hash.  Fixes #411962.

2008-07-25  Zoltan Varga  <vargaz@gmail.com>

	* cpu-x86.md: Increase the length of the fcall opcodes.

	* mini-x86.c (emit_move_return_value): Avoid some precision issues for
	calls returning floats.

	* method-to-ir.c (mono_method_to_ir2): Remove the generic sharing restrictions
	on NEWARR.
	
	* method-to-ir.c (mono_method_to_ir2): Merge some LDFTN gsharing changes
	missed earlier.

	* method-to-ir.c (handle_delegate_ctor): Avoid putting dynamic methods
	into the domain->method_code_hash.

	* aot-compiler.c: Fix win32 build.

	* method-to-ir.c (EMIT_GET_RGCTX): Call EMIT_NEW_LDARG in emit_get_rgctx ().
	
	* method-to-ir.c (mono_method_to_ir2): Use mono_array_new_specific in the
	gshared NEWARR implementation.

	* cpu-sparc.md: Remove duplicate localloc_imm opcode.

	* ir-emit.h (NEW_ARGLOAD): Use cfg->args and cfg->arg_types so this macro
	can be used outside of method_to_ir.

	* mini.h (MonoCompile): Add arg_types field.

	* method-to-ir.c (inline_method): Save/Restore cfg->args and cfg->arg_types.
	
	* method-to-ir.c (mono_method_to_ir2): Set cfg->args and cfg->arg_types to
	the values of the local arg_array and param_types array.

2008-07-24  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Allocate a GOT var for NEWOBJ, since
	got accesses might only get generated later when NEWOBJ is decomposed.
	
	* method-to-ir.c (handle_delegate_ctor): Add an optimization to avoid
	looking up the native code of the target method when a delegate is called
	for the first time.

	* mini-trampolines.c (mono_delegate_trampoline): Add the other half of the
	optimization.

	* debug-debugger.c (MONO_DEBUGGER__debugger_info): Fix a warning.

	* aot-runtime.c aot-compiler.c: Add a new option 'no-dlsym' which makes
	AOT work on platforms without a working dlsym implementation.

	* mini.h: Bump AOT image format version.
	
2008-07-24  Mark Probst  <mark.probst@gmail.com>

	* mini-exceptions.c: Free a MonoType with
	mono_metadata_free_type() instead of g_free().

	* aot-runtime.c: Free a MonoType.

2008-07-24  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Add a comment for the box+brtrue
	optimization.

	* mini-codegen.c (mono_local_regalloc): Remove the remaining items from the
	fp stack on x86.

2008-07-23  Massimiliano Mantione  <massi@ximian.com>
	* mini.c (sigprof_signal_handler): call the new "runtime initialized"
	profiler hook.

2008-07-23  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): Set the stack type properly for
	NEWOBJ calls on valuetypes.

	* iltests.il.in: Add new test.

	* mini-x86.c (mono_arch_emit_call): Use mini_type_stack_size ().

2008-07-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c: Fix some warnings. Remove one ia64 special case as it
	is no longer needed.

	* mini-ia64.c (mono_arch_emit_prolog): In native-to-managed wrappers, widen
	non register sized integer arguments.
	(mono_arch_call_opcode): Add support for ArgInFloatRegR4.
	(mono_arch_emit_outarg_vt): Pass a more reasonable alignment to 
	emit_memcpy2 ().

	* method-to-ir.c (mono_method_to_ir2): Handle the ret_var_is_local case in
	CEE_MONO_RETOBJ.
	
	* method-to-ir.c (ADD_WIDEN_OP): New macro to insert a widening op when
	two a binop with different sized arguments is emitted.

	* mini.c (mono_bblock_insert_after_ins): Properly link up with the next
	instruction in the ins==NULL case.

2008-07-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Add OP_X86_OUTARG_ALIGN_STACK.

	* mini-x86.c: Fix osx build.

	* mini-amd64.c (mono_arch_output_basic_block): Handle varargs in the CALL_REG
	opcodes as well.

	* method-to-ir.c (mono_spill_global_vars): Avoid fusing a load+store into the
	instruction for non int sized variables.

	* method-to-ir.c (mono_method_to_ir2): Fix an assert in the LDFLD
	implementation.

2008-07-23  Robert Jordan  <robertj@gmx.net>

	* method-to-ir.c: Fix MSVC build.

2008-07-22  Zoltan Varga  <vargaz@gmail.com>

	* method-to-ir.c (mono_method_to_ir2): When calling native code which returns
	a non int sized type, widen it to an int since newer versions of gcc seem to
	generate code which needs this.

	* ssa2.c abcremoval2.c: Fix warnings.

	* *: Merge the Linear IR branch.

	The original branch is at trunk/branches/vargaz/mini-linear-il, and
	the ChangeLog file there describes all the changes done over the years. 
	Further documentation can be found at www.mono-project.com/Linear_IL.

2008-07-21  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (get_call_info): Winx64 fix for passing floats.
	  The float param registers and other param registers must be the 
	  same index on Windows x64.

	Contributed under MIT/X11 license.

2008-07-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c: Make the previous fix GC safe.

2008-07-21  Raja R Harinath  <harinath@hurrynot.org>

	* Makefile.am (version.h): Allow a trailing '/' in the repository URL.

2008-07-21  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c (get_call_info): Correcting the case for MONO_TYPE_TYPEDBYREF
	  on Winx64.  This type will not be passed on the stack (ArgOnStack), but 
	  ArgValuetypeAddrInIReg instead.

	Contributed under MIT/X11 license.

2008-07-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (get_register_spilling): Fix a warning.

2008-07-17  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c: Use mono_runtime_class_init_full to avoid leaking memory
	for types which the initialization fails. Raises the provided exception
	at the right stop after cleanup.

2008-07-16  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Free most of the memory allocated during compilation.

	* mini.c (mini_parse_debug_options): Fix a leak.
	
	* mini.c (mini_method_compile): Don't add the method to the jit info tables
	during aot compilation.

2008-07-14  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Disable aot for code using CCASTCLASS on x86 as 
	it has too much register pressure.

2008-07-13  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (CEE_CASTCLASS): Remove some dead code.

2008-07-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.h aot-compiler.c aot-runtime.c: Store the plt info offset inline
	on x86.

	* mini-amd64.h aot-compiler.c aot-runtime.c: Store the plt info offset inline
	on amd64 similar to the way it is done on arm.

	* mini.h (MONO_AOT_FILE_VERSION): Bump AOT file format version.

	* aot-runtime.c (load_aot_module): Rename 'info' to 'amodule' for 
	consistency, normalize error messages, avoid loading aot-only modules in
	normal mode.

	* driver.c (mono_main): Rename --aot-only command line option to --full-aot
	for consistency.

	* aot-compiler.c aot-runtime.c tramp-arm.c: Implement aot-only support.

2008-07-11  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h
	(MonoDebuggerInfo): Add `interruption_request'.

2008-07-12  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_plt): Remove some dead code.

	* exceptions-arm.c (mono_arch_get_call_filter_full): Initialize ji.

	* aot-runtime.c (mono_aot_get_plt_info_offset): New helper function to
	return the plt info offset belonging to a given plt entry.

	* mini-trampolines.c (mono_aot_plt_trampoline): Use 
	mono_aot_get_plt_info_offset.
	
	* aot-runtime.c aot-compiler.c tramp-arm.c: Change the arm plt code to be
	similar to the amd64 code by makeing jumps through a separate jump table 
	instead of embedding the jump addresses into the code.

2008-07-11  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Disable aot for calling ldtoken in a generic
	method.

2008-07-10  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_method_compile): Disable generics sharing when
	running in the debugger.

2008-07-10  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Create the got var in CEE_REFANYVAL.

	* inssel.brg (CEE_CASTCLASS): Avoid reusing temporary registers to prevent
	the local register allocator from running out of registers on x86 when 
	using aot.

2008-07-10  Bill Holmes  <billholmes54@gmail.com>

	* inssel-long.brg For OP_LCONV_TO_OVF_I4 an int cast is needed when 
	expressing IntMin for the VS Compiler.  See Compiler Warning (level 2) 
	C4146.

	Contributed under MIT/X11 license.

2008-07-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Get rid of whitespace in the generated assembly file to
	speed up the assembler.

2008-07-09  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.h tramp-arm.c exceptions-arm.c aot-compiler.c: Beginnings of aot-only
	support.

	* mini.c: Move the soft float handling macros a bit earlier, add 
	NEW_TEMPSTORE_SOFT_FLOAT macro, fix warnings, add soft-float support in one
	place.

	* mini.h: Add prototype for mono_arch_fixup_jinfo.

	* mini.c (mini_init): In aot-only mode, set the root domain code manager to
	read-only to help catch code allocation requests.
	
	* mini.c inssel.brg aot-compiler.c: Make the use of IMT runtime configurable,
	and turn it off when using --aot-only or when compiling with --aot=full.

	* mini.c (mono_resolve_patch_target): In aot-only mode, allocate the
	jump table for switches from the normal domain mempool, not the code
	manager.

	* mini-trampolines.c (get_unbox_trampoline): New function to return an
	unbox trampoline which handles aot-only mode too.

	* aot-runtime.c (mono_aot_get_unbox_trampoline): New function to lookup
	an AOTed unbox trampoline.

	* aot-compiler.c (emit_trampolines): Emit unbox trampolines.

2008-07-09  Bill Holmes  <billholmes54@gmail.com>

	* wapihandles.c: Fixing MSVC builds.  Include statement changed from <> to
	""

	Contributed under MIT/X11 license.

2008-07-09  Bill Holmes  <billholmes54@gmail.com>

	* mini.c (mono_codegen):  Allocate space at the end of the code block and store
	  the unwind information for the method at the end of the allocated block.
	  
	* mini-amd64.h: Added declarations for the unwind routines and adding field to 
	  MonoCompileArch to hold the unwind info for SEH on Winx64
	
	* mini-amd64.c (mono_arch_emit_prolog): Calls to the unwind routines added to store
	  frame pointer info for the method being compiled.
	  
	* exceptions-amd64.c (mono_arch_get_throw_corlib_exception): Added a stack adjustment before
	  the call to mono_exception_from_token.
	  
	* exceptions-amd64.c: Added mono_arch_unwindinfo* implementations.  This code is responsible
	  storing the method prolog information in a format that the Winx64 SEH can understand.  This
	  information is stored a the end of the method block because it is all 32-bit offset based.

	Contributed under MIT/X11 license.

2008-07-09  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Remove duplicate definitions of the mini_wapi_ functions.

	* wapihandles.c: Fix warnings.

	* aot-runtime.c (load_aot_module): Add a missing error message in aot-only
	mode.

	* mini-trampolines.c (mono_create_jit_trampoline_in_domain): Avoid calling 
	mono_jit_compile_method in aot-only mode since that calls the type 
	initializer.
	
	* mini-trampolines.c (mono_create_delegate_trampoline): Avoid calling
	get_delegate_invoke_impl in aot-only mode.

	* mini.c (mono_global_codeman_reserve): Reenable the aot-only check.

2008-07-08  Zoltan Varga  <vargaz@gmail.com>

	* trace.c (mono_trace_enter_method): Fix printing of Type instances.

	* aot-compiler.c (compile_method): Disable the check for GSHARED since it
	is on by default.

	* inssel-long.brg (reg): Add a rule for LCALL_REG (OP_I8CONST).

	* tramp-amd64.c (mono_arch_nullify_plt_entry): Read the nullified class
	init trampoline from the AOT file as well.

	* mini-amd64.c (mono_arch_register_lowlevel_calls): Register
	mono_amd64_throw_exception as a jit icall since it is needed by the aot-only
	code.

	* mini.c (mini_init): Move the call to mono_exceptions_init () after 
	mono_init.

	* exceptions-amd64.c: Add _full variants for the remaining exception code
	creation functions as well, allow emission of relocatable code, remove
	caching since that is now done by the caller.

	* mini-exceptions.c: Add _full variants for the remaining exception code
	creation functions as well, add aot-only support.

	* aot-compiler.c (compile_method): Allow calls to methods of constructed types
	if we can determine a proper token for them.
	(add_wrappers): Add a few more wrappers.
	(emit_method_code): Remove some dead code.
	(emit_trampolines): Emit exception code too.

	* mini.c (mono_method_to_ir): Call mono_array_new_2 if possible.

	* jit-icalls.c (mono_array_new_2): New jit icall, specialized version of
	mono_array_new_va which avoids varargs.

	* mini-exceptions.c (mono_exceptions_init): Fix the ppc build.

	* mini-trampolines.c: Call mono_create_specific_trampoline () instead of
	mono_arch_create_specific_trampoline () in all places.

	* aot-compiler.c aot-runtime.c: Refactor the trampoline emitting/loading code
	a bit so it can be used for other things as well.
	
	* mini-exceptions.c (mono_exceptions_init): Initialize throw_exception_by_name
	on demand as well.

	* exceptions-amd64.c: Rename the caching from the exception code creation
	functions, it is done by the caller instead.
	
	* exceptions-amd64.c: Change the signature of the exception code creation 
	functions to allow the creation of relocatable code later.

	* mini-exceptions.c: Add a set of functions to query the various 
	runtime-generated exception functions.

	* mini.c mini-exceptions.c: Use the newly added functions instead of the
	mono_arch_.. () functions.
	
2008-07-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_aot_get_trampoline_code): Removed, no longer used.

	* aot-runtime.c aot-compiler.c: AOT the generic trampolines in aot-only mode.

	* mini.c (mini_get_imt_trampoline): Call mono_create_specific_trampoline ().
	(mini_get_vtable_trampoline): Ditto.

	* tramp-amd64.c (mono_arch_create_trampoline_code_full): Create relocatable
	code in the AOT case by returning the code size and a list of relocations to
	the caller.

	* mini-trampolines.c (mono_create_specific_trampoline): New helper function.

2008-07-07  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c:  On Winx64 the calling convention always requires the caller to 
	  clean the stack.

	Contributed under MIT/X11 license.

2008-07-07  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_exception_debug_info): Serialize the debug info first
	so the buffer size can be computed correctly. Fixes #404735.

	* debug-mini.c (mono_debug_serialize_debug_info): Lookup the debug info
	normally as cfg->debug_info is already freed.

2008-07-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c: For calls returning vtypes in registers, don't store
	the return address on the stack, instead allocate a separate local for
	it. Fixes #404729.

2008-07-05  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c, mini.h: Add an argument to
	mono_create_jit_trampoline_in_domain() for turning off the adding
	of the sync wrapper.

	* mini.c: Use the JIT trampoline without sync instead of
	ldftn_nosync in static RGCTX invoke wrappers so that the call can
	be patched.

2008-07-04  Mark Probst  <mark.probst@gmail.com>

	* driver.c: Turn on GSHARED optimization by default.

2008-07-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c mini.c mini.h tramp-<ARCH>.c: Rename MONO_TRAMPOLINE_GENERIC
	to MONO_TRAMPOLINE_JIT since it better reflects what it does.

	* mini-trampolines.c (mono_get_aot_trampoline_code): New internal function to
	create a variant of the generic trampoline code callable from AOTed trampolines.

	* tramp-amd64.c (mono_arch_create_trampoline_code_full): Add support for generic
	trampoline code callable from AOTed trampolines.

	* aot-compiler.c aot-runtime.c: Add support for AOTing trampolines.

2008-07-04  Mark Probst  <mark.probst@gmail.com>

	* inssel.brg, mini-ops.h: New opcode for doing CHECK_THIS in a
	pass-through manner.

	* mini.c: Generic method sharing.  Pass MRGCTX to generic methods
	and don't fail sharing for them anymore.

	* mini-exceptions.c: Handle exceptions in shared generic methods.

	* generic-sharing.c: When checking the context of a generic
	method, also check its class's context.  Don't treat wrappers as
	sharable.

	* mini-trampolines.c: Some code factored out to
	metadata/generic-sharing.c.  Handle the MRGCTX case.

	* jit-icalls.c, jit-icalls.h: ldvirtfn icall for generic sharing -
	we must deal with the method being of another instantiation of the
	class.  Add static rgctx invoke wrappers to generic methods.

2008-07-04  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Provide all jit infos of generic shared methods with a
	generic jit info.

	* mini-exceptions.c: Handle the new situation that a generic info
	might be available, but not info about the this/vtable/mrgctx
	variable.

2008-07-03  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Don't accept ldftn and ldvirtftn with uninstantiated
	generic methods.

2008-07-03  Zoltan Varga  <vargaz@gmail.com>

	* dominators.c (check_dominance_frontier): Fix a warning.

	* mini.h: Add some missing prototypes.

	* ssa.c local-propagation.c debug-debuger.c: Fix warnings.

	* driver.c (mono_jit_init_version): Correct the comments since the first
	argument should be the name of the root domain, not a filename.

	* aot-runtime.c (make_writable): Error out if this is called while running
	with --aot-only.
	(load_aot_module): Ditto.

	* aot-compiler.c: Really fix the computation of method indexes.

	* mini-amd64.c (mono_arch_get_delegate_invoke_impl): Remove the previous 
	optimizations as this is no longer called frequently.

	* mini-trampolines.c (mono_create_delegate_trampoline): Precompute the invoke
	method and the invoke impl code and pass it to the delegate trampoline instead of
	just the delegate class.

2008-07-02  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Fixup the computation of method indexes.
	(add_wrappers): Create the base methods of the runtime invoke wrappers using
	the method builder infrastructure.

	* aot-runtime.c (decode_exception_debug_info): Don't crash if the method
	has no header.

	* mini-trampolines.c (mono_create_jit_trampoline_in_domain): In aot-only
	mode, load the method right away instead of creating a trampoline.

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): Eliminate locking.

	* mini-amd64.c (mono_arch_get_delegate_invoke_impl): Eliminate locking, speed up
	some checks a bit.

2008-07-01  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (decode_patch_info): Don't create trampolines in aot_only mode.
	(mono_aot_load_method): Use method_index instead of method->token.

	* mini.c (mono_jit_compile_method_inner): Move the aot_only check down, so it
	can handle icalls etc. properly.

	* mini.h (MONO_AOT_FILE_VERSION): Bump AOT file format version.

	* aot-compiler.c aot-runtime.c: Allow AOTing many wrapper types.

	* mini.c (mono_resolve_patch_target): Handle JIT_ICALL_ADDR.
	(mono_codegen): Convert calls made by JIT icall wrappers to the icalls into
	JIT_ICALL_ADDR patch type.

	* patch-info.h: Add JIT_ICALL_ADDR patch type.

	* mini.c (mono_method_to_ir): Allow AOTing methods which access the interruption
	request flag.
	(mono_resolve_patch_target): Handle INTERRUPTION_REQUEST_FLAG.

	* patch-info.h: Add INTERRUPTION_REQUEST_FLAG.

2008-06-30  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Use domain->jit_code_hash_lock for controlling access to
	domain->jit_code_hash.

2008-06-29  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_parse_debug_options): Add 'dont-free-domains' option.

2008-06-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline): Don't pass a gsctx to
	get_this_arg_from_call, let it compute it when needed.

	* mini-amd64.c (mono_arch_get_this_arg_reg): Add a 'code' argument, compute
	gsctx from code only when needed.

	* mini-trampolines.c (get_generic_context): Rename this to 
	mono_get_generic_context_from_code (), and move it to generic-sharing.c, where
	it can be called by the arch backends.

	* mini-exceptions.c (mono_print_thread_dump): Allow the argument to be NULL.

2008-06-26  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Add experimental --aot-only command line option.

	* mini.c: Error out when creating trampolines or JIT compiling if --aot-only is
	set.

2008-06-26  Kornel Pal  <kornelpal@gmail.com>

	* driver.c (DllMain): Remove mono_module_handle.

	Contributed under MIT/X11 license.

2008-06-25  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Add not-yet-usable 'full' option. Add some infrastructure code
	for emitting methods which are not in the source assembly. Detect and report
	failure of assembling+linking.
	
	* aot-compiler.c (emit_klass_info): Call mono_class_setup_vtable ().

	* aot-compiler.c: Move the contents of the has_glot_slots array to MonoCompile.

2008-06-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c: Check if stats is enabled so we don't allocate memory when not needed.

2008-06-24  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Remove some obsolete prototypes.

	* mini.c: Avoid storing MonoMethod pointers in the JIT stats, store their string format instead.

2008-06-24  Mark Probst  <mark.probst@gmail.com>

	* mini.c (get_object_generic_inst): Variable-sized arrays are not
	supported by Visual Studio, so use alloca().

2008-06-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (add_valuetype): Increase *gr too when passing a HFA to be in sync with the ABi.
	Fixes #402585.

2008-06-23  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Fail sharing of a generic method if it contains an open
	catch clause (because we don't pass MRGCTXs yet).

2008-06-23  Mark Probst  <mark.probst@gmail.com>

	* mini.c: When compiling a method with generic sharing, insert the
	method instantiated with an all-Object generic context into the
	jit info table, instead of the context of the first instantiation
	of the method we happen to compile.

2008-06-18  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Replaced `version' with
	`major_version' and `minor_version'.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* generic-sharing.c, mini.c, mini.h, aot-runtime.c:
	mono_method_is_generic_sharable_impl() takes an additional
	argument specifying whether to treat type variables as reference
	types.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.h: Removed obsolete prototypes.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Don't fail generic sharing for initobj and sizeof - we
	already handle them.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.h, mini-trampolines.c, tramp-alpha.c, tramp-amd64.c,
	tramp-arm.c, tramp-hppa.c, tramp-ia64.c, tramp-mips.c,
	tramp-ppc.c, tramp-s390.c, tramp-s390x.c, tramp-sparc.c,
	tramp-x86.c: Added a MonoGenericContext* argument to
	mono_arch_get_unbox_trampoline() so that it can call other
	functions which require it.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.h, mini-trampolines.c, mini-amd64.c, mini-x86.c,
	mini-alpha.c, mini-arm.c, mini-ia64.c, mini-ppc.c:
	mono_arch_get_this_arg_from_call() takes a
	MonoGenericSharingContext* as well.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Factor out code for emitting unbox into emit_unbox() and
	implement generic sharing of unbox.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Don't compute the vtable to determine whether a field is
	special static, because it might not work for open types.

2008-06-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Removed the unused token_type and token_source arguments
	from get_runtime_generic_context_ptr().

2008-06-17  Marek Habersack  <mhabersack@novell.com>

	* mini.c (ADD_BINOP): fix the build

2008-06-16  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (ADD_BINOP): When operating on a native int and an int32, insert
	a widening op.

2008-06-16  Mark Probst  <mark.probst@gmail.com>

	* mini.h: Removed class relations enum that's not used anymore.

2008-06-16  Mark Probst  <mark.probst@gmail.com>

	* tramp-x86.c, tramp-amd64.c: Slot access code for MRGCTXs.

	* mini-trampolines.c: Distinguish between RGCTXs and MRGCTXs in
	the lazy fetch trampoline access code.

2008-06-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_local_regalloc): Add some micro optimizations.

2008-06-14  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Fix some soft-float bugs. Fixes #378735 and #398348.

	* mini.h (MONO_INST_LIST_ENTRY): Fix warnings on arm.

	* mini.c (mono_method_to_ir): Check call signature for NEWOBJ as well.

2008-06-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c inssel-x86.brg cpu-x86.md: Implement unsigned min/max
	intrinsics.

	* mini-ops.h: Add MIN/MAX_UN opcodes.

	* mini-amd64.c inssel-amd64.brg cpu-amd64.md: Implement unsigned min/max
	intrinsics.

	* basic-math.cs: Add more min/max tests.

	* inssel.brg: Remove the OP_MIN/OP_MAX rules. Fix a warning.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Small fix in the prologue of emit_castclass.

2008-06-13  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg: Remove the OP_MIN/OP_MAX rules. Fix a warning.

	* mini.c (mini_get_inst_for_method): Remove the Min/Max intrinsics, they
	do not work even for unsigned types. Fixes #400014.

	* basic-math.cs: Add regression tests for unsigned Min/Max.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Added additional context_used argument to several
	functions, which will be needed for sharing generic methods.  Use
	GET_RGCTX macro wherever appropriate.  Declare only one
	context_used in mono_method_to_ir().

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c, generic-sharing.c: Removed generic class relations.

	* mini.c, tramp-amd64.c, tramp-x86.c: Additional arguments to
	functions due to MRGCTX changes.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* inssel.brg, inssel-long.brg, inssel-long32.brg, mini-ops.h,
	graph.c, local-propagation.c, aliasing.c: New opcodes for calls
	with calculated IMT.

	* mini.c: Generic sharing of calls via generic interfaces.

	* jit-icalls.c, jit-icalls.h: Helper function for compiling a
	generic method with non-constant MonoGenericContext*.  Instead,
	the context is taken out of the method itself.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of ldvirtftn.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of ldftn.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Do pass VTable/RGCTX argument to static generic methods.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of the special case of ldtoken followed
	by a call to GetTypeFromHandle.

2008-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of box for nullable types.

2008-06-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390x.c (add_stackParm): Fix computation of offsets when arguments
	are passed on the stack. Fixes #324807.

2008-06-12  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c:add_valuetype: Adding Winx64 code to fill the ArgInfo
	for the ArgValuetypeAddrInIReg case.

	* mini-amd64.c:mono_arch_allocate_vars:  Adding a case for 
	ArgValuetypeAddrInIReg to avoid asserts.  Code needs to be added here.

	* mini-amd64.c: mono_arch_call_opcode:  Adding Winx64 code for an ArgInfo of 
	type ArgValuetypeAddrInIReg.  The code emitted will copy the argument to a 
	local variable and pass the local variable by reference to the called method.
	  
	* mini-amd64.c: mono_arch_emit_prolog:  Adjust the stack for calls to
	mono_jit_thread_attach and mono_get_lmf_addr for Winx64.

	Contributed under MIT/X11 license.

2008-06-10  Rodrigo Kumpera  <rkumpera@novell.com>

	* debug-mini.c (mono_debug_free_method_jit_info): Moved to metadata/mono-debug.c.

	* debug-mini.c (mono_debug_print_vars): Release memory after printing
	everything.

2008-06-10  Martin Baulig  <martin@ximian.com>

	* debug-mini.c
	(mono_debug_close_method): Check whether `cfg->epilogue_begin != NULL'.

2008-06-09  Kornel Pal  <kornelpal@gmail.com>

	* main.c: Add and set argv [argc] to NULL to match C specification that fixes
	possible error when no arguments are passed.

	Contributed under MIT/X11 license.

2008-06-09  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-exceptions.c (ves_icall_get_trace): Skip source locations
	where the file name is NULL.

2008-06-09  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Fix s390 build.

2008-06-08  Zoltan Varga  <vargaz@gmail.com>

	* trace.c (mono_trace_parse_options): Fix warnings.

	* mini-amd64.c: Revert most of the last patch for now as it breaks the build.

2008-06-07  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (remove_block_if_useless): Avoid printing the method name.
	
	* mini.c: Remove needless setting of ins->cil_code which is now done by 
	MONO_INST_NEW.

	* mini-amd64.c: Add some code to avoid saving callee saved registers in the
	LMF. Not yet used.

	* tramp-amd64.c (mono_arch_patch_callsite): Tell valgrind to discard the
	translated code after it has been patched.

2008-06-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (emit_call_body): Align the call displacement to 4 bytes to
	avoid problems during code patching on SMP systems.
	(emit_call): Avoid adding a patch info which is already added by 
	emit_call_body.
	(mono_arch_emit_exceptions): Ditto.

2008-06-05  Zoltan Varga  <vargaz@gmail.com>

	* tramp-*.c (mono_arch_get_unbox_trampoline): No need to check for ret->byref,
	MONO_TYPE_ISSTRUCT already checks for it.

2008-06-05  Bill Holmes  <billholmes54@gmail.com>

	* mini-amd64.c:merge_argument_class_from_type: When marshaling 
	  structs with floats on Winx64 the float registers are not used.  
	  The integer registers are always used..
	* mini-amd64.c:add_valuetype:  When marshaling structs on Winx64 
	  only one register will be used and only if the size of the struct 
	  is 1,2,4, or 8 bytes.

	* tramp-amd64.c :  Adjusting size used for mono_global_codeman_reserve
	  to work for Winx64.

	Contributed under MIT/X11 license.

2008-06-05  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (debugger_lookup_class): Also call
	mono_class_setup_methods() here; we're only called from RTI.

2008-06-05  Andreas Farber  <andreas.faerber@web.de>

	* mini.c (mini_init): Add DTrace probes ves-init-{begin,end}.
	(mini_method_compile) Add DTrace probes method-compile-{begin,end}.
	* Makefile.am (libmono_la_LIBADD,libmono_static_la_LIBADD,mono_LDADD):
	Post-process object files and add dtrace-generated object, if necessary.

	Contributed under MIT/X11 license.

2008-06-04  Mark Probst  <mark.probst@gmail.com>

	* inssel.brg, mini-ops.h: Added opcode for unboxcast with computed
	element class.

	* mini.c: Generic sharing for unbox.any and castclass.

2008-06-04  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Ignore tailcall prefix in shared generic code and when
	doing calls which require a vtable/rgctx argument.

2008-06-04  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Don't free the JIT info.

	* driver.c: Changes in the JIT info table testing code.

2008-06-03  Zoltan Varga  <vargaz@gmail.com>

	* tramp-arm.c (mono_arch_create_trampoline_code): Check for thread 
	interruption. Fix some warnings.

	* tramp-*.c (mono_arch_create_trampoline_code): Call the _force_ variant of
	interruption_checkpoint.

Tue Jun 3 13:07:03 CEST 2008 Paolo Molaro <lupus@ximian.com>

	* jit.h, mini.h, trace.c, driver.c: introduce an API to enable tracing
	from embedding applications.

2008-06-02  William Holmes  <billholmes54@gmail.com>

	* mini-amd64.c :  Correcting some of the issues for Winx64 dealing with
	  reserving 32 bytes on the stack when making calls. 

	Contributed under MIT/X11 license.

2008-06-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_output_basic_block): Merge some small fixes from
	the linear IL branch.

	* driver.c: Print out more information for --version on arm.

2008-05-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Increase max_offset when processing
	bb_exit instead, since out of line bblocks might not actually be emitted
	out-of-line.
	
	* mini-amd64.c (mono_arch_emit_prolog): Increase bb->max_offset by the
	maximum epilog size for out of line bblocks if tracing is enabled.

	* iltests.il.in: Merge tests/long-shift.regalloc.il into this file.

2008-05-28  Rodrigo Kumpera  <rkumpera@novell.com>

	* arrays.cs: Regression tests for allocating arrays with negative sizes.

2008-05-28  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.h mini-x86.c inssel-x86.brg cpu-x86.md: Add support for
	CAS instrinsics. Optimize the implementation of the ATOMIC_EXCHANGE 
	opcodes.

2008-05-27  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_get_inst_for_method): Add support for CAS instrinsics when
	the 'value' to store is a constant.

	* mini-ops.h: Add OP_ATOMIC_CAS_IMM opcodes.

	* mini-amd64.c (mono_arch_output_basic_block): Optimize the the implementation
	of ATOMIC_EXCHANGE opcodes, add support for the CAS opcodes.

2008-05-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.c generic-sharing.c jit-icalls.c aot-compiler.c: Use accessor functions
	for accessing method->generic_container.

2008-05-24  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_check_inlining): Avoid creating vtables if possible.
	
	* mini.c (SIG_HANDLER_SIGNATURE): Fix sparc build too.

	* mini.c (SIG_HANDLER_SIGNATURE): Fix IA64 build.

	* mini.c (mono_jit_compile_method_inner): Avoid a crash if mono_class_vtable ()
	fails.

2008-05-23  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Set mono_setup_vtable_in_class_init to FALSE.

	* mini.c: Handle the case when mono_class_vtable () fails.

2008-05-23  Massimiliano Mantione  <massi@ximian.com>
	* mini.c (sigprof_signal_handler): Support call chains (backtrace) in
	the stat profiler.

2008-05-22  Mark Probst  <mark.probst@gmail.com>

	* mini.c, jit-icalls.c, jit-icalls.h: Make generic sharing work
	together with domain sharing.

2008-05-22  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Treat callvirts to final methods like non-virtual calls
	when doing generic sharing, i.e. look them up in the runtime
	generic context.

2008-05-22  Mark Probst  <mark.probst@gmail.com>

	* inssel.brg, mini-ops.h: Added opcodes for mkrefany and refanyval
	with computed types (for generic sharing).

	* mini.c: Generic sharing for mkrefany and refanyval.

2008-05-22  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (mini_emit_virtual_call): Avoid constructing a generic vtable if
	possible.

	* mini-trampolines.c (mono_magic_trampoline): Avoid calling setup_methods () in
	the generic sharing code.
	
	* mini-trampolines.c (mono_magic_trampoline): Call mono_class_setup_methods ()
	when needed.

2008-05-21  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Remove the declaration of mono_aot_init_vtable ().

2008-05-21  C.J. Adams-collier <cjac@colliertech.org>

	* driver.c: updated copyright date

2008-05-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c mini.c: Remove the AOT init_vtable stuff as it is no longer
	needed.

2008-05-19  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Add `using_mono_debugger'
	pointing to the new `_mono_debug_using_mono_debugger' variable.

	* driver.c
	(mono_main): Check mono_debug_using_mono_debugger() rather than
	the `MONO_INSIDE_MDB' environment variable to check whether we're
	inside the debugger.

2008-05-19  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Use cfg->args [0] for accessing the this
	argument.

2008-05-08  Rodrigo Kumpera  <rkumpera@novell.com>

	* declsec.h: Move MONO_SECMAN_FLAG to metadata/metadata-internals.h.

	* mini.c: Added mini_assembly_can_skip_verification. This
	function checks if the assembly requested to skip verification.	
	Fixes part of #387274.

2008-05-07  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_get_method): Disable the check for open generic classes when
	using generic sharing.

	* generics.cs: Add a test for #387034.

	* mini.c (mini_get_method): Check whenever the method class is an open generic
	type, and return NULL in that case, causing a verification error. Fixes
	#384123.

2008-05-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* driver.c (mono_main): Revert r102623. The right
	thing to do is to enable the verifier under verifiable
	unless a --security flag was passed.

	We need this non-trivial behavior for --verify-all otherwise
	mcs-compileall won't be able to use it. As it needs everything to
	be verified under validil.

2008-05-06  Martin Baulig  <martin@ximian.com>

	Fix #383749.

	* debug-mini.c (mono_debugger_thread_created): Add proper locking.
	(mono_debugger_thread_cleanup): Likewise.
	(mono_debugger_extended_notification): Likewise.

2008-05-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_method_to_ir): Verify visibility of call related opcodes
	against both inflated and non-inflated methods. We need to check against the
	generic definition for cases where the instantiated method is not visible.
	We need to check against the inflated types for cases where the instantiation
	changes any super type. This fixes #382986.

	Note that this doesn't need to be applied to other parts of mono_method_to_ir
	that check for visibiliy as generic params only appears as the type subject
	of tokens on call opcodes. Field manipulation and ldftn must always
	target an exact type.

2008-05-06  Rodrigo Kumpera  <rkumpera@novell.com>

	* driver.c (mono_main): Using --verify-all enables the verifier under validil mode
	if no related --security flag is passed.

2008-05-05  Andreas Farber  <andreas.faerber@web.de>

	* mini-arch.h: Prepare support for ppc64.

	Contributed under MIT/X11 license.

2008-05-05  Andreas Farber  <andreas.faerber@web.de>

	* aot-runtime.c: Prepare support for ppc64.

	Contributed under MIT/X11 license.

2008-05-05  Andreas Farber  <andreas.faerber@web.de>

	* mini-ops.h: Prepare support for ppc64.

	Contributed under MIT/X11 license.

2008-05-04  Andreas Farber  <andreas.faerber@web.de>

	* helpers.c: Add support for OSX/ppc64 and Linux/ppc64 (dis)assemblers.

	Contributed under MIT/X11 license.

2008-05-03  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_aot_module): Avoid trying to load aot code for dynamic
	assemblies, since aot_name is not a full path, causing us to load MS.NET 
	assemblies on windows.

?2008-04-28  Kornel Pal  <kornelpal@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Use g_warning instead of g_error
	for unsupported METHOD_IMPL_ATTRIBUTE_NATIVE.
	* main.c: Use UTF-8 encoded command line instead of Windows default code
	page on Windows to support Unicode.
	* driver.c (DllMain): New function for mixed-mode assembly support.
	* Makefile.am: Add -Wl,--kill-at to libmono_la_LDFLAGS on Windows to
	export __stdcall functions without decoration.

	Contributed under MIT/X11 license.

2008-04-28  Mark Probst  <mark.probst@gmail.com>

	* tramp-amd64.c, mini-amd64.c: Preserve R11 in the trampoline by
	saving it very early.

2008-04-28  Mark Probst  <mark.probst@gmail.com>

	* mini.h, mini.c: Lots of code for accessing the old RGCTX
	deleted.  The only way to access the new RGCTX is via the
	trampline.

	* mini.c, mini-amd64, mini-x86.c, mini-exceptions.c: Pass the
	vtable instead of the RGCTX to static methods.

	* mini-tramplines.c, tramp-amd64.c, tramp-x86.c: Trampoline for
	accessing the new RGCTX.

	* generic-sharing.c: There is no separation between self, type
	arguments and other types in the RGCTX anymore.

2008-04-25  Jonathan Chambers <joncham@gmail.com>

	* mini-amd64.c (add_general): Remove previous stack adjustment.
	(mono_arch_call_opcode): Remove OP_OUTARG_MEMBASE and instead simply
	adjust stack pointer after pushing args. Adjust ARGS_OFFSET to account
	for 32 bytes of stack space reserved for all calls.
	
	* inssel-amd64.brg (OP_OUTARG_MEMBASE): Remove.
	(OP_AMD64_OUTARG_ALIGN_STACK): Take argument to specify size of stack 
	adjustment.
	
	Code contributed under MIT/X11 license.

2008-04-23  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mini_method_verify): Only verify non-inflated methods, check
	against the root definition, peeling out method and type instantiations.
	Cache verify success results, code that fails verification is still
	checked multiple times.

2008-04-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Avoid inserting write barriers for stores of null.

2008-04-23  Jonathan Chambers <joncham@gmail.com>

	* mini-amd64.c (add_general): Always increment stack on Win64.
	(mono_arch_call_opcode): Use OP_OUTARG_MEMBASE instead of OP_OUTARG
	on Win64.
	
	* inssel-amd64.brg (OP_OUTARG_MEMBASE): Add OP_OUTARG_MEMBASE for 
	stack based argument handling on Win64.
	
	Code contributed under MIT/X11 license.

2008-04-23  Raja R Harinath  <harinath@hurrynot.org>

	* Makefile.am (version.h): Add support for git-svn.

2008-04-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_native_sigsegv): Rework the gdb calling code
	so instead of calling g_spawn_command_line_sync, we do everything by hand, 
	avoiding allocations and libc functions which might deadlock.
	
	* mini-exceptions.c (mono_handle_native_sigsegv): Avoid calling gdb if the
	'no-gdb-backtrace' option is set.

	* mini.c (mini_parse_debug_options): Parse 'no-gdb-backtrace' option.

	* mini.h (MonoDebugOptions): Add 'no_gdb_backtrace' option.

2008-04-21  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Removed `attach', `detach'
	and `get_lmf_addr'; `notification_address' is no longer a pointer.

2008-04-21  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Added `thread_vtable_ptr',
	`thread_vtable', `event_handler_ptr' and `event_handler'.

2008-04-21  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Added `init_code_buffer';
	allows delayed initialization of the `executable_code_buffer' when
	attaching.

2008-04-21  Martin Baulig  <martin@ximian.com>

	* mini.h (mono_debugger_create_notification_function): Removed.
	* tramp-*.c (mono_debugger_create_notification_function): Removed.

	* mdb-debug-info64.s
	(MONO_DEBUGGER__notification_function): Added this in the .text section.

	* mdb-debug-info32.s
	(MONO_DEBUGGER__notification_function): Added this in the .text section.

	* Makefile.am: Fix the mdb-debug-info*.s logic; the debugger
	currently only works on x86 and x86_64, so don't create it on ppc.

2008-04-21  Martin Baulig  <martin@ximian.com>

	* mini.h (MonoDebugOptions): Added `mdb_optimizations'.

	* mini.c
	(mini_method_compile): In the fp elimination check, check
	`debug_options.mdb_optimizations' in addition to
	mono_debug_using_mono_debugger().	

	* driver.c (mono_main): Added `--debug=mdb-optimizations' option to
	disable some JIT optimizations which are only disabled when
	running inside the debugger.
	Added `--help-debug' option to describe the debugging options.
	(parse_debug_options): New static function to parse the `--debug'
	options, so we can easily add more stuff in future.

2008-04-20  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (set_exception_type_from_invalid_il): Avoid reading invalid memory when
	the method has no body.

2008-04-19  Jonathan Chambers <joncham@gmail.com>

	* mini-amd64.c (cpuid): Implement with MSVC intrinsic as inline
	assembly is not allowed in MSVC 64-bit compiler. 
	(mono_arch_cpu_init): Don't set floating point precision on MSVC build
	as we get floating point exceptions everywhere.
	
	* exceptions-amd64.c (get_throw_trampoline): Push empty args on stack to
	correctly align arguments for call to throw_exception.
	(prepare_for_guard_pages): Cast to guint64 instead of unsigned long.
	
	Code contributed under MIT/X11 license.

2008-04-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (amd64_patch): Make the check for (%rip) addressing more strict.

2008-04-17  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (OP_SWITCH): Use (gint64) instead of (long) to cast a large constant.

	* mini-amd64.c (NEW_INS): Set cil_code.

	* mini.c (mini_method_compile): Move the disabling of fp elimination to here
	from mini-amd64.c so all debugger related logic is in one place.

	* mini.c: Set cfg->ip to NULL after passes which set it so instructions created
	later won't have a random ip assigned to them.

2008-04-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_create_jump_trampoline): Add an assert to check that
	the arch specific function initializes code_size.
	(mono_create_delegate_trampoline): Ditto.

	* mini-mips.h mini-mips.c inssel-mips.brg inssel-long32-mips.brg cpu-mips.md
	tramp-mips.c: Resurrect MIPS port and also fix the issues on little-endian
	platforms.

	* liveness.c (mono_analyze_liveness): Disable the initlocals optimization if 
	running under the debugger.

	* linear-scan.c (mono_linear_scan): Avoid sharing registers if running under the
	debugger.

	* mini.c (mini_method_compile): Set a few flags in cfg if running under the
	debugger. Also move the disabling of optimizations here from driver.c.
	(mono_allocate_stack_slots_full): Avoid sharing stack slots if running under the
	debugger.

	* mini.h (MonoCompile): Add a few new flags.

2008-04-15  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Set cfg->ip before processing an IL instruction
	so the cil_code field of created MonoInst's is properly set.
	(mini_select_instructions): Ditto.

	* mini.h (MONO_INST_NEW): Initialize the cil_code field using cfg->ip.
	(MONO_INST_NEW_CALL): Ditto.

	* mini.c inssel.brg inssel-x86.brg inssel-amd64.brg: Use MONO_INST_NEW ()
	in many places so the ins->cil_code field is properly initialized.

	* mini.c (mono_bblock_add_inst): Call MONO_ADD_INS () so the logic is in one
	place.

2008-04-14  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_method_compile): Print a different message when compiling a 
	shared method.
	
	* mini.c (GENERIC_SHARING_FAILURE): Print a failure message when verbose_level
	> 1.

2008-04-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Implement OP_ABS directly using
	SSE2 instructions.

	* basic-math.cs: Fix warnings. Add a test for Math.Abs ().
	
2008-04-11  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (handle_stack_args): Make this return void since its return value was
	never used. Also set cfg->unverifiable for invalid IL instead of calling
	G_BREAKPOINT ().

2008-04-10  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Make sure "this" is live in catch clauses with type
	variables in shared generic code.

2008-04-08  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Replaced uses of MONO_TYPE_IS_REFERENCE with calls to
	generic_class_is_reference_type() to ensure the proper behaviour
	when sharing generic code and the type in question is a type
	argument.

2008-04-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c: Applied patch from Mark Spruiell (mes@zeroc.com). Fix
	race conditions when printing thread dumps. Fixes #377738.

2008-04-08  Massimiliano Mantione  <massi@ximian.com>
	
	aliasing.c (update_aliasing_information_on_inst): Fixed a bug which
	shows up when both MonoInst arguments can cause aliasig.
	There is likely no way in the current JIT to trigger this problem, but
	it showed up in the development of generics sharing, when in a new
	opcode both args of an OP_GROUP can be aliases (addresses of a local).
	When the generics sharing code will be committed, its tests will be
	valid also for this bug.

2008-04-08  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (decode_patch_info): Always transform PATCH_INFO_WRAPPER to
	PATCH_INFO_METHOD.

	* mini.c (mono_resolve_patch_target): Fix a crash in the AOT case if method is
	NULL.

2008-04-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_exception_internal): When --debug=casts is used,
	use a more detailed exception message for InvalidCastException.

	* mini.h (MonoJitTlsData): Add 'class_cast_from' and 'class_cast_to' fields.

	* driver.c (mono_main): Add --debug=casts option to turn on better 
	InvalidCastException message details.

	* mini.c (mini_get_debug_options): New helper function to return the address of
	the debug_options variable.

	* mini.c (mono_get_jit_tls_intrinsic): New helper function to create a load of
	the jit_tls TLS variable.

	* mini.c (mono_jit_tls): New TLS variable.

	* inssel.brg: Save the details of a cast to a TLS variable when the --debug=casts
	option is used.

2008-04-07  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.h: Removed verifer related stuff. This code was moved to verify.c

	* mini.c: Removed verifer related stuff, code moved to verify.c.

	* driver.c: Using code from verify.c instead of mini.c.

2008-04-05  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (check_for_method_verify): Remove the mscorlib comment since it is no
	longer valid.

2008-04-04  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (check_for_method_verify): Enabling verification of
	corlib if mono_verify_all is set. Bugs in the verifier preventing that
	have been fixed.

2008-04-04  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-amd64.c (throw_exception): Unify the win32/non-win32 cases, save
	caller saved registers as well.
	
	* exceptions-amd64.c (mono_arch_get_restore_context): Restore most caller
	saved registers as well.

2008-03-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c cpu-x86.md inssel-x86.brg: Add min/max intrinsics.

	* mini-amd64.c mini-amd64.h cpu-amd64.md: Get rid of the non-SSE2 floating point
	code.

2008-03-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_get_this_arg_reg): Add a 'gsctx' argument and pass it
	to get_call_info.
	(get_call_info): Take a gsctx argument instead of 'cfg'.

2008-03-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (check_for_method_verify): Avoid verifying mscorlib methods even if
	mono_verify_all is set.

	* driver.c (compile_all_methods_thread_main): Don't exit at the first error.

	* mini.c mini.h: Remove the unused and incomplete stack merge verification code.

2008-03-25  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (compile_all_methods_thread_main): Error out if compilation fails with
	an exception.

	* driver.c mini.c mini.h: Add a --verify-all development option to test the
	verifier and the code generated by the compiler.

2008-03-25  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of the non-nullable case of the box
	instruction.

2008-03-24  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg: Fix the build.

	* iltests.il.in: Add a test for lconv.ovf.u8.un.

2008-03-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_method_to_ir): Implement readonly for ldelema and
	Array:Address. Fixes #372410.

	* iltests.il.in: New tests for readonly prefix.

2008-03-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.h mini.c mini-trampolines.c: Move trampoline related code to 
	mini-trampolines.c.

	* mini.h mini.c mini-exceptions.c: Move mini_init_exceptions () to 
	mini-exceptions.c.

	* mini-amd64.c mini-s390.c (mono_arch_lowering_pass): Use mono_decompose_op_imm ().
	
	* mini.c (mono_decompose_op_imm): New helper function.

	* mini-s390x.c (calculate_sizes): Rename this to get_call_info for consistency
	with the other architectures, add an 'mp' argument, fold 'sz' argument into the
	return value.

	* mini-s390x.c: Handle DIV_IMM/REM_IMM in the lowering pass instead of in 
	mono_arch_output_basic_block. Fix warnings.

	* inssel-s390x.brg: Remove the unneccesary OP_LMUL_IMM rule to fix the s390x build
	for now.

2008-03-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (ves_icall_get_frame_info): Remove the ia64/s390 workarounds
	since the extra frame is now detected automatically inside the loop.

	* mini-s390.c (mono_arch_peephole_pass_2): Remove the arch independent peephole 
	opts which are now in mono_peephole_ins ().
	
	* mini-s390.c (mono_arch_output_basic_block): Fix OP_FCALL_MEMBASE.

	* mini-exceptions.c (ves_icall_get_frame_info): Skip native-to-managed wrapper
	frames and skip duplicate managed-to-native frames. Fixes #367665.

	* mini-x86.c (mono_arch_peephole_pass_1): Remove the arch independent peephole
	opts which are now in mono_peephole_ins ().
	(mono_arch_peephole_pass_2): Ditto.

	* mini-codegen.c (mono_peephole_ins): Fix a problem on 32 bit platforms.

	* mini-codegen.c (mono_peephole_ins): New helper function containing the
	arch independent peephole optimizations.

	* mini-amd64.c (mono_arch_peephole_pass_1): Remove the arch independent peephole
	opts which are now in mono_peephole_ins ().

	* mini-amd64.c (mono_arch_peephole_pass_2): Ditto.
	
	* mini-s390.c (mono_arch_output_basic_block): Fix build.

	* tramp-s390.c (mono_arch_get_vcall_slot): Handle an additional instruction
	pattern.

	* mini-s390.c (mono_arch_output_basic_block): Handle big offsets in the
	CALL_MEMBASE opcodes. Fix setting of the destination in the OP_LCONV_TO_OVF_I
	opcode.	

2008-03-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390.c (calculate_sizes): Rename this to get_call_info for consistency
	with the other architectures, add an 'mp' argument, fold 'sz' argument into the
	return value.

	* mini-s390.c: Handle DIV_IMM/REM_IMM in the lowering pass instead of in 
	mono_arch_output_basic_block. Fix warnings.

2008-03-20  Zoltan Varga  <vargaz@gmail.com>

	* inssel-long32.brg: Add rules for long conv.ovf.i/conv.ovf.u/conv.ovf.i.un/
	conv.ovf.u.un.

2008-03-20  Zoltan Varga  <vargaz@gmail.com>

	* inssel-long.brg: Add rules for long conv.ovf.i/conv.ovf.u/conv.ovf.i.un/
	conv.ovf.u.un.

	* iltests.il: Add new tests.

2008-03-20  Kornel Pal  <kornelpal@gmail.com>

	* mini.c: Removed Windows version macros.

2008-03-20  Mark Probst  <mark.probst@gmail.com>

	* generic-sharing.c: Put reflection types in the extensible part
	of the runtime generic context.

	* mini.c: Generic sharing of the GetTypeHandle special case of the
	ldtoken instruction.

2008-03-20  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MONO_BB_FOR_EACH_INS_SAFE): New helper macro.

	* mini-<ARCH>.c: Use the new macro instead in the peephole/lowering passes.
	
	* mini.h (MONO_DEL_INS): Rename to MONO_DELETE_INS and Add a 'bb' argument for 
	consistency with the other version on the linear IR branch.

	* mini-<ARCH>.c: Update callers of MONO_DEL_INS.

	* inssel-long32.brg inssel-long.brg: Add rules for conv.ovf.i/conv.ovf.u.

	* iltests.il.in: Add new tests.

2008-03-19  Zoltan Varga  <vargaz@gmail.com>

	* inssel-long32.brg inssel-long.brg: Add rules for conv.ovf.i.un/conv.ovf.u.un.

	* iltests.il.in: Add new tests.

2008-03-19  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Two variables with the same name were declared in
	nesting contexts and one wasn't initialized.  Fixed.

2008-03-19  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of the initobj instruction.

Tue Mar 18 20:18:02 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini.c: make the test to optimize ldtoken from typeof() more
	precise.

2008-03-18  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing of the initobj instruction for reference
	types.

Tue Mar 18 12:39:27 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-amd64.c, mini-x86.c, tramp-amd64.c, tramp-x86.c: change
	the mono_breakpoint_clean_code() code to perform bound checks.

Tue Mar 18 11:50:14 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-trampolines.c, tramp-*.c: change the signature of
	mono_arch_patch_callsite() to include the start of the managed method
	to be able to perform bound checks.

2008-03-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Generic sharing for the isinst instruction.

2008-03-17  Mark Probst  <mark.probst@gmail.com>

	* mini-ops.h, inssel.brg, inssel-long.brg, inssel-long32.brg,
	inssel-long32-mips.brg: Added opcodes for doing indirect calls
	with the runtime generic context argument.

	* mini.c: Share calls to several types of unsharable methods by
	putting the address of the method code in the runtime generic
	context and doing an indirect call.

	* graph.c, local-propagation.c, aliasing.c: Added the new opcodes
	to switches.

2008-03-16  Mark Probst  <mark.probst@gmail.com>

	* generic-sharing.c: Change due to a change in the runtime genric
	context API.

2008-03-15  Martin Baulig  <martin@ximian.com>

	* tramp-x86.c
	(mono_arch_nullify_class_init_trampoline): Add call to
	mono_breakpoint_clean_code() to make things work when running
	inside the debugger.

	* tramp-amd64.c
	(mono_arch_nullify_class_init_trampoline): Add call to
	mono_breakpoint_clean_code() to make things work when running
	inside the debugger.

2008-03-14  Zoltan Varga  <vargaz@gmail.com>

	* inssel-long.brg (reg): Fix 64 bit build.

2008-03-14  Mark Probst  <mark.probst@gmail.com>

	* mini.c, mini.h: Share static generic code by passing it an
	implicit argument pointing to the runtime generic context.

	* mini-ops.h, inssel.brg, inssel-long.brg, inssel-long32.brg,
	inssel-long32-mips.brg: New opcodes for calling shared static,
	which need to be passed the runtime generic context.

	* mini-amd64.c, mini-x86.c: Save the runtime generic context
	argument on the stack in the prologue if needed.  New function for
	finding the runtime generic context argument from the registers
	saved by the trampoline.

	* mini-amd64.h, mini-x86.h: Specify which register to use for the
	runtime generic context argument.

	* tramp-amd64.c: Also restore the register used for the runtime
	generic context argument.

	* mini-trampoline.c: Resolve shared static calls by consulting the
	runtime generic context via the new argument.

	* generic-sharing.c: Add an argument to sharability-checking
	functions that specifies whether type variables should be treated
	as sharable type arguments.

	* inssel-x86.brg: Removed a superfluous, buggy rule.

	* graph.c, local-propagation.c, aliasing.c: Added the new opcodes
	to switches.

2008-03-14  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (main_thread_handler): Call
	mono_runtime_run_main() without sending any notifications.

	* debug-debugger.h (MonoDebuggerInfo): Added `get_method_signature.

2008-03-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_magic_trampoline): Fix build on platforms without IMT.

2008-03-14  Mark Probst  <mark.probst@gmail.com>

	* tramp-x86.c: Fixed register restore offsets in the trampoline
	code for ECX and EDX.

2008-03-12  Geoff Norton  <gnorton@novell.com>

	* mini-arm.h: Add some #defines for locating sp, pc, r4 with
	different ucontext_t implementations.
	* exceptions-arm.c: Use the above defines to get exceptions working on 
	iPhone (based on a patch by Luke Howard lukeh@padl.com)
	* mini-arm.c: Implement iPhone icache support (based on a patch by
	Luke Howard lukeh@padl.com)

2008-03-12  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Enable generic sharing of calls to non-static
	non-interface non-generic non-value-type methods.

	* mini-trampolines.c: Resolve calls from shared generic code.

2008-03-11  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am il2tests.il iltests.il.in: Delete il2tests, merge it into iltests.

	* tramp-amd64.c (mono_arch_create_trampoline_code): Correctly save RBP as well.

Mon Mar 10 11:59:34 CET 2008 Paolo Molaro <lupus@ximian.com>

	* mini.c: some fixes for the AOT compiler.

2008-03-07  Zoltan Varga  <vargaz@gmail.com>

	* cpu-amd64.md: Add clob:1 to some float opcodes.

2008-03-07  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.h: Added MiniVerifierMode enumeration.

	* mini.c: Added mini_verifier_set_mode to control
	the usage of the new verifier.

	* mini.c (mono_method): Integrated the new verifier.

	* driver.c: Extended --security option with validil and
	verifiable options to activate the new verifier.

2008-03-07  Zoltan Varga  <vargaz@gmail.com>

	* mini.c jit-icalls.h jit-icalls.c: Generalize the exception creation 
	optimization to ctors taking 0 or 2 arguments too.

	* mini.c (mono_method_to_ir): Optimalize the size of the exception throwing code
	a bit.

	* jit-icalls.h (mono_create_corlib_exception): New JIT icall.

	* mini-amd64.c (mono_arch_emit_prolog): Improve the first_bb optimization a bit.

2008-03-06  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Apply one of the ldstr optimizations in the
	non-aot case as well.

	* cpu-amd64.md: Reduce the max size of some frequently used opcodes.

	* aot-runtime.c (decode_patch_info): Update this after the ldfld/stfld wrapper
	changes.

	* aot-compiler.c (encode_patch): Ditto.

	* mini.h (G_MININT32): Fix the definition of this.

2008-03-05  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Define G_MININT32/G_MAXINT32 if using an older glib version.

	* cfold.c: Remove definition of G_MININT32 which is now in mini.h.

2008-03-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_compute_omit_fp): Don't disable fp elimination for 
	methods returning vtypes in registers.
	(mono_arch_allocate_vars): Ditto.

	* mini-amd64.c (mono_arch_get_this_arg_reg): New arch specific helper function.

	* tramp-amd64.c (mono_arch_get_unbox_trampoline): Use mono_arch_get_this_arg_reg ().	

	* generics.cs: Add a test from the linear IR branch.

	* mini-amd64.c (emit_load_volatile_arguments): Handle vtypes passed in regs too.

	* mini.c (inline_method): Cache failed inline attempts.

2008-03-04  Mark Probst  <mark.probst@gmail.com>

	* mini.c: For shared methods of generic classes put the location
	of "this" into the MonoGenericJitInfo.

	* mini-x86.c, mini-amd64.c, mini.h: Added function for fetching a
	register out of a MonoContext by register number.  Add the generic
	sharing context as an argument to mono_arch_find_this_argument().

	* mini-alpha.c, mini-arm.c, mini-hppa.c, mini-ia64.c, mini-mips.c,
	mini-ppc.c, mini-s390.c, mini-s390x.c, mini-sparc.c: Added stub
	for new arch function.

	* mini-exception.c: Handle open exception clauses in shared
	generic code.

	* mini-trampolines.c: Supply additional argument to
	mono_arch_find_this_argument().

2008-03-04  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (regtests): Run the bench.exe tests last.

2008-03-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Improve the first bblock optimization
	a bit.

2008-03-02  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Allow callvirt on static methods for compatibility
	with MS.

	* mini-amd64.c (mono_arch_emit_prolog): Fix tracing after the last change.
	
	* mini-amd64.c (mono_arch_emit_prolog): Avoid saving dead arguments.

	* mini.c (mono_method_check_inlining): Avoid disabling inlining for methods
	whose class has no cctor.

	* liveness.c (mono_analyze_liveness): Mark dead arguments with MONO_INST_IS_DEAD.

2008-03-01  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Report calling a static method using callvirt as
	unverified.

2008-02-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Remove OP_SPARC_INARG_VT, add a new OP_VTARG_ADDR opcode instead
	to be in sync with the code on the linear IR branch.

	* mini-sparc.c inssel-sparc.brg: Use OP_VTARG_ADDR.

	* inssel-s390.brg (OP_SETRET (freg)): Set dreg correctly.

2008-02-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-mips.c: Use cfg->vret_addr instead of cfg->ret.

	* mini-s390x.c: Use cfg->vret_addr instead of cfg->ret.

	* mini-s390.c: Use cfg->vret_addr instead of cfg->ret.

	* mini-<ARCH>.h mini.c: Get rid of the MONO_ARCH_HAVE_CREATE_VARS define.

	* mini-<ARCH>.c (mono_arch_create_vars): Define this for all architectures.
	
	* mini.c (mono_method_to_ir): Avoid invalid memory reads for methods without a
	body.

2007-11-14  Yoichi NAKAYAMA  <nakayama@pixela.co.jp>

	* inssel-mips.brg (OP_OUTARG_MEMBASE (CEE_LDIND_R4 (base))): Add missing
	OP_LOADR4_MEMBASE emission.

	* mini-codegen.c (mono_spillvar_offset_int): Remove assertion.
	(mono_spillvar_offset_float): Ditto.

	* mini-mips.c (mono_arch_emit_prolog): Ditto.

	* inssel-long32-mips.brg: Fix wrong branching, reduce redundant code
	emission.

	* basic-long.cs: Add regression tests for them.

	* mini-mips.c (add_float32_arg): Respect o32 calling convention in gr
	use.
	(mono_arch_allocate_vars): Fix representation of single-precision float
	argument.
	(mono_arch_output_basic_block): Ditto.

	* inssel-mips.brg: Ditto, remove duplicate items.

	* mini-mips.c (emit_load_volatile_arguments): New function to handle
	arguments of tail calls as on other platforms.
	(mono_arch_output_basic_block): Handle tail calls.

	* inssel-mips.brg (OP_OUTARG_VT (CEE_LDOBJ (base))): Correct destination
	register.

	* objects.cs (test_5_pass_static_struct): Add test for it.

	Contributed under MIT/X11 license.

2008-02-26  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am: Use gmcs for compiling the regression tests.

	* *.2.cs *.2.il: Rename to *.cs and *.il.

2008-02-24  Zoltan Varga  <vargaz@gmail.com>

	* regalloc.h: Make the vassign array smaller.

	* mini.c (mini_method_compile): Remove an unused field in cfg.

	* mini-codegen.c: Add a bunch of micro optimizations.

2008-02-23  Zoltan Varga  <vargaz@gmail.com>

	* regalloc.h: Remove some unused fields.

2008-02-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_patch_code): Fix a warning.

	* ssa.c (mono_ssa_remove): Avoid declaring volatile variables dead.

2008-02-22  Mark Probst  <mark.probst@gmail.com>

	* mini.h: New trampoline type (RGCTX_LAZY_FETCH).

	* mini-trampolines.c, tramp-amd64.c, tramp-x86.c: RGCTX lazy fetch
	trampoline: Fetch an entry from the runtime generic context.  If
	it's NULL, jump to the actual trampoline to fill the runtime
	generic context.  Otherwise, return it.

	* mini.c: Call the lazy fetch trampoline to get entries out of the
	runtime generic context.

	* tramp-ia64.c, tramp-arm.c, tramp-alpha.c, tramp-s390.c,
	tramp-s390x.c, tramp-ppc.c, tramp-hppa.c, tramp-mips.c,
	tramp-sparc.c: Stubs for the lazy fetch trampoline.

2008-02-21  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Fetch data out of the extensible part of the runtime
	generic context instead of calling a helper function.

	* generic-sharing.c: Some functions moved into
	metadata/generic-sharing.c.  Helper function for fetching other
	types now checks and asserts against extensible rgctx (just for
	debugging purposes - the helper function isn't called anymore
	unless for debugging).

2008-02-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_output_basic_block): Implement proper argument passing
	for tail calls up to the point that the tests in iltests.exe run. Also add a
	dummy CKFINITE implementation.
	(mono_arch_emit_prolog): Avoid saving the method in the LMF since it is only
	needed for trampoline LMF frames.

	* exceptions-arm.c (mono_arch_find_jit_info): Only read lmf->method for 
	trampoline LMF frames.

2008-02-21  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (inline_method): clean any pending loader error when inlining fail.
	Otherwise loader errors in mono_method_to_ir leaks and cause spurious errors.

2008-02-21  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (encode_patch): Handle ICALL_ADDR patch type.

	* aot-runtime.c (decode_patch_info): Ditto.

	* mini.c (mono_resolve_patch_target): Ditto.
	
	* aot-compiler.c (compile_method): Add some experimental code for AOT compiling
	icall wrappers.

	* patch-info.h (PATCH_INFO): Add 'ICALL_ADDR' patch type.
	
	* mini.c (mono_method_to_ir): Convert a CEE_MONO_LDPTR opcode to an AOT constant
	if it references an icall address.

2008-02-20  Zoltan Varga  <vargaz@gmail.com>

	* cpu-s390x.md: Remove some more unused opcodes.
	
	* cpu-s390x.md: Remove some unused opcodes.

	* mini-ia64.c (mono_arch_lowering_pass): Add some more opcodes. Use
	mono_op_imm_to_op ().

	* mini-sparc.c (opcode_to_sparc_cond): Use the mono_opcode_to_cond () functions
	instead of a switch statement.
	
	* mini-sparc.c (mono_arch_allocate_vars): Allocate a stack slot for use by
	the int<->float conversion opcodes instead of using mono_spillvar_offset_float ().

	* mini-codegen.c: Eliminate rassign macro which is no longer needed.
	
	* mini-codegen.c: Remove unused mono_regstate2_... functions.

	* mini-codegen.c (mono_print_ins_index): Avoid printing an index when it is
	-1.

2008-02-19  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Improve error reporting when an assembly cannot be
	opened. Fixes #362607.

	* cpu-ia64.md cpu-s390x.md: Remove some unused opcodes.

	* iltests.il.in: Add a test for static methods in interfaces.

2008-02-18  Zoltan Varga  <vargaz@gmail.com>

	* genmdesc.c (build_table): Fix a crash on older glib versions.

	* cpu-sparc.md: Remove some unused opcodes.
	
	* genmdesc.c: Error out if the .md contains CEE_ opcodes if 
	MONO_ARCH_ENABLE_NORMALIZE_OPCODES is defined.

	* cpu-amd64.md: Remove some unused opcodes.

	* mini.h mini-ops.h mini.c: Define the OP_Ccc opcodes in mini-ops.h normally
	like the other opcodes.

2008-02-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c: Use cfg->vret_addr instead of cfg->ret.

	* mini-arm.h mini-arm.c: Use cfg->vret_addr instead of cfg->ret.

	* mini-sparc.c: Use cfg->vret_addr instead of cfg->ret. Name the MonoCompile
	variables 'cfg' instead of 'm' for consistency.

	* mini-x86.c: Use cfg->vret_addr instead of cfg->ret.

	* mini.h (MonoCompile): Add new 'vret_addr' field which represents the hidden
	argument holding the vtype return address, to avoid the ambigious use of
	cfg->ret for this purpose.

	* mini.c (NEW_RETLOADA): Use vret_addr if set.

	* mini-amd64.c: Use cfg->vret_addr instead of cfg->ret.
	
	* mini-codegen.c (mono_print_ins): Rename to mono_print_ins_index (), Add a
	new mono_print_ins () function which only takes one argument.

2008-02-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390.h (MONO_OUTPUT_VTR): Use cfg instead of s, avoid assignments to
	macro arguments.

2008-02-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Get rid of OP_SPARC_LOCALLOC_IMM.

	* mini-sparc.c inssel-sparc.brg: Use OP_LOCALLOC_IMM instead of OP_SPARC_LOCALLOC_IMM.

	* mini-x86.c: Sync with the version on the linear IR branch by adding new 
	opcodes and other small changes.

	* mini-ops.h: Add some new opcodes from the linear IR branch.

	* mini-ops.h: Get rid of the OP_X86_..._MEMBASE opcodes.

	* mini-x86.c inssel-x86.brg cpu-x86.md: Get rid of the confusing _MEMBASE
	opcodes, use the REG_MEMBASE opcodes instead.
	
	* mini-amd64.c inssel-amd64.brg cpu-amd64.md: Get rid of the confusing _MEMBASE
	opcodes, use the REG_MEMBASE opcodes instead.
	
	* mini-amd64.c (mono_arch_output_basic_block): Sync with the version on the
	linear IR branch.

	* mini.c (mono_op_imm_to_op): New helper function.

	* mini-ops.h: Add some opcodes from linear IR branch.

2008-02-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-alpha.h mini-alpha.c tramp-alpha.c: Alpha port updates from Sergey Tikhonov 
	<tsv@solvo.ru>.

2008-02-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_normalize_opcodes): Always convert CEE_CONV_R4/R8 to 
	OP_ICONV_TO_R4/R8.

	* mini-ia64.c cpu-ia64.md: Add OP_ICONV_TO_R4/R8.

2008-02-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_method_code): Add an assert.

	* mini-arm.h mini-arm.c exceptions-arm.c: Modify the exception throwing code and
	the IMT code so it is AOT friendly. Enable AOT for methods which call interface
	methods.

2008-02-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_output_basic_block): Fix the ordering of arguments for 
	some load/store opcodes so they are consistent.	
	(mono_arch_emit_prolog): Simplify some code.

	* aot-runtime.c (mono_aot_get_plt_entry): Fix a warning.

	* objects.cs: Add tests for large argument offsets on ARM.

	* mini-arm.c (mono_arch_emit_prolog): Fix handling of arguments with large 
	stack offsets. Fixes #359651.

	* mini.c (mono_normalize_opcodes): Remap CEE_CONV_R4/R8 properly.

	* cpu-s390x.md: Add OP_LCONV_TO_R4/R8.

	* cpu-ia64.md mini-ia64.h mini-ia64.c: Get rid of CEE_ opcodes.

	* mini-ops.h: Add OP_ICONV_TO_R_UN opcode.

	* mini.c (mono_normalize_opcodes): Remap CEE_CONV_R_UN too.

	* cpu-s390x.md cpu-s390.md mini-s390x.c mini-arm.c cpu-arm.md mini-s390.c: Get
	rid of CEE_CONV_R_UN.

	* mini-s390x.c mini-s390x.h cpu-s390x.md inssel-s390x.brg: Get rid of CEE_ opcodes.

2008-02-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390.c mini-s390.h cpu-s390.md: Get rid of CEE_ opcodes.

	* mini.c (mono_normalize_opcodes): Add some more opcodes.

	* mini-arm.c mini-arm.h cpu-arm.md: Get rid of CEE_ opcodes.

	* cpu-amd64.md: Remove some unused opcodes.

	* mini-sparc.c mini-sparc.h cpu-sparc.md: Get rid of CEE_ opcodes.

	* mini-x86.c mini-x86.h cpu-x86.md: Get rid of CEE_ opcodes.

	* mini.c mini-<ARCH>.c: Remove mono_arch_local_regalloc (), instead make 
	arch specific functions for its parts. Call the peephole pass after local
	regalloc so the prolog can compute a more accurate max_offset.
	
	* mini.c (mono_normalize_opcodes): New mini pass to convert CEE_ opcodes to
	the corresponding OP_I/OP_L opcodes.

	* mini-amd64.c mini-amd64.h cpu-amd64.md: Get rid of CEE_ opcodes.

	* mini-sparc.c (mono_arch_output_basic_block): Fix the sparc build.

2008-02-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-s390.c (mono_arch_get_inst_for_method): Remove the Interlocked cases
	as they are handled in mini.c.

	* mini-s390x.c (mono_arch_get_inst_for_method): Ditto.
	
	* mini-<ARCH>.c (mono_arch_get_inst_for_method): Remove the MemoryBarrier
	case since it is handled in mini.c.

	* cpu-sparc.md (sparc_setfreg_float): Fix the sparc build.

	* mini-ops.h: Add new opcodes OP_CALL/OP_CALLVIRT.

	* *.c: Use the new opcodes in the IR and back end code.

	* mini-ops.h cpu-<ARCH>.md: Correct the name of the bgt_un opcodes.

	* mini-amd64.c (emit_call_body): Use a far-call for calling dynamic methods.

2008-02-06  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c (mono_generic_class_init_trampoline): Removed
	an assert because it has a race condition.

2008-02-06  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_patch_callsite): Add more diagnostics.

	* inssel.brg mini-<ARCH>.c cpu-<ARCH>.md: Get rid of unused CEE_RET opcode.

	* mini-<ARCH>.c cpu-<ARCH>.md: Get rid of unused LDIND/STIND opcodes.

	* *.brg mini-<ARCH>.c cpu-<ARCH>.md: Get rid of OP_SETREG/OP_SETFREG/OP_SETREGIMM,
	use OP_MOVE/OP_FMOVE/OP_ICONST instead.

2008-02-05  Zoltan Varga  <vargaz@gmail.com>

	* cpu-amd64.md (move): Correct the maximum size of move.

2008-02-05  Mark Probst  <mark.probst@gmail.com>

	* tramp-amd64.c, tramp-x86.c, mini-trampolines.c: Added a check in
	the generic class init trampoline to return quickly if the class
	is already inited.

2008-02-04  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_patch_callsite): Add some diagnostics to help debug
	issues where an 32 bit callsite cannot be patched by a 64 bit address.

2008-02-03  Zoltan Varga  <vargaz@gmail.com>

	* generics.2.cs generics-variant-types.2.il: Merge some tests from the linear IR
	branch.

2008-01-31  Zoltan Varga  <vargaz@gmail.com>

	* objects.cs: Add some soft-float tests.

	* mini.c: Fix a couple more soft-float issues.

	* helpers.c (mono_disassemble_code): Fix disassembly on ARM.

	* mini-amd64.c (peephole_pass): Use IXOR instead of LXOR for zeroing a register to
	avoid a REX prefix.

2008-01-30  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (mono_arch_find_jit_info): Fix stack unwinding when an
	exception happens while compiling a virtual method.

2008-01-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_emit_epilog): Fix folding of negative return values.
	
	* mini-sparc.c: Fix build.

	* mini-sparc.c (get_call_info): Add support for generic sharing.

	* mini-exceptions.c: Add a FIXME.

2008-01-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_exception_internal): Remove the old style
	altstack handling code.

	* mini-s390.c (mono_arch_emit_exceptions): Really fix a warning.
	
	* mini-s390.c (mono_arch_emit_exceptions): Fix a warning.

	* mini-s390.c: Add support for generic sharing.

	* mini-exceptions.c (ves_icall_System_Security_SecurityFrame_GetSecurityFrame): 
	Fix CAS on s390.
	(ves_icall_System_Security_SecurityFrame_GetSecurityStack): Ditto.

	* mini-s390x.c (mono_arch_emit_exceptions): Fix a warning.

	* mini-s390x.c: Add support for generic sharing.
	
	* mini-exceptions.c (ves_icall_System_Security_SecurityFrame_GetSecurityFrame): 
	Fix CAS on ia64.
	(ves_icall_System_Security_SecurityFrame_GetSecurityStack): Ditto.

	* mini-s390x.c: Use is_imm16 instead of is_uimm16 when checking whenever s390_aghi
	can be used since it takes a 16 bit signed immediate.

	* inssel-s390x.brg: Fix OP_SETRET.

	* mini-s390x.c (mono_arch_output_basic_block): Fix OP_BREAK.

	* mini-codegen.c (mono_opcode_to_cond): Fix a warning.

	* mini-s390x.c cpu-s390x.md: Implement sext.i4 properly by sign extension.

	* mini.c (mono_create_delegate_trampoline): Don't use mono_create_ftpntr here.

	* mini-trampolines.c (mono_delegate_trampoline): Use mono_get_addr_from_ftnptr
	in one place.

	* mini-ia64.h mini-ia64.c: Add minimal support for the delegate trampoline 
	stuff.

	* mini.h inssel-x86.brg inssel-amd64.brg tramp-alpha.c tramp-ia64.c: Get rid
	of the unused mono_arch_patch_delegate_trampoline stuff.

2008-01-26  Zoltan Varga  <vargaz@gmail.com>

	* basic-long.cs: Move the fp related tests to basic-float.cs.

	* mini-ops.h (OP_OUTARG_FREG_R4): New opcode.

	* mini-ia64.c inssel-ia64.brg: Implement proper R4 argument passing.

	* basic-calls.cs: Add a test for proper float argument passing.

	* mini-ia64.h (mono_ia64_context_get_ip): Do not substract 1 from the ip
	if the context corresponds to an exception received through a signal.

	* exceptions.cs: Add a test for nullref handling at the start of a try
	clause.

	* mini-ia64.c (mono_arch_call_opcode): Fix ia64 argument passing.

	* jit-icalls.c (mono_break): New JIT icall.

	* mini-<ARCH>.c: Use mono_break instead of mono_arch_break.

	* mini-arm.c (arm_patch): Add support for patching the blx calling sequence.

2008-01-25  Zoltan Varga  <vargaz@gmail.com>

	* cpu-*.md: Get rid of unused opcodes.

	* cpu-g4.md: Rename this to cpu-ppc.md for consistency with other archs.

	* Makefile.am: Move mini-trampolines.c to $(common_sources) since it is now used
	by all platforms.

	* mini-<ARCH>.h mini.c: Get rid of the MONO_ARCH_HAVE_CREATE_SPECIFIC_TRAMPOLINE
	define.

	* mini-s390x.h tramp-s390x.c Makefile.am: Rework the s390x trampoline code to use
	the arch independent trampoline code in mini-trampolines.c.

	* aot-runtime.c (mono_aot_init_vtable): Fix a warning.

	* mini.c (get_runtime_generic_context_ptr): Fix a warning.

	* mini-s390.h: Remove an unused define.
	
	* mini-s390.h tramp-s390.c Makefile.am: Rework the s390 trampoline code to use
	the arch independent trampoline code in mini-trampolines.c.

	* mini-arm.c (mono_arch_emit_prolog): Fix build.

2008-01-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_output_basic_block): Remove some unecessary code.

	* mini-s390.c (mono_arch_emit_prolog): Fix build.

	* mini-s390x.c (mono_arch_emit_prolog): Fix build.

	* mini-ppc.c (mono_arch_emit_prolog): Fix build.

	* cpu-amd64.md: Use smaller sizes for int opcodes.

	* *.c: Get rid of the NOT_IMPLEMENTED define which is now in mini.h.

	* *.cs: Add some tests from the linear-ir branch. Move structs tests to 
	objects.cs.

	* driver.c (mono_main): Add a --break-at-bb command line argument for JIT
	debugging.

	* mini.h *.c: Change cfg->vars to contain the MonoMethodVar entries directly
	instead of though a pointer to save an indirection when accessing elements of
	the array.

	* mini.h (MONO_IS_COND_BRANCH_OP): Move these macros here from mini.c. Fix
	some typos.
	(NOT_IMPLEMENTED): New helper macro.
	(MONO_BB_FOR_EACH_INS): New helper macro to iterate through the instructions
	of a bb.

	* *.c: Use the new helper macro.

2008-01-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.h (MONO_ARCH_AOT_SUPPORTED): Disable AOT for apple x86.

2008-01-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Optimize the omit fp case to save two
	stack slots.

2008-01-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Disable	the new optimization if
	profiling is enabled.
	
	* mini-amd64.c (mono_arch_call_opcode): Emit the save_sp_to_lmf instruction at
	the end.
	(mono_arch_emit_prolog): Add more first bblock optimizations.

	* mini-amd64.c (mono_arch_call_opcode): Keep assignments to the arg registers
	in order if possible.
	(mono_arch_emit_prolog): Optimize assignments to arg registers in the first
	bblock, since the arguments are still in their original registers.

	* mini.c (type_from_op): Calling add.ovf on floats is not valid IL code.

2008-01-17  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Use the no-spilling optimization for CEE_CALLI
	as well.

	* mini-amd64.c (mono_arch_emit_prolog): Save an instruction if the LMF is at
	offset 0.

	* mini-amd64.h (MONO_ARCH_HAVE_NOTIFY_PENDING_EXC): Turn on this for amd64.

	* exceptions-amd64.c (mono_arch_notify_pending_exc): New function to 
	process async exceptions received while in unmanaged code.

	* mini.c (mini_init): Install a callback with the runtime which will be called
	when a thread receives an async exception while in unmanaged code.

	* mini.c driver.c: Update after mono_get_native_wrapper () signature change.

	* mini-s390x.c (mono_arch_output_basic_block): Fix s390x build.

2008-01-16  Wade Berrier  <wberrier@novell.com>

	* cpu-g4.md:
	* cpu-arm.md:
	* cpu-s390x.md:
	fix build

2008-01-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_output_basic_block): Remove some gccism which prevents
	compilation with sun cc.

	* cpu-*.md: Fix the build.

	* cpu-x86.md: Fix the length of some load membase opcodes. Fixes #354241.

	* mini-amd64.h: Add some comments to the MonoLMF structure.

	* mini-ops.h cpu-amd64.c: Add a OP_AMD64_SAVE_SP_TO_LMF opcode.
	
	* mini-amd64.c exceptions-amd64.c tramp-amd64.c: Avoid setting the rip field
	in the LMF structure if possible. This saves two instructions in the
	managed->native wrappers.

	* mini-ops.h *.md: Make some opcodes names uniform by removing the op_ prefix.

2008-01-16  Mark Probst  <mark.probst@gmail.com>

	* generic-sharing.c: New type argument lookup code which uses the
	runtime generic context template.

2008-01-15  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Avoid emitting a write barrier when storing NULL.

	* mini-arm.c (add_general): Fix arm eabi parameter passing.
	(mono_arch_output_basic_block): Fix localloc implementation.

	* mini-amd64.c (peephole_pass): Sync store+load optimizations with the x86 version.

	* mini-ia64.c (peephole_pass): Fix ia64 build.

	* mini-amd64.c (peephole_pass): Fix a warning.
	
	* mini-amd64.c (mono_arch_allocate_vars): Make sure the LMF is always stored
	at a constant offset from sp/fp.

	* exceptions-amd64.c (mono_arch_find_jit_info): Compute the LMF address from fp/sp
	instead of obtaining it from *lmf in the managed method case.

2008-01-14  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-amd64.c (mono_arch_find_jit_info): Remove some duplicate code.

Mon Jan 14 12:33:06 CET 2008  David S. Miller  <davem@davemloft.net>

	* mini.h (MonoInstList): New type.
	(MONO_INST_LIST_INIT, MONO_INST_LIST_EMPTY,
	__MONO_INST_LIST_ADD, MONO_INST_LIST_ADD,
	MONO_INST_LIST_ADD_TAIL, __MONO_INST_LIST_DEL,
	__MONO_INST_LIST_SPLICE, MONO_INST_LIST_SPLICE,
	MONO_INST_LIST_SPLICE_TAIL, MONO_INST_LIST_SPLICE_INIST,
	MONO_INST_LIST_SPLICE_TAIL_INIT, mono_container_of,
	MONO_INST_LIST_ENTRY, MONO_INST_LIST_FIRST_ENTRY,
	MONO_INST_LIST_LAST_ENTRY, MONO_INST_LIST_FOR_EACH,
	MONO_INST_LIST_FOR_EACH_PREV, MONO_INST_LIST_FOR_EACH_SAFE,
	MONO_INST_LIST_FOR_EACH_PREV_SAFE,
	MONO_INST_LIST_FOR_EACH_ENTRY,
	MONO_INST_LIST_FOR_EACH_ENTRY_REVERSE,
	MONO_INST_LIST_FOR_EACH_ENTRY_SAFE,
	mono_inst_list_first, mono_inst_list_last,
	mono_inst_list_next, mono_inst_list_prev): New instruction
	list handling interfaces.
	(MonoBasicBlock): Remove 'last_ins' and 'code', replace with
	list head 'ins_list'.
	(MonoInst): Replace next pointer with list head 'node'.
	(MonoCallInst): Make 'out_args' a MonoInstList.
	(MONO_INST_NEW_CALL): Explicitly init ->out_args.
	(MonoCompile): Delete reverse_inst_list and
	reverse_inst_list_len.
	* mini-hppa.c (mono_arch_call_opcode, NEW_INS,
	mono_arch_lowering_pass, mono_arch_local_regalloc,
	mono_arch_output_basic_block, mono_arch_emit_prolog):
	Convert to new instruction lists.
	(insert_after_ins): Delete.
	* inssel.brg (MONO_EMIT_NEW_BRANCH_BLOCK): Convert to new
	instruction lists.
	* mini-hppa.h (MONO_EMIT_NEW_COMPARE_BRANCH_BLOCK): Likewise.
	* mini.c (NEW_BBLOCK, ADD_BBLOCK, CHECK_BBLOCK,
	split_bblock, mono_add_ins_to_end, mono_emit_call_args,
	mono_emulate_opcode, mono_emit_load_got_addr,
	inline_method, mono_method_to_ir, mono_print_bb_code,
	print_dfn, decompose_pass, nullify_basic_block,
	replace_out_block_in_code, remove_block_if_useless,
	merge_basic_blocks, move_basic_block_to_end,
	try_unsigned_compare, optimize_branches, mono_print_code,
	mini_select_instructions, remove_critical_edges): Likewise.
	* mini-amd64.c (emit_sig_cookie, mono_arch_call_opcode,
	peephole_pass_1, peephole_pass, mono_arch_lowering_pass,
	mono_arch_output_basic_block, mono_arch_emit_prolog):
	Likewise.
	* mini-mips.c (mono_arch_call_opcode, peephole_pass,
	NEW_INS, mono_arch_lowering_pass, mono_arch_local_regalloc,
	mono_arch_output_basic_block): Likewise.
	(inst_list_prepend, insert_after_ins): Delete.
	* mini-mips.h (MONO_EMIT_NEW_BRANCH_NONZERO_LABEL,
	MONO_EMIT_NEW_COMPARE_BRANCH_BLOCK): Convert to new
	instruction lists.
	* mini-x86.c (emit_sig_cookie, mono_arch_call_opcode,
	peephole_pass_1, peephole_pass, mono_arch_output_basic_block,
	mono_arch_emit_prolog): Likewise.
	* cfold.c (mono_constant_fold): Likewise.
	* liveness.c (visit_bb, mono_analyze_liveness,
	optimize_initlocals): Likewise.
	* ssapre.c (dump_code, process_bb, code_motion): Likewise.
	* graph.c (mono_draw_code_cfg): Likewise.
	* ssa.c (mono_ssa_rename_vars, mono_ssa_compute,
	mono_ssa_remove, mono_ssa_avoid_copies, mono_ssa_create_def_use,
	mono_ssa_cprop): Likewise.
	* abcremoval (get_relations_from_previous_bb, process_block):
	Likewise.
	* local-propagation (mono_cprop_invalidate_values,
	mono_local_cprop_bb): Likewise.
	* mini-s390x.c (mono_arch_call_opcode, emit_sig_cookie,
	peephole_pass, mono_arch_output_basic_block,
	mono_arch_emit_prolog):	Likewise.
	* mini-arm.c (mono_arch_call_opcode, peephole_pass,
	NEW_INS, mono_arch_lowering_pass, mono_arch_local_regalloc,
	mono_arch_emit_prolog): Likewise.
	(insert_after_ins): Delete.
	* aliasing.c (print_code_with_aliasing_information,
	mono_build_aliasing_information, mono_aliasing_deadce):
	Convert to new instruction lists.
	* mini-ia64.c (emit_sig_cookie, mono_arch_call_opcode,
	peephole_pass, NEW_INS, mono_arch_lowering_pass,
	mono_arch_local_regalloc, mono_arch_output_basic_block):
	Likewise.
	(insert_after_ins): Delete.
	* mini-sparc.c (emit_sig_cookie, mono_arch_call_opcode,
	peephole_pass, mono_arch_output_basic_block): Convert to
	new instruction lists.
	* mini-codegen (InstList, inst_list_prepend,
	insert_after_ins): Delete.
	(insert_before_ins, get_register_force_spilling,
	get_register_spilling, free_up_ireg, free_up_reg,
	create_copy_ins, create_spilled_store, alloc_int_reg,
	alloc_float_reg, alloc_reg, mono_local_regalloc): Convert
	to new instruction lists.
	* mini-ppc.c (mono_arch_call_opcode, peephole_pass,
	NEW_INS, mono_arch_lowering_pass, mono_arch_local_regalloc,
	mono_arch_output_basic_block, mono_arch_emit_prolog): Likewise.
	(insert_after_ins): Delete.
	* mini-alpha.c (NEW_INS, peephole_pass, mono_arch_lowering_pass,
	mono_arch_local_regalloc, mono_arch_output_basic_block,
	mono_arch_call_opcode): Convert to new instruction lists.
	(insert_after_ins): Delete.
	* mini-s390.c (mono_arch_call_opcode, emit_sig_cookie,
	peephole_pass, mono_arch_output_basic_block,
	mono_arch_emit_prolog): Convert to new instruction lists.

2008-01-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Use a 4 byte load in OP_CHECK_THIS.

	* mini-sparc.c (mono_arch_output_basic_block): Use a byte load in CHECK_THIS.
	Fixes #353182.

	* Makefile.am (version.h): Make this work with non-bash shells.

2008-01-10  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (handle_delegate_ctor): Optimize away setting of NULL target.

2008-01-08  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Fix possible reading of invalid memory in 
	the InitializeArray optimization.

2008-01-06  Zoltan Varga  <vargaz@gmail.com>

	* mini.c driver.c: Don't include os/gc_wrapper.h.

2008-01-05  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (print_jit_stats): Print GC statistics if available.

2008-01-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_allocate_vars): Align argument storage offsets to 8.

2007-12-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-ppc.c (mono_arch_get_delegate_invoke_impl): Fix flushing of icache.

2007-12-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Move the setting of GC_stackbottom to mono_gc_base_init ().
	
	* mini.c (mini_init): Call mono_gc_base_init () instead of MONO_GC_PRE_INIT ().

	* driver.c (mono_main): Ditto.

2007-12-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline): Use mono_get_delegate_invoke ().

	* aot-compiler.c (emit_klass_info): Avoid emitting info if one of the methods
	in the vtable can't be encoded.
	(compile_method): Ditto.

2007-12-21  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (setup_jit_tls_data): Use the MONO_ARCH_INIT_TOP_LMF_ENTRY macro if
	defined.

	* mini-amd64.h mini-amd64.c exceptions-amd64.c tramp-amd64.c: Rename lmf->ebp to 
	lmf->rbp.

	* exceptions-amd64.c (mono_arch_find_jit_info): Fix the detection of whenever
	the top LMF entry belongs to the current method.

	* mini.c: Update after renaming of mono_thread_get_pending_exception ().

2007-12-20  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ia64.c (mono_arch_create_trampoline_code): Fix a warning.
	
	* tramp-ia64.c (mono_arch_create_trampoline_code): Ditto.

	* tramp-sparc.c (mono_arch_create_trampoline_code): Check for thread interruption.

	* tramp-amd64.c (mono_arch_create_trampoline_code): Ditto.

	* tramp-x86.c (mono_arch_create_trampoline_code): Check for thread interruption.

	* cpu-amd64.md mini-amd64.h mini-amd64.c inssel-amd64.brg: Add ulong->double 
	implementation.

	* basic-float.cs: Add an ulong->double cast test.

2007-12-15  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Fix a warning.

2007-12-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Add OP_SWITCH.

	* mini.c graph.c ssa.c aliasing.c mini-<ARCH>.c inssel-<ARCH>.brg: Avoid using
	CEE_SWITCH in back-end code, use OP_SWITCH instead.

2007-12-11  Geoff Norton  <gnorton@novell.com>

	* mini-s390x.c: Minor change to the MAX() define to allow
	it to compile with other gcc versions.

2007-12-11  Geoff Norton  <gnorton@novell.com>

	* cpu-s390x.md:
	* mini-s390x.c: Implement sext_i4 to fix the build on s390x

2007-12-11  Rodrigo Kumpera  <rkumpera@novell.com>

	exceptions-arm.c (mono_arch_get_restore_context): Restore
	the frame pointer.

	exceptions-arm.c (throw_exception): Save the frame pointer.
	This is a partial fix for #323747. Only the client side is
	fixed.

2007-12-11  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_method_to_ir): Verbose message in CEE_NEWOBJ
	was using an unrelated variable to log the class which
	needed the cctor to be called. This was crashing on arm.

2007-12-09  Robert Jordan  <robertj@gmx.net>

	* mini-x86.c (mono_arch_emit_epilog):
	Consider all kinds of 64-bit types. Fixes #323114.

2007-12-08  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_create_trampoline_code): Clean up the code a bit.

2007-12-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (peephole_pass): Add a missing instruction check.

Fri Dec 7 22:08:23 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: run type ctor before allocating an object, not only
	when running it's constructor method (fixes at least part of bug #342507).

2007-12-07  Zoltan Varga  <vargaz@gmail.com>
	
	* mini-trampolines.c (mono_delegate_trampoline): Fix a warning.
	
	* mini-trampolines.c (mono_generic_class_init_trampoline): Remove a debug printf.
	* mini.h mini-amd64.c mini-x86.c: Get rid of the mono_arch_find_vtable () 
	function.

	* tramp-x86.c tramp-amd64.c mini-trampolines.c: Pass the vtable argument to
	mono_generic_class_init_trampoline () the same as it is done with the other
	trampolines.

	* mini-arm.h mini-arm.c tramp-arm.c inssel-arm.brg cpu-arm.md 
	aot-runtime.c aot-compiler.c: Implement AOT support.	

2007-12-07  Mark Probst  <mark.probst@gmail.com>

	* mini-trampolines.c (mono_generic_class_init_trampoline): Fixed
	build for archs which don't have the vtable trampoline defined
	yet.

2007-12-07  Zoltan Varga  <vargaz@gmail.com>

	* tramp-x86.c (mono_arch_create_trampoline_code): Fix the build.

	* tramp-ppc.c (mono_arch_create_trampoline_code): Use the new helper function.

	* mini-trampolines.c (mono_get_trampoline_func): New helper function.

	* tramp-<ARCH>.c: Use the new helper function.

2007-12-07  Mark Probst  <mark.probst@gmail.com>

	* inssel.brg: Added a pattern for the OP_TRAMPCALL_VTABLE
	trampoline call, which takes a vtable argument.

	* graph.c, mini-ops.h, local-propagation.c, aliasing.c: Treat
	OP_TRAMPCALL_VTABLEs like other calls.

	* mini-amd64.c, mini-amd64.h, mini-x86.c, mini-x86.h: Designated a
	register to hold the vtable argument to the OP_TRAMPCALL_VTABLE
	call.  Implemented a support function which fetches the vtable
	from a register set.

	* mini.c, mini.h, tramp-amd64.c, tramp-x86.c, mini-trampolines.c:
	Implemented a generic class init trampoline, using the
	OP_TRAMPCALL_VTABLE opcode.

	* mini.c: Implemented static field access when sharing generic
	code.  This implies initing the class using the new
	OP_TRAMPCALL_VTABLE call.

2007-12-07  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Don't compile methods with sharing enabled if their
	classes are disabled for sharing.

2007-12-06  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg: Add a missing sign extension to the GETCHR and array access
	opcodes. Fixes #346563.

	* objects.cs: Add a new test.

	* aot-compiler.c (emit_method_code): Put back an #ifdef which is needed.

	* mini-<ARCH>.h mini.c aot-compiler.c aot-runtime.c: Get rid of the
	HAVE_PIC_AOT define and use AOT_SUPPORTED instead.

2007-12-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.h mini-arm.c: Add support for the common vtable trampoline.

2007-12-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-arm.c (mono_arch_emit_exceptions): Avoid uninitialized memory in the
	code stream.

2007-12-02  Zoltan Varga  <vargaz@gmail.com>

	* patch-info.h (PATCH_INFO): Add DELEGATE_TRAMPOLINE.

	* mini.c aot-compiler.c aot-runtime.c: Implement the delegate creation 
	optimization in the AOT case.
	
2007-11-30  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime (mono_aot_get_method_from_vt_slot): Add support for multi-byte method ref encodings.
	
	* aot-runtime.c (decode_klass_ref): Implement decoding of generic instances.

	* aot-compiler.c (encode_klass_ref): Implement proper encoding of generic instances.

	* mini.c (mono_method_to_ir): Optimize the common ldftn+create delegate combination.

	* mini-trampolines.c (mono_delegate_trampoline): Add some code to handle the case when the delegate
	is created by the inlined delegate ctor.

	* mini-x86.c (mono_arch_output_basic_block): Unify div/rem code and handle the case when sreg2 is EDX.	

	* mini.c (mono_jit_compile_method_inner): Replace calls to delegate invoke with the trampoline here too.

2007-11-29  Zoltan Varga  <vargaz@gmail.com>

	* cpu-x86.md: Fix the length of ckfinite.

2007-11-28  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_output_basic_block): Unify div/rem code and handle the case when sreg2 is EDX.
	
	* mini-x86.c (mono_arch_output_basic_block): Clean up the fp stack properly in CKFINITE.
	(mono_arch_output_basic_block): Get rid of unused last_ins and last_offset.

	* mini-x86.c (mono_arch_output_basic_block): Add some micro optimizations.

	* mini-x86.c inssel-x86.brg cpu-x86.md: Move the implementation of the 
	OP_START_HANDLER/OP_ENDFINALLY/OP_ENDFILTER opcodes to mini-x86.c.

2007-11-28  Martin Baulig  <martin@ximian.com>

	* mini-x86.c
	(mono_arch_get_delegate_invoke_impl): Call mono_debug_add_delegate_trampoline()
	after creating the trampoline.

2007-11-27  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_aot_module): Check runtime version if needed.

	* aot-compiler.c: Add bind-to-runtime-version for producing AOT files which only load into a runtime with
	the same version.

	* generic-sharing.c (mono_helper_get_rgctx_other_ptr): Change the signature to take the calling class
	instead of the calling method to help AOT.

	* mini.c (get_runtime_generic_context_other_ptr): Update after the change.

2007-11-26  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_init_vtable): Simplify this if MONO_ARCH_COMMON_VTABLE_TRAMPOLINE
	is defined.

2007-11-23  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_class_name_table): Properly encode generic class names.
	
	* aot-compiler.c (compile_method): Correct check for generic method definitions.
	(encode_method_ref): No need to handle generic method definitions specially.

	* mini.h (MONO_AOT_FILE_VERSION): Bump this.

	* aot-runtime.c (decode_klass_ref): Clean this up and rename from 
	decode_klass_info.

	* aot-compiler.c (encode_klass_ref): Clean this up and rename from
	encode_klass_info.
	(compile_method): Enable generic sharing.

2007-11-22  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (get_runtime_generic_context_other_ptr): Disable AOT here.
	(mini_method_compile): Add preliminary support for AOTing shared generic code.

	* aot-compiler.c (compile_method): Add preliminary support for AOTing shared
	generic code.

	* mini-trampolines.c: Fix a warning.

	* mini.c (get_runtime_generic_context_other_ptr): Use NEW_METHODCONST instead of
	NEW_PCONST.
	(mono_method_to_ir): Use NEW_DOMAINCONST in one place.
	(generic_class_is_reference_type): Remove unused function.

	* mini-trampolines.c (mono_magic_trampoline): Avoid loading metadata if possible
	in the generic vtable trampoline case.

	* aot-runtime.c (mono_aot_init_vtable): Use the generic vtable trampoline.
	
	* aot-runtime.c (mono_aot_get_method_from_vt_slot): New helper function to
	return an AOT method based on a vtable slot.

	* aot-compiler.c (compile_method): Avoid AOTing synchronized methods for now.

	* mini.c (mini_get_vtable_trampoline): Export this.

2007-11-22  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h
	(MonoDebuggerInfo): Move `debugger_version' up.

2007-11-22  Martin Baulig  <martin@ximian.com>

	* mini-amd64.c
	(mono_arch_get_delegate_invoke_impl): Call mono_debug_add_delegate_trampoline().

	* mini-trampolines.c
	(mono_delegate_trampoline): Call mono_debugger_trampoline_compiled()
	after compiling the method.

2007-11-20  Martin Baulig  <martin@ximian.com>

	* debug-mini.c
	(mono_debugger_insert_method_breakpoint): Moved into mono-debug-debugger.c.
	(mono_debugger_remove_breakpoint): Likewise.
	(mono_debugger_check_breakpoints): Likewise.

	* debug-debugger.c: Implement the new breakpoint interface here.

2007-11-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Unify the implementation of
	CEE_CONV_I1/SEXT_I1 and I2 since they are the same.

	* mini-x86.c (mono_arch_output_basic_block): Ditto.	

2007-11-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Fix a typo.

	* mini-x86.c (mono_arch_get_inst_for_method): Remove code which is now in
	mini.c.

	* mini-ia64.c (mono_arch_get_inst_for_method): Remove code which is now in
	mini.c.

	* mini-amd64.c (mono_arch_compute_omit_fp): Disable fp elimination for methods
	returning a vtype in a register.

	* mini.c (mini_get_inst_for_method): Move the handling of the atomic operations
	here from the arch specific code.

	* mini-amd64.c (mono_arch_get_inst_for_method): Remove code which is now in
	mini.c.

	* mini-amd64.c (mono_arch_output_basic_block): Add some micro optimizations.
	(mono_arch_emit_prolog): Increment maximum prolog size.

	* mini-amd64.c inssel-amd64.brg cpu-amd64.md: Move the implementation of the
	START_HANDLER/ENDFINALLY/ENDFILTER opcodes to mini-amd64.c.

	* mini-x86.c (get_call_info): Receive a MonoCompile instead of a 
	MonoGenericSharingContext.

	* mini-ia64.c (get_call_info): Receive a MonoCompile instead of a 
	MonoGenericSharingContext. Allocate memory from the cfg mempool.

2007-11-15  Mark Probst  <mark.probst@gmail.com>

	* mini.c, mini.h, generic-sharing.c: Functions for producing code
	which extract fields out of the runtime generic context.  Full
	sharing of the NEWARR opcode.

Thu Nov 15 14:20:21 CET 2007 Paolo Molaro <lupus@ximian.com>

	* abcremoval.c, mini.c, ssa.c, ssapre.c: updated to implement
	--enable-minimal=ssa.

2007-11-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_delegate_trampoline): Update after 
	mono_marshal_get_delegate_invoke () signature change.

2007-11-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Removed the shared context in favor of the generic
	sharing context.  Allocate the MonoJitInfo structure with room for
	the generic sharing context if it's needed.

	* mini.h: Remove MonoGenericSharingContext declaration.  It's in
	domain-internals.h now.

	* mini-x86.c: Pass the generic sharing context to get_call_info ().

	* generic-sharing.c: Several changes for working without a shared
	context and instead operating on open types instead.

2007-11-12  David S. Miller  <davem@davemloft.net>

       * inssel-sparc.brg: Fix double instruction emit.

2007-11-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_runtime_invoke): Avoid trying to compile the Array 
	Get/Set/Address methods.
	
	* mini.c debug-debugger.c mini-trampolines.c: Update after 
	mono_marshal_get_delegate_invoke signature change.

2007-11-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* cpu-arm.md: Increase the max size of OP_THROW to 24 bytes.
	This can happens with dynamic methods. Fixes the other bug in #322722.

2007-11-12  Rodrigo Kumpera  <rkumpera@novell.com>

	* tramp-arm.c (mono_arch_patch_callsite): Support patching
	BX call sequence.

	* mini-arm.c (arm_patch): Implement patching of BX call
	sequence. Fixes one of the bugs in #322722.

2007-11-03  David S. Miller  <davem@huronp11.davemloft.net>

       * mini-sparc.c (mono_arch_flush_icache): Make more efficient
       under Linux.  We only need to flush every 32-byte cache line.	

2007-11-07  Massimiliano Mantione  <massi@ximian.com>

	* mini.c:
	move_basic_block_to_end: Add branches when needed, eventually creating
	a new BB.
	optimize_branches: added a parameter that tells if it's ok to create
	new BBs (doing is "df_visit" has been called is (IMHO) a nightmare),
	and avoid calling move_basic_block_to_end when it's not ok.
	Fixes bug 318677.

2007-11-07  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Abort inlining call to InitializeArray if something
	looks wrong.  Let the icall handle it, which now has proper safety
	checks.

2007-11-05  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (mono_spill_call): add support for soft-float.

	* mini.c (mono_method_to_ir): add support for soft-float
	to inlined functions that return float.

	* mini.c (mono_method_to_ir): add support for soft-float
	to cee_stsfld opcode on float fields.

2007-11-05  Geoff Norton  <gnorton@novell.com>

	* mini-x86.h: Fix the structure access for X86 Leopard.


2007-11-05  Martin Baulig  <martin@ximian.com>

	* mini-trampolines.c
	(mono_magic_trampoline): Call mono_debugger_trampoline_compiled()
	after compiling the method to notify the debugger.

2007-11-05  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Use the new breakpoint tables.

2007-11-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (EMIT_COND_SYSTEM_EXCEPTION_GENERAL): Applied patch from
	David Miller <davem@davemloft.net>. Allow larger offsets in branches.

2007-11-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Check the domain as well for
	native-to-managed wrappers.
	
2007-11-01  Geoff Norton  <gnorton@novell.com>

	* mini-ppc.h, mini-x86.h:  Handle Leopards renaming of some structure 
	members.

Wed Oct 31 20:23:14 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-x86.c: when getting back from unmanaged code
	to managed via a marshaled delegate we also need to set the
	right domain.

Wed Oct 31 19:53:33 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-amd64.c, mini-amd64.h, tramp-amd64.c: breakpoint table support
	for amd64.

Wed Oct 31 19:29:30 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, mini-x86, tramp-x86.c, mini-x86.h: added API to
	let the debugger or other external agents to tell the JIT when
	a sw breakpoint has been inserted in the code that the JIT needs
	to be able to inspect.

2007-10-31  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h
	(MonoDebuggerInfo): Remove `runtime_class_init'.

2007-10-30  Martin Baulig  <martin@ximian.com>

	* debug-mini.h
	(mono_debugger_thread_created): Added `MonoThread *' argument.
	(mono_debugger_extended_notification): New public method.
	(mono_debugger_trampoline_compiled): New public method.

	* debug-mini.c
	(MonoDebuggerThreadInfo): Added `thread' and
	`extended_notifications' fields.

	* debug-debugger.c
	(debugger_executable_code_buffer): New static variable.

	* debug-debugger.h
	(MonoDebuggerInfo): Added `executable_code_buffer',
	`executable_code_buffer_size', `breakpoint_info_area',
	`breakpoint_table' and `breakpoint_table_size'.

2007-10-26  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini-arm.c (mono_arch_build_imt_thunk): Take the advantage
	that IP  either is an unused value or the vtable pointer. IMT 
	calls use vtable + offset now. Reduced by almost half the size
	of IMT entries.

2007-10-26  Jonathan Chambers <joncham@gmail.com>

	* mini-amd64.c: Begin Win64 port. Use AMD64_ARG_REG#
	defines to access param registers. Replace long usage with
	gsize as sizeof(long) != sizeof(void*) on Win64.

	* mini-amd64.h: Add %rdi and %rsi to MonoLMF structure
	on Win64. Fix intrinsic, use _AddressOfReturnAddress
	instead of non-existant _GetAddressOfReturnAddress.

	* tramp-amd64.c: Use AMD64_ARG_REG#	defines to access 
	param registers. Save/restore %rdi and %rsi in MonoLMF.

	* exceptions-amd64.c: Use AMD64_ARG_REG# defines to access 
	param registers. Modify (throw_exception) signature to take 
	%rdi and %rsi on Win64. 

	Code is contributed under MIT/X11 license.

Thu Oct 25 23:06:58 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* helpers.c: unlink debugging output files.

2007-10-25  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Move mono_create_ftnptr () to object.c.

2007-10-24  Rodrigo Kumpera  <rkumpera@novell.com>

	* helpers.c (mono_disassemble_code): MonoCompile parameter is now
	optional. This function can now be used to disassemble code generated
	outside the JIT such as trampolines and IMT thunks.

	* mini-arm.h: defined MONO_ARCH_HAVE_IMT.

	* mini-arm.c (decode_vcall_slot_from_ldr): added, extract the
	vtable pointer from a ldr instruction.

	* mini-arm.c (mono_arch_get_vcall_slot_addr): support the
	new IMT call sequence.

	* mini-arm.c (mono_arch_output_basic_block): emit the IMT
	call sequence for interface invocations.

	* mini-arm.c (mono_arch_emit_imt_argument): added, required
	for imt support. This function is empty since IMT on ARM requires no
	special handling on the IR side.

	* mini-arm.c (mono_arch_find_imt_method): added, required for
	imt support.

	* mini-arm.c (mono_arch_find_this_argument): added, required
	for imt support.

	* mini-arm.c (arm_emit_value_and_patch_ldr): added, patches
	a ldr instruction to load a value stored in the code stream.

	* mini-arm.c (mono_arch_build_imt_thunk):added, required
	for imt support.


2007-10-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Install the jump trampoline callback.

Tue Oct 23 17:07:52 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-trampolines.c: handle synchronized methods with the common
	vtable trampoline (bug #335601).

2007-10-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.h mini-amd64.c: Add support for the common vtable trampoline.

	* inssel.brg (mini_emit_virtual_call): Fix the computation of ins->inst_offset on
	64 bit platforms.

	* mini-ia64.h mini-ia64.c: Add support for IMT.

	* mini-x86.c (mono_arch_emit_prolog): Increase the size allocated for the
	prolog. Fixes #331958.

2007-10-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.h mini-sparc.c: Add support for the common vtable trampoline.

Mon Oct 15 11:18:52 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-ppc.h: ppc support for the common vtable
	trampoline.

Mon Oct 15 10:41:27 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-amd64.c, mini-amd64.h: amd64 support for the common vtable
	trampoline.

Mon Oct 15 10:39:26 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, mini-x86.h: x86 support for the common vtable
	trampoline.

Mon Oct 15 10:37:15 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-trampolines.c: changed the magic rampoline to understand
	the common vtable trampoline method: the method to invoke is
	determined by the vtable displacement of the call.

Mon Oct 15 10:35:12 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h: register the common vtable trampoline if the
	architecture supports it.

Mon Oct 15 09:50:52 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* cpu-amd64.md: use the correct max length for tls_get.

2007-10-14  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Use mini_get_class in CEE_LDELEM_ANY and
	CEE_STELEM_ANY. Fixes #333696.

Thu Oct 11 18:04:29 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-x86.c: provide more graceful handling of the case where
	we followed a bogus function pointer from managed code (bug #332866).

2007-10-11  Mark Probst  <mark.probst@gmail.com>

	* mini.h, mini.c: Introduced the MonoGenericSharingContext, which
	replaces the generic_shared flag and will carry more information
	in the future.

	* generic-sharing.c: Added mini_type_stack_size() which allows
	allows open types if given a generic sharing context.
	mini_get_basic_type_from_generic() takes a
	MonoGenericSharingContext* instead of a MonoCompile* now.

	* mini-alpha.c, mini-amd64.c, mini-arm.c, mini-hppa.c,
	mini-ia64.c, mini-mips.c, mini-ppc.c, mini-s390.c, mini-s390x.c,
	mini-sparc.c, mini-x86.c: Trivial changes required by the two
	changes above.  Just passing arguments through to the right
	places.

Wed Oct 10 19:44:42 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: unify the call emission to emit_code_seq().

Wed Oct 10 13:05:46 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* tramp-arm.c: reduced the trampoline size.

2007-10-10  Mark Probst  <mark.probst@gmail.com>

	* generic-sharing.c, mini.h, mini-amd64.c, mini-x86.c: Moved type
	variable handling out of arch-specific code.

Wed Oct 10 10:49:28 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: implemented fast delegate dispatch.

2007-10-09  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_compute_omit_fp): Add more checks to ensure
	that fp elimination is turned off if the space required by locals is too
	big. Fixes #331958.

Tue Oct 9 21:01:03 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, mini-arm.c, mini-arm.h, tramp-arm.c: ported
	ARM to the new style trampoline.

2007-10-09  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c: Rework the specific trampoline code to make it smaller.

	* mini-amd64.h mini-amd64.c: Export amd64_patch as mono_amd64_patch.

2007-10-09  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h
	(MonoDebuggerMetadataInfo): Added `field_info_type_offset' and
	`field_info_offset_offset'.	

Tue Oct 9 09:47:51 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-ppc.h, mini-ops.h, inssel-ppc.brg, cpu-g4.md:
	removed more internal usage of the r11 register and made it available
	to the register allocator.

2007-10-08  Mark Probst  <mark.probst@gmail.com>

	* mini.c, mini-amd64.c, mini-x86.c: Allow open generic contexts
	when sharing generics and treat type variables as references.

Mon Oct 8 10:55:38 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: started removing the internal uses of register r11
	to eventually allow the register allocator to manage it as an
	additional available register.

Mon Oct 8 14:25:39 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* tramp-amd64.c: fixed memory corruption in the trampoline generation.

Mon Oct 8 12:06:33 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c, tramp-x86.c: reduce the alignment requirements for
	specific trampolines as they are not performance critical as a jump
	target (maybe align as before only for AOT code?). This saves about
	200 KB of native code on x86 for monodevelop startup.

Mon Oct 8 10:04:40 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c: reduce the size of the trampolines, saves 160KB on
	monodevelop startup.

2007-10-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_get_vcall_slot_addr): Allow signed displacements.

	* mini-sparc.h mini-sparc.c: Implement IMT support.

	* tramp-sparc.c (mono_arch_create_trampoline_code): Rework the trampoline code so
	its smaller and doesn't clobber sparc_g1.

	* mini-sparc.c (mono_arch_get_vcall_slot_addr): Update after trampoline changes.

Fri Oct 5 18:28:11 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: optimized the size of the IMT thunks a bit.

Fri Oct 5 18:08:30 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: implemented fast delegate invocation.

Fri Oct 5 00:01:05 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, mini-ppc.c: IMT support for the PPC architecture.

Thu Oct 4 22:04:49 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-ppc.h, tramp-ppc.c, Makefile.am: port the PPC
	code to the new style trampoline in preparation for IMT support.

Thu Oct 4 19:01:59 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, tramp-ppc.c: don't use r13 as it's used by the PPC EABI
	systems already. This also reduces the specific trampiline sizes and
	prepares for the use of r12 as the IMT identifier register.

Thu Oct 4 16:38:27 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-mips.h: endianess fix (simplified from a patch by
	Thomas Kunze <thommy@tabao.de>, bug #323737).

Thu Oct 4 14:43:49 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c, mini-ppc.h: refactor to use macros
	to access ucontext fields and enable netbsd support
	(partially from Magnus Henoch <mange@freemail.hu>).

Thu Oct 4 12:35:27 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* genmdesc.pl: patch from Henryk Plotz <henryk@openmoko.org> to
	use the preprocessor from the CPP env var if it is set.

Wed Oct 3 17:11:38 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-trampolines.c: fixed an assertion and moved it earlier in the
	code, before interface_offset gets used.

2007-10-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-trampolines.c (mono_convert_imt_slot_to_vtable_slot): Call 
	mono_class_setup_vtable () before accessing klass->vtable.

2007-10-01  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (get_plt_index): Rework the handling of wrappers to be not so
	hackish.

Mon Oct 1 15:00:27 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-trampolines.c, mini.h: enable the lazy filling of the
	IMT slots (this saves hundreds of KB of memory in programs like
	IronPython and Monodevelop).

Mon Oct 1 14:44:19 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: print the delegate counter.

Mon Oct 1 14:36:50 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: make it easier to enable the debugging code for IMT
	slots.

2007-09-28  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h
	(MonoDebuggerMetadataInfo): Add `klass_image_offset',
	`mono_method_klass_offset' and `mono_method_token_offset'.

2007-09-20  Mark Probst  <mark.probst@gmail.com>

	* mini.c: First generics sharing implementation.  Can only share
	in very simple cases.  If sharing doesn't work it falls back to
	dedicated compilation.

	* mini.h: Flag in MonoCompile to specify whether generic
	compilation is shared.  Flags enum for marking which generic inst
	of a context is used.  Prototypes for helper functions.

	* generic-sharing.c: Helper functions for generic method sharing.

	* optflags-def.h: Optimization flag (gshared) for enabling generic
	method sharing added.

	* Makefile.am: generic-sharing.c added.

2007-09-19 Daniel Nauck <dna@mono-project.de>

	* mini.c (mono_thread_abort): fixed typo in r86014. It should be '==' instead of '!='.

2007-09-19  Massimiliano Mantione  <massi@ximian.com>
	* mini.c (mono_thread_abort): Correctly handle ThreadAbortException,
	fixes bug 325507.

2007-09-19  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_cleanup): Only call mono_debugger_cleanup() here;
	mono_debug_cleanup() is now part of mono_cleanup().

2007-09-18  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Fix a warning.

2007-09-17  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Optimize various parts when processing large assemblies.
	Fixes ##325568.

	* mini.c (mono_patch_info_hash): Improve hash function.

2007-09-14  Jonathan Chambers <joncham@gmail.com>

	* mini-exceptions.c: Add HAVE_UNISTD_H check around include.
	
	Code is contributed under MIT/X11 license.

2007-09-14  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Fix a leak.

	* debug-mini.c (mono_debug_free_method_jit_info): Fix a leak.

Fri Sep 14 12:53:13 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: redirect string.InternalAllocStr() to the managed allocator.

2007-09-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_find_imt_method): Add support for AOT code.

2007-09-13  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am generics-variant-types.2.il generics.cs: Add some generics
	variance tests.

	* inssel.brg: Reorganize the isinst/castclass code to reduce code duplication.

	* mini.c (handle_alloc): Enable managed allocators in AOT code.

	* aot-compiler.c (encode_patch): Add support for MONO_WRAPPER_ALLOC.

	* aot-runtime.c (decode_patch_info): Ditto.

2007-09-12  Jonathan Chambers <joncham@gmail.com>

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): Implement
	static case. Cache delegates in architecture specific code, 
	based on number of parameters.
	
	* mini-amd64.c (mono_arch_get_delegate_invoke_impl): Cache delegates
	in architecture specific code, based on number of parameters.
	
	* mini-trampolines.c (mono_delegate_trampoline): Architecture specific 
	caching happen in architecture specific code now.
	
	Code is contributed under MIT/X11 license.

2007-09-12  Jonathan Chambers <joncham@gmail.com>

	* mini.h, mini.c, mini-x86.c, mini-amd64.c, mini-hppa.c, mini-mips.c,
	mini-s390x.c, mini-arm.c, mini-ia64.c, mini-sparc.c, mini-ppc.c, mini-alpha.c,
	mini-s390.c: Add mono_arch_init and mono_arch_cleanup methods.

	Code is contributed under MIT/X11 license.

2007-05-15  Massimiliano Mantione  <massi@ximian.com>
	* mini.c: (mono_thread_abort) Fixed bug #82416.

Tue Sep 11 16:15:53 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.: hook the new managed GC allocation feature into the JIT.

Tue Sep 11 16:14:16 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: implementation for the new runtime tls opcode.

2007-09-11  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h
	(MonoDebuggerMetadataInfo): Add `mono_method_flags_offset' and
	`mono_method_inflated_offset'.

2007-09-07  Zoltan Varga  <vargaz@gmail.com>

	* driver.c mini.h mini.c: Add a new devel command line option for injecting
	async exceptions into a method.

	* mini-amd64.h mini-amd64.c: Implement injecting of async exceptions for the
	purpose of testing whenever the unwinder works at every instruction.

Thu Sep 6 12:42:14 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: check accessibility of method used in ldftn (fixes
	bug #82635).

2007-09-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Fix a warning.

	* inssel.brg: Fix a warning.

2007-09-03  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c: `MONO_DEBUGGER_EVENT_INITIALIZE_MANAGED_CODE'
	now takes the `main_method' as argument.

2007-09-02  Zoltan Varga  <vargaz@gmail.com>

	* cpu-sparc.md (endfilter): Add missing src1:i argument.

2007-08-30  Jonathan Chambers <joncham@gmail.com>

	* driver.c: include the cil-coff.h header on Windows.
	
	Code is contributed under MIT/X11 license.

Thu Aug 30 16:17:23 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, driver.c: don't include the cil-coff.h header.

Thu Aug 30 14:50:53 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: flag places that needs fixes fo soft-float support.

Wed Aug 29 18:26:20 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h, inssel-float.brg: fix soft-float constant loads on big
	endian systems (partially from Dean Jenkins, bug #81924).

2007-08-28  Mark Probst  <mark.probst@gmail.com>

	* mini.c (check_linkdemand): Remove embedded reference object in
	call to LinkDemandSecurityException.
	(mono_jit_compile_method_inner): Call LinkDemandSecurityException
	with an IntPtr instead of a reference object.

2007-08-28  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (handle_initobj): Handle alignment properly.

	* inssel.brg (mini_emit_memset): Ditto.	

	* inssel.brg (mini_emit_memcpy): Ditto.	

	* inssel-sparc.brg: Ditto.		

	* mini.h mini.c inssel-*.brg: Pass alignment information to OP_MEMCPY/MEMSET.

2007-08-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_exception_internal): Skip the first frame for
	exceptions raised in unmanaged code. Fixes part of #82594.

2007-08-24  Mark Probst  <mark.probst@gmail.com>

	* mini.c (mono_method_to_ir), declsec.c
	(mono_declsec_linkdemand_aptc): Fixed custom attr leaks.

2007-08-22  Martin Baulig  <martin@ximian.com>

	* debug-mini.h
	(MonoDebuggerThreadInfo): New typedef.
	(mono_debugger_thread_table): New global variable.
	(mono_debugger_thread_created): New public function.
	(mono_debugger_thread_cleanup): New public function.

	* debug-debugger.h
	(MonoDebuggerInfo):
	- removed `get_current_thread' and `lookup_assembly'.
	- removed `data_table'.
	- added `thread_table'.

	* mini.c
	(mono_thread_start_cb): Call mono_debugger_thread_created().
	(mono_thread_attach_cb): Likewise.
	(mini_thread_cleanup): Call mono_debugger_thread_cleanup().
	(mini_cleanup): Move mono_debug_cleanup() down, after free'ing the
	initial domain.

	* driver.c (mono_main): Move mono_debug_init() up, before calling
	mini_init(); mono_debug_init_1() and mono_debug_init_2() are gone.

Tue Aug 21 16:40:04 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, inssel-x86.brg: group multiple stack adjustments
	together when passing several arguments of type double (gives a small
	speedup and saves a few bytes of generated code).

2007-08-20  Jb Evain  <jbevain@novell.com>

	* mini.c (mono_method_to_ir): fix leak on InvalidProgramException.

2007-08-20  Jb Evain  <jbevain@novell.com>

	* mini.c (mono_method_to_ir): throw MethodAccessException
	and FieldAccessException instead of InvalidProgramException.

2007-08-20  Mark Probst  <mark.probst@gmail.com>

	* mini.c: CoreCLR security checks.

	* mini.h: Removed MonoSecurityMode (moved to
	metadata/security-manager.h) and mono_security_mode global var
	(replaced by set/get functions in security-manager.h).

	* driver.c: Added "core-clr-test" security mode for testing.  Used
	set-function for setting security mode.

2007-08-17  Mark Probst  <mark.probst@gmail.com>

	* mini.c: MonoJitInfo's are freed hazardously now.  Statistics for
	the new jit_info_table.

	* driver.c: Test code for the new jit_info_table (enabled by the
	define MONO_JIT_INFO_TABLE_TEST).

2007-08-14  Zoltan Varga  <vargaz@gmail.com>

	* tramp-amd64.c (mono_arch_nullify_class_init_trampoline): Fix
	detection of call <REG> instruction sequence. Fixes build on freebsd.

2007-08-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c: Fix a warning.

2007-08-11  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-amd64.c (mono_arch_handle_altstack_exception): Enable the new
	stack overflow handling code on amd64 too.

	* mini-exceptions.c (mono_setup_altstack): Make this use 
	mono_thread_get_stack_bounds ().

	* mini-x86.h: Disable sigaltstack on solaris x86.

2007-08-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_setup_altstack): Enable this to work on solaris x86.

2007-08-10  Geoff Norton  <gnorton@customerdna.com>

	* tramp-x86.c: Remove some unneeded alignment changes on Apple.  Fixes #82387.

2007-08-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_print_thread_dump): Enable this on amd64 too.

	* mini-amd64.h (MONO_INIT_CONTEXT_FROM_FUNC): Fix a warning.

2007-08-03  Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c (add_general): Adjust offset calculation to take into account of rounding up
	due to alignment.

Thu Aug 2 17:36:22 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: avoid an invalid encoding of unsigned right shift by 0
	to be emitted (bug #82281).

2007-08-01  Martin Baulig  <martin@ximian.com>

	Merged the `debugger-dublin' branch.

	* debug-debugger.h (MonoDebuggerInfo):
	Removed the `old_*' compatibility entries.
	Added `debugger_version' and `data_table'.
	Renamed `get_method_addr_or_bpt' -> `insert_breakpoint'.
	Renamed `remove_method_breakpoint' -> `remove_breakpoint'.

	* debug-mini.c
	(MiniDebugMethodBreakpointInfo): Add `address_list'.
	(mono_debugger_check_breakpoints): Take a `MonoDebugMethodAddress *'
	instead of a `gconstpointer'.
	(mono_debugger_insert_method_breakpoint): Return a
	`MonoDebugMethodAddressList *'.

2007-06-28  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Added `debugger_version'.

2007-08-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.h (MONO_INIT_CONTEXT_FROM_FUNC): Avoid using 
	__builtin_frame_address () since it is broken on older gcc versions.

Tue Jul 31 17:34:42 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, mini-exceptions.c: added a bit of documentation
	on the stack overflow handling and made the managed stack overflows
	catchable in most cases using soft guard pages.
	* exceptions-x86.c: added code to restore the protection in the soft
	guard pages at the end of exception handling.

2007-07-31  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (SIG_HANDLER_SIGNATURE): Fix a warning.

Mon Jul 30 17:43:13 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c, mini-ppc.h: arch-specific stack overflow
	exception handling.

Mon Jul 30 17:38:13 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-alpha.h, mini-ia64.h, mini-sparc.h: disable the altstack
	signal handling support until it has been ported to the new mechanism.
	* mini.c: fixed stack overflow detection and use the new
	architecture code  to handle signals on the altstack.

Mon Jul 30 17:33:02 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-amd64.c, mini-amd64.h: amd64 code to handle
	stack overflows on the alt stack.

Mon Jul 30 17:29:56 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-x86.c, mini-x86.h, mini.h: new code to handle
	stack overflows on the alt stack.

Mon Jul 30 11:50:06 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: cleanup preparing for altstack support.

Mon Jul 30 11:31:24 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-arm.c: cleanup preparing for altstack support.

2007-07-27  Mark Probst  <mark.probst@gmail.com>

	* mini.c (print_jit_stats): Output hazard pointer stats.

2007-07-26  Mark Probst  <mark.probst@gmail.com>

	* driver.c, mini.c: Replaced security mode flags with a single
	enum variable.

Thu Jul 26 20:12:12 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-exceptions.c: cleanup the sigaltstack code.

2007-07-25  Mark Probst  <mark.probst@gmail.com>

	* mini.c, mini.h, driver.c (mono_main): Added command-line flag
	(which doesn't do anything yet) for activating Core CLR
	(Silverlight) security.

Tue Jul 24 21:16:17 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-codegen.c: work around a possible gcc bug on arm.

Tue Jul 24 17:20:19 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* driver.c, mini-x86.h, mini-amd64.h: print a nice error
	message for platforms that don't support AOT compilation.

Mon Jul 23 10:29:29 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, driver.c: temporary smcs hack.

Mon Jul 23 09:29:34 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-arm.h, mini-arm.c: arm EABI fixes.

2007-07-22  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c (mono_arch_find_jit_info): Handle the lmf->method == NULL
	case.

	* tramp-x86.c (mono_arch_create_trampoline_code): Only set lmf->method for
	trampolines taking a method argument.

	* mini-x86.h (MonoLMF): Add an 'esp' field plus comments.

	* mini-x86.c (mono_arch_emit_prolog): Update after changes to the LMF structure.
	* tramp-x86.c (mono_arch_create_trampoline_code): Ditto.

	* exceptions-x86.c (mono_arch_get_jit_info): Properly clean up the stack after
	JIT compilation throws an exception. Fixes #82050.

2007-07-19  Mark Probst  <mark.probst@gmail.com>

	* mini.c: Removed the MonoLoaderErrorKind enum and replaced it
	with the MONO_EXCEPTION_ defines.

2007-07-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_find_imt_method): Handle mov reg,IMM64 case. Fixes
	#82117.
	
	* mini-amd64.c (mono_arch_find_imt_method): Add some debug code to help find out
	the cause of an assertion.

Mon Jul 16 19:31:21 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.c: mono_get_inflated_method() is obsolete,
	removed.

2007-07-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_build_imt_thunk): Remove the non-32bit MonoMethod
	assert. Should fix #82103.

2007-07-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_jit_walk_stack_from_ctx): Use MONO_CONTEXT_GET_SP ()
	here too. Fixes #82095.

	* mini-amd64.c (mono_arch_build_imt_thunk): Add support for non-32bit MonoMethod
	addresses.

	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Add a couple asserts.

	* mini-amd64.h: Enable IMT for amd64.
	
	* mini-amd64.c (mono_arch_build_imt_thunk): Optimize IMT thunk size.

2007-07-12  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Add support for IMT call sequences.

2007-07-12  Mark Probst  <mark.probst@gmail.com>

	* mini.c (check_linkdemand, mono_method_to_ir): Abort compilation
	as soon as check_linkdemand sets an exception_type.

Thu Jul 12 12:18:22 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: fixed offsets for IMT call sequence.
	* mini-x86.h: enable IMT again.

2007-07-11  Zoltan Varga  <vargaz@gmail.com>

	* trace.c (mono_trace_enter_method): Decode MonoType too.

	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Handle signed displacements too.

	* mini.h mini-x86.h mini-trampolines.c: Change the signature of mono_arch_find_imt_method () to pass the calling code address too.

	* mini-amd64.c: Add preliminary IMT implementation.
	
Wed Jul 11 18:21:30 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: adjusted mono_arch_get_vcall_slot_addr () to
	understand the new IMT-base interface invocation (thanks to
	Daniel Nauck for the report and the remote debugging session).

Wed Jul 11 14:54:39 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: size and speed optimizations for the IMT bsearch.

2007-07-11  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (aotcheck): Make this actually use the AOTed code.

Wed Jul 11 12:41:32 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-trampolines.c: implement AOT IMT support.
	* mini-x86.h: enable IMT support for wider testing.

2007-07-10  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (emit_imt_argument): Add aot support here.

	* aot-runtime.c (decode_patch_info): Fix reading of MONO_PATCH_INFO_METHOD.

Tue Jul 10 17:50:58 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, mini-x86.h, tramp-x86.c: x86 arch-specific changes
	of the IMT implementation, partially from massi, with my
	implementation of the bsearch sequence. Disabled by default until
	the AOT code is implemented.

2007-07-10  Zoltan Varga  <vargaz@gmail.com>

	* cpu-x86.md: The source argument of sext_i1/i2 must by a byte reg.

	* inssel-x86.brg: Add reg:ldind.i1(regvar) rules. Fixes #82056.

Tue Jul 10 17:33:12 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* inssel.brg, mini.c, mini.h, mini-trampolines.c:
	arch-independent IMT JIT code from Massimiliano
	Mantione (massi@ximian.com) with small cleanups from me.

Tue Jul 10 13:07:24 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: fix svn invocation to get the svn revision to be
	independent of the local language (build fix).

2007-07-09  Mark Probst  <mark.probst@gmail.com>

	* mini.c (inline_method): Reset cfg->exception_type if the
	inlining is aborted.  Fixes: 82049.

Mon Jul 9 17:26:47 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: remove assert from exception handling code when exception_ptr
	is not set.

2007-07-05  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_codegen): Add an assert.

	* mini-x86.c (mono_arch_emit_prolog): Allocate space for the profiler method 
	enter and leave code.
	* mini-amd64.c (mono_arch_emit_prolog): Likewise.

Thu Jul 5 20:12:52 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixed memory corruption for localloc(0)
	(bug #81852).

2007-07-05  Zoltan Varga  <vargaz@gmail.com>
	
	* mini.c: Fix warnings.

Wed Jul 4 15:30:36 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* optflags-def.h, mini-x86.c: added sse2 optimization flag and use it
	to emit better double->int conversions.

Tue Jul 3 19:42:16 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: the provided Min/Max optimizations are valid for unisgned
	ints.

2007-07-03  Rodrigo Kumpera  <rkumpera@novell.com>

	* mini.c (can_access_method, can_access_field): methods moved to metadata/class.c and renamed to mono_method_can_access_method and mono_method_can_acesss_field

2007-06-28  Miguel de Icaza  <miguel@novell.com>

	* mini.c (mono_running_on_valgrind): Add support for reporting the
	method and  its boundaries to valgrind.

2007-06-28  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Added `debugger_version'.

2007-06-25  Zoltan Varga  <vargaz@gmail.com>

	* ssa.c (visit_inst): Add support for OP_BR. Fixes #81946.

	* generic.2.cs: Add new test case.

2007-06-25  Martin Baulig  <martin@ximian.com>

	Merged the `debugger-dublin' branch.

	* debug-mini.c
	(mono_debugger_insert_method_breakpoint): New public method.
	(mono_debugger_remove_method_breakpoint): Likewise.
	(mono_debugger_check_breakpoints): New static method.
	(mono_debug_close_method): Call mono_debugger_check_breakpoints().

	* debug-debugger.h (MonoDebuggerInfo):
	Renamed (to keep backward compatibility in the vtable):
	`insert_breakpoint' -> `old_insert_breakpoint'.
	`remove_breakpoint' -> `old_remove_breakpoint'.
	`create_string' -> `old_create_string'.
	`lookup_class' -> `old_lookup_class'.
	`lookup_type' -> removed; changed into a dummy field.
	`lookup_assembly' -> `old_lookup_assembly'.
	Added (same functionality, but different signature):
	`create_string', `lookup_class', `lookup_assembly'
	Added new:
	`get_method_addr_or_bpt', `remove_method_breakpoint',
	`runtime_class_init'.

	* debug-debugger.c: Merged the `debugger-dublin' branch.

2007-06-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (peephole_pass_1): Optimize away moves at the beginning of the bb as
	well.
	(peephole_pass): Likewise.

Fri Jun 22 09:17:08 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* driver.c: hopefully make setaffinity work also for ancient
	versions of linux.

2007-06-22  Atsushi Enomoto  <atsushi@ximian.com>

	* driver.c : win32 build fix.

Thu Jun 21 19:24:03 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* driver.c: check for the MONO_NO_SMP env var and bind to a single
	processor if it is set.

2007-06-21  Martin Baulig  <martin@ximian.com>

	* debug-mini.h: New file.

	* debug-mini.c
	(mono_debugger_insert_breakpoint_full): Moved here from
	../metadata/mono-debug-debugger.c.
	(mono_debugger_remove_breakpoint): Likewise.
	(mono_debugger_breakpoint_callback): Likewise.

2007-06-15  Raja R Harinath  <rharinath@novell.com>

	* jit-icalls.c (mono_helper_compile_generic_method): Update to
	changes in MonoGenericClass.

2007-06-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_opcode_to_type): Fix ia64 build.

2007-06-14  Raja R Harinath  <rharinath@novell.com>

	* jit-icalls.c (mono_helper_compile_generic_method): Update to
	removal of MonoGenericMethod.

Thu Jun 14 12:42:04 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: hooks for the exception events profiling API.

2007-06-14  Randolph Chung  <tausq@debian.org>

	* Makefile.ma: Add hppa target.
	* mini-arch.h: Include mini-hppa.h
	* cpu-hppa.md, exceptions-hppa.c, inssel-hppa.brg, mini-hppa.c,
	mini-hppa.h, tramp-hppa.c: New files for 32-bit HPPA port.
	Contributed under the X11 license (http://bugzilla.ximian.com/show_bug.cgi?id=81866).

2007-06-14  Randolph Chung  <tausq@debian.org>

	* inssel.brg: Add rules for "chained" compare-branch operations so that
	a single compare op can affect multiple branches.  Adjust cost for
	OP_CEQ/OP_CGT/OP_CGT_UN/OP_CLT/OP_CLT_UN.
	* inssel-long32.brg: Update rules to use compare-branch macros.  Adjust
	cost for some rules so that they can more easily be overridden by
	per-arch rules (with fixes from lupus).
	Contributed under the X11 license (http://bugzilla.ximian.com/show_bug.cgi?id=81866).

2007-06-13  Randolph Chung  <tausq@debian.org>

	* mini-ops.h: Reorder branch ops so that they match the order of the
	corresponding CEE_* ops.  The code expects them this way.
	Add new ops for HPPA target.
	Contributed under the X11 license (http://bugzilla.ximian.com/show_bug.cgi?id=81866).

2007-06-13  Randolph Chung  <tausq@debian.org>

	* mini-exceptions.c: Handle cases where the stack grows towards
	larger addresses.
	Contributed under the X11 license (http://bugzilla.ximian.com/show_bug.cgi?id=81866).

Wed Jun 13 19:13:23 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c, mini.h, mini.c: added virtual generic invoke
	counter.
	* driver.c: explain where a non-matching corlib is found.

2007-06-13  Mark Probst  <mark.probst@gmail.com>

	* mini.c (print_jit_stats): Output dynamic code allocation stats.

2007-06-10  Sanghyeon Seo <sanxiyn@gmail.com>

	* mini-exceptions.c: Generate a method profile leave event during
	an exception to ensure that the profiler gets notified.

2007-06-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (peephole_pass): Merge some small changes from the linear-ir 
	branch.

	* cpu-amd64.md: Add long_and/or/xor opcodes.

2007-06-06  Wade Berrier  <wberrier@novell.com>

	* cpu-s390x.md (shr_imm): Correct the length of shr_imm instruction.
	(./class/lib/monolite/mcs.exe:25498): WARNING **: wrong maximal instruction 
	length of instruction shr_imm (expected 8, got 10)

2007-06-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_output_basic_block): Really fix the build.

2007-06-06  Mark Probst  <mark.probst@gmail.com>

	* mini.c, driver.c: Changed MonoDomain.jit_code_hash to a
	MonoInternalHashTable again (fixed bug in the internal hash table
	code).

2007-06-06  Mark Probst  <mark.probst@gmail.com>

	* mini.c, driver.c: Reverted the MonoInternalHashTable changes.
	Have to figure out what makes it crash the SWF regression.

2007-06-05  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_lowering_pass): Fix ia64 build.

Tue Jun 5 17:40:04 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: optimize out the type check when storing null in a
	reference array.

2007-06-04  Mark Probst  <mark.probst@gmail.com>

	* mini.c, driver.c: Changed MonoDomain.jit_code_hash to a
	MonoInternalHashTable.

Mon Jun 4 11:29:43 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* inssel.brg, mini.c, mini-ops.h: optimized Math.Mini/Max
	signed integer methods.

2007-06-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): Disable the static case 
	permanently since the current approach doesn't work.

2007-06-02  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (stmt): Only call delegate->invoke_impl if 
	MONO_ARCH_HAVE_CREATE_DELEGATE_TRAMPOLINE is defined.

2007-06-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Unify div/rem opcodes and handle
	the sreg2==rdx case.
	
	* mini-amd64.c cpu-amd64.md: Correct length of r4const instruction and take into
	account if it contains a rex prefix.
	(peephole_pass): Handle OP_FMOVE as well.

2007-06-01  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): Disable the static case for now
	as it causes regressions.

2007-05-31  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): Implement support for the
	static case as well.

	* tramp-ia64.c (mono_arch_create_trampoline_code): Fix ia64 build.

	* mini-x86.c (mono_arch_get_delegate_invoke_impl): New arch dependent function.
	(mono_arch_get_this_arg_from_call): Ditto.

	* tramp-x86.c (mono_arch_patch_delegate_trampoline): Removed.

	* inssel.brg (mini_emit_virtual_call): Call delegate->Invoke through the delegate's
	invoke_impl field.

	* mini-amd64.c (mono_arch_get_delegate_invoke_impl): New arch dependent function.
	(mono_arch_get_this_arg_from_call): Ditto.

	* tramp-amd64.c (mono_arch_patch_delegate_trampoline): Removed.
	
	* mini-trampolines.c (mono_delegate_trampoline): Complete rewrite. On first call,
	try to create optimized invoke code and use that for further invocations. 
	Otherwise, use the original mono_marshal_get_delegate_invoke () implementation.

	* mini-x86.h mini-ia64.h: Remove MONO_ARCH_HAS_CREATE_DELEGATE_TRAMPOLINE for now.

2007-05-29  Rodrigo Kumpera  <kumpera@gmail.com>

	* inssel.brg (mini_emit_virtual_call): Statically dispatch virtual calls to
	sealed classes or methods.
	*devirtualization.cs: tests for the new optimization

2007-05-29  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c (update_gen_kill_set): No need to set VOLATILE flags here, it is done
	by the update_volatile () function.

2007-05-27  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Call g_thread_init () early since newer glib versions
	require it.

	* abcremoval.c (mono_perform_abc_removal): Avoid using alloca.

2007-05-24  Jonathan Chambers  <joncham@gmail.com>

	* mini.c: Add configure checks for header files.
	* mini-x86.c: Add configure checks for header files.
	* trace.c: Add configure checks for header files.
	* aot-runtime.c: Add configure checks for header files.
	* aot-compiler.c: Add configure checks for header files.
	* driver.c: Add configure checks for header files.
	* mini-codegen.c: Add configure checks for header files.
	
	Code is contributed under MIT/X11 license.

2007-05-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_lowering_pass): Fix the handling of
	icompare_imm -128 + op_iclt. Fixes #81703.

2007-05-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_local_regalloc): Fix long-shift-regalloc on amd64.

2007-05-15  Massimiliano Mantione  <massi@ximian.com>

	* inssel.brg: added "mini_emit_load_intf_bit_reg_vtable", and used it
	inside "mini_emit_isninst_iface_cast" and "mini_emit_castclass_iface"
	so that all isinst checks now use "interface_bitmap".

2007-05-15  Zoltan Varga  <vargaz@gmail.com>

	* cpu-amd64.md (jmp): Fix a warning.

	* inssel.brg (CEE_SWITCH): Hopefully fix #80738.

	* basic.cs: Add new regression test.

	* basic.cs: Remove test which is now in basic-long.cs.

	* mini-ia64.c (mono_arch_output_basic_block): Sign extend in CEE_CONV_I8/CEE_CONV_I.

	* basic-long.cs: Add new test.
	
2007-05-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_spillvar_offset_float): Fix sparc build.

2007-05-12  Zoltan Varga  <vargaz@gmail.com>

	* cpu-x86.md minix-86.c: Add a peephole_pass_1 () as on amd64.

	* mini-x86.c (mono_arch_output_basic_block): Use mono_opcode_to_cond () in a few
	places.
	
	* mini-x86.c (mono_arch_emit_exceptions): Decrease the size of the exception 
	throwing code a bit.

	* exceptions-x86.c (mono_arch_get_throw_corlib_exception): Decrease the size of 
	the exception throwing code a bit.

	* mini-x86.c (get_call_info): Allocate result from a mempool.

2007-05-11  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (find_typespec_for_class): Fix the assert.

	* mini.h (MONO_AOT_FILE_VERSION): Bump AOT file version.

	* mini.h (MonoCompile): Add 'token_info_hash' field.

	* mini.c: Save token->method associations during compilation so the AOT 
	compiler can use it.
	
	* aot-compiler.c aot-runtime.c: Add support for compiling non-generic methods
	which reference generic classes and methods.

2007-05-10  Zoltan Varga  <vargaz@gmail.com>

	* mini.h mini-<ARCH>.h: Get rid of MONO_ARCH_HAS_XP_LOCAL_REGALLOC.

	* aot-compiler.c (compile_method): Fix a typo in a comment.

	* aot-runtime.c (decode_cached_class_info): Skip generic types.

	* aot-compiler.c: Add minimal support for AOTing generic code by skipping 
	everything generic.

	* mini.c (mono_method_to_ir): Disable AOT when calling helper_compile_generic_method.

2007-05-09  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoCompile): Add 'args' field.

	* mini.c (mono_compile_create_vars): Store variables representing the arguments
	into cfg->args.

	* mini-<ARCH>.c: Use cfg->args for accessing the method arguments.

2007-05-08  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_compile_get_interface_var): Remove this unused function.

	* mini-ops.h inssel.brg mini-<ARCH>.c: Add a new opcode for ckfinite as well.

	* mini-ops.h: Introduce new opcodes used in the IR instead of the original CEE_
	opcodes for some opcodes.

	* mini.h *.brg *.c: Use the new opcodes.

2007-05-08  Massimiliano Mantione  <massi@ximian.com>

	* mini.h: Bumped aot revision.

	* inssel.brg: modified code generation of type checks for interfaces
	to use the new "MonoClass.interface_bitmap" instead of the old
	"MonoClass.interface_offsets".

2007-04-30  Zoltan Varga  <vargaz@gmail.com>

	* cpu-amd64.md (jmp): Increase the maximum size of the jmp opcode to 128.

2007-04-29  Zoltan Varga  <vargaz@gmail.com>

	* abcremoval.c (summarize_integer_value): Handle OP_LCONV_TO_I4 to fix abcrem on
	64 bit platforms.

2007-04-27  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c: Fix MONO_TYPE_VALUETYPE processing.

2007-04-27  Wade Berrier  <wberrier@novell.com>

	* mini-s390x.c: Remove redeclaration of CompRelation and CompType (defined in 
	mini.h) to fix build.

2007-04-26  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (peephole_pass_1): Fix and reenable this pass.
	
	* mini-amd64.c (mono_arch_local_regalloc): Disable the new peephole_pass_1 as it
	causes the corlib unit tests to fail.

2007-04-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_opcode_to_type): Fix a bug in the previous patch.

	* mini-amd64.c (peephole_pass_1): New pass to perform before local regalloc.

	* mini-codegen.c (mono_opcode_to_cond): New helper function to convert conditional 
	opcodes to the comparison relations.

	* mini-codegen.c (mono_opcode_to_type): New helper function to convert conditional 
	opcodes to their types.
	
	* mini-ia64.c mini-amd64.c: Use mono_opcode_to_cond and mono_opcode_to_type.

	* mini-amd64.c (get_call_info): Allocate the result from the cfg mempool and cache 
	it in cfg->arch.cinfo.

	* local-propagation.c (mono_local_cprop_bb): Fix a warning.

	* mini.h mini.c branch-opts.c: Change bbhash to be an array and store it in 
	cfg->cil_offset_to_bb.

2007-04-24  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c (optimize_initlocals): New mini-pass to optimize away dead assignments
	created becase of initlocals.

2007-04-23  Zoltan Varga  <vargaz@gmail.com>

	* mini-alpha.c cpu-alpha.md: More alpha port work from 
	Sergey Tikhonov <tsv@solvo.ru>.

2007-04-21  Andreas Faerber  <andreas.faerber@web.de>

	* Makefile.am (BUILT_SOURCES): Fix for automake 1.6.x. Fixes #81417.

2007-04-19  Zoltan Varga  <vargaz@gmail.com>

	* cpu-s390.md (break): Correct the length of break instruction.

Thu Apr 19 16:28:52 CEST 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: fix a couple of soft-float issues and comments.

2007-04-15  Miguel de Icaza  <miguel@novell.com>

	* trace.c (is_filenamechar): - is also a filename char.

2007-04-15  Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c: Correct checking for enum type in return value processing.

2007-04-14  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (BUILT_SOURCES): Add 'version.h'.
	(version.h): Makefile is in the build directory.

2007-04-06  Andreas Faerber  <andreas.faerber@web.de>

	* mini-amd64.h: fix for assertion failure on Solaris/amd64

2007-04-11  Martin Baulig  <martin@ximian.com>

	* mini.c (can_access_member): Fix handling of generic classes;
	fixes #81259.

2007-04-10  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_plt_resolve): Fix disabling of AOT. Fixes #81316.

2007-04-05  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c: Fix disabling of AOT. Fixes #81316.

Fri Mar 23 20:25:31 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-codegen.c: make sure the right spill amount is
	used for fp or integer registers (fixes the float_sub_spill() on ppc).

Fri Mar 23 19:43:35 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixes for the fp_branch_nan test.

2007-03-23  Zoltan Varga  <vargaz@gmail.com>

	* basic.cs: Comment out new test which still fails on ia64.

Fri Mar 23 15:54:23 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: immediate shifted or fix (mono_metadata_user_string assert).

Fri Mar 23 12:53:28 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-ppc.h: struct passing ABI fix (bug #77968).

2007-03-22  Zoltan Varga  <vargaz@gmail.com>

	* cfold.c (FOLD_BINOP): Cast the result to gint32 to prevent overflow problems
	on 64 bit machines. Fixes part of #80738.

	* basic.cs: Add regression test.

2007-03-17  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg basic.cs: Revert previous change to fix build.

	* inssel.brg (SWITCH): Clean out the upper word of the switch value on 64 bit
	platforms.
	
	* inssel.brg (SWITCH): Use an integer comparison. Fixes #80738.

	* basic.cs: Add new regression test.

2007-03-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_emit_prolog): Fix an assert when a function has too
	many arguments.

2007-03-16  Neale Ferguson <neale@sinenomine.net>

	* cpu-s390x.md: Correct length of break instruction.

2007-03-16  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, cpu-s390x.md: Fix #80507 for s390x.
	* mini-s390.c, cpu-s390.md: Fix #80507 for s390.

2007-03-15  Jonathan Chambers  <joncham@gmail.com>

	* *.c: Begin WIN64 port.
	* mini.c:  Use correct register in profiler.
	* mini-amd64.c: No inline assembly on Win64.
	* mini-amd64.h: Implement MONO_INIT_CONTEXT_FROM_FUNC for Win64.
	Only define MONO_ARCH_USE_SIGACTION on non-windows platforms.
	* exceptions-amd64.c: Only need gregs_from_ucontext if MONO_ARCH_USE_SIGACTION
	is defined. Implement mono_arch_sigctx_to_monoctx, mono_arch_monoctx_to_sigctx, and
	mono_arch_ip_from_context for Win64.
	
	Contributed under MIT/X11 license.

2007-03-15  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-amd64.c (seh_handler): Ditto.

	* exceptions-x86.c (seh_handler): Fix a memory leak.

Thu Mar 15 13:47:59 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c, mini-mips.c, mini-ppc.c, mini-s390.c,
	mini-s390x.c: fixed peephole optimizations to deal
	correctly with 1 and 2 byte reload avoidance.

Thu Mar 15 10:17:54 CET 2007 Paolo Molaro <lupus@ximian.com>

	* cpu-s390.md, cpu-s390x.md: update localloc length.

Wed Mar 14 21:00:19 CET 2007 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md: added missing descriptions.

2007-03-14  Miguel de Icaza  <miguel@novell.com>

	*  Makefile.am: Add support so the tail tests are not executed on
	PowerPC as that is a known limitation of the PowerPC port.

2007-03-13  Jonathan Chambers  <joncham@gmail.com>

	* runmdesc.bat:  Move to msvc directory.
	
2007-03-13  Jonathan Chambers  <joncham@gmail.com>

	* runmdesc.bat:  Run executable that was produced by the current
	target and sent via an argument.
	
2007-03-11  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Fix box+brtrue optimization. Fixes
	#81102.

	* generics.2.cs: Add regression test.

2007-03-09  Wade berrier  <wberrier@novell.com>

	* mini-ppc.h: Undo typo of MONO_CONTEXT_SET_SP (ppc doesn't define this symbol)

2007-03-09  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_aot_module): Load all dependent assemblies eagerly since all
	AOT code depends on this.

Thu Mar 8 19:36:13 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: more precise tracking of types in the eval stack
	(part of fix for bug #81044).

2007-03-07  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_class_from_name): Add a cache.

	* aot-compiler.c (encode_patch): Remove an obsolete comment.

2007-03-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_native_sigsegv): Fix a warning.

	* mini.c (mono_method_to_ir): Add a workaround for bug #80733.

2007-02-22  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (type_from_op): Convert CEE_CONV_U to OP_LCONV_TO_U when the argument is
	a pointer on 64 bit systems. Fixes #80190.

	* iltests.il: Add new regression test.

Tue Feb 20 11:33:28 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: inline a constant for Environment.IsRunningOnWindows.

2007-02-19  Geoff Norton  <gnorton@customerdna.com>

	* trace.c: Remove an erroneous alignemnt check when tracing.
	  Fixes --trace on OSX86.

Wed Feb 14 19:45:56 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-$(arch).h: initialize SP in context for all the archs.

2007-02-14  Sebastien Pouliot  <sebastien@ximian.com>

	* mini-x86.h: Initialize SP in MONO_INIT_CONTEXT_FROM_FUNC. Fix CAS
	regressions in the thread tests.

2007-02-14  Zoltan Varga  <vargaz@gmail.com>

	* *-alpha.*: More alpha port work from Sergey Tikhonov <tsv@solvo.ru>:
	- fixed implementation of LOCALLOC opcode
	- implemented non-un compare for floats
	- code cleanup
	- implementation of FDIV and CKFINITE opcodes
	- fixes for latest mono updates
	- additional arch opcodes

Mon Feb 12 11:54:16 CET 2007 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: simplify and merge rules for cross-compilation.

2007-02-07  Massimiliano Mantione  <massi@ximian.com>

	* local-propagation.c: Actually *apply* the fix for bug 80591...

Tue Feb 6 19:03:19 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: backuot part of the last change
	(fixes cas tests on amd64 related to GetExecutingAssembly ()).

2007-02-06  Massimiliano Mantione  <massi@ximian.com>
	* inssel.brg: Fix bug 59286.


Tue Feb 6 12:23:50 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: patch from Zoltan to correctly check for
	stack boundaries (using the stack register, not the frame register),
	fixes bugs #80724, #79717.

2007-02-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c inssel-sparc.brg mini-sparc.c cpu-sparc.md: Get rid of OP_SETREG/
	OP_SETREGIMM, use OP_MOVE/OP_ICONST instead.

	* mini-amd64.c (mono_arch_output_basic_block): Fix ATOMIC_EXCHANGE in the
	presence of frame pointer elimination.

2007-02-01  Geoff Norton  <gnorton@customerdna.com>
        
	* mini-x86.h: NetBSD UCONTEX_REG defines.

2007-02-01  Zoltan Varga  <vargaz@gmail.com>

	* inssel-amd64.brg: Fix amd64 build.

Thu Feb 1 14:02:09 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h: remove extern to workaround what looks likes gcc bug 26905
	on amd64.

2007-01-31  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_is_regsize_var): New helper function usable by the back
	ends.

	* mini-<ARCH>.c: Use mono_is_regsize_var ().

2007-01-30 Mark Mason <mason@broadcom.com>

	   * exceptions-mips.c: Lots of exception handling fixes, LMFs now work, some cleanups.
	   * mini-mips.h: Add LMF magic numbers, and fix context set/get macros.
	   * mini-mips.c: Cleanups, LMF handling now works, optimize store of zero, implement localloc
	   beginning support for CEE_JMP [not quite working yet]
	   * tramp-mips.c: LMF handling now works
	
2007-01-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (peephole_pass): Optimize code common in initlocals blocks.

	* mini.h (NULLIFY_INS): New macro.

Tue Jan 30 16:33:33 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: statistical profiler fix for windows, patch
	from Tor Lillqvist (tml@novell.com).

2007-01-30  Massimiliano Mantione  <massi@ximian.com>
	* local-propagation.c: Fix bug 80591.

Mon Jan 29 12:14:34 CET 2007 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: put back the --export-dynamic option as with
	the previous gmodule flags (thanks to Robert Jordan).

2007-01-28  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (peephole_pass): Fix #80622 for sparc as well.

	mini.h *.c: Allocate fp vregs from the same pool as the int vregs. Use this to
	simplify and speed up the local register allocator. Also rename some fields
	like iassign->vassign.
	
	* regalloc.c: Remove some functions which are no longer used since their
	inlined version is in mini-codegen.c.
	
	* mini-codegen.c: Rename mono_regstate2_ functions to mono_regstate_.

	* basic.cs objects.cs iltests.il: Merge tests from the linear IL branch.

2007-01-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (peephole_pass): Remove optimizations which omit a 
	narrowing. Fixes #80622.

	* iltests.il: Add new regresssion test.	

Fri Jan 26 18:31:45 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-trampolines.c, aliasing.c, mini-codegen.c,
	debug-debugger.c, debug-debugger.h: warning fixes.
	* driver.c: updated copyright year and made it fit in one line.

Fri Jan 26 12:48:39 CET 2007 Paolo Molaro <lupus@ximian.com>

	* aot-runtime.c: updated to use mono-dl instead of gmodule.

2007-01-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_output_basic_block): Fix #80507 for x86.

	* mini-amd64.c (mono_arch_output_basic_block): Fix #80507 for amd64.

	* iltests.il: Add new test for bug #80507.

Wed Jan 24 19:10:28 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-arm.h: use soft-float also on vfp for now.

Wed Jan 24 14:54:40 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: fix some more soft-float issues.

2007-01-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.h (MONO_ARCH_FRAME_ALIGNMENT): Fix sparc build.

2007-01-24  Massimiliano Mantione  <massi@ximian.com>
	* mini-arch.h, , inssel-amd64.brg, mini-x86.c, inssel-x86.brg,
	mini-ia64.c, mini-sparc.c, mini-alpha.c: Introduced
	MONO_ARCH_LOCALLOC_ALIGNMEENT to fix bug 80498.

Wed Jan 24 12:04:39 GMT 2007 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: typo fix.

2007-01-23  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c: Use lgb instructions for I1 type variables instead of lb.

2007-01-21  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_allocate_stack_slots_full): Allocate memory from the cfg mempool.
	Share stack slots for scalar types. Avoid expensive g_list_free () calls.

	* mini-x86.c (mono_arch_allocate_vars): Don't free the result of allocate_stack_slots_full.

	* mini-amd64.c mini-ia64.c mini-alpha.c: Ditto.	

	* mini.h (MonoJitStats): Add a new JIT statistics: locals_stack_size.
	
	* inssel.brg: Fix a warning.

	* mini.h (MonoBasicBlock): Make bb->dominated a GSList.

	* abcremoval.c ssa.c ssapre.c: Update after this change.
	
	* dominators.c (compute_dominators): Allocate bb->dominated from the cfg mempool.

	* dominators.c (df_set): Use mono_bitset_union_fast.	

Sat Jan 20 16:59:01 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h, genmdesc.c, genmdesc.pl, mini-${arch}.c, cprop.c,
	mini-codegen.c: reduce relocations and memory usage for the cpu
	description.

2007-01-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_regstate2_alloc_int): Optimize this using bsfq on amd64.

	* genmdesc.c genmdesc.pl mini.h: Remove some unused fields from the mdesc tables
	to reduce their size.

2007-01-19 Mark Mason <mason@broadcom.com>

	* exceptions-mips.c: fix mono_arch_ip_from_context(), increase exception debug support.
	* mini-mips.c: more configuration macros, support long conditional branches, additional
	asserts, fix epilog instrumentation.
	* mini-mips.h: use standard stack walk
	* cpu-mips.md: increase size of div, rem and conditional branches
	
Fri Jan 19 17:23:32 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-codegen.c, mini-$(arch).h: claenup references
	to cpu spec data.

2007-01-19  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (encode_klass_info): Allow classes of the form <Type>[][].
	(compile_method): Ditto.

	* aot-runtime.c (decode_klass_info): Ditto.

	* mini.c (mono_method_to_ir): Call mono_get_got_var () in a place where it is
	needed by the code generated by inssel.brg. Also fix a warning.

Thu Jan 18 17:55:22 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: deal with enums that become genericinsts by
	being nested in a generic class (bug #79956).

Thu Jan 18 16:52:56 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: match the generic definition to check for
	private access with generic types (bug #78431).

Thu Jan 18 11:50:13 CET 2007 Paolo Molaro <lupus@ximian.com>

	* genmdesc.pl, Makefile.am: perl implementation of genmdesc,
	to make life easier for people cross-compiling that insist on not
	using scratchbox.

2007-01-17 Mark Mason <mason@broadcom.com>

	* inssel-long.brg: patch to deal with mips missing flags
	* inssel-long32-mips.brg: implement overflow checks
	* insset-mips.brg: implement overflow checks
	* mini-mips.h: implement conditional exception handling
	* mini-mips.c: add mips_emit_exc_by_name(), implement conditional exception handling.
	  Remove unused code, minor cleanups.
	* exceptions-mips.c: minor cleanups
	* mini-ops.h: add mips conditional exception ops
	* cpu-mips.md: add mips conditional exception ops

	
Wed Jan 17 19:22:34 CET 2007 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: patch from Mark Mason <mason@broadcom.com>
	to deal with mips missing of flags.

Tue Jan 16 20:01:01 CET 2007 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: execute fault handlers.

Tue Jan 16 19:54:44 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: handle missing call locationss with FORCE_INDIR_CALL.

Tue Jan 16 13:14:31 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle also floating point values in initialize_array.

Tue Jan 16 12:42:40 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, aot-runtime.c, aot-compiler.c: enable aot compilation of
	array initialization and make it conditional on the intrins option.

Tue Jan 16 11:28:45 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.h, patch-info.h, Makefile.am, aot-compiler.c: reduce
	relocations and put the patch info names close to the enum definition.

2007-01-15 Mark Mason <mason@broadcom.com>

	* basic.cs, exceptions.cs: break up large tests to increase debugability.

Mon Jan 15 18:57:14 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c: optimized RuntimeHelpers::InitializeArray () calls.

2007-01-12  Raja R Harinath  <rharinath@novell.com>

	* mini.c (mono_method_to_ir): Use new MonoGenericContext accessor.

Thu Jan 11 11:16:42 CET 2007 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: distribute the mips sources.

Wed Jan 10 19:49:33 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini-codegen.h: handle bug #80489 here, by excluding ecx
	directly.

Wed Jan 10 19:08:05 CET 2007 Paolo Molaro <lupus@ximian.com>

	* cpu-x86.md: back out for now as this triggers other regressions.

Wed Jan 10 18:33:16 CET 2007 Paolo Molaro <lupus@ximian.com>

	* cpu-x86.md: force src1 and dest regpair for long shift instructions
	to eax:edx, so ecx can't get allocated to them (bug #80489).

Tue Jan 9 12:36:11 CET 2007 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-exceptions.c: enabled running fault handlers
	(bug #80469).

2007-01-03  Miguel de Icaza  <miguel@novell.com>

	* driver.c: If nothing fail, do not use the string "failed",
	because it makes it very annoying to view test result logs on the
	web. 

2006-12-30  Miguel de Icaza  <miguel@novell.com>

	* debug-debugger.c (mono_debugger_main): Rename "main" to
	"main_method" to prevent a warning.

	Remove a warning for unused field.

2006-12-28  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c
	(MONO_DEBUGGER__debugger_info): Add `get_lmf_addr'.

2006-12-22  Martin Baulig  <martin@ximian.com>

	* mdb-debug-info32.s, mdb-debug-info64.s: New files.
	Put a pointer to the `MONO_DEBUGGER__debugger_info' into a
	seperate `.mdb_debug_info' section, so we can access it from the
	debugger even if the binary is stripped.

	* debug-debug.c: Reference the `MONO_DEBUGGER__debugger_info_ptr'
	from the `.mdb_debug_info' here to prevent the linker from
	removing that section.

	* Makefile.am (mono_debugger_sources): Add mdb-debug-info32.s /
	mdb-debug-info64.s.

2006-12-19  Robert Jordan  <robertj@gmx.net>

	* mini-x86: enable the code to return small structures in
	registers for FreeBSD as well. Fixes bug #80278.
	* aot-runtime.c: Include sys/wait.h for WEXITSTATUS/WIFEXITED.

Mon Dec 18 19:47:17 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: align the stack when calling the profiler
	function instrumenting the prolog (on OSX).

Thu Dec 14 15:22:43 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: emit a break opcode where Debugger.Break () is called.

2006-12-13  Miguel de Icaza  <miguel@novell.com>

	* mini.c (mono_method_to_ir): Provide useful information on this
	assert, to prevent others from debugging like I did.

Tue Dec 12 17:01:38 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: enable code which was incorrectly commented
	(bug #80235).

Tue Dec 12 16:28:15 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: enable on OSX, too, the code to return small
	structures in registers.

Mon Dec 11 19:22:35 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: remove the use of the dynamic code manager here, too.

Mon Dec 11 19:08:33 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, debug-debugger.c, tramp-*.c: fixed 
	mono_debugger_create_notification_function() to use
	mono_global_codeman_reserve () instead of a dynamic code manager.

Tue Dec 5 17:54:50 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.h, jit-icalls.c: remove the 
	ves_array_element_address() jit icall and use a generated
	managed method instead (which is about 4 times faster for a rank 3
	array access).

2006-11-29  Mark Mason  <mason@broadcom.com>

	* basic-calls.cs: additional tests for passing
	structures as function arguments.

2006-11-29  Mark Mason  <mason@broadcom.com>

	* mini-mips.h: disable custom exception handling
	* mini-mips.c: throw/rethrow should use jalr to call
	exception stubs.  Fixed bug with passing structures
	by value. More support for tracing floating point
	functions.

Wed Nov 29 20:28:17 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: fixed typo in the soft-float ldind.r4 handling
	(bug #80086).

Wed Nov 29 11:33:03 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, driver.c: added --runtime command line
	option to select a different runtime than the autodetected one.
	* jit.h: added API for embedders to initialize with a specific
	runtime version.

Tue Nov 28 21:24:55 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle also boxing of r4 values (bug #80024).

Tue Nov 28 19:45:44 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: force indirect calls until we reserve
	enough address space for all the generated code.

Tue Nov 28 20:04:34 GMT 2006 Paolo Molaro <lupus@ximian.com>

	* exceptions-arm.c: workaround bugs in the libc definition
	of struct ucontext.

Mon Nov 27 15:13:41 CET 2006 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: fixes from me and Mark Mason.

2006-11-23  Dick Porter  <dick@ximian.com>

	* wapihandles.c (mini_wapi_seminfo): No need to adjust the counter
	semaphore display now we've fixed the initial value

Wed Nov 22 11:04:37 CET 2006 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: partially revert the last change to fix the build.

2006-11-21  Mark Mason  <mason@broadcom.com>

	* inssel.brg: Add and use compare-and-branch macros to support
	architectures that do not have condition code registers (ie. MIPS).
	* *-mips.{c,brg,md}: Fix copyright statements

2006-11-20  Mark Mason  <mason@broadcom.com>

	* Makefile.am: remove mini-codegen.c from list of MIPS sources
	* mini.c: Allow GET_CONTEXT to be specified by the arch port
	* mini.h: Added declaration for mono_print_ins()
	* mini-codegen.c: added ins_spec initializer for MIPS
	* mini-codegen.c (mono_call_inst_add_outarg_reg): added asserts for
	vreg to be virtual and hreg to be non-virtual.
	* mini-codegen.c (mono_spillvar_offset): assert if MIPS - spilling
	is not yet working/implemented correctly.
	* mini-codegen.c (print_ins): rename to mono_print_ins(), make
	non-static, fixup calls to print_ins() from other parts in the file.

2006-11-20  Mark Mason  <mason@broadcom.com>

	* basic-calls.cs: added tests for passing structures as arguments
	to calls.

Mon Nov 20 19:40:11 CET 2006 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg: optimize signed division by power of two.

Mon Nov 20 17:37:58 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: added support for interworking with thumb code
	(mono must be still be built using the ARM instruction encoding).

2006-11-19  Miguel de Icaza  <miguel@novell.com>

	* mini.c (type_from_op): Separate the conditions for OP_EQ as the
	verifier has different rules for it.   Fixes a few verifier issues
	in the test suite.

	* mini-exceptions.c (mono_handle_native_sigsegv): Put the message
	at the end, so people know what happened.

Thu Nov 16 14:07:18 CET 2006 Paolo Molaro <lupus@ximian.com>

	* brach-opts.c: in optimize_exception_target() make sure we
	are in a catch clause (fixes bug #79871).

Thu Nov 16 12:42:13 CET 2006 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c, jit-icalls.h, mini-arm.c, mini.c:
	more soft-float support fixes.

Wed Nov 15 18:45:47 GMT 2006 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c, inssel-arm.brg: ABI fix for longs and doubles
	that are passed half on the stack and half in registers.

Wed Nov 15 17:00:27 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini-arch.h, helpers.c, Makefile.am:
	more mips integration work from Mark E Mason 
	<mark.e.mason@broadcom.com>.

Wed Nov 15 16:34:03 CET 2006 Paolo Molaro <lupus@ximian.com>

	* exceptions-mips.c, inssel-mips.brg, mini-mips.h,
	cpu-mips.md, inssel-long32-mips.brg, mini-mips.c,
	tramp-mips.c: added sources for the mips port, not
	integrated in the build yet. Contributed by
	Mark E Mason <mark.e.mason@broadcom.com>.

2006-11-14  Neale Ferguson <neale@sinenomine.net>

	* mini-s390[x].c (is_regsize_var): Support PTR/FNPTR too.

Tue Nov 14 16:06:37 CET 2006 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, inssel-float.brg, inssel-softfloat.brg:
	put the soft-float rules in its own file since it seems to
	break s390 compilation.

Mon Nov 13 15:54:38 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: fixed wrnings.

Fri Nov 10 19:18:32 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c, mini-arm.h, cpu-arm.md, inssel-float.brg,
	inssel-arm.brg: ARM support for soft-float.

Fri Nov 10 18:38:15 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.c, jit-icalls.h: added first cut at handling
	loads and stores of 32 bit fp values.

2006-11-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (is_regsize_var): Support PTR/FNPTR too.

	* tramp-sparc.c (mono_arch_patch_callsite): Fix this function so it actually
	works. Fixes #79852 and #79463.

Thu Nov 9 16:56:13 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-codegen.c, jit-icalls.c, jit-icalls.h:
	more soft-float support WIP and fixes.

Wed Nov 8 16:40:02 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: some VFP updates.

Tue Nov 7 19:45:51 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: 0 is a valid local var offset in some
	architectures, don't assert (bug #78508).

Tue Nov 7 18:17:52 GMT 2006 Paolo Molaro <lupus@ximian.com>

	* exceptions-arm.c: fixed off by one error in stack walk code.

Tue Nov 7 11:27:26 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c: more precise tracking of type load exceptions.

2006-11-03  Robert Jordan  <robertj@gmx.net>

	* Makefile.am: [WIN32] Add monow.exe target.
	* driver.c: [WIN32] Don't detach the console when debugging.
	Fixes bug #79797.
	
2006-10-30  Miguel de Icaza  <miguel@novell.com>

	* tramp-x86.c (mono_arch_patch_delegate_trampoline): Eliminate warning.

2006-10-23  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (emit_method_info): Add a case missed earlier.

	* driver.c (mini_regression): Fix --regression with AOT.

	* aot-compiler.c (emit_method_info): Fix AOT on amd64.

2006-10-17  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (GET_CONTEXT): Correct the definition of this for sparc/linux.

	* mini-sparc.h: Don't use sigaction on sparc/linux.

	* exceptions-sparc.c: Call mono_arch_flush_icache () in a couple of places.

	* mini-sparc.c (mono_sparc_flushw): Call mono_arch_flush_icache ().

	* mini-exceptions.c: Add proper include files for getpid ().

2006-10-16  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method): Change this to return the native code
	address instead of a MonoJitInfo* to avoid decoding the exception info for the
	method.

	* aot-runtime.c aot-compiler.c: Use uint16 instead of uint32 entries in the
	name cache to reduce its size.

	* mini.h (MONO_AOT_FILE_VERSION): Bump aot file format version.

2006-10-15  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c: Save/restore the current LMF structure more efficiently using
	the mono_lmf TLS variable.

	* exceptions-x86.c (mono_arch_find_jit_info): Only access lmf->method in 
	trampoline lmf frames.	

	* mini-sparc.h (MONO_ARCH_ENABLE_EMIT_STATE_OPT): Define this on sparc as well.

2006-10-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c: Save/restore the current LMF structure more efficiently using
	the mono_lmf TLS variable.

	* mini-exceptions.c: Access the LMF structure through accessors.

	* mini.c: Allow the backends the option for storing the lmf in a dedicated TLS 
	variable instead of in jit_tls->lmf.

	* mini-x86.c mini-amd64.c: Update after lmf->lmf_addr name change.
	
	* exceptions-amd64.c (mono_arch_find_jit_info): Only access lmf->method in 
	trampoline lmf frames.

	* mini-amd64.c (mono_arch_emit_prolog): Do not set lmf->method as it is not needed.

2006-10-12  Zoltan Varga  <vargaz@gmail.com>

       * mini.c trace.c mini-x86.c: Revert these too.
	
       * mini.c trace.c mini-x86.c: Remove warning workarounds after the mono_type_size ()
       signature change.

Tue Oct 10 11:35:20 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* genmdesc.c: removed now dead code.

2006-10-09  Robert Jordan <robertj@gmx.net>

	* mini.c: Disable the CrashReporter on MacOS X; Fixes #74869

Mon Oct 9 17:06:41 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h: do not leave gaps in the opcode values.

Mon Oct 9 16:08:51 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.h: flag functions as internal here, too.

Mon Oct 9 15:58:18 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, aliasing.h, declsec.h, regalloc.h, trace.h: mark internal
	functions with the internal attribute.

Mon Oct 9 15:52:45 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* aot-compiler.c: fclose the file descriptor in the profile read loop.

Fri Oct 6 16:01:38 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.c, inssel-float.brg: beginnings of support
	for soft-float.

2006-10-05  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (emit_load_volatile_arguments): New function to handle arguments of
	tail calls as on other platforms.

	* mini.c (mono_method_to_ir): Fix a few tailcall problems. Fixes #79557.

	* iltests.il: Add a few tailcall tests.

Tue Oct 3 16:33:08 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* driver.c: fix loop for old compilers (bug #79521).

2006-10-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (ves_icall_get_trace): Remove debug printf.

	* aot-runtime.c (mono_aot_get_class_from_name): Avoid a memory allocation.

	* aot-compiler.c: Add a new option 'metadata-only' to only emit the cached
	metadata without any code.

	* mini-exceptions.c (mono_handle_native_sigsegv): Add some code to print out
	more precise debugging information using gdb.

2006-09-30  Zoltan Varga  <vargaz@gmail.com>

	* inssel-ia64.brg: Make the helper methods static.

Thu Sep 28 16:40:07 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* inssel-x86.brg: make the helper methods static.

Thu Sep 28 16:31:32 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* inssel-amd64.brg, mini-amd64.c: small cleanup, use inst_call.

Thu Sep 28 15:36:07 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: updates for monoburg changes.
	* inssel.brg: make a few helper functions static as they should.

2006-09-27  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am: Move mini-codegen.c to common_sources.

Wed Sep 27 15:07:08 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h: instroduce inst_call in MonoInst for use in OUTARG
	instructions.
	* Makefile.am, cpu-g4.md, inssel-ppc.brg, mini-codegen.c, mini-ppc.c,
	mini-ppc.h: port to use the common local register allocator.

2006-09-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Remove the comment too then.

Tue Sep 26 14:02:58 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h: put back backend.data which is to be used shortly and
	doesn't increase the size of MonoInst. If any 64 bit arch aligned
	pointers on 4 byte boundaries it'd have much bigger issues running
	and you can ifdef it out anyway.

2006-09-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoInst): Remove backend.data field since it is unused and increases
	MonoInst size by 4 bytes on 64 bit machines.

Tue Sep 26 11:57:26 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* *.{c,h,brg}: long due removal of the unused field in MonoInst and
	replacement with more meaningful field names. Arch maintainers, please
	check the assigned names are good enough for your arch.

2006-09-26  Zoltan Varga  <vargaz@gmail.com>

	* cpu-ia64.md mini-ia64.c inssel-ia64.brg mini-ops.h: Get rid of the 
	OP_IA64_FETCHADD opcodes, use OP_ATOMIC_ADD_IMM_NEW opcodes instead.

Mon Sep 25 11:05:24 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, driver.c, optflags-def.h, Makefile.am: reduce runtime
	relocations and memory requirements, put the optimization flags
	definitions in their own file.

2006-09-24  Zoltan Varga  <vargaz@gmail.com>

	* jit-icalls.c (mono_helper_stelem_ref): Remove this unused helper function.

	* mini.c (mini_init): Remove reference to mono_helper_stelem_ref.

2006-09-22  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (add_valuetype): Fix an uninitialized memory issue.

Thu Sep 21 19:06:09 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: use the correct function to get the size of an item
	in an array, given an element class.
	* aot-compiler.c: do not access class->class_size directly.

Thu Sep 21 12:10:56 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, debug-mini.c: added a debugging function to print
	info about local variables and arguments in a jitted method.

2006-09-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-alpha.c: More alpha port work from Sergey Tikhonov <tsv@solvo.ru>.

	* exceptions-ia64.c: Fix some problems reported by Bill Seurer <seurer@us.ibm.com>.

2006-09-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_call_opcode): Avoid using the same loop index in the
	inner and outer loops when passing vtypes.

Tue Sep 19 17:53:40 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: take into account the cpu errata for cache flushing
	which caused some random errors (bug #79381).

2006-09-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_exceptions): Emit the call to 
	mono_arch_throw_corlib_exception using emit_call () too. Fixes #79271.

2006-09-17  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_aot_module): Return immeditely if the AOT module was already
	loaded.

	* exceptions-amd64.c (gregs_from_ucontext): Apply another patch from the
	freebsd ports tree.

	* mini-amd64.c (emit_call): Avoid near calls on freebsd.
	(mono_arch_patch_code): Remove the unused handling of MONO_PATCH_INFO_CLASS_INIT.

	* tramp-amd64.c (mono_arch_create_specific_trampoline): Fix check for 32 bitness of
	displacement.

2006-09-13  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (load_aot_module_from_cache): Fix PPC build.

2006-09-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (UNVERIFIED): Add a 'break-on-unverified' MONO_DEBUG option so this 
	macro does not have to be changed during debugging.

	* cpu-alpha.md inssel-alpha.brg mini-alpha.h mini-alpha.c exceptions-alpha.c tramp-alpha.c: More alpha port work from Sergey Tikhonov <tsv@solvo.ru>.

	* cpu-pentium.md: Rename this to cpu-x86.md for consistency with other platforms.

	* Makefile.am mini-x86.c mini-codegen.c: Rename pentium_desc to x86_desc.
	
	* mini.c (mini_get_ldelema_ins): Allow ldelema2d optimization if 
	MONO_ARCH_NO_EMULATE_MUL is defined.

	* mini-ia64.h (MONO_ARCH_CALLEE_FREGS): Reserve f33 for use by instructions.

	* mini-ia64.h: Define MONO_ARCH_NO_EMULATE_MUL.

	* mini-ia64.c: Implement CEE_MUL based on gcc emitted code.

	* mini-ia64.c (mono_arch_lowering_pass): Optimize store_membase_imm with offset==0.
	
2006-09-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.h mini-amd64.h mini-exceptions.c: Move the bsd specific MAP_ANON
	stuff to mini-exceptions.c where it is used.

	* mini-sparc.c (mono_arch_setup_jit_tls_data): Remove the duplicate altstack
	setup code, the real one is in mini-exceptions.c.

	* mini-amd64.h mini-amd64.c exceptions-amd64.c: Move all dependencies on the
	layout of ucontext_t to helper functions in exceptions-amd64.c, as on x86. Add
	some changes from the freebsd ports tree.

	* mini-amd64.h exceptions-amd64.c: Fix the amd64 build. Get rid of the SC_
	constants.
	
	* mini-amd64.h: Freebsd has MAP_ANON instead of MAP_ANONYMOUS.

Mon Sep 11 13:18:55 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: on Linux, check for /proc to be mounted
	(bug# 79351, novell bug#201204).

Mon Sep 11 13:10:12 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle cases where pthread_attr_getstack() behaves
	incorrectly (bug #78096).

Mon Sep 11 11:31:10 BST 2006 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: support larger stack frames (bug #79272).

2006-09-08  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_class_from_name): Remove a debug printf.

	* aot-compiler.c: Add a hash table to the AOT file mapping class names to typedef 
	tokens.

	* aot-runtime.c (mono_aot_get_class_from_name): New function used by 
	mono_class_from_name () to find a class from its name.

	* mini.c (mini_init): Register mono_aot_get_class_from_name () with the runtime.

2006-09-07  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (emit_call): Avoid strstr () call if possible.

2006-09-05  Kornel Pal  <kornelpal@gmail.com>

	* Makefile.am: Renamed mono-1.dll to mono.dll. (-avoid-version)

2006-09-04  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_icall_get_wrapper): Fix a race condition on initializing
	callinfo->trampoline.

	* mini-amd64.c (emit_call): Special case calls to the vararg array icalls. Hopefully
	fixes #79271.
	(mono_arch_patch_code): Add some debug code to help track down similar failures in the
	future.

2006-09-03  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_plt_resolve): Add an assert.

2006-09-02  Zoltan Varga  <vargaz@gmail.com>

	* tramp-x86.c (mono_arch_create_specific_trampoline): Don't increase
	stats.method_trampolines, it is already done by the generic trampoline code.

	* tramp-amd64.c (mono_arch_create_specific_trampoline): Ditto.
	
2006-09-01  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Remove some references to mono_compile_aot, and use cfg->compile_aot instead.

	* aot-runtime.c: Add some tweaks to the MONO_AOT_CACHE functionality.

	* tramp-amd64.c (mono_arch_create_specific_trampoline): Fix a FIXME.

	* mini.c (print_jit_stats): Print mscorlib mempool size too.
	
	* mini.c (print_jit_stats): Print new stats.

	* *-alpha.c: More alpha port work from Sergey Tikhonov <tsv@solvo.ru>.

2006-08-31  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_get_ldelema_ins): Fix verifier error when calling
	Address on two dimensional arrays. Fixes #78729.

	* mini.h (MonoCompile): Add a 'skip_visibility' field.

	* mini.c (method_to_ir): Disable visibility checks if skip_visibility is set on
	a method.

	* mini-amd64.c (mono_arch_emit_exceptions): Fix assertion introduced by the last change.

	* mini.c (mono_runtime_cleanup_handlers): Clean up signal handlers on unix. Fixes
	#79130.
	
	* mini.c (handle_array_new): Applied patch from "briaeros007". Fix
	a race condition.
	(mini_get_ldelema_ins): Ditto.

2006-08-30  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_exceptions): Align fp constants to 16 bytes.
	(mono_arch_output_basic_block): Avoid unaligned accesses in FNEG implementation. 
	Fixes #79213.

2006-08-29 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c, mini-s390x.c: Fix VARARG case processing with 0 arguments. Add
	mono_arch_get_patch_offset as a dummy entry point to allow successful link. 

	* exceptions-s390x.c: Cosmetic change.

	* tramp-s390.c: Fix warning.

	* cpu-s390.md: Correct length of mul_imm.

Wed Aug 23 19:24:00 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* aot-compiler.c: added binary writer with ELF backend
	implementation (only on Linux/x86 for now).

2006-08-18  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am: Don't run net 2.0 AOT tests.

	* aot-compiler.c (compile_method): Skip methods with tail calls as well.
	(mono_compile_assembly): Skip net 2.0 assemblies as well.

	* aot-runtime.c (load_patch_info): Fix an uninitialized memory error.

Fri Aug 18 19:38:28 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* aot-compiler.c: simplified and refactored the asm-writing code
	to allow different backends.

2006-08-18  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MONO_AOT_FILE_VERSION): Bump AOT file format version.

	* aot-compiler.c aot-runtime.c: Reorg the GOT slot allocation code a 
	little. Share patches of type TYPE_FROM_HANDLE as well.

	* mini.c (mono_patch_info_equal): New helper function.
	(mono_patch_info_hash): Ditto.

	* aot-compiler.c (emit_method_code): Fix s390 build.

	* mini.c (mono_allocate_stack_slots_full): Fix yet another place where byref
	is not handled because it is stored as a flag and not as a type ctor. Fixes
	#79016.

2006-08-17  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Fix computation of GOT slot statistics.
	
	* aot-compiler.c aot-runtime.c: Implement sharing of GOT slots for classes/fields.
	Also remove support for not PIC AOT.

	* mini.h: Bump AOT file format version.

	* objects.cs: Add a test for #78990.

	* mini-x86.c (mono_arch_output_basic_block): Applied patch from Peter Dettman
	(peter.dettman@iinet.net.au). Fixes #79087.

	* basic-long.cs: Add a test for the above.

2006-08-16  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c (get_got_offset): Add a cache for GOT entries, not yet used.
	
	* aot-compiler.c (get_plt_index): Add a cache for wrappers too. Simplify the
	code somewhat.

2006-08-15  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Fix registration of idiv/imul opcodes which can throw
	exceptions.

2006-08-10  Jonathan Chambers  <joncham@gmail.com>

	* mini.c: Don't verify COM proxy invoke calls
	

2006-08-10  Dick Porter  <dick@ximian.com>

	* wapihandles.c (mini_wapi_seminfo): More info, to help track down
	which process is holding semaphores locked.

2006-08-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c mini-amd64.c: Fix #79027.

	* mini-sparc.c (mono_arch_call_opcode): Fix the previous patch.

	* mini-sparc.c (mono_arch_call_opcode): Fix #79027.

	* mini-x86.c (mono_arch_call_opcode): Handle the case where there are no
	implicit arguments in a vararg call. Fixes #79027.

2006-08-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_get_element_address_signature): Use CDECL calling convention on windows. Fixes #78969.
	(mono_get_array_new_va_signature): Ditto.

2006-08-05  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c: Call init_plt lazily.

	* inssel-long.brg: Fix unsigned long->int conversion.

	* aot-runtime.c (init_plt): Remove a redundant make_writable () call.

	* aot-compiler.c aot-runtime.c: Reorganize the file structure in the amd64 case so
	that most data is now in the .rss/.data section.

2006-08-04  Zoltan Varga  <vargaz@gmail.com>

	* aot-compiler.c: Correct the computation of the 'direct-calls' statistic.	

	* aot-compiler.c: Print the number of methods without GOT slots as a statistics.

	* aot-compiler.c aot-runtime.c tramp-amd64.c: Resurrect amd64 AOT support.

	* tramp-amd64.c (mono_arch_patch_callsite): Fix a warning.

	* jit-icalls.c (mono_helper_compile_generic_method): Unbox vtypes since this is a
	virtual call. Fixes #79010.

	* mini.c (mono_method_to_ir): Pass an additional out arg to compile_generic_method 
	and use the result as the this argument in the real call.

	* generics.2.cs: Add a new test for #79010.
	
2006-08-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c: Fix a warning.

	* aot-compiler.c: Add a bunch of statistics.

	* mini.c (inline_method): Disable inlining in out-of-line bblocks.

2006-08-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-arch.h Makefile.am mini-ops.h mini-codegen.c: More alpha updates.

2006-08-01  Zoltan Varga  <vargaz@gmail.com>

	* cpu-alpha.md inssel-alpha.brg mini-alpha.h mini-alpha.c exceptions-alpha.c tramp-alpha.c: More alpha port work from Sergey Tikhonov <tsv@solvo.ru>.

2006-07-13  Miguel de Icaza  <miguel@novell.com>

	* mini.c (mono_method_to_ir): Obtain the original method in the
	CIL stream and use this to perform validation.

	Fixed: #78816

2006-07-19  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_argument_info): Fix a warning.
	(mono_arch_call_opcode): Ditto.

	* mini.c (mono_method_to_ir): Clear ins_flag at the end of CEE_CALL. Fixes
	#78826.

	* mini.c (mono_patch_info_dup_mp): New helper function.
	
	* aot-compiler.c (compile_method): Fix some of the memory allocated during
	compilation. Fixes #78827.

2006-07-18  Kornel Pal  <kornelpal@gmail.com>

	* declsec.c: Use original security informations for
	  MONO_WRAPPER_MANAGED_TO_MANAGED.

2006-07-15  Jonathan Chambers  <joncham@gmail.com>

	* mini.c: Allow Com Interop methods/classes and
	don't verify COM wrapper calls
	

2006-07-13  Zoltan Varga  <vargaz@gmail.com>

	* inssel-long32.brg: Fix long->i4 checked conversion.

	* exceptions.cs: Add a test for the above.

2006-07-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_setup_altstack): Fix a memory leak.

	* mini.c: Applied patch from Joachim Ante (joe@otee.dk). Fix some shutdown 
	leaks.

	* helpers.c (mono_disassemble_code): Avoid using fixed temporary files. Fixes
	#78775.

2006-07-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Fix solaris/x86 exception handling.

	* Makefile.am: Get rid of $(ICU_LIBS).

2006-07-02  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c: Fix handling of unhandled SIGSEGV exceptions on ia64.
	(ves_icall_System_Security_SecurityFrame_GetSecurityStack): Use MONO_INIT_CONTEXT_FROM_CURRENT.
	(ves_icall_System_Security_SecurityFrame_GetSecurityFrame): Ditto.

	* mini-ia64.h (MONO_CONTEXT_SET_FUNC): New macro.

	* mini-exceptions.c (mono_handle_native_sigsegv): Prevent infinite loops if
	this function causes a SIGSEGV.

2006-06-22  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Remove unused solaris/x86 includes.

2006-06-21  Zoltan Varga  <vargaz@gmail.com>

	* jit.h: Add G_BEGIN_DECLS/G_END_DECLS.

2006-06-20  Jb Evain  <jbevain@gmail.com>

	* cpu-g4.md: fix max length of start_handler instruction.

2006-06-20  Massimiliano Mantione  <massi@ximian.com>
	* simple-cee-ops.h, simple-mini-ops.h: Fixed bug 78656.

2006-06-16  Massimiliano Mantione  <massi@ximian.com>
	* ssa.c: Fixed bug 78653 for SSA based deadce.
	* mini.h: added MONO_INST_DEFINITION_HAS_SIDE_EFFECTS flag go
	MonoInst.flags, used in SSA based deadce.
	* aliasing.c: Fixed bug 78653 for "fastpath" deadce.
	* simple-cee-ops.h, simple-mini-ops.h: Fixed bug 78653.

Thu Jun 15 16:52:46 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c: don't use malloc () for trampoline code, sometimes
	it can end up using non executable memory on ppc64 systems
	running ppc32 userspace (fix from Johannes Berg).

2006-06-14  Dick Porter  <dick@ximian.com>

	* wapihandles.c: Fix a bunch of signed/unsigned warnings from gcc
	4.1.1

2006-06-13  Massimiliano Mantione  <massi@ximian.com>
	* mini.c: Made so that inline is locally disabled if it would
	trigger a .cctor, because too many apps depend on this behavior
	(which seems to be also the one of the MS CLR).

2006-06-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_emit_stack_alloc): Fix initialization of localloc'ed memory.
	No idea why this worked before.

	* branch-opts.c (mono_branch_optimize_exception_target): Avoid branches
	which branch to outer exception clauses since they could skip the
	inner finally clauses. Fixes #78633.

	* exceptions.cs: Add a test for the above.

	* mini.c (merge_basic_blocks): Nullify the branch at the end of the first bb.
	Fixes #78629.

	* iltests.il: Add a test for the above.

2006-06-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (remove_block_if_useless): Do not remove the bblock immediately
	after the end of a try bblock, to prevent asserts in mini_method_compile ().

	* iltests.il: Add a test for the above.

2006-06-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_lowering_pass): Remove some code duplication.
	
	* mini-ia64.c inssel-ia64.brg: Implement the new net 2.0 Interlocked.Add
	methods as instrinsics.

2006-06-09  Wade Berrier <wberrier@novell.com>

	* Makefile.am: Fix sources list for svn rename so that make dist succeeds
	(simple-cee-ops.h ssapre-mini-ops.h)

2006-06-09  Neale Ferguson <neale@sinenomine.net>

	* mini-exceptions.c (ves_icall_get_frame_info): Fix this function on s390/s390x.
	* mini-s390x.c, mini-s390.c: Correct ATOMIC operations (incorrect register for CS
	instruction).
	* mini-s390x.h, mini-s390.h: Simplify MCONTEXT_GET_BP.
	* cpu-s390x.md: Fix max. length values for a couple of instructions.

2006-06-09  Jonathan Chambers  <jonathan.chambers@ansys.com>

	* mini-exceptions.c: Minor fix for building mono in Visual Studio.

2006-06-08  Massimiliano Mantione  <massi@ximian.com>

	* ssapre-cee-ops.h: Renamed as "simple-cee-ops.h"
	* simple-cee-ops.h: Was "ssapre-cee-ops.h" (renamed).
	* ssapre-mini-ops.h: Renamed as "simple-mini-ops.h"
	* simple-mini-ops.h: Was "ssapre-mini-ops.h" (renamed).
	* local-propagation.c: In mono_cprop_invalidate_values use a whitelist
	of opcodes, so that bug 78549 should not happen again.
	* ssapre.c: Updated to use the renamed files.

2006-06-08  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Fix a wrong reg-reg move 
	in OP_ATOMIC_EXCHANGE_I4.

2006-06-07  Wade Berrier <wberrier@novell.com>

	* tramp-s390.c: Fix s390 build (add missing pointer declarations 
	in mono_debugger_create_notification_function)

2006-06-06  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (NEW_AOTCONST_TOKEN): Fix amd64 build.
	
	* mini.c (type_from_stack_type): Disable some changes which do not
	seem to work.

	* driver.c: Reenable opts.

	* mini.h (MonoStackSlot): New structure to keep track of the verification state
	of the evaluation stack.
	
	* mini.h (MonoBasicBlock): Add a 'stack_state' field to keep track of the
	evaluation stack trace at entry to the bblock.

	* mini.c (merge_stacks): New function to perform verification of stack merges.
	Turned off by default.

	* mini.c: Fill up ins->klass for instructions whose type is STACK_OBJ or
	STACK_MP.
	
2006-06-06  Massimiliano Mantione  <massi@ximian.com>

	* local-propagation.c: Fixed bug 78549.

2006-06-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (ves_icall_get_frame_info): Fix this function on ia64.

2006-06-02  Miguel de Icaza  <miguel@novell.com>

	* tramp-sparc.c, tramp-ppc.c, tramp-s390.c, tramp-s390x.c,
	tramp-arm.c, tramp-ia64.c
	(mono_debugger_create_notification_function): Update signature to
	new signature and use new protocol for creating the notification
	function.  

	Should fix the build.

2006-06-02  Geoff Norton  <gnorton@customerdna.com>

	* exceptions-ppc.c (mono_jit_walk_stack)
	(ves_icall_get_frame_info): Fix the build

2006-06-02  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_set_defaults): Fix the handling of -O=-all.

2006-05-31  Raja R Harinath  <rharinath@novell.com>

	* il2tests.2.il: New file for generics CIL tests.  Add test for
	#78019.
	* Makefile.am: Update.

	Fix #78019
	* mini.c (mono_method_to_ir): Don't apply box+brtrue optimization
	to nullable types.

2006-05-30  Massimiliano Mantione  <massi@ximian.com>

	* aliasing.c: Fixed bug 78311.

2006-05-29  Martin Baulig  <martin@ximian.com>

	* mini-exceptions.c (mono_find_jit_info): When computing the
	native offset, check whether we're actually inside the method's
	code; call mono_debug_print_stack_frame() to format the frame.
	(ves_icall_System_Exception_get_trace): Call
	mono_debug_print_stack_frame() to format the stack frame.
	(ves_icall_get_trace): Update to the new debugging API.
	(mono_jit_walk_stack_from_ctx): Likewise.
	(ves_icall_get_frame_info): Likewise.

	* mini.c (get_method_from_ip): Use the new debugging API.
	(mono_print_method_from_ip): Likewise.

	* exceptions-ppc.c
	(mono_jit_walk_stack): Use the new debugging API.
	(ves_icall_get_frame_info): Likewise.	

2006-05-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_output_basic_block): Fix MONO_PROFILE_COVERAGE.

2006-05-25  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: Added "limitator" to inline for debugging.

2006-05-24  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (mono_debugger_init): Create a private,
	malloc()-based code manager for the notification function and
	intentionally leak it on exit.  This fixes the crash-on-exit race
	condition.

	* tramp-amd64.c
	(mono_debugger_create_notification_function): Added
	`MonoCodeManager *' argument.

	* tramp-x86.c
	(mono_debugger_create_notification_function): Added
	`MonoCodeManager *' argument.

2006-05-23  Massimiliano Mantione  <massi@ximian.com>

	* aliasing.c: Fixed 64 bit issue.
	* driver.c: Enabled inline,consprop,copyprop,treeprop,deadce by
	default since all known bugs are fixed (one more time!).

Tue May 23 13:47:28 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: write barrier support.

2006-05-23  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c: Revert Paolo's change.  Add comment and #error
	check at the top of the file.

Sun May 21 12:22:29 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* debug-debugger.c: fix the build. Again. Hopefully Martin will stop
	reverting changes without reason and without changelog entries.

2006-05-18  Zoltan Varga  <vargaz@gmail.com>

	* mini-sparc.c (mono_arch_output_basic_block): Add support for large stack offets
	to a few opcodes. Fixes #78439.

	* mini-sparc.c: Rename mono_sparch_break () to mono_arch_break () to improve
	consistency with other archs.

	* mini-ia64.c (mono_arch_emit_prolog): Remove debug stuff left in by mistake.

Wed May 17 18:07:33 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* debug-debugger.c: fix the build.

2006-05-17  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c
	(debugger_thread_vtable): Moved here from ../metadata/threads.c.
	(debugger_init_threads): Formerly known as mono_debugger_init_threads().
	(debugger_finalize_threads): Formaly known as mono_debugger_finalize_threads().
	(debugger_attach): Call GC_mono_debugger_add_all_threads().

2006-05-11  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Call pthread_attr_destroy () to fix a small memory leak.

2006-05-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_instrument_epilog): Fix handling of 
	MONO_TYPE_GENERICINST.
	
	* mini-amd64.c (mono_arch_instrument_epilog): Fix handling of 
	MONO_TYPE_GENERICINST.

2006-05-09  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_get_vcall_slot_addr): Add a missing call sequence. Fixes
	#78325.

2006-05-08  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_create_jump_trampoline): Allocate MonoJitInfo from the domain
	mempool.
	(mono_jit_free_method): Remove the method from jump_trampoline_hash as well.

2006-05-06  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_cleanup): Applied patch from Joachim Ante (joe@otee.dk). Call
	mono_trace_cleanup ().

	* iltests.il: Fix problem with the newly added test.

	* mini-codegen.c (mono_local_regalloc): When changing the dreg of an instruction
	due to register constraints, free up the previous hreg. Fixes #78314.

	* iltests.il: Add new test for #78314.	

	* mini-x86.c (mono_arch_get_inst_for_method): Use OP_ATOMIC_ADD_NEW_I4 for
	Interlocked.Add. Fixes #78312.

	* mini-amd64.c (mono_arch_get_inst_for_method): Ditto.
	
2006-05-05  Zoltan Varga  <vargaz@gmail.com>

	* inssel.brg (mini_emit_virtual_call): Fix a warning.

2006-05-05  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_debug_open_block): New method.

	* mini-amd64.c
	(mono_arch_output_basic_block): Call mono_debug_open_block() at
	the beginning of each basic block.

	* mini-x86.c
	(mono_arch_output_basic_block): Call mono_debug_open_block() at
	the beginning of each basic block.

2006-05-04  Massimiliano Mantione  <massi@ximian.com>

	* driver.c: Disabled inline,consprop,copyprop,treeprop,deadce by
	default until I understand why they break the build on amd64.

2006-05-04  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_cleanup): Call mono_cleanup ().

	* mini.c (UNVERIFIED): New macro to make it easier to track down verification
	errors.

2006-05-04  Massimiliano Mantione  <massi@ximian.com>

	* aliasing.c: Fixed shameful cut&paste error that caused JIT crashes.
	* driver.c: Enabled inline,consprop,copyprop,treeprop,deadce by
	default since all known bugs are fixed, and I cannot reproduce bug
	77944... I'm asking Matt Hargett to test again after this commit.

2006-04-28  Massimiliano Mantione  <massi@ximian.com>

	* mini-codegen.c: Fixed typo that thrashed inline.

2006-04-28  Zoltan Varga  <vargaz@gmail.com>

	* dominators.c (compute_dominators): Avoid using a worklist since
	it is not correct in some cases. Instead, iterate over all bblocks as
	in the original paper. Fixes --compile-all -O=all System.Xml.dll.

2006-04-28  Miguel de Icaza  <miguel@novell.com>

	* mini.c (mono_jit_compile_method_inner): Use
	mono_prepare_exception_from_error that resets the value
	internally.

2006-04-27  Miguel de Icaza  <miguel@novell.com>

	* mini.c: Move the mini_loader_error_to_exception to metadata. 
	
2006-04-27  Massimiliano Mantione  <massi@ximian.com>

	* aliasing.c: Fixed bug 78210.

2006-04-27  Massimiliano Mantione  <massi@ximian.com>

	* driver.c: Disabled inline,consprop,copyprop,treeprop,deadce by
	default until all their problems (or the ones they trigger) are fixed.

2006-04-26  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c (mono_aot_get_method_from_token_inner): Fix the previous patch.
	
	* aot-runtime.c (mono_aot_get_method_from_token_inner): Mark the method
	as loaded only after resolving patches since that could invoke the same method.

	* aot-runtime.c (mono_aot_plt_resolve): Fix ppc etc. builds.

	* aot-compiler.c: Refactor mono_aot_compile_aot () into a bunch of smaller
	functions.

	* aot-runtime.c (init_plt): Use a normal trampoline to transfer code to the
	AOT loader.

	* aot-compiler.c (emit_plt): Pass the plt offset in %eax instead of on the
	stack.

	* mini-trampolines.c (mono_aot_plt_trampoline): New trampoline to handle calls
	made from AOT code through the PLT table.

	* mini-x86.h mini-amd64.h: Define MONO_ARCH_AOT_PLT_OFFSET_REG to the register
	holding the plt offset when a call is made to the aot plt trampoline.
	
2006-04-25  Zoltan Varga  <vargaz@gmail.com>

	* aot-runtime.c aot-compiler.c cpu-amd64.md mini-amd64.c: Update parts of the 
	amd64 AOT support.

	* Makefile.am (common_sources): Fix build breakage.

	* aot-runtime.c aot-compiler.c: Reorganize the AOT code yet again: Make all
	calls through a jump table similar to the ELF PLT table. Avoid indirect calls for
	intra-assembly calls if possible.
	
	* tramp-*.c: Add new functions for patching/nullifying PLT entries.

	* mini-trampolines.c: Handle PLT entries.

	* mini.c: Avoid creating a GOT var for calls.

	* jit-icalls.c (helper_ldstr_mscorlib): New helper function for loading strings
	from mscorlib code.

	* jit-icalls.c (helper_newobj_mscorlib): New helper function to create objects
	from mscorlib code.

	* mini.c (mono_method_to_ir): Use the new helper functions in throw bblocks in
	AOT code.	

	* mini.h: Bump AOT file format version.
	
	* mini.c (get_basic_blocks): Fix the calculation of bb->out_of_line so it
	covers more cases.

2006-04-25  Martin Baulig  <martin@ximian.com>

	* driver.c: Disable copyprop, consprop and inline when running
	inside the debugger.

2006-04-25  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h (MonoDebuggerInfo): Replaced `get_thread_id'
	with `get_current_thread' and added `detach'.
	(MonoDebuggerMetadataInfo): Added `thread_size',
	`thread_tid_offset', `thread_stack_ptr_offset' and
	`thread_end_stack_offset'.

2006-04-25  Zoltan Varga  <vargaz@gmail.com>

	* aot.c Makefile.am: Split aot.c into two new files aot-compiler.c and 
	aot-runtime.c.

	* inssel.brg (mini_emit_load_intf_reg_vtable): Use a new kind of AOT constant
	ADJUSTED_IID to avoid the need for adjusting the IID at runtime.

	* mini.h (MonoJumpInfoType): Add MONO_PATCH_INFO_ADJUSTED_IID.

	* mini.c (mono_resolve_patch_target): Handle ADJUSTED_IID.

	* aot.c: Add support for ADJUSTED_IID.	

2006-04-24  Zoltan Varga  <vargaz@gmail.com>

	* aot.c (emit_method_order): Don't align method_order_end.

	* inssel.brg (stmt): Fix interface calls in AOT code which got broken by
	the interface ID changes.

2006-04-21  Dick Porter  <dick@ximian.com>

	* mini.c (mini_thread_cleanup): Clear the JIT TLS data when
	cleaning up a thread.  Fixes the new part of bug 77470.

2006-04-20  Geoff Norton  <gnorton@customerdna.com>

	* mini-ppc.c: Call mono_jit_thread_attach when transitioning a native
	to managed wrapper.
                     
2006-04-19  Zoltan Varga  <vargaz@gmail.com>

	* mini.h mini.c: Remove mono_type_to_ldind/stind () which are now in marshal.c.
	
	* mini.c (mono_runtime_install_handlers): Handle SIGABRT similarly to
	SIGSEGV. Fixes #78072.

	* mini-exceptions.c (mono_handle_native_sigsegv): Add a 'signal' argument,
	unregister our SIGABRT handler.

2006-04-19  Massimiliano Mantione  <massi@ximian.com>

        * mini.c: Disabled inline where it can alter the call stack in a
	way visible from managed code.
	* driver.c: enabled inline,consprop,copyprop,treeprop,deadce by
	default.

2006-04-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_emit_prolog): Attach the thread to the runtime as it is done
	on other platforms. Fixes #78089.

2006-04-13  Martin Baulig  <martin@ximian.com>

	* driver.c: Also check a `MONO_INSIDE_MDB' environment variable to
	determine whether we're inside the debugger.

	* debug-debugger.h
	(MonoDebuggerMetadataInfo): Added all offsets from `MonoDefaults'.

2006-04-12  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Handle multiple LEAVE statements inside a single
	handler clauses. Fixes #78024.

	* mini-sparc.c (mono_arch_output_basic_block): Handle large offsets
	in the CALL_MEMBASE opcodes. Fixes #78088.
	(mono_arch_get_vcall_slot_addr): Ditto.

2006-04-10  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c: The thread handling code has now been moved
	into ../metadata/threads.c.

2006-04-10  Zoltan Varga  <vargaz@gmail.com>

	* driver.c (mono_main): Fix --with-gc=none build.

	* mini-codegen.c (mono_spillvar_offset): Improve alignment.
	(mono_spillvar_offset_float): Ditto.
	(mono_local_regalloc): Only do the OP_MOVE optimization if ins->dreg is a local
	hreg, not when its !global, since on ia64, there is a third category: stacked
	registers.	

Mon Apr 10 14:39:49 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: set MonoInst->klass for load field address and a few other
	places.

2006-04-10  Zoltan Varga  <vargaz@gmail.com>

	* helpers.c (mono_disassemble_code): Emit debug info on amd64 as well.

2006-04-07  Zoltan Varga  <vargaz@gmail.com>

	* dominators.c (compute_dominators): Fix yet another bug which surfaced after
	the branch opt changes.

2006-04-06  Dick Porter  <dick@ximian.com>

	* wapihandles.c (mini_wapi_semdel): Fix parameters in semctl () call.
	
	* wapihandles.c (mini_wapi_seminfo): 
	* driver.c (mono_main): Add semaphore info option

2006-04-05  Zoltan Varga  <vargaz@gmail.com>

	* dominators.c (compute_dominators): Fix a bug which surfaced after the recent
	branch optimization changes. Fixes #78009.

Wed Apr 5 16:40:33 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: ignore accessibility of methods in managed->native wrappers.

2006-04-04  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_cleanup): Call print_jit_stats () earlier since it accesses metadata.
	
	* mini.c (mini_cleanup): Free 'emul_opcode_map' as well.

2006-04-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Modify the branch optimizations to preserve the invariant that
	the entries inside the in_bb and out_bb arrays are unique.
	(mono_unlink_bblock): Avoid creation of new arrays.

2006-04-02  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_unlink_bblock): Fix regression caused by previous
	change (#77992).

2006-04-01  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (optimize_branches): Remove the "optimizations" in
	the cbranch1/cbranch2 -> branch cases which were causing several
	problems in the past. Fixes #77986.

2006-03-31  Chris Toshok  <toshok@ximian.com>

	* driver.c (DEFAULT_OPTIMIZATIONS): back out the new set of
	default optimizations :(

2006-03-31  Zoltan Varga  <vargaz@gmail.com>

	* inssel-x86.brg mini-codegen.c mini.c: Merge some changes/fixes from linear-il
	branch.

2006-03-31  Massimiliano Mantione  <massi@ximian.com>

        * local-propagation.c: Added comments to structs and removed
	"Mono" prefixes from local tree mover types.

2006-03-30  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am (arch_sources): Define this for each architecture so 
	libmono_la_SOURCES is defined in one place.

Wed Mar 29 20:51:14 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* driver.c, wapihandles.c, Makefile.am: integrate the io-layer utils
	from handles/.

Wed Mar 29 17:16:57 CEST 2006 Paolo Molaro <lupus@ximian.com>

	* driver.c: print the GC name supplied by configure.

2006-03-29  Massimiliano Mantione  <massi@ximian.com>

        * local-propagation.c: Added tree mover, and moved here all the
	local propagation code from mini.c
        * mini.c: Added support for treeprop, and moved all the	local
	propagation code to local-propagation.c
        * mini.h: Added support for treeprop
        * driver.c: Added support for treeprop, enabled consprop, copyprop,
	treeprop, inline and deadce by default
        * Makefile.am: Added local-propagation.c

2006-03-25  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-sparc.c: Applied patch from David S. Miller  <davem@sunset.davemloft.net>: Implement correct support for sparc/linux.

Fri Mar 24 20:07:19 CET 2006 Paolo Molaro <lupus@ximian.com>

	* debug-debugger.c: make it compile without the Boehm GC.

Wed Mar 22 18:25:18 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: fixed issue with mismatch when an icall is registered
	with multiple names but same address.

Tue Mar 21 15:59:57 CET 2006 Paolo Molaro <lupus@ximian.com>

	* declsec.c, mini-exceptions.c: use write barrier to set reference
	fields of managed objects.

2006-03-19  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_print_method_from_ip): Recognize JIT trampolines as well.
	(can_access_internals): Fix a warning.

	* mini.c (print_method_from_ip): Rename this to 
	mono_print_method_from_ip so it gets exported.

	* trace.c: Deal with strings inside StringBuilder's containing garbage
	and fix memory leaks. Fixes #77848.

2006-03-19  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mini_init): Disable the setting of GC_stackbottom on ia64. Hopefully
	fixes #77787.

2006-03-16 Neale Ferguson <neale@sinenomine.net>
	
	* mini-s390.c: Remove OP_X86_TEST_NULL.

Thu Mar 16 17:19:04 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: use the correct GetHashCode() for the moving collector.

2006-03-16  Massimiliano Mantione  <massi@ximian.com>

        * liveness.c: Regalloc spill cost tuning.

2006-03-15 Neale Ferguson <neale@sinenomine.net>
	
	* mini-s390x.h: Correct S390_LONG macro.

	* mini-s390x.c: Cleanup unused code.

2006-03-15  Zoltan Varga  <vargaz@gmail.com>

	* jit-icalls.h: New file.

	* Makefile.am mini.c jit-icalls.c: Use a proper include file for the jit
	icalls and include that instead of including jit-icalls.c.

	* mini-ppc.c (mono_arch_output_basic_block): Remove references to
	OP_X86 opcodes.

Tue Mar 14 20:23:53 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: when checking for member accessibility, also check for
	friend assemblies and for explicit interface implementations.

2006-03-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_local_regalloc): Remove incorrect g_free () calls.

	* cpu-arm.md cpu-g4.md: Remove x86_ opcodes.

	* mini-x86.h (MONO_ARCH_INST_FIXED_REG): Reorganize the comparisons so
	common cases are done first.	

	* mini-ops.h: Only define platform specific opcodes on the given platform.

	* mini.h regalloc.h mini-codegen.c: Merge optimizations from the linear-il
	branch.
	
2006-03-14  Martin Baulig  <martin@ximian.com>

	Revert Paolo's change from r57348:

	* mini.h: don't use gboolean for bitfields.
	* mini.c: verifier changes for fields and methods accessibility.

2006-03-13  Neale Ferguson <neale@sinenomine.net>

	* mini-s390.h, mini-s390x.h: Fix calls to mono_call_inst_add_outarg_reg.

	* mini-s390x.c: Fix conv_r_un.

	* cpu-s390, cpu-s390x.md: Fix lengths.

Sun Mar 12 17:31:22 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: nested types have access to all the nesting
	levels, not just the enclosing types.

Sun Mar 12 16:23:11 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: added a few more verification checks.

2006-03-12  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c: Merge optimizations from the linear-il branch.

2006-03-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (emit_call): Add a comment.

	* tramp-ia64.c (mono_arch_patch_callsite): Handle indirect calls as well.

	* tramp-ia64.c: Fix some warnings.

Sat Mar 11 20:15:59 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h: don't use gboolean for bitfields.
	* mini.c: verifier changes for fields and methods accessibility.

2006-03-11  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_icall_get_wrapper): Fix an ia64 bug introduced by the
	lazy icall wrapper changes.

	* dominators.c: Replace all the dominator algorithms with faster
	ones from the linear-il branch.

	* inssel-*.brg: Allocate call->out_ireg_args and call->out_freg_args from
	the mempool.

	* mini-amd64.h (MONO_ARCH_INST_FIXED_REG): Reorganize the comparisons so
	common cases are done first.

	* mini-amd64.c: Fix some warnings.

	* mini-codegen.c mini-*.c: Allocate call->out_ireg_args and call->out_freg_args
	from the mempool.

	* mini.c (mono_jit_compile_method_with_opt): Fix a race in the newly
	added code.

	* mini.h: Add a missing prototype.

2006-03-10  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Compile icall wrappers lazily.

	* mini-codegen.c: Use printf instead of g_print since its much faster.

	* mini.h (mono_bitset_foreach_bit): Use the faster mono_bitset_find_start ()
	function.

	* mini.c (optimize_branches): Cache the negative result from 
	remove_block_if_useless ().

	* mini.c (optimize_branches): Avoid restarting the iteration after each change.	
	Also fix some bblock linking issues.

	* helpers.c (mono_disassemble_code): Reduce the size of the temporary
	assembly files.

	* mini.h: Define G_LIKELY/G_UNLIKELY macros for older glib versions.

	* mini.h (MonoBasicBlock): Reorganize the fields, putting more frequently
	accessed fields first, for better cache behavior.
	
Fri Mar 10 18:21:41 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: speedup IList<T> array accesses.

2006-03-09  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Handle large methods overflowing the 
	inline_costs counter. Fixes #77190.

2006-03-06  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c: Call mono_trace_is_enabled () before printing
	trace messages. Fixes #77706.

2006-03-04  Martin Baulig  <martin@ximian.com>

	* tramp-amd64.c, tramp-x86.c
	(mono_debugger_create_notification_function): Use
	mono_global_codeman_reserve() to allocate a buffer at runtime and
	return it.

	* debug-debugger.h (MonoDebuggerInfo): Added `initialize'.

	* debug-debugger.c (mono_debugger_init): Dynamically allocate the
	notification function at runtime and then call `initialize' in the
	`MONO_DEBUGGER__debugger_info' vtable.

2006-03-04  Zoltan Varga  <vargaz@gmail.com>

	* iltests.il: Fix a visibility problem.

Wed Mar 1 15:55:25 CET 2006 Paolo Molaro <lupus@ximian.com>

	* driver.c, mini.c: add hooks for the counters API.

Wed Mar 1 12:28:04 CET 2006 Paolo Molaro <lupus@ximian.com>

	* driver.c: show disabled options.

Wed Mar 1 12:18:51 CET 2006 Paolo Molaro <lupus@ximian.com>

	* linear-scan.c: always use cost-driven selection.

2006-02-28  Raja R Harinath  <rharinath@novell.com>

	* jit-icalls.c (helper_compile_generic_method): Revert change from
	2006-02-24.

Mon Feb 27 18:58:19 GMT 2006 Paolo Molaro <lupus@ximian.com>

	* cpu-arm.md, mini-arm.c: implemented MemoryBarrier.

Sat Feb 25 17:39:21 CET 2006 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: style fixes, mostly to force the updated monoburg
	to run for people using svn.

Sat Feb 25 17:07:42 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: match monoburg changes.

Sat Feb 25 16:04:33 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, abcremoval.c, aliasing.c, liveness.c,
	ssapre.c, graph.c, ssa.c: put the mono_burg_arity[]
	declaration in the header file.

Sat Feb 25 14:19:31 CET 2006 Paolo Molaro <lupus@ximian.com>

	* helpers.c: reduce relocations and mem usage.

Sat Feb 25 11:58:16 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-codegen.c: disable logging features if
	requested by configure.

Sat Feb 25 11:54:49 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: tiny verifier changes.

Fri Feb 24 18:17:52 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, inssel-x86.brg, tramp-x86.c, mini-x86.c,
	cpu-pentium.md: stack alignment changes for osx/x86,
	partially from Geoff Norton <gnorton@customerdna.com>.

2006-02-24  Raja R Harinath  <harinath@gmail.com>

	* jit-icalls.c (helper_compile_generic_method): Update to changes
	in metadata/class.c.

2006-02-24  Zoltan Varga  <vargaz@gmail.com>
	
	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Add a missing check.
	
	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Add support for
	interface calls with large offsets.

2006-02-23  Raja R Harinath  <rharinath@novell.com>

	* jit-icalls.c (helper_compile_generic_method): Document the
	special-case we depend on so that we can inflate the method twice
	with the same context with no bad side-effects.

Thu Feb 23 13:45:46 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, mini-amd64.c: fix for case when xen support
	is disabled.

Wed Feb 22 19:38:40 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, mini-amd64.c: generate code to access tls items
	in a faster way for Xen systems.

Wed Feb 22 10:31:25 CET 2006 Paolo Molaro <lupus@ximian.com>

	* exceptions-x86.c, mini-x86.h, driver.c, mini-codegen.c:
	updates and compilation fixes for the OSX/x86 port, mostly from
	Geoff Norton <gnorton@customerdna.com>.

Tue Feb 21 19:56:55 CET 2006 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: faster interface call implementation
	to sync with the interface_offsets MonoVTable changes.

Mon Feb 20 10:37:57 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: more verification checks.

Fri Feb 17 19:47:29 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: added a few more verification checks.

2006-02-17	Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, mini-s390x.h: Check for presence of long displacement
	facility on the processor and use it if available.

Fri Feb 17 16:12:52 CET 2006 Paolo Molaro <lupus@ximian.com>

	* driver.c, aot.c, mini.c: throw exception if the IL code is
	invalid or unverifiable.

2006-02-17  Raja R Harinath  <rharinath@novell.com>

	* generics.2.cs (test_0_ldfld_stfld_mro): Use m.struct_field, not
	m.StructField.

2006-02-16  Zoltan Varga  <vargaz@gmail.com>

	* generics.2.cs: Add some tests for generics ldfld/stfld wrappers.

Wed Feb 15 16:23:17 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-s390x.c, mini-s390.c, mini.c, mini-amd64.c, mini-arm.c,
	mini-ia64.c, mini-sparc.c, mini-x86.c, mini-ppc.c: fixed
	handling of instantiated generic valuetypes.

2006-02-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c mini-x86.h mini-x86.c: Get rid of 
	MONO_INIT_CONTEXT_FROM_CALLER, and use MONO_INIT_CONTEXT_FROM_FUNC
	instead.

	* generics.2.cs: Revert the nullable reftypes tests.

2006-02-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (MONO_INIT_CONTEXT_FROM_CALLER): Avoid
	using __builtin_frame_address (1) as it doesn't work in the presence
	of optimizations. Hopefully fixes #77273.

	* Makefile.am generics.cs generics.2.cs: Revert the generics.2.cs
	-> generics.cs change as it doesn't work with some automake versions.

Thu Feb 9 16:24:44 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle systems that sue a different way to
	retrieve the stack address of the current thread.

2006-02-09  Zoltan Varga  <vargaz@gmail.com>

	* Makefile.am generics.2.cs: Rename this to generics.cs and handle
	it specially in the makefile.

	* generics.2.cs: Add tests for nullable reference types.

Wed Feb 8 19:33:17 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: always handle the case when mono_jit_init()
	is called in a thread different from the main thread,
	confusing libgc (bug #77309).

Mon Feb 6 09:01:24 EST 2006 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fix handling of exceptions in large methods (bug #74932).

Fri Feb 3 18:51:35 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: change optimize_branches () to use a single loop
	and introduce a new optimization to simplify some range checks.

2006-02-03  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c (debugger_thread_manager_thread_created): Removed
	and merged with debugger_thread_manager_add_thread().
	(mono_debugger_main): Call debugger_thread_manager_add_thread() to
	inform the debugger about the main thread.

2006-02-03  Zoltan Varga  <vargaz@gmail.com>

	* basic.cs: Add test for div.un/rem.un constant folding.

2006-02-03  Neale Ferguson <neale@sinenomine.net>

	* cpu-s390x.md: correct int_xor_imm length

2006-02-03  Zoltan Varga  <vargaz@gmail.com>

	* generics.2.cs: New test for #77442.

	* jit-icalls.c (helper_compile_generic_method): Check for null. Fixes
	#77442.

2006-02-02  Martin Baulig  <martin@ximian.com>

	* tramp-x86.c, tramp-amd64.c: It's now safe to #include
	<mono/metadata/mono-debug-debugger.h>	

	* debug-mini.c: Don't #define _IN_THE_MONO_DEBUGGER.

2006-02-02  Martin Baulig  <martin@ximian.com>

	* debug-debugger.h: New header file for debug-debugger.c.

	* debug-debugger.c: Big API cleanup; don't run the managed Main()
	function is a separate thread anymore; add support for attaching.

2006-02-01  Zoltan Varga  <vargaz@gmail.com>

	* tramp-x86.c: Fix a warning.

2006-01-31  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_compute_omit_fp): Avoid hitting an assertion
	on very large methods.

	* aot.c (load_patch_info): Fix a warning.

Mon Jan 30 12:51:10 CET 2006 Paolo Molaro <lupus@ximian.com>

	* cpu-pentium.md, mini-x86.c, inssel.brg, inssel-x86.brg,
	mini-ops.h: alu membase optimizations.

Fri Jan 27 21:11:08 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini.c, inssel.brg, inssel-x86.brg: opcode
	to speedup StringBuilder.

2006-01-27  Zoltan Varga  <vargaz@gmail.com>

	* dominators.c (mono_compute_natural_loops): Fix detection of
	loop body start blocks.

	* mini-exceptions.c (mono_print_thread_dump): Fix non x86 builds.

2006-01-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.h mini.c mini-exceptions.c: Add thread dump support. Fixes
	#75145.

2006-01-25  Massimiliano Mantione  <massi@ximian.com>

        * aliasing.c: Fixed aliasing issue on 64 bit archs.

2006-01-25  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c: Moved the `MonoDebuggerManager' and
	`MonoDebuggerThread' typedefs here from mono-debug-debugger.h and
	started to cleanup this file a little bit.

Tue Jan 24 18:20:48 CET 2006 Paolo Molaro <lupus@ximian.com>

	* mini.c: optimize a codepath frequently happening in generics code.

2006-01-23  Martin Baulig  <martin@ximian.com>

	* Makefile.am: Only compile debug-debugger.c on supported platforms.

	* debug-debugger.c: Kill the IO_LAYER() hack and use the io-layer
	functions directly.

	* driver.c: debug-debugger.c is only available if
	`MONO_DEBUGGER_SUPPORTED' is defined.	

2006-01-23  Martin Baulig  <martin@ximian.com>

	* debug-debugger.c: Only enable this on platforms where the Mono
	Debugger is working (x86 and x86_64).

2006-01-21  Martin Baulig  <martin@ximian.com>

	The Mono Debugger is now using the normal `mono' instead of the
	`mono-debugger-mini-wrapper' when executing managed code.

	* debug-debugger.c: New file; previously known as
	debugger/wrapper/wrapper.c.

	* debug-mini.c (mono_init_debugger): Removed.

	* driver.c (mono_main): Added new `--inside-mdb' command line
	argument which is used when running inside the debugger.

2006-01-20  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c (mono_analyze_liveness): Remove some unused data
	structures.

2006-01-17  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Move mono_bitset_test_fast macro to monobitset.h where it belongs.

2006-01-16  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (mono_bitset_test_fast): Disable the 'fast' implementation which
	depends on implementation details of monobitset.

	* mini.c (mini_get_ldelema_ins): Fix handling of 1 dimensional arrays.
	Fixes #77271.

2006-01-15  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c: Update after monobitset changes.

2006-01-14  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (mono_arch_compute_omit_fp): Fix a leak.

2006-01-11 Neale Ferguson <neale@sinenomine.net>

	* inssel-s390x.brg: Fix reg: OP_LDADDR(OP_S390_LOADARG) register setting.

	* mini-s390x.c: Remove warning messages.

2006-01-11  Ben Maurer  <bmaurer@andrew.cmu.edu>

	* mini.c: pass the jitinfo to mono_profiler_method_end_jit.

2006-01-10  Zoltan Varga  <vargaz@gmail.com>

	* generics.2.cs: Add ldelem/stelem_any test.

2006-01-10 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c: Fix ATOMIC_ADD_I4 operation.

2006-01-07  Zoltan Varga  <vargaz@gmail.com>

	* inssel-long.brg: Fix int->long ovf conversion rules. Fixes #77172.
	
2006-01-06  Zoltan Varga  <vargaz@gmail.com>

	* generics.2.cs: Reenable vtype tests.

	* inssel-x86.brg: Remove an icorrect valuetype rule.

2006-01-06 Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, inssel-s390x.brg, cpu-s390x.md: Fix ATOMIC_I8 operations. Provide
	initial support for OP_ABS.

2006-01-05 Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c (emit_float_to_int): Correct r8 to unsigned int algorithm.

2006-01-05 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c, mini-s390.h, inssel-s390.brg, cpu-s390.md: Fix r8 to unsigned int 
	conversion and implement LADD/LSUB.

	* exceptions-s390.c: Standardize mono_arch_find_jit_info to match other
	architectures.

2006-01-05 Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, mini-s390x.h: Fix r8 to unsigned int conversion.

	* exceptions-s390x.c: Standardize mono_arch_find_jit_info to match other
	architectures.

2006-01-05 Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, mini-s390x.h, mini-s390.c, mini-s390.h: Fix lmf handling when 
	localloc is encountered.  Fixes crash in test-183.cs when using gmcs 
	(stack walk problem).

2006-01-04  Zoltan Varga  <vargaz@gmail.com>

	* aot.c (mono_aot_load_method): Fix a warning.

2006-01-03  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.h, exceptions-s390x.c, inssel-s390x.brg: Fix compiler warnings

2006-01-03  Zoltan Varga  <vargaz@gmail.com>

	* iltests.il: Add test for #77148.

	* mini.c (mini_get_ldelema_ins): Handle arrays with rank 1 too. Fixes
	#77148.

2006-01-03  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, inssel-s390x.brg: Remove debug statements

2006-01-03  Neale Ferguson <neale@sinenomine.net>

	* mini-s390x.c, mini-s390x.h, exceptions-s390x.c, tramp-s390x.c, inssel-s390x.brg,
	cpu-s390x.md, mini-codegen.c, Makefile.am: add 64-bit s390 support to JIT.

	* basic-long.cs: Add lconv-to-r4/r8 tests.

2006-01-03  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Fix DynamicMethod support in some opcodes.

	* mini-sparc.c (mono_arch_call_opcode): Use mono_class_value_size ()
	here as on other archs.

2005-12-29 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c (mono_arch_get_inst_for_method): Add memory_barrier support.

2005-12-29 Neale Ferguson <neale@sinenomine.net>

	* inssel-s390.brg: Correct register assignment; Rework L[ADD|SUB]_OVF[_UN] for s390.
	
	* cpu-s390.md: Fix lengths of a couple of long instructions; Add memory_barrier.

	* mini-s390.c: Fix long add/sub overflow instructions; Fix displacement handling in
	instrument_prolog; Add memory_barrier instruction.

2005-12-26  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c mini-x86.h: Fix solaris/x86 exception handling.

2005-12-23  Zoltan Varga  <vargaz@gmail.com>

	* tramp-ia64.c (mono_arch_get_unbox_trampoline): Flush icache.

	* aliasing.c inssel.brg: Fix warnings.

	* inssel-ia64.brg (OP_MEMSET): Fix an optimization which previously
	could skip initialization of some parts of memory.

	* mini.c mini-ia64.c: Fix warnings.

	* inssel-sparc.brg: Add an implementation of lneg which actually works.

2005-12-22  Zoltan Varga  <vargaz@gmail.com>

	* aliasing.c (mono_build_aliasing_information): Add a workaround for
	a crash seen on sparc.

	* mini-sparc.c: Add implementation of Thread.MemoryBarrier.
	
	* cpu-sparc.md: Add memory_barrier opcode. Remove unused opcodes.

2005-12-21 Neale Ferguson <neale@sinenomine.net>

	* mini-ops.h: Add s390_backchain instruction

	* inssel-s390.brg: Use backchaining instruction for LOADARG/STKARG operations.

	* cpu-s390.md: Add s390_backchain instruction

	* mini-s390.c: Significant ABI changes

	* mini-s390.h: Cater for zero length structures

2005-12-20 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c: ABI fixes

	* inssel-s390.brg: Remove debug statements

	* cpu-s390.md: Fix length of ATOMIC_xx operations

2005-12-19  Zoltan Varga  <vargaz@gmail.com>

	* basic-float.cs: Add float<->long conversion tests.

2005-12-16 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c: Fix LOCALLOC processing.

	* tramp-s390.c (s390_magic_trampoline): Fix base calculation.

2005-12-15  Zoltan Varga  <vargaz@gmail.com>

	* iltests.il: Add tests for some opcodes not covered by the other
	tests.

2005-12-15 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c: Fix ADDCC/SBB bug revealed by test_0_ulong_regress; Correct 
	register loading for Tail processing; Correct trace output.

	* inssel-s390.brg: Reimplement LSUB_OVF due to s390 implementation of signed math.

	* cpu-s390.md: Correct size of jmp instruction. 

2005-12-13 Neale Ferguson <neale@sinenomine.net>

	* mini-s390.c (mono_arch_emit_prolog): Remove some debugging bits.

2005-12-13 Neale Ferguson <neale@sinenomine.net>

	* inssel-s390.brg tramp-s390.c cpu-s390.md mini-s390.c mini-s390.h:
	  Bring s390 up to current level.

2005-12-12  Zltan Varga  <vargaz@gmail.com>

	* generics.2.cs: Disable the newly added tests as they do not work yet.
	
	* generics.2.cs: Add valuetype tests.

2005-12-09  Zoltan Varga  <vargaz@gmail.com>

	* basic-long.cs: Add i4->u8 test.

	* objects.cs: Add tests for JIT intrinsic.

	* mini.c (mini_get_inst_for_method): Resurrect the array Rank/Length
	optimizations lost by a mistake.

2005-12-07  Zoltan Varga  <vargaz@gmail.com>

	* basic-long.cs: Remove a test moved to objects.cs.

	* arrays.cs: Add more array tests.

2005-12-06  Zoltan Varga  <vargaz@gmail.com>

	* arrays.cs: Add new tests for multi-dimensional arrays.

2005-12-06  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (test_sources2): Add generics.2.cs.
	(EXTRA_DIST): Add test_sources2.

2005-12-05  Ben Maurer  <bmaurer@ximian.com>

	Support for boxing and unboxing nullable types as well as the
	isinst operation on nullables, per the CLI ammendment.

	* inssel.brg (CEE_ISINST): Special case for nullable

	* mini.c (handle_unbox_nullable): new method
	(handle_box): Special case for nullable types
	(mono_method_to_ir): Call handle_unbox_nullable in correct
	places.

	* generics.2.cs: New test suite

	* Makefile.am: Support for regression tests with generics.

2005-12-03  Zoltan Varga  <vargaz@gmail.com>

	* mini-amd64.c (emit_load_volatile_arguments): Add loading of arguments
	allocated to registers. Fixes #76800.

Thu Dec 1 12:59:40 EST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, inssel-ppc.brg: fix ABI issue (pinvoke3.cs).

2005-11-30  Zoltan Varga  <vargaz@gmail.com>

	* exceptions.cs: Disable test_0_long_cast () test, since it fails on a lot 
	of platforms.

2005-11-29  Zoltan Varga  <vargaz@gmail.com>

	* objects.cs basic-calls.cs: Move a test depending on valuetypes to
	objects.cs.

	* inssel-long32.brg (CEE_CONV_I8): Remove unused labels.
	
	* inssel-long32.brg (CEE_CONV_I8): Convert this to a branchless version.
Tue Nov 29 05:41:34 EST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: ensure a fp register is converted to
	single precision before storing to a single precision location.

2005-11-28  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (ILASM): Use profile-dependent location of ilasm.

2005-11-27  Zoltan Varga  <vargaz@gmail.com>

	* basic-long.cs basic-calls.cs objects.cs: Move some tests to the
	correct files.

	* basic.cs: Remove test_0_byte_compares test which was moved to
	objects.cs a long time ago.

2005-11-22  Massimiliano Mantione  <massi@ximian.com>

        * aliasing.c: Fixed aliasing issue on 64 bit archs.

2005-11-20  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c exceptions-ia64.c: Simplify the way filters/finally
	handlers are called.

	* mini-ia64.c (mono_arch_emit_exceptions): Optimize size of exception
	throwing code.

	 * mini-ia64.c: Add support for the throw->branch exception 
	optimization.	

	* driver.c (DEFAULT_OPTIMIZATIONS): Add MONO_OPT_EXCEPTION.

2005-11-18  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: Enabled "fastpath" deadce :-)
	
2005-11-18  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: Added "fastpath" deadce (deadce without SSA), and a simple
	alias analysis pass to support it.
	* mini.h: Likewise.
	* ssa.c: Likewise.
	* liveness.c: Likewise (liveness computation can use aliasing
	information to be more accurate).
	* driver.c: Added an "ssa" option go tell the JIT to use SSA, and
	moreover made so that "--compile-all" uses the given optimization
	flags and not the default ones.
	* aliasing.c: Alias analysis (new file).
	* aliasing.h: Likewise.
	* Makefile.am: added "aliasing.c" and "aliasing.h".
	
2005-11-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h: Add missing OP_I opcodes so it is in synch with the
	OP_L opcodes.

2005-11-13  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_exception_internal): Remove the 
	fp >= end_of_stack exit condition, as it is not needed, and it might
	become true for fp eliminated frames.

2005-11-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_epilog): Use G_STRUCT_OFFSET instead of hard
	coded offsets.

Tue Nov 8 11:28:20 GMT 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: fixed alignment of doubles/longs to match
	the C ABI (bug #76635).

Mon Nov 7 16:13:21 CET 2005 Paolo Molaro <lupus@ximian.com>

	* aot.c: fix compilation with --enable-minimal=aot.

Fri Nov 4 12:34:15 GMT 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: fixed compatibility with the new
	floating point emulator package for compares.

2005-11-03  Atsushi Enomoto  <atsushi@ximian.com?

	* mini.c : reverted sig->pinvoke changes (r51396-51397).

2005-11-01  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (print_stack_frame): Output to stderr.
	(mono_handle_native_sigsegv): Ditto.

2005-10-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Remove unused
	OP_LCONV_TO_OVF_I implementation.

	* mini-amd64.c: Add support for the throw->branch exception 
	optimization.

	* branch-opts.c (mono_branch_optimize_exception_target): Allow the case
	when the catch clause catches a more general exception, i.e. Object.

2005-10-30  Zoltan Varga  <vargaz@gmail.com>

	* cpu-ia64.md: Remove unused opcodes.

	* mini.c (GET_CONTEXT): Simplify this somewhat by removing arch
	specific defines for architectures defining USE_SIGACTION.

	* mini-ia64.c: Fix some warnings.

	* exceptions-ia64.c (mono_arch_ip_from_context): Fix this, the previous
	version seemed to skip a frame.

2005-10-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Clean up the usage of sig->pinvoke flag. Now
	only calls which are made to native code use this flag.

2005-10-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_compute_omit_fp): Disable fp elimination for
	varargs methods as well.
	
	* mini-amd64.c exceptions-amd64.c: Allow fp elimination in methods
	which have save_lmf set. Reorganize methods prologs a bit.

	* mini-amd64.c (mono_arch_compute_omit_fp): Move the check for the
	debugger to the proper place.

2005-10-29  Martin Baulig  <martin@ximian.com>

	* mini-amd64.c (debug_omit_fp): Temporarily disable fp elimination
	when running inside the debugger until the debugger has support
	for it.

2005-10-26  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Fix a warning.

2005-10-24  Miguel de Icaza  <miguel@novell.com>

	* mini.c (mono_pmip): Just a wrapper for get_method_from_ip which
	we expose publicly, this returns the string.

2005-10-22  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-amd64.c (mono_arch_find_jit_info): Fix some corner cases
	with fp elimination.

2005-10-21  Zoltan Varga  <vargaz@gmail.com>

	* mini-exceptions.c (mono_handle_native_sigsegv): Try to print a
	native stacktrace using the glibc 'backtrace' function if available.

2005-10-20  Zoltan Varga  <vargaz@gmail.com>

	* mini.h (MonoDebugOptions): Remove 'abort_on_sigsegv' option.

	* mini-exceptions.c (mono_handle_native_sigsegv): New function to 
	handle SIGSEGVs received while in native code.

	* mini.c (sigsegv_signal_handler): If the SIGSEGV happened in native
	code, call mono_handle_native_sigsegv which will abort the runtime
	after printing some diagnostics, instead of converting it into a
	confusing NullReferenceException.

2005-10-18  Zoltan Varga  <vargaz@gmail.com>

	* cpu-pentium.md: Remove unused opcodes.

2005-10-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.h (MonoLMF): Add rsp field.

	* mini-amd64.c exceptions-amd64.c tramp-amd64.c: Save the sp reg into
	the lmf too.

2005-10-17  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (get_register_spilling): Fix some warnings.

2005-10-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.h mini-amd64.c exceptions-amd64.c: Add support for fp
	elimination during exception handling. Enable fp elimination by
	default.

	* mini-amd64.h mini-amd64.c: Add preliminary support for frame pointer
	elimination.

2005-10-16  Martin Baulig  <martin@ximian.com>

	* mini-exceptions.c
	(mono_debugger_run_finally): New public method for the debugger.

2005-10-10  Zoltan Varga  <vargaz@gmail.com>

	* debug-mini.c (mono_debug_init_method): Fix warning.

	* mini.h branch-opts.c (mono_branch_optimize_exception_target): Make
	the 'exname' parameter const to fix some warnings.

2005-10-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (mono_handle_exception_internal): Fix another bug
	introduced by the previous patch.

2005-10-08  Zoltan Varga  <vargaz@gmail.com>

	* basic-float.cs: Add test for precision of float arithmetic.

	* mini-ia64.c (mono_arch_output_basic_block): Convert to/from doubles
	when loading/storing single values from/to memory.

	* mini.c (mono_jit_compile_method_with_opt): Create the function
	pointers in the correct domain.

2005-10-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (mono_handle_exception_internal): Fix bug 
	introduced by previous patch.
	
	* mini-exceptions.c (mono_handle_exception_internal): Handle the case
	when out_filter_idx is NULL.

	* mini-exceptions.c: Don't run filter clauses twice during exception
	handling. Fixes #75755.

2005-10-07  Zoltan Varga  <vargaz@gmail.com>

	* aot.c: Add support for ldflda wrappers.

	* mini.c (mono_method_to_ir): Use ldflda wrappers for CEE_LDFLDA. Fixes
	#75902.

Tue Oct 4 20:23:25 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h: do not consider exception handlers blocks when
	setting up interface variables.

2005-10-04  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (emit_section_change): Fix emitting of sections on win32. Fixes #76322.

2005-10-03  Zoltan Varga  <vargaz@gmail.com>

	* liveness.c (mono_analyze_liveness): Revert parts of r51051 since it
	causes a regression.

	* mini.c (mini_thread_cleanup): Fix reading of freed memory.

2005-10-02  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (OP_PCONST): Move the definition of OP_PCONST into the rest
	of the OP_P definitions.

	* TODO: Add a proposal for dealing with the CEE/OP mess.

	* mini-amd64.c (mono_arch_output_basic_block): Merge mul_imm 
	optimizations from the x86 port.

	* cpu-amd64.md: Ditto.

	* basic.cs basic-long.cs: Add tests.

Fri Sep 30 20:07:20 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, driver.c, mini-x86.c, mini.c, mini.h, branch-opts.c:
	Patrik Torstensson's implementation of my exception-handling
	optimization idea, when the exception object is not used
	(bug #62150).

Fri Sep 30 19:10:29 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, cpu-pentium.md: Patrik Torstensson's port
	of the mul_imm optimizations from the old jit.

Fri Sep 30 11:37:51 EDT 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c, liveness.c: patch by Patrik Torstensson and
	Zoltan Varga to improve performance in methods with
	exception clauses.

2005-09-30  Zoltan Varga  <vargaz@gmail.com>

	* driver.c: Remove 'Globalization' entry from --version.

2005-09-28  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_jit_compile_method_inner): Do not load AOT code when
	there is a profiler interested in JIT events.

	* aot.c: Load profile files produced by the AOT profiling module, and
	reorder methods based on the profiling info. Add a 'method_order' table
	to the AOT file to make mono_aot_find_jit_info work with the reordered
	methods.

	* mini.h: Bump AOT file version info.

Wed Sep 28 17:12:48 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.h: work around what looks like a gcc bug when optimizations
	are enabled.

2005-09-28  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (AM_CFLAGS): Don't use += to append inside
	conditionals.  Use ...
	(PLATFORM_CFLAGS, ARCH_CFLAGS): ... these.

2005-09-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_call_opcode): Use mono_class_value_size ()
	to determine the amount of memory to copy when passing valuetypes.

	* inssel-amd64.brg: Remove PUSH(LDIND4) rules since they convert an
	4 byte load into a 8 byte load. Fix aligning of size in OP_OUTARG_VT.

2005-09-27  Zoltan Varga  <vargaz@gmail.com>

	* mini.h mini.c aot.c: Add infrastructure to collect pagefault 
	information about aot.

2005-09-27  Ben Maurer  <bmaurer@ximian.com>

	* *.c: Replace the use of {Enter,Leave}CriticalSection with
        macros. This will allow a deadlock debugger to easily be plugged
        in.

Tue Sep 27 09:32:11 EDT 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: added memory barrier instruction.

2005-09-27  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (AM_CFLAGS): Rename from INCLUDES.
	(AM_CFLAGS) [PLATFORM_WIN32): Append to it, don't set it.
	(AM_CFLAGS) [ARM]: Add arch/arm directory from the build tree.
	($(arch_built)) [CROSS_COMPILING]: Error out.

2005-09-26  Zoltan Varga  <vargaz@gmail.com>

	* aot.c: Add support for the no_special_static flag for classes.

2005-09-24  Zoltan Varga  <vargaz@freemail.hu>

	* Reapply reverted patches.

	* *: Revert r50174 as well.

	* mini-amd64.c cpu-amd64.md inssel-amd64.brg: Revert r50170 as well.

2005-09-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c: Revert r50342 to see if this fixed buildbot.

2005-09-23  Miguel de Icaza  <miguel@novell.com>

	* mini.c (SIG_HANDLER_SIGNATURE): Only dereference info if it is
	part of the SIG_HANDLER_SIGNATURE.  

2005-09-23  Zoltan Varga  <vargaz@gmail.com>

	* mini.h mini.c: Add a new MONO_DEBUG option to collect metadata pagefault
	statistics.

	* mini-x86.c (mono_arch_call_opcode): Fix vararg calling convention 
	introduced by previous patch.

2005-09-21  Zoltan Varga  <vargaz@gmail.com>

	* tramp-x86.c (mono_arch_create_trampoline_code): Restore caller
	saved registers too.

	* mini-x86.c (mono_arch_allocate_vars): Rewrite this so it works based 
	upon the information returned by get_call_info ().
	
	* mini-x86.c (add_float): Fix stack size calculation.
	(mono_arch_call_opcode): Rewrite this so it works based up the
	information returned by get_call_info ().
	(mono_arch_get_this_vret_args): Ditto.

2005-09-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_emit_this_vret_args): Use the information
	in cinfo to determine the registers which need to be used.

2005-09-20  Miguel de Icaza  <miguel@novell.com>

	* driver.c (mono_main): Add --server and --desktop flags. 

2005-09-16  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.h: Make register masks 64 bit. Don't treat argument
	registers as global registers.

	* inssel-ia64.brg (stmt): Remove OP_OUTARG_REG () rules which are no 
	longer needed with the new register allocator.

	* mini-ia64.c: Use OP_MOVE instead of OP_SETREG for reg-reg moves.

	* cpu-ia64.md: Remove unused opcodes.
	
	* regalloc.c mini-codegen.c: Make register masks 64 bit on ia64.
	
2005-09-16  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md: Remove unused opcodes.

	* inssel-amd64.brg: Remove OP_OUTARG_REG () rules which are no longer
	needed with the new register allocator.

	* inssel-amd64.brg mini-amd64.c: Use OP_MOVE instead of OP_SETREG for
	reg-reg moves.

2005-09-16  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (check-local): Don't invoke semdel-wrapper.

2005-09-16  Martin Baulig  <martin@ximian.com>

	* exceptions-amd64.c
	(throw_exception): Don't call mono_debugger_throw_exception() if
	we're a rethrow - see the FIXME in the code.

2005-09-15  Geoff Norton  <gnorton@customerdna.com>

	* mini.c (mono_init_exceptions): This only works on some architectures.
	
2005-09-15  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_method_to_ir): Add OP_LMUL imm -> OP_LMUL_IMM conversion
	on ia64.

	* inssel-long.brg mini-ia64.c: Add OP_LMUL_IMM rules.

	* mini-ia64.h mini-ia64.c: Remove the altstack support code which is
	now in mini-exceptions.c.

2005-09-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.h mini-am64.c: Remove the altstack support code which is
	now in mini-exceptions.c.

2005-09-15  Zoltan Varga  <vargaz@gmail.com>

	* exceptions-x86.c: Applied patch from Patrik Torstensson 
	<patrik.torstensson@gmail.com>. Add stack overflow handling support for win32.

	* mini-exceptions.c mini-x86.c mini.c: Move the altstack setup/teardown
	code into mini-exceptions.c. Add some assertions to it.

2005-09-12  Zoltan Varga  <vargaz@gmail.com>

	* aot.c (emit_section_change): Applied patch from "The Software Team" 
	(<software@solmersa.com>). Fix as errors on windows.

2005-09-11  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c (mono_arch_create_trampoline_code): Fix saving of
	method info into the LMF.

2005-09-11  Zoltan Varga  <vargaz@gmail.com>
	
	* mini-ia64.c: Add proper unwind info for method epilogs.

	* exceptions-ia64.c: Add some code to help debugging.
	
	* mini-ia64.c mini-ia64.h: Add sigaltstack support.

	* mini-exceptions.c: Fix warning.

2005-09-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Really fix build.

	* mini-x86.c mini-amd64.c: Fix build.

2005-09-11  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c inssel-ia64.brg: Add InterlockedExchange instrinsics.

	* mini-ops.h cpu-ia64.md inssel-ia64.brg mini-ia64.c: Implement
	some Interlocked methods as intrinsics.

	* mini.c (mini_get_inst_for_method): Call arch_get_inst_for_method
	for Thread methods as well.

	* mini-ops.h: Add OP_MEMORY_BARRIER opcode.

	* inssel.brg: Add rule for OP_MEMORY_BARRIER.

	* mini-ia64.c mini-x86.c mini-amd64.c 
	cpu-ia64.md cpu-pentium.md cpu-amd64.md: Add implementation of 
	OP_MEMORY_BARRIER.
	
	* mini.c (mono_init_exceptions): Fix build breakage.

2005-09-10  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c exceptions-ia64.c tramp-ia64.c: Remove 'manual' emitting
	of instructions. Use the new ia64_unw_op macros for emitting unwind
	info.

	* mini.c (mono_init_exceptions): Initialize exception handling
	related trampolines at startup.

Fri Sep 9 19:30:37 BST 2005 Paolo Molaro <lupus@ximian.com>

	* cpu-arm.md, mini-arm.c: fix for dynamic code (Gtk# apps).

2005-09-09  Zoltan Varga  <vargaz@gmail.com>

	* mini.c: Handle type loading errors gracefully during compilation and
	throw the appropriate exception.

Fri Sep 9 09:49:14 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* ldscript.mono, Makefile.am: use anonymous versions in the ldscript
	for the mono binary.

2005-09-09  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): Comment out the G_BREAKPOINT()'s for
	the release.

Thu Sep 8 14:53:45 BST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.h: use emulation for conv.r.un for the release.

Thu Sep 8 11:28:45 BST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c, objects.cs: more fixes and tests for them.

Wed Sep 7 17:14:26 BST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c: align structures to at least 4 bytes to be able
	to keep our current optimized memcpy.

Tue Sep 6 22:51:08 BST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c, cpu-arm.md, inssel-arm.brg: bugfixes.

2005-09-05 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: ignore SIGPIPE.

2005-09-04  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_lowering_pass): Convert 'and_imm 255' to zext1.

	* mini-ia64.h mini-ia64.c: Add some minor optimizations.

2005-09-02  Zoltan Varga  <vargaz@gmail.com>

	* mini.h: Add prototype for mono_allocate_stack_slots_full.

Thu Sep 1 21:05:26 BST 2005 Paolo Molaro <lupus@ximian.com>

	* exceptions-arm.c, mini.c, mini-arm.c, mini-arm.h:
	exception handling support.
	* mini-arm.c, mini-arm.h: bigendian fixes (partially from a
	patch by Brian Koropoff <briank@marakicorp.com>).

Thu Sep 1 10:22:44 EDT 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: revert another 'optimization' which breaks when
	items on the eval stack need to be saved at a basic block end
	(bug #75940).

Wed Aug 31 17:29:32 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c: for arrays, ensure we always provide
	lower bounds.

2005-08-30  Zoltan Varga  <vargaz@gmail.com>

	* mini.c (mono_allocate_stack_slots_full): Fix ia64 build.
	
	* mini.c (mini_get_inst_for_method): Special case Object:.ctor as well.

2005-08-29  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.h mini-ia64.c: Implement frame pointer elimination. Keep
	arguments in their original register.

2005-08-28  Zoltan Varga  <vargaz@gmail.com>

	* mini-ops.h cpu-ia64.md inssel-ia64.brg mini-ia64.c: Optimize
	memset/memcpy.

	* mini.c (mono_method_to_ir): Disable the MUL->MUL_IMM optimization
	when ssapre is enabled.

	* inssel-long.brg: Fix bug in previous patch.

	* mini-ia64.c mini-ia64.h mini.c inssel-long.brg: Optimize 
	multiplication by a constant.

2005-08-27  Zoltan Varga  <vargaz@gmail.com>

	* mini-ia64.c (mono_arch_setup_jit_tls_data): Add support for intel
	icc.

	* tramp-ia64.c (mono_arch_create_trampoline_code): Use st8.spill for
	saving registers.

Fri Aug 26 11:09:28 BST 2005 Paolo Molaro <lupus@ximian.com>

	* inssel-arm.brg: apply changes tested by Brian Koropoff
	<briank@marakicorp.com>.

2005-08-25  Zoltan Varga  <vargaz@gmail.com>

	* mini-x86.c (mono_arch_emit_prolog): Fix calling of mono_jit_thread_attach () under windows.
	
2005-08-24  Zoltan Varga  <vargaz@gmail.com>

	* mini-codegen.c (mono_local_regalloc): Avoid allocating dreg and sreg1/2
	to the same register if dreg is just a base register.
	(print_ins): Improve printing of membase opcodes.

	* inssel-x86.brg: Add optimized ldind(reg) rules.

	* mini-x86.c cpu-pentium.md: Changes required to support the new rules.

Wed Aug 24 19:39:36 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: when running under valgrind, set the stack bottom for
	the GC at the actual approximate stack for the app (fixes running
	mono with valgrind).

Tue Aug 23 21:38:50 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: do no break at the first valuetype to init found
	(fixes bug #75791).

Tue Aug 23 16:53:21 BST 2005 Paolo Molaro <lupus@ximian.com>

	* cpu-arm.md, mini-arm.c: more fixes and LMF support.

Tue Aug 23 15:11:44 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md: fixed instruction length exposed by the nemerle compiler.

2005-08-23  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-amd64.brg inssel-x86.brg: Fix the fcall rules.

2005-08-22  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-x86.brg: Fix assert in patch_delegate_trampoline.

	* tramp-x86.c (mono_arch_patch_delegate_trampoline): Add some debug
	code.

	* tramp-amd64.c (mono_arch_patch_delegate_trampoline): Add some debug
	code.

	* mini.c (optimize_branches): Don't quit after 1000 iterations on large
	methods.

Mon Aug 22 19:16:29 BST 2005 Paolo Molaro <lupus@ximian.com>

	* tramp-arm.c: allocate less memory for the trampoline and fix typo.

2005-08-22  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Remove instructions inserted after a branch
	in the tail recursion optimization.

	* mini.h helpers.c (mono_disassemble_code): Emit starts of basic blocks as 
	debug info into the assembly file.

	* iltests.il: Add test for filter regions.

	* mini.c (mono_method_to_ir): Fix handling of nested FILTER clauses. Fix
	initial stack of filter regions. Fixes #75755.

Mon Aug 22 17:49:16 BST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-arm.c, cpu-arm.c: fixes and support for methods with bigger
	stack requirements.

2005-08-22  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_create_delegate_trampoline): Fix memory leak. Put back
	the check for an already compiled method on non-ia64 platforms.
	(mono_create_jump_trampoline): Store the MonoJitInfo structure into the
	proper domain.

	* mini-x86.h tramp-x86.c: Add support for delegate trampolines.

	* inssel-x86.brg: Add some optimized call rules.

2005-08-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_create_delegate_trampoline): Do not return an already compiled
	method here.

	* mini.h mini-trampolines.c: Pass the trampoline argument to 
	mono_arch_patch_delegate_trampoline.

	* mini-ia64.h mini-ia64.c tramp-ia64.c: Add support for delegate trampolines.

	* mini-trampolines.c: Fix build.

	* mini-amd64.h: Add delegate trampolines.

	* mini.h mini.c mini-trampolines.c tramp-amd64.c: Add delegate trampolines.

	* inssel-amd64.brg: Add optimized call rules.
	
	* mini-ia64.c tramp-ia64.c: Improve instruction scheduling.

	* inssel-ia64.brg: Add optimized ldind(reg) rules.

2005-08-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_create_class_init_trampoline): Fix bug caused by last
	change.

	* mini-ia64.c: Remove LMF fixmes.

	* mini-ia64.h: Remove most fields from LMF.

	* inssel-ia64.brg (stmt): Fix unaligned access errors.

	* mini-trampolines.c: Add support for IA64 function descriptors.

	* mini.h mini.c jit-icalls.c exceptions-ia64.cdriver.c: Add support
	for IA64 function descriptors.

Sat Aug 20 16:51:44 BST 2005 Paolo Molaro <lupus@ximian.com>

	* tramp-arm.c: patch the vtable for virtual calls. Added
	support code to register/unregister the LMF.
	* mini-arm.c, mini-arm.h: warning fixes, fixes, speedups,
	more LMF work.

2005-08-19  Dick Porter  <dick@ximian.com>

	* mini.c: Use a gsize to store the thread ID, so it can hold a 64
	bit value if needed.

2005-08-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mini_get_method): Move handling of wrapper data here.

	* mini.c (mono_method_to_ir): Add support for dynamic methods.

	* mini.c (mono_method_to_ir): Convert nonvirtual calls to abstract methods into
	virtual.

	* mini.c (mono_method_to_ir): Emit IR for CEE_NOP as well, so 
	bblock->code does not remain empty.

2005-08-17  Zoltan Varga  <vargaz@freemail.hu>

	* arrays.cs: Add regression test for #75832.

	* inssel-amd64.brg cpu-amd64.md mini-amd64.c: Fix LDELEMA optimization
	rules. Fixes #75832.

	* mini-ia64.c tramp-ia64.c exceptions-ia64.c: Implement improved
	instruction scheduling.

2005-08-12  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (ves_icall_get_frame_info): Fix IA64 build.

2005-08-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c mini-x86.h: Move VC stuff into macros in mini-x86.h.

	* mini-codegen.c: Fix VC build.

	* cpu-pentium.md: Increase length of atomic_exhange_i4.

2005-08-09 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.h: fix signature for mono_register_opcode_emulation.

2005-08-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Get rid of most of the helper_sig_... constants using
	mono_create_icall_signature ().

2005-08-08  Zoltan Varga  <vargaz@freemail.hu>

	* jit-icalls.c (helper_ldstr): New helper function.

	* mini.c (get_basic_blocks): Set out_of_line for bblocks containing a throw.

	* mini.c (mono_method_to_ir): If an LDSTR instruction is in a bblock with a
	throw, load the string using a helper call instead of creating a string object.

	* aot.c: Update after LDSTR changes.

	* mini.h: Bump AOT file version.
	
	* aot.c: Save class size info into the AOT file. Print more statistics during
	compilation.

	* mini.h: Bump AOT file version.

	* tramp-amd64.c (mono_arch_nullify_class_init_trampoline): Fix
	ordering of disasm cases. Fixes #74957.

Thu Aug 4 19:47:24 BST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini-arch.h, inssel.brg, mini.c, mini.h,
	jit-icalls.c, mini-codegen.c, Makefile.am: changes in
	the generic code needed for the ARM port.

Thu Aug 4 19:42:54 BST 2005 Paolo Molaro <lupus@ximian.com>

	* exceptions-arm.c, tramp-arm.c, mini-arm.c, mini-arm.h, cpu-arm.md,
	inssel-arm.brg: more ARM features and fixes.

Mon Aug 1 18:37:38 BST 2005 Paolo Molaro <lupus@ximian.com>

	* tramp-arm.c, mini-arm.c, cpu-arm.md, inssel-arm.brg: more
	ARM port work in progress.

2005-07-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c (mono_arch_call_opcode): Ongoing IA64 work.

	* mini-exceptions.c mini-ia64.h: Ongoing IA64 work.

	* mini-ia64.c (ia64_emit_bundle): Ongoing IA64 work.

	* inssel.brg (mini_emit_memset): Add support for unaligned access.

	* *-ia64.*: Ongoing IA64 work.
	
	* mini-ia64.c exceptions-ia64.c: Ongoing IA64 work.

2005-07-28  Zoltan Varga  <vargaz@freemail.hu>

	* TODO: Remove out-of-data todo stuff.

	* mini.h mini.c (mono_create_jit_trampoline_from_token): Remove some
	dead code.

	* aot.c: Save/load MonoCachedClassInfo->has_nested_classes.

	* mini.h: Bump corlib version.

2005-07-27  Martin Baulig  <martin@ximian.com>

	* mini-codegen.c
	(create_copy_ins): Added `const unsigned char *ip' argument; set
	`copy->cil_code' from it.

2005-07-27  Martin Baulig  <martin@ximian.com>

	* mini-exceptions.c (mono_handle_exception): Don't call
	mono_debugger_handle_exception() for filters.

2005-07-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini-trampolines.c (mono_aot_trampoline): Handle AppDomain:InvokeInDomain
	as well.

2005-07-26  Martin Baulig  <martin@ximian.com>

	Committing a patch from Michal Moskal <michal.moskal@gmail.com>.

	* mini.c (mono_method_to_ir): In `CEE_CALLI', only use
	helper_compile_generic_method() if the method is actually virtual
	and non-final.

2005-07-26  Martin Baulig  <martin@ximian.com>

	* mini.c
	(trampoline_code): Renamed to `mono_trampoline_code' and made it
	public; this is now accessed directly by the debugger.
	(mono_generic_trampoline_code): Removed.

	* debug-mini.c
	(mono_debug_init_method): Also add interncalls and wrappers.

2005-07-23  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c mini-ia64.h: Add support for tracing/profiling.

2005-07-22  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_get_method_from_token): Fix a potential crash here.

2005-07-21  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (load_patch_info): Fix handling of stfld_remote wrapper.

2005-07-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_setup_jit_tls_data): Use the nice way of
	getting TLS offsets on AMD64 too.

2005-07-20  Kornel Pal <kornelpal@hotmail.com>

	* driver.c: Detach console when executing IMAGE_SUBSYSTEM_WINDOWS_GUI on win32

Wed Jul 20 18:05:19 BST 2005 Paolo Molaro <lupus@ximian.com>

	* exceptions-arm.c, mini-arm.c, tramp-arm.c, cpu-arm.md,
	inssel-arm.brg,	mini-arm.h: ARM port work in progress.

2005-07-20  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c (mono_arch_create_specific_trampoline): Fix build.

	* mini.h mini.c mini-*.h tramp-*.c: Move more cross platform trampoline code
	to mini.c.

	* mini-sparc.c (mono_arch_get_vcall_slot_addr): Call 
	mono_sparc_is_virtual_call ().
	
	* mini-sparc.c (mono_arch_get_vcall_slot_addr): Fix warning.

	* tramp-sparc.c (mono_arch_create_trampoline_code): Fix order of
	trampoline parameters.

	* mini-sparc.c (mono_arch_get_vcall_slot_addr): Fix signature.
	
	* mini-sparc.c (mono_arch_get_vcall_slot_addr): Rename this
	to mono_arch_get_vcall_slot_addr.

	* Makefile.am tramp-sparc.c: Update the sparc port to use the generic
	trampoline code.

	* *-sparc.*: Merge the mini-xp-regalloc branch for sparc.

2005-07-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.h mini-ia64.c: Finish pinvoke support.

2005-07-19  Martin Baulig  <martin@ximian.com>

	* exceptions-amd64.c (throw_exception): Call
	mono_debugger_throw_exception() here like we're doing it on i386.

2005-07-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c: Add optimized TLS access support.

2005-07-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c: Ongoing IA64 work.

	* mini-ia64.c inssel-long.brg: Ongoing IA64 work.

	* mini.c: Use the default optimization set when embedding. Fixes
	#75194.

2005-07-11  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c tramp-ia64.c Makefile.am: Move arch independent parts 
	of trampolines to a separate file.

	* mini-trampolines.c: New file.

	* mini.h tramp-x86.c: Move arch independent parts of trampolines to a 
	separate file.
	
	* tramp-x86.c: Reorganize the trampoline code to be similar to the 
	amd64/ia64 code.

	* mini-codegen.c: Fix cygwin build.

2005-07-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Add some minor changes needed by the IA64 port.

	* *-ia64.*: Ongoing IA64 work.

2005-07-09  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c mini-amd64.c: Update after latest AOT changes. Split 
	trampolines into arch-independent and arch-dependent parts.

	* mini-amd64.c (mono_arch_lowering_pass): Fix store_membase_imm -> store_membase_reg rule.

2005-07-08  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md: Merge the xp-regalloc-branch for amd64.

	* mini-ops.h mini-amd64.h mini-amd64.c inssel-amd64.brg Makefile.am: Merge
	the xp-regalloc-branch for amd64.

	* mini-x86.h mini-x86.c cpu-pentium.md Makefile.am: Merge the
	xp-regalloc-branch for x86.

2005-07-07  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg (OP_THROW_OR_NULL): Allways rethrow the abort exception.

2005-07-06  Martin Baulig  <martin@ximian.com>

	* mini.c
	(mono_jit_compile_method_inner): Call mono_get_inflated_method().
	(mono_jit_runtime_invoke): Likewise.

2005-07-05  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Allocate the GOT in the .bss segment
	on x86 too.
	
	* aot.c: Add new mono_aot_get_method_from_token () function to load AOT methods
	without loading their metadata. Reorganize the file format so exception handling+
	debug info is kept separate from normal method info. Create MonoJitInfo 
	structures for methods lazily.

	* tramp-x86.c (x86_aot_trampoline): Use the new from_token method to avoid
	loading metadata.
	(x86_class_init_trampoline): Patch AOT class init trampolines too.

	* mini.c (mini_init): Install the new mono_aot_find_jit_info hook.

	* mini.c (mono_method_to_ir): Reduce the number of class init trampoline calls
	in AOT code.

	* mini.h: Bump AOT file version.

2005-07-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (peephole_pass): Fix the loadi1/loadi2 rules.

2005-07-01  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (check-local): Call semdel-wrapper.

2005-06-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c: Revert the last change as it seems to break the build..

2005-06-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (peephole_pass): Fix the loadi1/loadi2 rules.
	
	* mini-x86.c (mono_arch_cpu_init): Fix setting of fp precision in the VC build.

2005-06-27  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (NEW_AOTCONST): make sure to call mono_get_got_var
	outside of the macro, so strange stuff doesn't happen with gcc4
	(NEW_AOTCONST_TOKEN): Likewise.

2005-06-28  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_class_is_system_array): New static method; use this
	instead of `klass->parent == mono_defaults.array_class' everywhere
	since this also works for the new generic array class.

2005-06-26  Ben Maurer  <bmaurer@ximian.com>

	* inssel.brg: Remove warnings.

2005-06-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c: Ongoing IA64 work.

	* basic-float.cs: Add float->i1 conversion test.

	* iltests.il: Add conv.u4 test.

2005-06-23  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-long.brg: Fix bug caused by last change.

2005-06-23  Geoff Norton  <gnorton@customerdna.com>

	* mini-x86.h: Add __APPLE__ to the SC_* redefines with the other 
	BSDs.  Allows the x86 JIT to work on OSX86

2005-06-22  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-long.brg: Use OP_LSHR_UN_IMM instead of OP_SHR_UN_IMM in
	u4->i8 conversion.

	* mini-ia64.c: Ongoing IA64 work.

2005-06-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c: Ongoing IA64 work.

	* driver.c: Clean up jit_code_hash as well when using --regression.

	* inssel-long.brg: Fix long->i4/u4 conversion rules.

	* basic-long.cs: Add tests for long->u4 conversion.

2005-06-18  Ben Maurer  <bmaurer@ximian.com>

	* mini.c: Take mono_get_domainvar out of macros. This makes sure
	that we do not depend on undefined C behavior: the order stuff
	gets evaluated within an expression. Fixes mono when compiled on
	GCC 4.

2005-06-18  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Ongoing IA64 work.

	* aot.c: Lower memory usage while loading AOT methods.

	* tramp-x86.c: Avoid allocating+freeing MonoJitInfo structures.

	* mini.h: Bump AOT file format version.

2005-06-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Allow STACK_PTR as input to SWITCH.

2005-06-16  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Fixed APTC to check for FullTrust on caller assembly (and
	not on callee assembly). Fixed some comments.

2005-06-16  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Mark the "methods" symbol as a function so
	it gets proper disassembly.
	(emit_method_info): Remove some dead code.

	* mini.c (mini_method_compile): Allways allocate the GOT var in
	mono_method_to_ir for emulating opcodes.

2005-06-13  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_free_method): Remove the method from the JitInfo table
	before freeing the code memory. Fixes #74990.

	* objects.cs: Add regression test for #74992.

	* liveness.c: Extend live ranges of arguments to the beginning of the
	method. Fixes #74992.

	* exceptions-ia64.c mini-ia64.h: Modify ip during exception handling
	so it points into the faulting instruction.

2005-06-12  Zoltan Varga  <vargaz@freemail.hu>

	* jit-icalls.c (mono_imul_ovf): Add exception handling.

	* *-ia64.*: Ongoing IA64 work.

	* mini.c (mini_init): Fix signature of mono_delegate_ctor.

2005-06-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.h exceptions-ia64.c: Ongoing IA64 work.

	* *-ia64.*: Ongoing IA64 work.

2005-06-10  Zoltan Varga  <vargaz@freemail.hu>

	* basic-long.cs: Add tests for add/sub.ovf.

	* basic.cs: Add tests for sub.ovf.

	* *-ia64.*: Ongoing IA64 work.

2005-06-09  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Ongoing IA64 work.

	* basic.cs: Add conv.ovf.i4.un test.

2005-06-09  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: (remove_block_if_useless) Fixed bug 75061.
	
2005-06-08 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: no SIGUSR2 on windows. Remove it for PLATFORM_WIN32.

2005-06-07  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Ongoing IA64 work.

2005-06-07 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* trace.[ch]:
	* mini.c: added the ability to toggle trace on/off using SIGUSR2.

2005-06-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c mini-ia64.h: Fix cleanup of memory stack.

2005-06-03  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (emit_call): Fix yet another bug in the near call optimization.

	* mini-amd64.c (amd64_patch): Add an assert to check that the destination
	of a call is callable by a near call.

2005-05-31  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ia64.c: Ongoing IA64 work.

2005-05-29  Zoltan Varga  <vargaz@freemail.hu>

	* genmdesc.c: Make the generated array non-static.

	* inssel-long.brg: Fix LSHR_IMM rule.

	* *-ia64.*: Ongoing IA64 work.

	* *-ia64.*: Ongoing IA64 work.

2005-05-28  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Ongoing IA64 work.

	* *-ia64.*: Ongoing IA64 work.
	
	* mini-ia64.c: Ongoing IA64 work.

	* *-ia64.* jit-icalls.c mini-codegen.c: Ongoing IA64 work.

2005-05-28  Zoltan Varga  <vargaz@freemail.hu>

	* objects.cs basic-calls.cs: Move some tests to objects.cs.
	
	* objects.cs basic-long.cs: Move some tests to objects.cs.

2005-05-26  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Ongoing IA64 work.

	* iltests.il: Add a new test.

	* mini.c (mono_method_to_ir): Initialize valuetypes when created using
	newobj. Fixes #75042.

2005-05-22  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Ongoing IA64 work.
	
	* *-ia64.*: Ongoing IA64 work.
	
	* *-ia64.*: Ongoing IA64 work.

	* basic.cs objects.cs: Move tests accessing static variables as well.

	* basic.cs objects.cs: Move test_0_pin_string to objects.cs.

2005-05-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (SIG_HANDLER_SIGNATURE): Fix warning.

	* driver.c: Always print failed tests.

	* mini-codegen.c: Use cfg->frame_reg instead of a macro for the
	frame pointer.

	* *ia64*: Ongoing IA64 work.

2005-05-20  Zoltan Varga  <vargaz@freemail.hu>

	* basic.cs: Add tests for add.ovf. Fix warnings.

2005-05-18  Miguel de Icaza  <miguel@novell.com>

	* driver.c (mono_main): Avoid crash if no argument is passed to
	--break;  Do not use g_error, but f_printf.   And fix all other
	ocurrences of the same crash.

2005-05-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c: Generalize the existing uses of the MONO_DEBUG env variable
	and add a new one: aborting when a SIGSEGV is raised while in unmanaged code.
	Fixes #74742.

2005-05-14  Zoltan Varga  <vargaz@freemail.hu>

	* *-ia64.*: Add beginnings of IA64 backend.

	* Makefile.am mini-arch.h mini-codegen.c: Add IA64 support.	

2005-05-13  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-long.brg: Add missing ulong->{i1, i2} checked conversions.
	Fixes #74925.

	* basic-long.cs exceptions.cs: Add new tests. Fix some warnings.

	* mini-amd64.c: Fix a warning.

2005-05-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Fix stack space leakage
	in float_neg. Fixes #74897.

	* mini-amd64.c (emit_call): Fix another near call bug.

2005-05-06  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Keep the appdomain information in the structure. Added a 
	missing "return	FALSE" for Unmanaged if FullTrust is set (or else the
	value gets overwritten).
	* declsec.h: Set the default MonoArray for the the stack to 6. Added
	an MonoAppDomain member to MonoSecurityFrame.
	* mini-exceptions.c: Do not use a glist to keep GC allocated objects
	used in the stack walk. Now use a MonoArray which grow (double) when
	it gets full.

2005-05-05  Lluis Sanchez Gual  <lluis@novell.com>

	* mini.c: Re-enabled runtime cleanup, since running threads should
	now properly stop when exiting.

2005-05-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini-codegen.c: New file contaning the arch-independent local
	register allocator. Not used by any architectures yet.

	* mini.h linear-scan.c: Merge some changes from the 
	mini-xp-local-regalloc branch.

2005-04-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (emit_call): Fix calls to native functions when the
	runtime is compiled as a shared library. Fixes #74756.

	* mini.c (mono_method_to_ir): Assert if ldsfld and friends are used
	on a literal field. Fixes #74751.

2005-04-25  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (RUNTIME): Add MONO_CFG_DIR.

2005-04-23  Zoltan Varga  <vargaz@freemail.hu>

	* objects.cs: Add missing null casting test.

2005-04-22  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (mono_find_jit_info): Fix native offset calculation
	in wrapper methods. Also rename 'address' variable to 'offset'.

2005-04-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c debug-mini.c aot.c tramp-x86.c driver.c: Fix some gcc 4.0
	warnings.
	
	* Makefile.am (MCS): Use -unsafe instead of --unsafe.

	* aot.c: Applied patch from "The Software Team" <software@solmersa.com>. Make AOT compilation
	work on windows.

Mon Apr 18 16:20:32 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: update code to handle stack traces (fixes bug #74452).

2005-04-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_emit_stack_alloc): Initialize the whole allocated area not
	just the last bytes.

2005-04-17  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Fix warning.

	* mini-exceptions.c (ves_icall_get_frame_info): Fix bug introduced
	by the _MSC_VER stuff.

2005-04-16  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-long.brg: Fix #74588.

	* cpu-amd64.md: Fix #74591.

	* iltests.il: Add new regression tests.

2005-04-13  Zoltan Varga  <vargaz@freemail.hu>

	* trace.c (mono_trace_enter_method): Print enums as an int, not as a
	valuetype.

2005-04-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (setup_stack): Unconditionally call pthread_attr_init ().

	* exceptions-x86.c mini-x86.h mini-x86.c: Applied some freebsd patches 
	from Bill Middleton <flashdict@gmail.com>.

2005-04-10  Zoltan Varga  <vargaz@freemail.hu>

	* arrays.cs: Add new regression test. Fix warnings.

2005-04-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Fix stack alignment
	and leakage in CKFINITE.

	* exceptions-amd64.c (mono_arch_get_throw_exception_by_name): Change
	this to a null op since it is called on amd64 too.

	* exceptions-amd64.c (get_throw_trampoline): Align stack.

	* exceptions-amd64.c (mono_arch_get_throw_exception_by_name): Remove
	body since this is not used on amd64.
	
	* mini-amd64.h (MONO_ARCH_NO_EMULATE_LONG_SHIFT_OPS): Remove duplicate define.

	* mini-amd64.c: Remove obsolete fixmes.

	* mini.c (print_method_from_ip): Fix debugging support.

2005-2-1  Massimiliano Mantione  <massi@ximian.com>

	* ssapre.c: Fix a subtle bug about availability, and limit SSAPRE
	so that expressions that don't give much gain are not reduced.
	* ssapre.h: Likewise.

2005-04-04  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-x86.c (mono_arch_find_jit_info): Remove last SC_EBP reference.

	* mini-x86.c (mono_emit_stack_alloc): Fix localloc under windows.

	* mini-x86.h exceptions-x86.c: Hopefully fix compilation on *BSD.

2005-04-01  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c mini-sparc.h: Add asserts when running with sigaltstack.

	* exceptions-x86.c (mono_arch_monoctx_to_sigctx): Fix cygwin build.

2005-03-31  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c: If sigaltstack support is enabled, perform win32 style
	stack touching.

	* mini.h (mono_arch_sigctx_to_monoctx): New arch-specific function.

	* mini.h (mono_arch_monoctx_to_sigctx): New arch-specific function.

	* mini.c: sigaltstack support requires MONO_ARCH_USE_SIGACTION.

	* mini-x86.h mini-x86.c exceptions-x86.c: Add support for 
	MONO_ARCH_USE_SIGACTION. Fixes #74252.

	* mini-x86.h: Enable MONO_ARCH_USE_SIGACTION on linux.

	* mini-x86.c: Fix up stack overflow handling.	

	* exceptions.cs: Add new regression test.

2005-03-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_emit_prolog): Adjust stack after calls to
	mono_jit_thread_attach.

	* mini.c (mono_method_to_ir): Verify called method is not abstract.

2005-03-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Applied Ben's patch from bug #61441 to
	avoid calling constructors using callvirt.

	* inssel.brg: Fix #74073.

2005-03-29  Sebastien Pouliot  <sebastien@ximian.com>

	* aot.c, mini.h: Added mono-compiler.h header to allow/ease 
	compilation with non-GCC compilers.
	* mini-exceptions.c, mini-x86.c|h: Patches to make compilation of mono
	possible using VS.NET. Adapted from the work of J Lothian (for VC6).

Tue Mar 29 11:43:01 CEST 2005 Paolo Molaro <lupus@ximian.com>

	* inssel.brg, arrays.cs: fix long standing 64 bit issue in access to
	klass->interface_offsets (will likely fix bug#74073).

2005-03-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_is_int_overflow): Fix rex handling.

2005-03-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Fix order of parameters
	to amd64_div_reg_size ().
	
	* mini-amd64.c (mono_arch_emit_exceptions): Emit a near call here too.

2005-03-27  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md (store_membase_reg): Fix length of storer8 opcodes.

2005-03-24  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c: Turn off automatic command line globbing under windows. Fixes #73763.

2005-03-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Remove debugging stuff left in by mistake.
	
	* mini.c (mono_precompile_assembly): Load and precompile referenced
	assemblies as well. Fixes #74015.

2005-03-23  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md (sin): Fix up maximum lengths of some opcodes.

2005-03-23  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Skip linkdemand checks for intra-corlib calls. This skips
	a lot of checks	and (anyway) permissions cannot work until corlib is 
	loaded.

Wed Mar 23 14:29:49 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixed ABI issue on sysv/ppc.

Tue Mar 22 19:03:17 CET 2005 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c, exceptions-ppc.c: added missing icache flush
	calls (fixes bug#72824).

Tue Mar 22 16:28:48 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: fix tail recursion elimination (see test in bug#73936).

2005-03-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Add inline versions of
	some fp functions in sse2 mode.

2005-03-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (emit_tls_get): Move tls handling into a separate helper function.

2005-03-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c: Add mono_get_jit_tls_key ().

	* mini-x86.c: Enable fast TLS support on windows.

2005-03-17  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Renamed aptc to allowpartiallytrustedcallers.
	* mini.c: Check for p/invoke method when generating code. If a
	p/invoke method, or it's class, isn't decorated with [Suppress
	UnmanagedCodeSecurity] then generate code to call System.Security.
	UnmanagedDemand (only if the security manager is active).

2005-03-16  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c (create_specific_trampoline): Revert parts of the 
	last change as it seems to cause strange crashes.
	
Wed Mar 16 16:24:11 CET 2005 Paolo Molaro <lupus@ximian.com>

	* *.c: handle unsafe function pointers where needed.

2005-03-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_free_method): Remove the fixme too.

2005-03-15  Miguel de Icaza  <miguel@novell.com>

	* mini.c: As discussed, make the code actually free the delegate
	thunk now, to enable the debugging of delegate problems, use
	MONO_DEBUG=1 when running Mono. 

	This takes also care of parts of the leaks as seen by Joe.

2005-03-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_setup_jit_tls_data): Enable 
	thread_tls_offset calculation.

2005-03-14  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Reworked linkdemand checks for icall. The previous code
	was using the declaration code (untrusted) and didn't work as expected
	with the CLR 2.0. We're now more compatible with 2.0 than 1.x for this
	specific case.

2005-03-13  Zoltan Varga  <vargaz@freemail.hu>

	* iltests.il: Add new localloc test.

	* mini-amd64.c: Handle large stack allocations the same way as on
	windows if stack overflow handling is working.
	
	* mini-amd64.c: Allocate the signal stack using mmap.

	* mini.c (sigsegv_signal_handler): Fix reading of context.

	* mini-exceptions.c: Fix up stack overflow handling.

	* mini-amd64.h mini-amd64.c: Fix up stack overflow handling.

	* tramp-amd64.c (create_specific_trampoline): Optimize trampoline size.

	* exceptions-amd64.c (mono_amd64_exceptions_init): Remove this.

	* mini.h mini.c tramp-*.c: Move common trampoline code to mini.c.

	* mini-x86.h mini-x86.c mini-amd64.h mini-amd64.c: Get rid of the
	tramp_init functions as they are no longer needed.

2005-03-12  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c (mono_amd64_tramp_init): Fix typo.
	
	* tramp-amd64.c (mono_amd64_tramp_init): Init AOT trampoline as well.

	* mini-amd64.h mini-amd64.c (mono_amd64_exceptions_init): Remove this.
	
	* mini.c mini-*.h: Remove OUT_OF_LINE_BBLOCK defines since all arches
	support that now.

	* mini-ops.h: Add OP_LMUL_IMM.

	* mini.c jit-icalls.cmini-amd64.h mini-amd64.c cpu-amd64.md: Implement
	long mul/div opcodes as intrinsic.

	* mini-amd64.c (emit_call): Handle the case when the callee might be
	an AOT method.

2005-03-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Reorder cases to be
	extra safe.
	
	* mini-amd64.c (mono_arch_get_vcall_slot_addr): Fix ordering of cases.

	* aot.c (mono_aot_load_method): Get rid of bogus make_writable call.

2005-03-09  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (mono_codegen): Don't leak here, to help people running
	monogrind.

2005-03-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Fix int->float 
	conversions in sse2 mode.

	* basic-float.cs: Add regression test.
	
	* mini-amd64.c: Reenable sse2.

2005-03-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c: Disable sse2 until some regressions are fixed.

2005-03-07	Joerg Rosenkranz <joergr@voelcker.com>

	* driver.c: Copyright text should include 2005.
	
2005-03-07  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md (load_membase): Fix more max lengths.

2005-03-06  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md (load_membase): Fix max length.

	* mini-ops.h: Add OP_F<xx>_MEMBASE opcodes.

	* inssel.brg: Add MONO_EMIT_BIALU_MEMBASE macro.

	* cpu-amd64.md inssel-amd64.brg mini-amd64.h mini-amd64.brg: Finish SSE2
	support and enable it by default. Also add OP_F<xxx>_MEMBASE opcodes.

	* basic-float.cs: Add rounding regression test.

	* mini-amd64.c (INST_IGNORES_CFLAGS): Add more instructions.

2005-03-04  Neale Ferguson <NealeFerguson@earthlink.net>

	* inssel-s390.brg, mini-s390.c: Add support for passing/returning small
        structures in registers for pinvoke wrappers.

2005-03-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (ves_icall_get_trace): Return wrapper info as well.

2005-03-03  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c mini-x86.c: Pass the domain of the native->managed
	wrapper to mono_jit_thread_attach.

	* mini.c (mini_jit_thread_attach): New jit icall.

	* mini-x86.c (mono_arch_emit_prolog): Attach to the VM in 
	native->managed wrappers.

	* exceptions.cs: Add new regression test.

	* mini.c (optimize_branches): Check regions in the cbranch to throw
	block case as well. Fixes #73242.

Tue Mar 1 18:35:27 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: thread safety fixes.

2005-02-27  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c (amd64_magic_trampoline): Disable the method_ptr
	patching stuff, since delegates use jump trampolines so there is
	no caller.

	* tramp-amd64.c (create_trampoline_code): Pass NULL as 'code' in 
	jump trampolines.
	
	* tramp-amd64.c: Fix build.

	* mini-x86.c tramp-x86.c: Moved get_vtable_slot_addr into mini-x86.c and rename
	it to mono_arch_.... Add get_delegate_method_ptr implementation for x86.

	* mini-amd64.h mini.h mini-amd64.c tramp-amd64.c (mono_amd64_get_vcall_slot_addr):
	Rename this to mono_arch....
	(mono_amd64_get_delegate_method_ptr_addr): Ditto.

	* mini-amd64.c (mono_amd64_get_delegate_method_ptr_addr): New helper function.

	* mini-amd64.c (emit_call): If both the caller and the callee is
	guaranteed to have 32 bit addresses, emit a normal call.

	* tramp-amd64.c: Adapt to changes in mini-amd64.c.

	* tramp-amd64.c (amd64_magic_trampoline): Remove patching of trampolines. 
	* tramp-amd64.c (amd64_magic_trampoline): Add support for patching the
	method_ptr inside delegates.

2005-02-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_free_method): Free the method info even if the native code is
	invalidated. Fixes #73001.

	* mini.c: Add a proper icall wrapper for mono_delegate_ctor.

	* mini-x86.c: Only use stdcall for pinvokes on windows.

Thu Feb 24 15:22:30 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h: make mono_lmf_addr a fast-access thread var.
	* mini-x86.c: remove unreliable __thread var offset detection,
	use the correct accessors and enable by default.

2005-02-23  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_free_method): Fix memory leak.

2005-02-22  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Allocate a GOT var for THROW and RETHROW. 

2005-02-21  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md: Fix lengths of atomic opcodes.

Mon Feb 21 16:52:20 CET 2005 Paolo Molaro <lupus@ximian.com>

	* driver.c: try to not imply using ICU is any good.

2005-02-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_get_inst_for_method): Implement more 
	functions as inline ops.

	* mini-ops.h inssel-amd64.brg cpu-amd64.md mini-amd64.c: Implement
	some Interlocked functions as inline ops.

	* mini.c (move_basic_block_to_end): Fix bug in last patch.

	* mini.h (MonoBasicBlock): Reorganize fields a bit.

	* mini-ops.h inssel.brg: Add OP_NOT_REACHED.

	* mini.c: Add support for OP_NOT_TAKEN.

	* mini-amd64.h mini-amd64.c: Add support for passing/returning small 
	structures in registers for pinvoke wrappers.

	* mini-amd64.c: Fix warnings.

2005-02-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (MonoCompile): Add 'ret_var_is_local' field.

	* mini.h mini.c (mono_arch_create_vars): Add new arch specific hook.

	* mini.c (NEW_RETLOADA): If the ret variable is a local, use its 
	address instead of loading the address from it.

	* mini-x86.c: Add support for returning small structs in registers
	on Win32. Fixes part of #70864.
	
2005-02-18  Zoltan Varga  <vargaz@freemail.hu>

	* trace.c (get_token): Improve error checking.

2005-02-17  Zoltan Varga  <vargaz@freemail.hu>

	* jit-icalls.c (mono_ldvirtfn): Explicitly check for a NULL obj here.

2005-02-17  Sebastien Pouliot  <sebastien@ximian.com> 
 
	* mini.h: Moved MONO_EXCEPTION_* enum to metadata/class-internals.h so
	it can be reused for MonoClass.
	* mini.c: Renamed MONO_EXCEPTION_SECURITY to MONO_EXCEPTION_SECURITY
	_LINKDEMAND.

2005-02-15  Sebastien Pouliot  <sebastien@ximian.com>

	* mini.c: Fixed 2 cases where I sent a MonoMethod to managed code 
	instead of a MonoReflectionMethod. The method information wasn't used
	when displaying SecurityException details (but will be now).

2005-02-15  Atsushi Enomoto  <atsushi@ximian.com>

	* Makefile.am : windows build fix.

2005-02-14  Zoltan Varga  <vargaz@freemail.hu>

	* iltests.il: Add new regression test.

	* mini.c (mono_method_to_ir): Allocate a GOT var in CEE_NEWOBJ. Fixes
	#72522.

2004-02-13  Sebastien Pouliot  <sebastien@ximian.com> 
 
	* mini.c: Moved linkdemand check into helper function check_linkdemand
	to allow reuse for all intructions (CALL, CALLVIRT, NEWOBJ, JMP, 
	LDFTN, LDVIRTFTN).

2004-02-13  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Added statistics counter for different kinds of 
	LinkDemands.
	* mini.h: Added CAS statistic counters to MonoJitStats. Removed unused
	(and commented) declaration.
	* mini.c: Added statistics counter for security Demand code 
	generation. Added display of security statistics.

2005-02-13  Zoltan Varga  <vargaz@freemail.hu>

	* declsec.c (mono_declsec_linkdemand_aptc): Applied patch from Robert Jordan (robertj@gmx.net).
	Fix compilation errors under gcc-2.95.

2005-02-12  Ben Maurer  <bmaurer@ximian.com>

	* mini.c, driver.c: Use the new jit trampoline hashtable

Fri Feb 11 18:47:11 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.c: use the managed implementation of memcpy, too.

2005-02-11  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_debug_close_method): Free the line number array.

2005-02-10  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Break up large methods into smaller ones. Share GOT slots for
	icalls.

	* mini.h: Bump AOT file format version.	

2005-02-10  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Added LinkDemand support and it's special cases for ECMA,
	APTC and P/Invoke.
	* declsec.h: Added macros to get/set lazyly initialized security 
	informations about assemblies. Added new enum for different type of
	possible LinkDemand violation. Added function to check LinkDemands.
	* mini.h: Added a field to MonoCompile to hold any security violation
	detected when JITting a method (so it can be thrown later).
	* mini.c: Added LinkDemand checks in mono_method_to_ir for CEE_CALL 
	and CEE_CALLVIRT. Added code to throw exception at the end of
	mini_method_compile (note: the exception is unhandled right now).

Thu Feb 10 15:49:44 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.c: use the managed implementation of
	memset for initobj and memset, to avoid managed <-> unmanaged
	transitions.

2005-02-10  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg (mini_emit_virtual_call): Disable the virtual->nonvirtual
	optimization if it would need a GOT var.

	* basic.cs: Add tests for constant propagation and switch statements.

	* ssa.c: Fix out-of-range constant propagation and switch statements.

2005-02-09    <vargaz@freemail.hu>

	* inssel-x86.brg (reg): Align the allocation size in the localloc(imm) case too.

2005-02-08  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md (load_membase): Fix max length of load_membase.

Tue Feb 8 18:21:11 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: update to new signature of mono_class_get_allocation_ftn().

2005-02-06  Neale Ferguson <NealeFerguson@earthlink.net>

	* cpu-s390.md,  mini-s390.c: Correct bug with register usage on certain 
	arithmetic operations.

Sun Feb 6 07:10:12 EST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: add a workaround for broken user code that
	DllImports vararg functions with non-vararg signatures.

2005-02-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_compile_method_inner): Add detection and a 
	meaningfull error message for assemblies written in Managed C++.

	* tramp-amd64.c mini-amd64.h: Add support for 
	create_trampoline_from_token ().

	* aot.c mini-x86.c abcremoval.c: Applied patch from
	Robert Jordan (robertj@gmx.net). Fix compilation errors under gcc-2.95.

2005-02-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c mini-x86.h tramp-x86.c: Add a new kind of trampoline 
	which takes a MonoImage/token as parameter instead of a MonoMethod.

	* aot.c: Use the new trampoline for initializing vtables.

	* aot.c: Add support for ldfld/stfld_remote wrappers.

	* mini-ops.h cpu-pentium.md inssel-x86.brg mini-x86.c: Add optimized
	rules for compare <MEM>, IMM.

	* mini.h (MONO_AOT_FILE_VERSION): Bump it.

	* aot.c: Handle inherited finalizers correctly.

2005-02-03  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg (stmt): Add a missing _setup_... ().

	* aot.c: Save some parts of the class state to the AOT file and use it
	to recompute that state when a class is initialized.

	* mini.c: Install AOT hooks into the runtime.

	* mini.h: Bump AOT file format version.
	
	* mini.c (mono_method_to_ir): Initialize pointer type locals correctly.
	Fixes #72148.

	* iltests.il: Add new test.

Wed Feb 2 16:53:59 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: fix typo.

Wed Feb 2 16:37:13 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: setup the statistical profiler in the thread attach
	callback to cope with the new single thread code.

Wed Feb 2 15:43:58 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: ensure we have enough room for the profiler
	calls (fixed bug#72084).

2005-02-02  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Get rid of the MonoAotMethod structure and the hashtable holding 
	it.

2005-2-1  Massimiliano Mantione  <massi@ximian.com>

	* driver.c: Re-enabled SSAPRE (two commits, I was just dumb).

2005-2-1  Massimiliano Mantione  <massi@ximian.com>

	* ssapre.c: Fixed an issue with down safety (this allows IronPython
	to succesfully execute parrotbench).
	* ssapre.h: Likewise.

2005-2-1  Massimiliano Mantione  <massi@ximian.com>

	* ssa.c: In mono_ssa_rename_vars, forced the creation of a new SSA
	variable for stores to method arguments (fixes a SSAPRE issue).

Tue Feb 1 15:52:26 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle value types in dup, fixes gen-112.cs.

Tue Feb 1 11:45:19 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md, tramp-ppc.c: use a slower code
	sequence for calls in dynamic methods to avoid thunks.

Tue Feb 1 11:44:01 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: correctly remove dynamic methods from the hashtable.

2005-1-20  Massimiliano Mantione  <massi@ximian.com>

	* driver.c: Disabled SSAPRE until fix the bug that appears
	in IronPython's parrotbench.

2005-01-31  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Get rid of Skip (other) messages.

	* mini.c (mono_method_to_ir): Revert the previous change.
	
	* mini.c (mono_method_to_ir): Do not inline ldfld and stfld wrappers
	when AOT compiling.

	* tramp-x86.c (x86_magic_trampoline): Avoid calls to 
	mono_jit_info_table_find () etc. when running under valgrind.

	* inssel.brg: Fix warnings.

	* mini-exceptions.c: Fix warnings.

2005-01-31  Martin Baulig  <martin@ximian.com>

	* driver.c (compile_all_methods_thread_main): Don't try to compile
	generic methods or anything which has type parameters.

2005-01-30  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Avoid costly calls to mono_method_full_name in tracing code and fix memory leaks.

	* TestDriver.cs: Add --verbose flags.

	* graph.c ssa.c: Fix 64 bit warnings.
	
	* abcremoval.h ssapre.h abcremoval.c ssapre.c mini.c tramp-amd64.c 
	trace.c mini-exceptions.c linear-scan.c inssel-amd64.brg inssel.brg:
	Fix 64 bit warnings.

	* mini-amd64.c (mono_arch_output_basic_block): Fix uninitialized
	variable not spotted by gcc.
	
	* mini-amd64.c inssel-amd64.brg: Applied patch from  
	Willibald Krenn <Willibald.Krenn@gmx.at>. Clean up usage of 
	X86_COMPARE_MEMBASE opcodes.

	* exceptions-amd64.c (mono_arch_find_jit_info): Fix AMD64 build.

2005-01-29  Ben Maurer  <bmaurer@ximian.com>

	* *: MonoMethod->signature might be NULL now. You *MUST* use
        mono_method_signature.

2005-01-28  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (compile_all_methods_thread_main): Compile the methods
	without invoking cctors.

Fri Jan 28 18:28:26 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: remove ben's "optimizations" to dup+stloc (bug #71905).
	* basic-calls.cs: test for the above.

2005-01-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c mini-exceptions.c aot.c exceptions-*.c: Update after 
	MonoJitInfo changes.

2005-01-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (mono_handle_exception): Compute the stack trace
	eagerly if it contains dynamic methods.
	
	* mini-exceptions.c (ves_icall_System_Exception_get_trace): New icall.

	* mini-exceptions.c (mono_handle_exception): Avoid computing the stack
	trace, it is now computed by an icall from trace_ips.
	
	* mini-exceptions.c: Fix a warning.

Thu Jan 27 13:38:34 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c: don't bother getting stack trace info if
	it's not going to be used.

2005-01-27  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (common_sources): Add ssapre-cee-ops.h and
	ssapre-mini-ops.h.

2005-01-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (remove_block_if_useless): Only print debug stuff with -v -v.

	* aot.c: Avoid calling mono_method_get_header () if not needed.

	* mini.h: Bump AOT file format version.
	
	* mini.c (mono_emit_native_call): Allocate a GOT var here.

	* mini.c (mono_print_tree): Print more info for calls.

2005-01-26  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.h: Remove warning by adding missing include for marshal.h

2005-01-26  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_UNBOX_ANY, don't increase
	`ip' twice.

2005-01-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_call_opcode): Add missing MONO_SSA_LOAD/STORE
	flags.

	* ssa.c (mono_ssa_compute): Fix crashes when using AOT.

	* aot.c (mono_compile_assembly): Fix a warning.

2005-01-25  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Look for security attributes on the original MonoMethod 
	(and not the wrapped one). This fix permissions on icalls.

2005-01-23  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_allocate_vars): Use mono_allocate_stack_slots ().

	* mini.c (mono_allocate_stack_slots): Add a fixme.

	* mini-x86.c (mono_arch_allocate_vars): Use mono_allocate_stack_slots ().

Sun Jan 23 16:16:48 CET 2005 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: optimize casts of sealed types (more
	optimizations waiting for fixes in remoting).

2005-01-23  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg (stmt): Add another dummy rule.

	* driver.c: Fix warnings.

	* driver.c (mono_main): If running under valgrind, instruct glib to use
	the system allocation functions so valgrind can track the memory
	allocated by the g_... functions.

	* inssel.brg (stmt): Add DUMMY rule for OP_DUMMY_STORE.

	* mini-ops.h: Add OP_DUMMY_STORE opcode.

	* mini.h (MONO_BBLOCK_IS_IN_REGION): New helper macro.

	* liveness.c: Handle OP_DUMMY_STORE. Enable register allocation for
	variables in try regions.

	* mini.c (mini_method_compile): Don't disable optimizations on large
	methods when AOT compiling.

	* mini.c (mono_allocate_stack_slots): New arch independent method to 
	allocate stack slots. Not yet used.

2005-01-22  Ben Maurer  <bmaurer@ximian.com>

	* debug-mini.c (mono_debug_close_method): Plug some leaks.

Sat Jan 22 13:41:51 EST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: make the branch info relative as the code
	buffer can be reallocated.

2005-01-22  Sebastien Pouliot  <sebastien@ximian.com>

	* aot.c: Allow decoding of the new  MONO_PATCH_INFO_DECLSEC.
	* driver.c: Removed the AOT/security restriction. Now initialize the
	security manager (in metadata) if --security is used.
	* mini.c|h: Add the MONO_PATCH_INFO_DECLSEC code to use the index,
	rather than the pointer to declarative security, when AOT is used.

Sat Jan 22 09:35:19 EST 2005 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-ppc.h, mini-ppc.c: updated to use out of line
	basic blocks, reduced intrinsic exception throwing code size.

2005-01-22  Miguel de Icaza  <miguel@ximian.com>

	* driver.c (mini_usage): Reorder the usage screen.

2005-01-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_resolve_patch_target): Fix warning.

2005-01-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_local_regalloc): Fix bug introduced by
	previous patch.

	* mini-amd64.c (mono_arch_local_regalloc): Ditto.	

	* mini-amd64.c (mono_arch_local_regalloc): Revert last patch as it
	breaks the amd64 build.

	* mini-x86.c (mono_arch_local_regalloc): Fix bug in div/rem 
	register allocation. Fixes #71454.

	* mini-amd64.c (mono_arch_local_regalloc): Ditto.	

	* arrays.cs: Add new regression test.	

2005-1-20  Massimiliano Mantione  <massi@ximian.com>

	* ssapre.c: Turned usage of snprintf to GString.
	* ssapre.h: disabled MONO_APPLY_SSAPRE_TO_SINGLE_METHOD
	(I left it on by mistake in my previous commit).

Thu Jan 20 12:00:45 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c, cfold.c, basic-calls.cs: preserve side effects
	on cond branch optimization (fixes bug# 71515).

2005-1-20  Massimiliano Mantione  <massi@ximian.com>

	* abcremoval.c: Fixed bug 71062.
	* abcremoval.h: Likewise.

2005-1-20  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: Added a new functionality to optimize_branches, the removal
	of useless basic blocks, and fixed some problem in the removal of
	critical edges; some utility functions added for both purposes.
	* ssapre.c: Added complex expression support, and fixed bug 70637.
	* ssapre.h: Likewise.
	* ssapre-cee-ops.h: Added file with list of "CEE_*" opcodes
	enabled in SSAPRE.
	* ssapre-mini-ops.h: Likewise, but for "OP_*" opcodes.
	* driver.c: Re-enabled SSAPRE.

2005-01-19  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): Call mono_get_inflated_method() on
	the result of mono_get_method_constrained().

2005-01-18  Neale Ferguson <NealeFerguson@earthlink.net>

	* exceptions-s390.c tramp-s390.c: Allocate code using the global code
	manager.

2005-01-18  Geoff Norton  <gnorton@customerdna.com>

	* jit-icalls.c (mono_llmult_ovf): Fix other overflow conditions to
	be detected.  Fixes #59296.

2005-01-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Remove some assertions
	which can happen. Fixes #71361.

2005-01-18  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-sparc.c tramp-sparc.c: Allocate code using the global code
	manager.

2005-01-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_create_jump_trampoline): Revert last change as it causes
	appdomain-unload.exe to fail.
	
	* mini.c: Fix some memory leaks.

Mon Jan 17 16:16:23 CET 2005 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: handle the new size of rank, idepth, max_interface_id.
	Fixed bug and sped up some codepaths.

2005-01-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Fix some memory leaks.

	* exceptions.cs basic-long.cs: Add test for checked ulong->int 
	conversion.

	* inssel-long.brg: Implement long_conv_to_ovf_i4_un. Fixes #71319.

	* inssel-long.brg: Fix conv.ovf.i8 when run on an int32. Fixes
	#71320.

	* iltests.il: Add regression test for #71320.

2005-01-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_codegen): Fix installation of profiler hooks.

	* mini-sparc.c mini-amd64.c: Don't allocate stack space for dead vars.

Sun Jan 16 12:19:35 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, cfold.c: optimize access to enum
	readonly fields, too. Eval conditional branches if possible
	to perform unreachable code removal in more cases.

2005-01-15  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c exceptions-amd64.c: Use the new global code manager.

	* mini.c (mono_global_codeman_reserve): New function to allocate code memory from a global
	code manager.

	* tramp-x86.c mini-x86.c exceptions-x86.c: Allocate all code memory so mono works with
	WinXP DEP. Fixes #71244.

2005-01-14  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg: Allways convert CEE_CONV_OVF_I4 to a move on 64 bit platforms. Fixes #71236.

2005-01-13  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_output_basic_block): Fix OP_ATOMIC_ADD_NEW_I4.

2005-01-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c exceptions-ppc.c aot.c: Cope with MonoJitInfo 
	changes.

	* mini.h: Bump AOT version.

	* mini.h (MonoCompile): Change exvar to a hash table.

	* mini.c: Allocate a separate exvar for each handler block.

	* mini.c: Get rid of the computation of filter_lengths, its not needed.

	* mini.c inssel.brg: Change OP_THROW_OR_NULL to compare the current
	ex var with the pending exception and only throw if the two are equal.
	Fixes #68552.
	
	* exceptions.cs: Add tests for rethrow and nested catch clauses.

	* mini-x86.c: Fix warnings.

	* Makefile.am (common_sources): Move mini-exceptions.c here as it is
	used by all the ports now.

	* aot.c: Add write-symbols and save-temps options.

2005-01-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c: Add support for returning structs in registers from pinvoke functions on WIN32.

Mon Jan 10 16:11:16 EST 2005 Neale Ferguson <nealeferguson@earthlink.net>

	* mini-ops.h, inssel-s390.brg, cpu-s390.md: Support OP_ATOMIC__xxx 
	operations.

	* tramp-s390.c: Check vtable slot belongs to the domain.

	* mini-exceptions.c, exceptions-s390.c: Standardize exception handling
	as per other platforms.

	* mini-s390.c, mini-s390.h: Enable out-of-line bblock support.

Mon Jan 10 18:53:05 CET 2005 Paolo Molaro <lupus@ximian.com>

	* driver.c: we don't run the Main() code in a subthread anymore.

Mon Jan 10 17:54:16 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: added experimental rtc support in the statistical
	profiler: if the user has the permission, more accurate statistics
	are gathered. Run with: MONO_RTC=4096 mono --profiler=default:stat ....
	The MONO_RTC value must be restricted to what the linux rtc allows:
	power of two from 64 to 8192 Hz.

2005-01-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_emit_exceptions): Fix #71121.

Mon Jan 10 05:20:49 EST 2005 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: better icache flush for smp.

2005-01-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (emit_move_return_value): Fix memory leak.

	* mini-x86.c (get_call_info): Add the get_call_info () code from the
	amd64 port, not yet used.

2005-01-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Disable inlining of ldfld wrappers with
	a struct type.

2005-01-07  Sebastien Pouliot  <sebastien@ximian.com>

	* driver.c: Added --security option to activate the security manager.
	Right now this will allow code generation for declarative demands and
	is disabled when AOT is specified.
	* mini.c: Add code generation for declarative security demands.
	* mini.h: Add mono_use_security_manager as an extern gboolean.

2005-01-07  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Speed up compilation a bit by
	emitting more dense assembly code.

	* mini-sparc.c mini-sparc.h exceptions-sparc.c: Enable optimized corlib
	exception throwing stuff.

2005-01-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_emit_exceptions): Fix typo in previous patch. Remove
	dead code.

	* mini-amd64.c (mono_arch_emit_exceptions): Remove duplicate epilog stuff
	left in by mistake.

	* driver.c (EXCLUDED_FROM_ALL): Disable SSAPRE until bug #70637 is 
	fixed.

	* mini-sparc.h mini-sparc.c: Enable out-of-line bblock support.

	* tramp-*.c: Only patch vtable slots if the object is in the current
	domain. Fixes appdomain-unload.exe.

	* mini-amd64.c mini-amd64.h: Enable out-of-line bblock support.
	
	* mini-amd64.c (mono_arch_local_regalloc): Port regalloc fix from
	x86 branch.

2005-01-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (reverse_branch_op): New helper function.

	* mini.c (optimize_branches): Run the new optimization only on 
	platforms which support it. Also reverse all kinds of branches.

	* mini.h (MonoBasicBlock): Add 'out_of_line' field.

	* mini.c (mono_method_to_ir): Set 'out_of_line' for bblocks which have
	a throw statement.

	* mini.c (optimize_branches): Reverse not-equals branches if the false
	bblock is a throw. This happens a lot of time with argument checking in
	corlib.

	* mini.c (mono_codegen): Add support for placing basic blocks after
	the function epilogue.

	* mini-x86.c mini-x86.h: Add support for placing basic blocks after the
	function epilogue.
	
2005-01-05  Miguel de Icaza  <miguel@ximian.com>

	* mini.c (setup_stat_profiler): Only set this up if the platform
	supports ITIMER_PROF.

2005-01-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_local_regalloc): Fix a bug introduced by the
	previous patch.

	* inssel.brg: Fix a warning.

Wed Jan 5 16:40:18 CET 2005 Paolo Molaro <lupus@ximian.com>

	* mini.c: added support for statistical profiler 
	(run with: --profile=default:stat).

2005-01-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.h (MONO_ARCH_ENABLE_EMIT_STATE_OPT): Enable this on x86.

	* mini-x86.c cpu-pentium.md: More fixes for usage of global registers.

	* mini-amd64.c (mono_arch_local_regalloc): Port some regalloc fixes 
	related to global registers from the amd64 port.

2005-01-03  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Handle MONO_CLASSCONST.

	* mini-amd64.c (mono_arch_local_regalloc): Fix some regalloc problems
	with global registers.
	(mono_arch_output_basic_block): Fix SWITCH in the AOT case.

	* aot.c (emit_method_code): Fix the 'method emitted as' messages.

2004-12-31  Zoltan Varga  <vargaz@freemail.hu>

	* debug-mini.c (encode_value): Fix off-by-one.

	* aot.c (encode_value): Likewise.

	* mini.c (mono_method_to_ir): Disable AOT for methods containing LDPTR.

2004-12-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c linear-scan.c: Add a workaround for the mcs crash when using 
	AOT.

	* aot.c (mono_aot_load_method): Free up patch info if no longer needed.
	
	* aot.c (emit_method_info): Increase size of temp buffer.

	* mini-x86.c cpu-pentium.md mini.c: Load fp constants differently in 
	the AOT case.

2004-12-28  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (emit_method_info): Fix build.
	
	* aot.c: Further rework of the AOT file format to reduce the size of
	the method info data.

	* mini.h: Bump AOT file format version.

2004-12-27  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_get_method): New static method; call
	mono_get_method_full() and mono_get_inflated_method().
	(mono_method_to_ir): Use mini_get_method() instead of
	mono_get_method_full().	

2004-12-26  Patrik Torstensson  <patrik.torstensson@gmail.com>

	* mini-x86.c (atomic ops): fixed bug interlocked bug #70784. 

2004-12-25  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg (ldind_to_load_membase): Handle CEE_LDIND_I8.

	* inssel-amd64.brg: Add some optimization rules.

2004-12-24  Ben Maurer  <bmaurer@ximian.com>

	* aot.c: Remove the use of MonoGHashTable and other GC stuff. The
	standard not GC'd stuff is fine.

2004-12-24  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Rework the AOT file format to get rid of most of the global
	symbols. This reduces the size of the mscorlib.dll.so by 1MB.

	* mini.h: Bump AOT file format version.
	
2004-12-23  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h: Bump AOT file format version.

	* aot.c (mono_aot_is_got_entry): New function to determine if an 
	address is inside a GOT.

	* aot.c mini-x86.c tramp-x86.c: Make all patches use the GOT.

	* cpu-pentium.md: Increase the maximum size of some instructions which
	might involve a got access.
	
	* mini.c (get_method_from_ip): Another debug helper function.

	* mini.c: Call mono_get_got_var () in a couple places. Handle the case
	when got var accesses are created during the decompose phase.

	* mini-sparc.c: Change mono_compile_aot to cfg->compile_aot.

	* mini.h mini.c mini-x86.c aot.c mini-sparc.c: Add a 'compile_corlib'
	argument mini_compile_method and to MonoCompile, and use this to
	determine whenever a given method is compiled for AOT. This allows the
	other methods compiled during AOT compilation to be free of AOT stuff,
	so the backends does not need to add special support for them by
	creating a fake GOT etc.

	* mini-x86.c (mono_arch_patch_code): Remove fake got stuff as it is no
	longer needed.

2004-12-21  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (mono_method_to_ir): It turns out that some of the
	x-appdomain wrappers are lax with types, so just ignore this for
	all wrappers.

	* inssel.brg (OP_CHECK_ARRAY_TYPE): Optimize this by only looking
	at the vtable->klass. If it is non-shared code we can just use the
	vtable.

Tue Dec 21 17:43:06 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: access MonoDomain from tls, too.

2004-12-21  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c: Removed unused variable (and related warning ;-)

2004-12-21  Ben Maurer  <bmaurer@ximian.com>

	* iltests.il: New test for LDELEMA on an array of ref types.

	* mini.c (CEE_LDELEMA): We need to emit OP_CHECK_ARRAY_TYPE for
	all ldelema's on reftypes.
	(check_call_signature): Remove the OP_CHECK_ARRAY_TYPE from here,
	it was the wrong place to put it.

	* mini-x86.c (mono_arch_output_basic_block): Just use ecx as the
	register to pop to make this cleaner, at the request of Paolo.

2004-12-20  Ben Maurer  <bmaurer@ximian.com>

	* mini-ops.h (OP_GETHASHCODE): New op.

	* inssel.brg (OP_GETHASHCODE): Emit code for the new opcode

	* mini.c (mini_get_inst_for_method): Create the intrinsic hash
	operation.

	For a microbenchmark, this reduces the cost of Hashtable.get_Item
	by 25%.
	
	* mini-x86.c (mono_arch_output_basic_block): Rather than

	add ebp, 4

	Emit

	pop edx

	The first is 3 bytes while the second is 1. This saves 36 kb on
	mscorlib, quite a big saving. When bootstraping mcs, I was able to
	see a small boost because of icache locality.

	* cfold.c (FOLD_BINOPCOMM): Kill add foo, 0

Mon Dec 20 12:19:40 EST 2004 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, mini-ppc.h, mini-exceptions.c, exceptions-ppc.c:
	started code sharing with the generic code.

Mon Dec 20 11:08:06 EST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: added code for direct access to
	tls data slots.

Mon Dec 20 10:58:28 EST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, inssel-x86.brg, cpu-amd64.md, inssel.brg, inssel-amd64.brg,
	 mini-amd64.c, mini-x86.c, cpu-pentium.md: renamed OP_X86_TLS_GET
	to OP_TLS_GET.

2004-12-20  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c|h: Added functions to cache the declarative stack modifiers
	in MonoJitInfo and to create a security frame from a MonoJitInfo 
	structure.
	* mini.c: Initialize jinfo->cas_inited to FALSE when MonoJitInfo is
	created. Register internal calls for System.Security.SecurityFrame::
	_GetSecurityFrame and _GetSecurityStack.
	* mini.h: Added definition for new icalls (in mini-exceptions.c) and
	the definitions for the new stack walk/callback mechanism.
	* mini-exceptions.c: Added internal call GetSecurityFrame (to get the 
	first security frame for LinkDemands and InheritanceDemands) and
	GetSecurityStack for Demands. Both use the new mono_walk_stack code
	from lupus.
	* mini-x86.h, mini-amd64.h, mini-sparc.h: Architecture specific stack
	walk initialization (lupus).

2004-12-20  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_DUP, handle the dup / stloc
	idiom.
	(handle_loaded_temps): Do not create a temporary variable for
	things that we know are temps. They will never be modified.
	(mono_spill_call): Set MONO_INST_IS_TEMP
	(mono_emulate_opcode): ditto
	(emit_tree): ditto
	(mono_method_to_ir.CEE_DUP): ditto

2004-12-19  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (type_to_eval_stack_type): Make this handle the void type
	(mono_emit_call_args): set the call->type with type_to_eval_stack_type
	(emit_tree): use ip_in_bb to special case some common idioms
	Update all callers to pass in the IP.
	(mono_method_to_ir): Make CEE_CALL* do the above as well.

	This gives us a nice 2% speedup in mcs bootstrap.

	* mini-x86.c (peephole_pass): Peephole pass to make
	mov  [foo], eax
	push [foo]

	into

	mov [foo], eax
	push eax

	* mini.c (ip_in_bb): new method.
	(mono_method_to_ir): use this method rather than doing the hash
	lookup ourselves.

	* linear-scan.c (mono_linear_scan): When expiring actives, you
	don't need to keep around variables that expire on this
	instruction. This makes it so that:
	     a = b + 1
	will turn into:
	     store (ebx add (ebx, 1))
	which will become
	     add ebx, 1

2004-12-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Optimize the common ldobj+stloc 
	combination to avoid doing two copies. Fix up problems with previous
	patch.

	* mini.c: Fix 64 bit warnings.

	* mini-x86.c (INST_IGNORES_CFLAGS): Add OP_STOREI4_MEMBASE_REG.

2004-12-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.h mini-amd64.c exceptions-amd64.c: Port exception handling
	changes from the x86 code.

	* mini.h: Add prototype for mono_arch_get_throw_corlib_exception ().

2004-12-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_emit_epilog): Optimize the corlib exception
	throwing code to reduce its size, unify the AOT and non-aot code and 
	get rid of relocations in the AOT case.

	* mini-x86.h mini.c exceptions-x86.c 
	(mono_arch_get_throw_corlib_exception): New arch specific function to 
	raise corlib exceptions which doesn't require relocations in the 
	caller.

	* aot.c (emit_method): Handle PATCH_INFO_NONE as well.

2004-12-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_emit_method_call): Only allocate the got var when it is
	needed.

	* mini-x86.c (mono_arch_patch_code): Add missing PATCH_INFO_METHOD_REL
	in the AOT case.

2004-12-14  Patrik Torstensson  <patrik.torstensson@gmail.com>

	* mini-x86.c, cpu-pentium.md, inssel-x86.brg: Fixed bug
	with add function when used from Inc/dec atomic 
	functions. Re-enabled optimization on x86.
	* mini-ops.h: renamed atomic_add functions to
	allow _add to match the Interlocked::Add and
	_add_next to match Interlocked::Inc/Dec.

2004-12-15  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: Fixed a subtle bug in mono_method_to_ir, about the
	linking of BBs to the end BB, and enabled SSAPRE also with
	consprop and copyprop (which was prevented by that bug).

2004-12-14  Patrik Torstensson  <patrik.torstensson@gmail.com>

	* mini-x86.c: disabling the Interlocked optimizing code. 

2004-12-14  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (load_aot_module): Move reading of got_addr after the AOT
	file version check.
	
2004-12-14  Patrik Torstensson  <patrik.torstensson@gmail.com>

	* mini-x86.c, inssel-x86.brg, cpu-pentium.md: removed _imm 
	interlocked optimization due lack of support on x86, rewrote 
	exchange to take into account that base may be in eax.
	
	xsp works again; activated Interlocked optimizing code.
	
2004-12-14  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (MONO_AOT_FILE_VERSION): Bump AOT file version.

2004-12-13  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ops.h: Add new opcodes.

	* mini.h: Add new patch types. Add got_var to MonoCompile.

	* mini.h mini-x86.c mini-amd64.c aot.c: Rename 
	mono_arch_get_aot_patch_offset () to mono_arch_get_patch_offset () and
	make it work with all kinds of patchable code.

	* inssel.brg inssel-x86.brg: Add new rules dealing with computing the
	address of the GOT, and referencing entries in the GOT.

	* mini.c: Add code to load the GOT address if needed by an opcode.

	* aot.c mini-x86.h mini-x86.c cpu-pentium.md: Add support for position 
	independent AOT code on the x86 using an elf-style Global Offset Table.

2004-12-14  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (RUNTIME): Set MONO_SHARED_DIR.

2004-12-13 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini-x86.c: disabling the Interlocked optimizing code. It segfaults
	when running xsp.

2004-12-13  Patrik Torstensson  <patrik.torstensson@gmail.com>

	* mini-x86.c,mini-ops.h,inssel-x86.brg,cpu-pentium.md: Implementation
	of Interlocked:Increment/Decrement/Add as inline ops.
	(mini-x86.c (mono_arch_get_inst_for_method and mono_arch_output_basic_block))

2004-12-12  Geoff Norton  <gnorton@customerdna.com>

	* exceptions-ppc.c: Reorder code so gcc3.4 can compile it
	* mini-ppc.c: Unify mono_arch_patch_code with changes in r37636.

2004-12-12  Duncan Mak  <duncan@ximian.com>

	* mini-ppc.c (mono_arch_patch_code): Hopefully made this build
	again. `patch_info->table_size' is no longer valid after Zoltan's
	commit #37636.

2004-12-12  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): Only call mono_debug_init_method()
	if we are the "real" method, ie. not an inlined method inside it.

2004-12-11  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (CEE_LDSFLD): Make sure that the vtable has been init'd
	before we look in the special fields table. This fixes
	../tests/thread-static-init.cs.

2004-12-11 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: return immediately after setting OP_ARRAY_RANK or CEE_LDLEN
	for Array get_Rank and get_Length. Fixes bug #70465.

2004-12-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c aot.c: Put the bblock table for a SWITCH patch into a
	separate structure to reduce the size of MonoJumpInfo.

Fri Dec 10 18:09:22 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, aot.c, driver.c: allow disabling the aot code.

2004-12-10  Patrik Torstensson  <patrik.torstensson@gmail.com>

	* mini.c (mini_get_inst_for_method): Changed to allow ports
	to return a MonoInst instead of opcode 
	(renamed mini_get_opcode_for_method to better reflect the new functionality)
	
	* mini-[x86|s390|s390x|ppc|sparc].c (mono_arch_get_inst_for_method): 
	Allow ports to return a created MonoInst instead of op-code, will enable
	new optimizations.
	(renamed mini_get_opcode_for_method to better reflected the functionality)

2004-12-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (NEW_AOTCONST): Share some code between the different NEW_AOTCONST macros.

2004-12-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c jit-icalls.c: Pass generic_context to mono_ldtoken_wrapper.
	Fixes #69985.

2004-12-08  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_CALLVIRT, use `fsig->signature'
	if we're a CEE_CONSTRAINED call.  Fixes gen-118.cs.

2004-12-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_output_basic_block): Implement OP_FCONV_TO_<X>
	correctly.

	* exceptions.cs: Disable some tests which depend on properties of x86 fp
	arithmetic.

2004-12-08  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (CLEANFILES): Add *.exe, *.dll.

2004-12-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_output_basic_block): Fix LOCALLOC_IMM
	bug introduced by the previous patch.

Tue Dec 7 11:44:39 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, objectc.cs: handle large structs passed by value
	(fixes bug #69972).

Tue Dec 7 10:43:31 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: OP_ARGLIST implementation from
	Geoff Norton  <gnorton@customerdna.com>.

Tue Dec 7 10:14:25 CET 2004 Paolo Molaro <lupus@ximian.com>

	* inssel-x86.brg, inssel-ppc.brg: fix reference to register
	in stmt: OP_OUTARG_VT (reg) (should fix bug #69785).

Tue Dec 7 10:06:39 CET 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: avoid calling ppc_patch in exception trampolines.

2004-12-01  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* inssel-s390.brgi, mini-ops.h, mini-s390.c : Add stubs for support of tls offset
	support.

2004-12-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c: Zero out localled-ed memory.

	* iltests.il: Add tests for zeroing out localloc-ed memory.

2004-12-04  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_CALLVIRT, use the new
	mono_method_get_signature_full().	

2004-12-03  Massimiliano Mantione  <massi@ximian.com>

	* mini.c: Added removal of critical edges (prerequisite for SSAPRE),
	and some utility functions (always for SSAPRE), integrated SSAPRE.
	* mini.h: Likewise.
	* driver.c: Added ssapre option.
	* ssa.c: Small fix on OP_ARG handling.
	* ssapre.c, ssapre.h: Added files containing SSAPRE implementation.
	* Makefile.am: Likewise.

2004-12-02  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-x86.c (mono_arch_create_jit_trampoline): Remove code which is
	now in the xp code.

	* mini.c (mini_init): Register mono_thread_force_interruption_checkpoint
	icall.

2004-12-01  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* inssel-s390.brg : Add OP_OUTARG_VT (OP_REFANYTYPE (reg)) rule.
	
	* cpu-s390.md : Increase instruction length of oparglist.

	* mini-s390.c : Implement vararg and TYPEDEBYREF support.

2004-11-30  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_CALLVIRT, added support for
	virtual generic methods.  We call a special helper_compile_generic_method()
	icall to retrieve the method from the vtable, inflate and compile
	it and then do a CEE_CALLI.  Thanks a lot to Paolo for this idea.

	* jit-icalls.c (helper_compile_generic_method): New JIT icall.

2004-11-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c: Fix up vararg corner cases. Fixes #70019.

2004-11-29  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-sparc.md mini-sparc.c (long_conv_to_ovf_i): Fill missing delay slot.
	Fixes #69929.

2004-11-27  Ben Maurer  <bmaurer@ximian.com>

	* inssel.brg (CEE_SWITCH): The AOT stuff Zoltan added is only for
	platforms with PIC aot.

2004-11-28  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_DUP, added handle_stobj().
	Fixes gen-112.cs.

2004-11-28  Martin Baulig  <martin@ximian.com>

	* mini-x86.c (mono_arch_call_opcode): Use the original type, not
	the result of mono_type_get_underlying_type() to check whether
	we're byref.

2004-11-26  Martin Baulig  <martin@ximian.com>

	* mini.c
	(mono_method_to_ir): Use `!method->signature->has_type_parameters'
	in the g_assert().

2004-11-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_emit_this_vret_args): Handle this and vret
	the same way as the other arguments so they won't get clobbered.

	* mini-amd64.c (mono_arch_output_basic_block): Avoid doing virtual 
	calls through R11 since it is clobbered by the trampoline code.

2004-11-26  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am: Consistently use $(RUNTIME) rather than ./mono to
	pick up in-tree mscorlib.dll.

2004-11-25  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Rename MonoAOTModule->cleanup to out_of_date.

	* mini-amd64.c aot.c: Switch to PIC relative AOT code. References to 
	runtime data/code are now stored in a table similar to the GOT in ELF. 
	This allows the code itself to be position independent.

	* aot.c: Fix loading of referenced assemblies after the lazy assembly
	loading changes.

	* aot.c: Attach ELF type (object/function) directives to all global
	symbols.

	* tramp-amd64.c (amd64_magic_trampoline): Patch RIP relative calls too.

	* inssel.brg (SWITCH): Emit an AOT_CONST in the aot case.

	* mini-amd64.h: Turn on PIC AOT code.

	* mini.h (mono_arch_get_aot_patch_offset): New arch specific function
	returning the offset within an OP_AOTCONST instruction where the GOT
	offset needs to be added.

	* mini.h: Bump AOT file format version.

2004-11-25  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): In CEE_CALL, don't allow calling any
	uninflated generic methods.

2004-11-25  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): Don't allow any uninflated generic methods.

2004-11-24  Martin Baulig  <martin@ximian.com>

	* minit.c (type_to_eval_stack_type): Set `inst->klass' to the
	original klass (this only applies for generic instances).

2004-11-24  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): Use `STACK_OBJ' instead of
	`ldind_type [CEE_LDIND_REF]' (which would be beyond the end of
	that array).

2004-11-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Disable inlining for methods containing
	localloc. Fixes #69678.

	* iltests.il (test_0_localloc_inline): Add regression test for #69678.
	
2004-11-23  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Set %al to the number of
	used SSE registers on pinvoke calls. Fixes #69774.

2004-11-23  Geoff Norton  <gnorton@customerdna.com>

	* inssel-ppc.brg, mini-ppc.c: Use mono_class_from_mono_type instead of
	vt->inst_vtype->data.klass.  This fixes generic structs and bug #69766

2004-11-23  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (MCS,ILASM): Don't refer to runtime/ directory.
	Refer directly to the mcs/ tree.

2004-11-19  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* mini-s390.c, tramp-s390.c, mini-s390.h: Add LMF processing for trampolines.
	Check if a trampoline for a synchronized method is required. 

Fri Nov 19 17:34:21 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: set to zero the memory allocated
	with localloc if needed. Throe arithmetric exception in
	div an rem if needed. Implement ovf checks in OP_LCONV_TO_OVF_I.
	Adapted from a patch by Geoff Norton  <gnorton@customerdna.com>.

2004-11-19  Geoff Norton  <gnorton@customerdna.com>

	* mini-ppc.c: Call mono_type_get_underlying_type to unwrap generic
	types before switching on type.  Fixes #69622.

2004-11-19  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (check-local): New.  Integrate into 'make check'.
	(MCS,RUNTIME): Define using in-tree mono and mcs.
	(ILASM): New.
	(%.exe): Use $(ILASM).

Fri Nov 19 14:54:07 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: adjust initial prolog size (bug #69691).

2004-11-18  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-pentium.md (localloc): Increase max instruction len. Fixes
	#69664.

2004-11-17  Raja R Harinath  <rharinath@novell.com>

	* Makefile.am (clean-local): Rename from 'clean'.

2004-11-15  Nelae Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* mini.c, mini-x86.c, mini-amd64.c, exceptions-s390.c: Add siginfo_t parameter
	to mono_arch_is_int_overflow. 
	* exceptions-s390.c: Add mono_arch_is_int_overflow routine to discern between
	SIGFPE events.

2004-11-15  Sebastien Pouliot  <sebastien@ximian.com>

	* declsec.c|h: New files to support declarative security attributes.
	Added function to check if a method has (applicable) security.
	* mini.c|h: Add check for declarative security attributes in
	mono_method_check_inlining.
	* Makefile.am: Added declsec.c and declsec.h to the build.

Mon Nov 15 11:53:46 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h: update to keep dynamic code info per-domain.

2004-11-12  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c mini-*.h: Get rid of MONO_ARCH_HAVE_RETHROW since all architectures support it now.
	(mini_init): Get rid of it from here too.

Thu Nov 11 20:17:17 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-ppc,h, cpu-g5.md, exceptions-ppc.c:
	implemented OP_RETHROW (patch by Geoff Norton
	<gnorton@customerdna.com>).

2004-11-10  Geoff Norton  <gnorton@customerdna.com>

	* tramp-ppc.c (ppc_magic_trampoline): Don't trampoline methods
	between appdomains.  Fixes appdomain-unload on PPC.

2004-10-26  Lluis Sanchez Gual  <lluis@novell.com>

	* exceptions-ppc.c, exceptions-s390.c, exceptions-s390x.c,
	mini-exceptions.c: handle the new wrapper types.
	* mini.c: The CEE_ISINST and CEE_CASTCLASS opcodes now take the
	token value as a MonoClass* when compiling a wrapper.
	mono_jit_create_remoting_trampoline now takes an additional
	MonoRemotingTarget parameter.
	
2004-11-10  Martin Baulig  <martin@localhost>

	* mini.c (mono_method_to_ir): Use `generic_container->context'
	rather than creating a new one.

2004-11-09  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* exceptions-s390.c, mini-s390, cpu-s390.md: Add support for OP_RETHROW.

	* inssel-390.md, mini-s390.c: Correct register allocation for globals.

2004-11-09  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_init): Add MONO_AOT_CACHE env variable to turn on
	the experimental aot cache stuff.

Tue Nov 9 17:30:20 CET 2004 Paolo Molaro <lupus@ximian.com>

	* aot.c, mini.c, exceptions-ppc.c, exceptions-s390.c, exceptions-s390x.c,
	mini-exceptions.c: update to exception clause structure changes.

2004-11-08  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-x86.c (throw_exception): Fix warnings.

	* mini-x86.h mini-x86.c cpu-pentium.md exceptions-x86.c: Add support 
	for OP_RETHROW.

2004-11-08  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-sparc.c (get_throw_exception): Really fix this.

2004-11-07  Ben Maurer  <bmaurer@ximian.com>

	* tramp-*.c: we no longer support icalls without wrappers, so
	a bit of code can be removed here

2004-11-07  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-sparc.c (get_throw_exception): Fix more bugs in previous
	patch.

	* cpu-sparc.md: Add op_rethrow.

	* exceptions-sparc.c (get_throw_exception): Fix bug in previous patch.

	* mini-sparc.h mini-sparc.c exceptions-sparc.c: Add support for OP_RETHROW.

	* mini.h: Add mono_arch_get_rethrow_exception () arch specific function.
	* mini-ops.h: Add OP_RETHROW.

	* mini.c inssel.brg: Distinguish between THROW and RETHROW.

	* cpu-amd64.c mini-amd64.c exceptions-amd64.c: Add support for OP_RETHROW.

2004-11-05  Geoff Norton  <gnorton@customerdna.com>
	
	* helpers.c: Change otool arguments from -V -v -t to -v -t on Darwin
	Makes the output much easier to read

2004-11-05  Ben Maurer  <bmaurer@ximian.com>

	* ssa.c: allocate MonoMethodVar.uses from the mempool. First, this
	prevents another huge leak when compiling with ssa. Secondly, the
	performance of doing this rather than freeing the lists is much
	better. GList does a lock every time you allocate a list link,
	so that it can use a memory pool. So, it is better to just use
	a memory pool of our own.
	
	* ssa.c, linear-scan.c: replace g_list_remove_link with
	g_list_delete.  The remove one does not free the GList, so we were
	leaking memory. On -O=all --compile-all with corlib, this cut down
	3 MB of allocations.

2004-11-05  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-sparc.c (mono_arch_create_jit_trampoline): Fix sparc build.

	* tramp-amd64.c (mono_arch_create_jit_trampoline): Fix amd64 build.

	* mini.h mini.c tramp-*.c: Moved xp parts of JIT trampoline creation
	into a new function mono_create_jit_trampoline ().

2004-11-02  Zoltan Varga  <vargaz@freemail.hu>

	* trace.c (get_spec): Allow tracing of classes without a namespace.

2004-11-02  Sebastien Pouliot  <sebastien@ximian.com>

	* mini.c: Fix pointer overwrite in mini_method_compile.

2004-11-2  Geoff Norton  <gnorton@customerdna.com>

	* inssel-ppc.brg (OP_OUTARG_VT (CEE_LDOBJ (base))):
	The darwin ABI needs some special handling for 1 and 2 byte structs
	Lets use lbz/lhz instead of lwz everywhere.
	* mini-ppc.c (calculate_sizes):  The Darwin ABI needs from special handling
	for 1 and 2 byte structs and struct which are size >= 3 || size % 4 != 0.
	Use stb/sth for the former, and put the latter always on stack instead of in
	argument registers.

2004-10-30  Zoltan Varga  <vargaz@freemail.hu>

	* trace.c (is_filenamechar): Add '_'.

2004-10-29  Neale Ferguson  <Neale.Ferguson@SoftwareAG-usa.com>

	* mini-s390.c: Fix prolog length to allow for large trace requirements.

	* exceptions-s390.c: Remove dwarf unwinding stuff that was unused.

2004-10-29  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am (libgc_libs): Do some automake magic so libmono/mono
	depends on libmonogc. Fixes #68805.

2004-10-26  Miguel de Icaza  <miguel@ximian.com>

	* mini.c (mono_jit_free_method): Provide extra information for
	this error.  Currently this leaks, but will be turned into a
	developer option in the future.

2004-10-26  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (mono_main): Applied patch from Willibald Krenn <willibald.krenn@gmx.at>. Make --graph work for icalls and pinvoke methods.

2004-10-25  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_load_method): Align PATCH_INFO_R8 on an 8 byte 
	boundary. Fixes reading of PATCH_INFO_R4 and R8.
	(mono_aot_load_method): Do not allocate MonoAotMethod in the GC heap.

2004-10-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_patch_code): Fix patching of class init
	trampolines for AOT code.

2004-10-22    <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Disable AOT for methods containing calls to methods of
	constructed types. Fixes #68136.

2004-10-21  Martin Baulig  <martin@ximian.com>

	* exceptions-x86.c (throw_exception): Call mono_debugger_throw_exception();
	if it returns true, unwind the stack to the call instruction.

2004-10-21    <vargaz@freemail.hu>

	* aot.c: Reorganize the AOT file format to avoid relocations. Fix warnings.

	* mini.h: Bump AOT version number.

	* objects.cs: Add another test for unbox trampolines.

	* tramp-amd64.c (amd64_magic_trampoline): Disable patching of trampolines for 
	valuetype methods.

2004-10-20    <vargaz@freemail.hu>

	* driver.c: Add SHARED to the set of optimizations tested.

	* tramp-amd64.c (amd64_magic_trampoline): Patch trampoline code as well.

	* mini.c (mono_method_to_ir): Mark the domainvar as volatile when it is implicitly
	used by CEE_NEWARR.

	* ssa.c (mono_ssa_deadce): Do not optimize away accesses to volatile variables.

2004-10-20  Martin Baulig  <martin@ximian.com>

	* mini-exceptions.c (mono_handle_exception): Call
	mono_debugger_handle_exception() to tell the debugger about
	catch/finally clauses.

2004-10-18  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-amd64.c (mono_arch_find_jit_info): Pop arguments of the stack.

	* mini-amd64.c (mono_amd64_get_vcall_slot_addr): Handle extended registers. Fixes
	#68447.

2004-10-15  Geoff Norton  <gnorton@customerdna.com>

	* mini-ppc.c (calculate_sizes): Marshal valuetypes for pinvoke
	methods as their native size, fixed bug #57543, #57545.
	* mini-ppc.c (mono_arch_output_basic_block): Use mulli for imm16 types
	This saves a temporary register and mullw call down into 1 (minor perf
	increase for cases like sum = sum * 5;  This use to translate into:
	    li r11,5
	    mullw r28,r28,r11
	It now translates to
	    mulli r28,r28,5

2004-10-15  Zoltan Varga  <vargaz@freemail.hu>

	* trace.c (mono_trace_eval): Use mono_method_desc_full_match. Fixes
	#68388.

2004-10-11  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): If we're a generic method, get the
	MonoGenericContainer from our MonoMethodNormal and create a
	MonoGenericContext from it.

2004-10-08  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-long32.brg (OP_LCONV_TO_OVF_I2): Fix CONV_I1 -> CONV_I2.

	* basic-long.cs: Add test for checked i8->i2 cast.

Wed Oct 6 12:40:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* inssel-ppc.brg: added a couple of speedup rules.

2004-10-05  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am (genmdesc_LDADD): Don't link this against libmetadata
	to speed up rebuilds.

2004-10-04  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* mini-s390.c: Minor fix to OP_OR_IMM.

2004-10-03  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-sparc.c (sparc_magic_trampoline): Handle appdomain stuff
	better. Fixes appdomain-unload.exe on sparc.

2004-10-02  Massimiliano Mantione  <massi@ximian.com>

	* ssa.c: Fixed casts to unsigned where the value was of 64 bits in
	simulate_long_compare, patch by will@exomi.com (Ville-Pertti Keinonen),
	see bug 67324.

2004-10-02  Zoltan Varga  <vargaz@freemail.hu>

	* jit-icalls.c: Handle a nonexisting trunc function more correctly.

2004-09-30  Lluis Sanchez Gual  <lluis@novell.com>

	* mini.c: Always generate a field read/write wrapper for members
	of the class MarshalByRefObject since the actual instance could
	be a CBO.

2004-09-28  Lluis Sanchez Gual  <lluis@novell.com>

	* mini.c: Use mono_thread_exit() to stop threads, instead of ExitThread.

2004-09-28  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c mini.h trace.c: Move the setting of the main assembly into
	a separate function called mono_trace_set_assembly () and call it after
	actually loading the main assembly. Fixes #66872.

2004-09-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.h mini-amd64.c tramp-amd64.c: Allocate trampoline memory
	using the code manager.

2004-09-24  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c mini-amd64.h: Add support for MONO_ARCH_HAVE_INVALIDATE_METHOD.

2004-09-23  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md: Fix bug in previous patch.
	
	* cpu-amd64.md: Fix instruction lengths of membase opcodes. Fixes
	#66650.

Wed Sep 22 19:03:20 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.h, exceptions-ppc.c, exceptions-s390.c, exceptions-s390x.c,
	mini-exceptions.c: updates for changed stack walk interface.

2004-09-21  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* mini-s390.c, cpu-s390.md: Minor changes to OP_ARGLIST handling

2004-09-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Fix LDSTR in dynamic methods. Fixes #66132.

2004-09-13  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (mini_regression_list): Do not call mono_assembly_close 
	since assemblies can't be unloaded.
	
2004-09-11  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-amd64.md: Fix more instruction lengths.

	* cpu-amd64.md: Fix lengths of some instructions.

2004-09-11 Ben Maurer  <bmaurer@users.sourceforge.net>

	* inssel.brg: Make the array ldelema check aot friendly.

2004-09-11  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_get_argument_info): Fix stack_unwind test.

	* cpu-amd64.md inssel-long.brg inssel-amd64.brg: Small optimizations.

2004-09-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c: Fix build.

	* mini-sparc.c mini-x86.c mini-amd64.c: Use the new 
	mono_type_get_underlying_type () helper function to simplify code.
	
2004-09-09  Martin Baulig  <martin@ximian.com>

	* mini-amd64.c: Don't access `type->data.klass' directly, call
	mono_class_from_mono_type() instead since the type may be a
	generic instance.

2004-09-09  Martin Baulig  <martin@ximian.com>

	* mini-amd64.c (get_call_info): Fix support for generic instances.
	(add_valuetype): Use mono_class_from_mono_type() to get the class
	since we can be a generic instance.

Thu Sep 9 01:43:53 PDT 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini.h, regalloc.c, regalloc.h: powerpc speedups.

2004-09-07 Ben Maurer  <bmaurer@users.sourceforge.net>

	* liveness.c: reset spill costs on each scan: bug 62107

2004-09-07  Bernie Solomon  <bernard@ugsolutions.com>

	* exceptions-sparc.c (mono_arch_find_jit_info): remove
	unnecessary line that doesn't compile

2004-09-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c mini.h mini-x86.h tramp-x86.c: Instead of freeing delegate
	trampolines, make them call an error function so people can fix their
	code.

2004-09-06  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): When initializing locals, handle a
	generic instances like a valuetype if it's a valuetype and like a
	class if it's a class.

2004-09-06  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-x86.c (mono_arch_find_jit_info): Pop arguments off the
	stack. Fixes #64674.

	* exceptions.cs: Add test for unwinding of call arguments.

Mon Sep 6 05:50:02 PDT 2004 Paolo Molaro <lupus@ximian.com>

	* mini-*.c, mini-ops.h, inssel-long32.brg: introduced
	OP_ADDCC_IMM and OP_SUBCC_IMM (add/sub immediate that will
	set the carry/borrow flag). The sparc and s390 implementations
	can now use optimized versions (and simplify the code). ppc bugfixes.

2004-09-06  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-ppc.c (mono_arch_find_jit_info): Fix memory leak.

2004-09-05  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-amd64.brg: Remove leftover 32 bit rule.

	* mini-amd64.c (mono_arch_instrument_prolog): Fix tracing support.

2004-09-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (mono_find_jit_info): Refactor common code from
	mono_arch_find_jit_info functions into a new function. Fix a memory
	leak.

	* exceptions-x86.c exceptions-amd64.c exceptions-sparc.c: Remove
	refactored code.
	
2004-09-02  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs inssel-long32.brg: Handle the OP_LCONV_TO_OVF_I2 case
	as well.
	
	* exceptions.cs: Add array size tests.

	* mini.c: Allocate a separate icall wrapper for each arity of 
	mono_array_new_va. Fixes #59509.

	* exceptions.cs: Add testcase for 64578.

	* inssel-long32.brg: Fix OP_LCONV_TO_OVF_I1 rule. Fixes #64578.

	* trace.c (is_filenamechar): Allow 0..9 in strings. Fixes #65094.
	
2004-09-02  Martin Baulig  <martin@ximian.com>

	* mini.c (mono_method_to_ir): When initializing the locals, call
	handle_initobj() on the generic instance itself, not its
	underlying type.

2004-09-02  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (MonoJitDynamicMethodInfo): New structure, extension of 
	MonoJitInfo for dynamic methods.

	* mini.c: Rename trampoline_hash_mutex to jit_mutex.

	* mini.c: Add support for freeing JIT data for dynamic methods.
	
2004-09-01  Martin Baulig  <martin@ximian.com>

	* mini-x86.c (is_regsize_var): Added support for generic
	instances.
	(mono_arch_emit_prolog): Make this compile again, use
	`x86_push_imm_template (code)'.

2004-08-30 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini-x86.c: make all push_imm instructions that get
	patched always emit the long form

2004-08-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_create_jump_trampoline): Store the jump trampolines 
	in a per-domain hash.

	* mini-amd64.c (merge_argument_class_from_type): Handle generic
	types.

2004-08-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c cpu-amd64.md inssel-amd64.brg mini-amd64.h: Ongoing SSE
	work.
	
	* mini-amd64.c cpu-amd64.md inssel-amd64.brg mini-amd64.h: More SSE
	work.

	* mini-amd64.c cpu-amd64.md: Implement checked int<->uint casts.
	Beginnings of SSE2 support.

	* exceptions.cs: Add more tests for checked int<->uint casts.

2004-08-28  Martin Baulig  <martin@ximian.com>

	* mini-x86.c (mono_arch_instrument_epilog): Added support for
	generic instances.

	* mini.c
	(mono_type_to_ldind, mono_type_to_stind, type_to_eval_stack_type):
	Handle generic instances recursively.

2004-08-27 Ben Maurer  <bmaurer@users.sourceforge.net>

	* iltests.il: test for conv.u8 on a constant

2004-08-27 Ben Maurer  <bmaurer@users.sourceforge.net>

	* inssel-long32.brg: c&p rules for LCONV_x4 (membase) and
	LCONV_x4 (shrun_32 (membase)).

2004-08-27 Ben Maurer  <bmaurer@users.sourceforge.net>

	* inssel-x86.brg: c&p rules for push/setret of long

2004-08-26 Ben Maurer  <bmaurer@users.sourceforge.net>

	* inssel-x86.brg: c&p rules for compare (base, regvar) and
	compare (regvar, base)

	* inssel-x86.brg: more burg love

	* inssel.brg: more cleanup

	* inssel-x86.brg, inssel-long32.brg: burg cleanup.

2004-08-26 Ben Maurer  <bmaurer@users.sourceforge.net>

	* basic-long.cs, basic-calls.cs: new tests for optimization.

2004-08-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (read_tls_offset_from_method): Fix typo in previous
	patch.

2004-08-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (read_tls_offset_from_method): Add another case.
	
2004-08-25  Bernie Solomon  <bernard@ugsolutions.com>

	* inssel.brg (mini_emit_memcpy): use 
	NO_UNALIGNED_ACCESS to disable memcpy optimization

2004-08-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c: Handle generic types in various places.

	* mini.c (mono_method_to_ir): Handle generic types in init locals.

2004-08-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (handle_box): Fix warning.

	* mini-amd64.c (mono_arch_local_regalloc): Fix regalloc problem.

	* mini-amd64.h: Enable the emit_state optimization.

	* mini-ops.h cpu-amd64.md: Add new amd64_test_null opcode.

	* mini-amd64.c: Add some new 64 bit peephole opts.

	* inssel.brg (mini_emit_memcpy): Optimize for 64 bit architectures.

	* cpu-amd64.md: sreg1 of div instructions must be %rax.

	* mini-amd64.c: Register allocator fixes.

	* mini.c: Add an optimization to emit_state to avoid allocation of new
	registers on some platforms.

2004-08-23  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-x86.brg inssel-amd64: Add yet another missing tree->dreg assignment.

	* mini-x86.c (mono_arch_local_regalloc): Fix bug in long register
	allocation. Fixes #63085.

	* basic-long.cs: Add new regression test.

	* mini-amd64.c: Register allocator improvements.

2004-08-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (read_tls_offset_from_method): Add another code
	sequence.

	* tramp-amd64.c (amd64_class_init_trampoline): Use a more efficient
	instruction sequence for nullifying class init trampolines.

	* objects.cs: Add new regalloc test.

	* mini-amd64.c inssel-amd64.brg: Optimize parameter passing.

2004-08-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_call_opcode): Refactor this a little.
	
	* mini-amd64.c (mono_arch_regalloc_cost): Adjust regalloc costs for
	arguments.

	* driver.c: Fix profiling after TLS changes.
	
	* driver.c (mono_main): Set mono_stats.enabled if needed.

	* mini.c (handle_alloc): New helper function used by CEE_NEWOBJ and
	CEE_BOX.

2004-08-20 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini-x86.c: use a 1 op rather than a 2 op tls access
	instruction -> faster.

2004-08-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c inssel-amd64.brg cpu-amd64.md: Merge changes from
	x86 backend.

2004-08-19 Bernie Solomon <bernard@ugsolutions.com>

	* exceptions-sparc.c (throw_exception): fix typo

2004-08-19 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini-x86.c, cpu-pentium.md, inssel-x86.brg:
	set tree->dreg correctly with tls. Allow any
	register to be used.

	* mini-x86.c (read_tls_offset_from_method): add new code
	generation pattern seen with GCC.


Thu Aug 19 17:26:55 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-exceptions.c, exceptions-x86.c, exceptions-amd64.c,
	exceptions-ppc.c, exceptions-s390.c, exceptions-s390x.c,
	exceptions-sparc.c: fix some performance issues in exception
	handling and setting of the stack trace for exceptions that were
	already thrown.

2004-08-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c inssel-amd64.brg cpu-amd64.md: Merge changes from 
	x86 backend.
	
	* mini-amd64.c (mono_arch_is_int_overflow): Handle all possible 
	registers.

2004-08-18 Ben Maurer  <bmaurer@users.sourceforge.net>

	This patch inlines tls access, when possible.
	
	* mini.h: new arch functions for TLS intrinsics.
	All platforms updated with a stub.

	* mini.c: use the new intrinsics

	* mini-x86.c, cpu-pentium.md, inssel-x86.brg, mini-ops.h:
	arch specific intrinsic for tls variables

2004-08-18  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am (libmono_la_LDFLAGS): Enable creating of libmono dll
	under windows.

2004-08-17 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini.c: thread local allocation

2004-08-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.h (MONO_ARCH_NO_EMULATE_LONG_SHIFT_OPS): Enable.

	* Makefile.am: Link against the static version of libmonogc.
	
	* Makefile.am: Link the static versions of the convenience libraries
	into the mono executable.

	* mini-x86.h mini-x86.c: Throw the correct exception on integer overflow.

2004-08-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c mini-amd64.h mini-amd64.c: Throw the correct exception
	on integer overflow.

	* mini-amd64.c: Reorganize function call code.

	* mini-amd64.c (peephole_pass): Merge changes from mini-x86.c.

2004-08-14 Ben Maurer  <bmaurer@ximian.com>

	* inssel-x86.brg: use xor eax,eax.
	
	* basic.cs: new tests

2004-08-14  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_emit_epilog): Use RIP relative addressing
	in exception throwing code.
	
2004-08-14 Ben Maurer  <bmaurer@ximian.com>

	* inssel-x86.brg: use xor esi,esi.

2004-08-14  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (mono_main): Call mono_trace_parse_options earlier so it
	can trace methods compiled during mini_init () too.

	* cpu-amd64.md mini-amd64.c (mono_arch_output_basic_block): Handle 
	CEE_CONV_U4.

2004-08-14 Ben Maurer  <bmaurer@ximian.com>

	* Makefile.am: static link on x86 (r=zoltan)

2004-08-14  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-amd64.c (amd64_magic_trampoline): Avoid patching the trampoline
	code since it causes some programs to fail.

2004-08-12  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (bb_is_loop_start): Merge changes from mini-x86.c.

2004-08-11  Bernie Solomon <bernard@ugsolutions.com>

	* mini.c: ovfops_op_map - add STACK_OBJ case for
	CONV_I 
	* basic.cs: add test_0_pin_string as test
	case for above.

2004-08-11  Bernie Solomon <bernard@ugsolutions.com>

	* Makefile.am: build C# if srcdir != builddir

Tue Aug 10 19:23:47 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* dominators.c, mini.h, mini-x86.c: fix loop alignment with
	fall-through blocks.

Tue Aug 10 16:18:22 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* driver.c: enable loop by default again and include abcrem in -O=all.

2004-08-08  Zoltan Varga  <vargaz@freemail.hu>

	* iltests.il: Add some localloc tests.

	* mini.c (mono_method_to_ir): Set stack type of LOCALLOC correctly.

	* inssel-amd64.brg inssel-x86.brg: Set dreg of LOCALLOC correctly. 
	Fixes #62574.

	* inssel-amd64.brg: Add some optimizations.

	* mini-amd64.c (mono_arch_setup_jit_tls_data): Add tls offset detection
	for gcc-3.4.

	* Makefile.am: Statically link mono against libmono on AMD64.
	
	* mini-amd64.c inssel-amd64.brg: Optimizations.

2004-08-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_emit_prolog): Optimize lmf saving a bit.

	* tramp-amd64.c: Patch calling code in trampolines.

2004-08-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c: pinvoke struct passing fixes.

2004-08-05  Bernie Solomon  <bernard@ugsolutions.com>

	* mini-sparc.c: redo change, make mono_arch_cpu_init call
	mono_arch_cpu_optimizazions so sparcv9 is initialized when embedded

2004-08-05  Duncan Mak  <duncan@ximian.com>

	* mini.c: Renamed CEE_STELEM to CEE_STELEM_ANY and CEE_LDELEM to
	CEE_LDELEM_ANY.

2004-08-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (emit_move_return_value): Move return value for normal
	calls too.

2004-08-05  Martin Baulig  <martin@ximian.com>

	* mini.c (ret_type_to_call_opcode): Don't use a `t' variable for
	`type->type'; just modify `type' itself when dealing with enums
	and generic instances.
	(check_call_signature): Make `simple_type' a `MonoType *'.

2004-08-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Use OP_PADD to add offsets to addresses.

	* mini-amd64.h: Disable SIGSEGV_ON_ALTSTACK.

2004-08-04  Bernie Solomon  <bernard@ugsolutions.com>

	* mini-sparc.c (mono_arch_emit_epilog): fix check
	for folding last op into restore instruction

2004-08-05  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-amd64.c (mono_arch_get_throw_exception_by_name): Allocate
	helper methods using the code manager.
	
	* exceptions-amd64.c (mono_arch_get_throw_exception): Fix maximum length.

	* mini-amd64.c (mono_arch_allocate_vars): Fix tls offset detection.

Tue Aug 3 23:50:00 EST 2004 Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>
	
	* mini-s390x.c mini-s390x.h tramp-s390x.c inssel-s390x.brg
	  cpu-s390x.md exceptions-s390x.c Makefile.am: S/390 64-bit JIT

	* mini-s390.c: fix tail processing

Tue Aug 3 01:35:44 PDT 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: mul.ovf.un exception name fix.

2004-08-03  Martin Baulig  <martin@ximian.com>

	* mini-x86.c (mono_arch_call_opcode): Correctly handle generic
	instances; before jumping to `handle_enum', also modify `ptype'.

2004-08-02  Bernie Solomon  <bernard@ugsolutions.com>

	* cpu-sparc.md: fcall maximal length too small.

2004-08-02  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c mini.h: Add initial support for passing/returning 
	structures to/from pinvoked methods.

Mon Aug 2 11:59:35 PDT 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: reg allocator fix.

2004-07-31  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c (mono_arch_output_basic_block): Fix OP_X86_PUSH_OBJ.

	* inssel.brg: Optimize memset on 64 bit machines.

	* mini-amd64.c: Fix some vararg cases.

2004-07-30  Neale Ferguson <Neale.Ferguson@SoftwareAG-usa.com>

	* mini-s390.c: Corrected macro in emit_float_to_int

	* s390-abi.cs: Tests to exercise the s390 ABI

2004-07-30  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-amd64.c (mono_arch_find_jit_info): Fix restoring of
	caller saved regs.

	* basic.cs: Add a test for add.ovf.un.

2004-07-30  Bernie Solomon  <bernard@ugsolutions.com>

	* mini-sparc.c: add case for OP_IDIV_UN

2004-07-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini-amd64.c mini-amd64.h mini.c: Add support for vararg pinvoke calls.
	
	* mini-amd64.c cpu-amd64.md: Ongoing JIT work.

2004-07-30  Ben Maurer  <bmaurer@ximian.com>

	* basic.cs: regression tests.

	* inssel-x86.brg: Disable cmp BYTE PTR [eax], imm, it causes various
	regressions.

2004-07-30  Zoltan Varga  <vargaz@freemail.hu>

	* basic.cs: Add a new test.

	* mini-amd64.c aot.c cpu-amd64.md: Add support for tracing, profiling 
	and AOT. Various fixes and optimizations.

	* inssel.brg (CALL_REG): Add 64 bit versions of call_reg rules.

Fri Jul 30 15:49:26 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: make sure temp regs are not used for global reg
	allocation.

2004-07-29  Bernie Solomon  <bernard@ugsolutions.com>

	* cpu-sparc.md: conv_i8 fix for 64bits

	* mini-sparc.c: add cases for OP_IXXX codes for 64bits

2004-07-29  Ben Maurer  <bmaurer@ximian.com>
	
	* cpu-pentium.md, mini-x86.c, inssel-x86.brg, mini-ops.h:
	add opcode for cmp BYTE PTR [eax], imm.

	* inssel.brg: Make memcpy and memset takes bases.

2004-07-28  Zoltan Varga  <vargaz@freemail.hu>

	* *-amd64.*: More AMD64 work.
	
2004-07-28  Ben Maurer  <bmaurer@ximian.com>

	* cpu-pentium.md, inssel-x86.brg, mini-ops.h, mini-x86.c:
	add a compare-not-equal opcode.
	
2004-07-28  Lluis Sanchez Gual  <lluis@novell.com>

	* mini.c: Use mono_init_from_assembly instead of mono_init.
	
2004-07-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Fix opcode mapping for STACK_MP on 64 bit platforms.

	* mini.c (CEE_NEWOBJ): Call mono_array_new_va using the correct signature.

	* mini.c: Use MONO_ARCH_SIGACTION on AMD64 as well.

	* inssel.brg: 64 bit fixes.

	* mini.h (MonoCallInst): Add some AMD64 specific data.

	* mini.h: Add some OP_P opcodes.

2004-07-28  Ben Maurer  <bmaurer@ximian.com>

	* basic.cs: tests for 61797 and 61740

Tue Jul 27 16:05:19 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-sparc.c, mini-s390.c: keep track of line
	numbers in the debug info (spotted by Geoff Norton, <gnorton@customerdna.com>).

2004-07-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_output_basic_block): Add CEE_CONV_U8/I8.

	* *-amd64*.*: Ongoing AMD64 work.

2004-07-23 Zoltan Varga <vargaz@freemail.hu>

	* inssel-long.brg: Implement CONV_I8/CONV_U8 in the backends.

	* *-amd64*: Ongoing AMD64 work.

	* mini-arch.h: Add AMD64 support.

	* mini-sparc.c (mono_arch_is_inst_imm): New arch dependent function.

	* mini.h: Add new arch dependent function mono_arch_is_inst_imm.

	* mini-ops.h: Add new opcodes.

	* Makefile.am: Add AMD64 support.

	* inssel.brg inssel-long32.brg inssel-long.brg: Move mul/div and shift
	rules into the inssel-long*.brg files.

	* *-amd64.*: Add beginnings of AMD64 backend.

2004-07-22  Ben Maurer  <bmaurer@ximian.com>

	* mini.c (print_dfn): commenting out the code that prints
	the cil. With -O=deadce, this makes -v -v crash.
	
	* cpu-pentium.md: make checkthis have a length of 2

2004-04-21  Bernie Solomon  <bernard@ugsolutions.com>

	* mini-sparc.h: fix implementations of __builtin
	functions for Sun compiler for V9.

2004-07-16  Ben Maurer  <bmaurer@ximain.com>

	* mini.c: use the new stelem.ref wrapper
	* exceptions.cs, arrays.cs: new stelem.ref tests

Wed Jul 14 19:08:41 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, exceptions-ppc.c: cleanups and fixes (the
	new XSP should work with these changes).

2004-07-14  Ben Maurer  <bmaurer@ximain.com>
	
	* inssel-{long32,x86,}.brg: trivial optimizations.
	
Mon Jul 12 20:25:57 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: load value when emitting box operation in
	constrained calls.

2004-07-12  Ben Maurer  <bmaurer@ximian.com>

	* mini-x86.c (OP_CHECK_THIS): cmp DWORD PTR [eax], eax
	is one byte shorter than cmp DWORD PTR [eax], 0.

Mon Jul 12 17:47:00 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* inssel-ppc.brg: arguments on the stack are always
	relative to the stack pointer (spotted by Neale Ferguson).

2004-07-11 Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* exceptions-x86.c: delay appending the method name to the trace until
	after mono_jit_info_table_find is called, as this gets the real
	MonoMethod.

2004-07-09  Ben Maurer  <bmaurer@ximian.com>

	* aot.c: register roots

2004-07-09  Atsushi Enomoto  <atsushi@ximian.com>

	* aot.c : I could just use PLATFORM_WIN32 flag.

2004-07-09  Atsushi Enomoto  <atsushi@ximian.com>

	* aot.c : Reverting the previous fix. This time it broke linux build.

2004-07-09  Atsushi Enomoto  <atsushi@ximian.com>

	* aot.c : quick cygwin build fix. mkdir() with two args does not exist.

2004-07-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (handle_stack_args): Remove some more debugging code.
	
	* mini.c (handle_stack_args): Remove debug output left in by mistake.

	* driver.c mini.h aot.c: Allow additional options to be specified with
	--aot and pass them to mono_compile_assembly.

	* aot.c: Add experimental code to AOT compile all loaded assemblies
	on demand and save the code into a cache in the filesystem.

	* aot.c: Add support for more wrapper methods.
	
	* mini.c (handle_stack_args): Handle some corner cases. Fixes 
	58863.

	* cpu-*.md: Remove removed opcodes.

	* mini.h mini.c: Move JIT icall handling to icall.c. Replace usage of
	CEE_MONO_PROC<x> with CEE_MONO_ICALL. Move registration of marshalling
	related icalls to marshal.c.

2004-07-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ops.h: Add OP_SAVE_LMF and OP_RESTORE_LMF.

	* Makefile.am (EXTRA_DIST): Add inssel-long[32].brg.

	* inssel.brg: Fix warning. Add rules for SAVE_LMF and RESTORE_LMF.

2004-07-06  Ben Maurer  <bmaurer@ximian.com>
	* liveness.c: If liveness is recomputated we need to reset the information
	for each variable. This way, if the liveness range has been narrowed
	by optimizations that happened after the last computation, we can return
	a smaller range.
	
	For example, if you have
	
	{
		int i = 0;
		
		// Tons of code that does not affect i
		
		i = foo ();
		...
	}
	
	i = 0 is dead code and will be removed by SSA. However, when
	linear scan gets to the code, i will still appear to be live
	throughout the entire block. This prevents good register allocation.

2004-07-06  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_debug_init_method): Allow
	MONO_WRAPPER_MANAGED_TO_NATIVE wrappers.
	(mono_debug_add_icall_wrapper): New method.

	* mini.c (mono_icall_get_wrapper): Call mono_debug_add_icall_wrapper().

2004-07-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (optimize_branches): Fix linking of bblocks in branch->branch
	optimization.

2004-07-03  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_load_method): Fix loading of debug info.

2004-07-02  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Add logging support.

2004-07-01  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h: Add prototype for mono_print_method_from_ip.

	* mini.c: 64 bit fixes. Use LCOMPARE for comparing longs.

	* inssel.brg: 64 bit fixes.

	* inssel.brg inssel-long32.brg: Move 32 bit arithmetic rules to 
	inssel-long32.brg.

	* Makefile.am: Add SPARC64 support.

2004-07-02  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c: Fix alignment problems on 32 bit platforms.

2004-07-01  Zoltan Varga  <vargaz@freemail.hu>

	* helpers.c (mono_disassemble_code): Pass -xarch=v9 to assembler on
	SPARC64.

	* aot.c: Add SPARC64 support. Reorganize patch table to fix alignment
	problems.

	* mini.h: Bump AOT file version. Some 64 bit fixes.

2004-06-30  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-sparc.brg: Add new rule to avoid register moves.

	* inssel.brg: Add ldind_to_load_membase helper function.

2004-06-30  Ben Maurer  <bmaurer@ximian.com>

	* mini.c: OffsetToStringData intrinsic.
	
2004-06-30  Zoltan Varga  <vargaz@freemail.hu>

	* ssa.c: Handle OP_LCOMPARE the same as OP_COMPARE.

	* objects.cs exceptions.cs basic.cs basic-long.cs basic-calls.cs: New
	regression tests.

	* mini-ops.h cpu-sparc.md mini-sparc.h mini-sparc.c exceptions-sparc.c tramp-sparc.c inssel-long.brg: Add SPARC64 support.
Mon Jun 28 18:05:09 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: reinstated mono_compile_get_interface_var()
	on x86, too, since the change breaks the Gtk# build there as well.

Fri Jun 25 17:36:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* driver.c: remove loop from the default optimizations: it seems to
	interact badly with some of the other options (see bug #60613).

2004-06-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c mini-x86.h mini-x86.c: Applied patch from Guenter Feldmann 
	(fld@informatik.uni-bremen.de): Add Solaris x86 support.

Tue Jun 22 21:29:11 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: small updates to be able to compile
	vararg-using methods.

2004-06-21  Martin Baulig  <martin@ximian.com>

	* mini/mini-exceptions.c
	(mono_handle_exception): Added `gpointer original_ip' argument.
	After calling mono_unhandled_exception(), call
	mono_debugger_unhandled_exception() and if that returns true,
	restore the context and return.

Mon Jun 21 19:26:40 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: prefer the use of relative branches so
	they won't need to be patched in aot code (patch from Patrick Beard).

Mon Jun 21 19:03:18 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* aot.c: patch from Patrick Beard to make the output assembly
	more correct for the MacOSX assembler. Small tweak to
	generate sane images on Linux/PPC, too.

Fri Jun 18 18:24:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, mini-ppc.c: handle varargs methods with a special
	case until bug #59509 is fixed (shows up in #60332).

Tue Jun 15 16:36:51 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: make sure the needed wrappers are compiled, too, with
	precomp.

Mon Jun 14 18:36:08 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* driver.c: remove NPTL reference in --version output.

Sun Jun 13 17:25:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* aot.c: patch from Patrick Beard (pcbeard@mac.com) to
	generate valid assembly for the Mach-O assembler.

Sun Jun 13 15:59:38 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* driver.c: don't include abcrem in the all optimization specifier
	since it slows down jit compilation too much for now.

2004-06-12 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini.c: use BIGMUL only if both operands have the same signage.
	* iltests.il: Test for bug 60056. (errors related to signage in
	BIGMUL).

	r=lupus.

Thu Jun 10 16:06:42 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c, aot.c: memory leak fixes.

Tue Jun 8 16:37:15 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg: implemented a few missing ulong cast opcodes.

Tue Jun 8 15:36:30 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: remove the -static hack completely, it links in
	statically glib as well.

Sat Jun 5 16:32:33 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* iltests.il, mini.c: fixed bug#59580 in branch optimization.
	* exceptions.cs: make it compile with new mcs/csc.

2004-06-03 Massimiliano Mantione <massi@ximian.com>
	* cpu-pentium.md basic-float.cs Fixed bug on fpu spills (see bug 54467),
	and added relevant test case.

Mon May 31 19:41:46 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c revert Zoltan's fix to bug#58863 on ppc, since it causes
	regressions in gtk-sharp.

2004-05-29  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs: New regression tests.

	* jit-icalls.c (mono_llmult_ovf): Fix some boundary conditions.

Sat May 29 10:45:58 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: emit castclass/isinst in their own trees (bug #54209/59057).

2004-05-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.h (MONO_ARCH_NEED_DIV_CHECK): Define this.

	* cpu-sparc.md mini-sparc.c: Add overflow detection to div opcodes.

2004-05-28	Patrik Torstensson <totte@hiddenpeaks.com>

	* mini.c (mono_jit_runtime_invoke): Init class in this
	method instead of trusting mono_jit_compile_method to
	do the work (because wrappers can be in object class)

2004-05-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_output_basic_block): Fix sub.imm.

	* basic-long.cs: New regression test.

Thu May 27 15:50:52 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md, mini-ppc.c: fixes to long add/sub ovf opcodes
	and div/rem checks.

Thu May 27 12:36:53 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: fix miguel's change to build mono statically against
	libmono (track build dependencies).

2004-05-26  Zoltan Varga  <vargaz@freemail.hu>

	* cfold.c: Some glib versions do not have G_MININT32.

2004-05-26  Massimiliano Mantione  <massi@ximian.com>

	* mini-x86.c cpu-pentium.md Makefile.am basic-math.cs: Fixed problem
	with precision of tan, atan, sin and cos, and implemented related
	regressions tests (fixes bug 54467, but one new problem appeared and
	is not fixed yet).

2004-05-26  Zoltan Varga  <vargaz@freemail.hu>

	* cfold.c (FOLD_BINOPZ): Avoid division by zero.

	* exceptions.cs: Add test for constant folding && division by zero.

	* driver.c mini.h mini.c mini-x86.c: Revert most of the previous patch
	since driver.c is in libmono too, so the optimization was useless.

	* driver.c mini.h mini.c mini-x86.c: Moved the mono_lmf_addr TLS 
	variable to driver.c so the compiler can emit more efficient code to
	access them.

2004-05-26  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* Makefile.am: don't distribute generated inssel.[ch] files.

2004-05-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_compile_method_with_opt): Really emit icall wrappers
	into the default appdomain. Fixes #58707.

	* jit-icalls.c: Remove the broken approximation for truncl, doing
	no conversion is better.

	* mini.c (handle_stack_args): Avoid reusing variables for stack slots.
	Fixes #58863.

Tue May 25 14:33:56 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini-ppc.c, cpu-g4.md, inssel-ppc.brg: eliminate the use
	of the mcrxr instruction which is not available on some processors
	even if it's documented to be. Implement add and sub overflow correctly
	(still not complete for long unsigned). Speed up icalls a bit.

2004-05-25 13:01 CET Patrik Torstenson <totte@hiddenpeaks.com>

	* mini.c (mono_jit_compile_method_with_opt): Make sure that
	we run .cctor in the current domain instead of target_domain.
	
	Fixes bug #58558, .cctor not being called in -O=shared.

Tue May 25 12:46:50 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, jit-icalls.c: added explicit checks for divide by zero.

2004-05-24 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini-x86.c (EMIT_COND_BRANCH): If an OP_LABEL has an offset
	which can be done with an imm8, do it that way.
	(mono_arch_output_basic_block): ditto for a jmp
	(mono_arch_emit_prolog): Computate maximum offset of a label.

2004-05-24 18:18 CET Patrik Torstenson <totte@hiddenpeaks.com>

	* mini-x86.c (mono_arch_local_regalloc): the reg allocator
	now tries to allocate prefered physical reg's for virtual
	regs. This reduces the number of emited spills/loads with
	20-30% on our core assemblies.

Mon May 24 18:21:51 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c: truncl() is not needed and trunc() is
	the correct thing to do anyway (bug #58287).

2004-05-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_flush_icache): Call sync_instruction_memory
	if available.

Mon May 24 12:49:45 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* driver.c: enable loop optimizations by default.

Mon May 24 11:13:46 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: fix calc of max loop size when aligning loops start.

2004-05-23  Zoltan Varga  <vargaz@freemail.hu>

	* ssa.c (mono_ssa_cprop): Allocate carray dynamically instead of on
	the stack.

2004-05-22  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_output_basic_block): ADD_IMM and SUB_IMM
	should set carry.

	* basic-long.cs: Add tests for add/subtract of immediates with carry.

	* mini.c exceptions-x86.c: Remove MONO_USE_EXC_TABLES stuff.
	
	* mini.c (inline_method): Allways inline some wrappers even if the cost
	is too large. Fixes #58785.

	* mini.c: Add support for MARSHAL_CONV_FTN_DEL.
	
2004-05-21  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c exceptions-sparc.c: Applied patch from Mark Crichton
	(crichton@gimp.org). Beginning of support for sparc/linux.

	* mini-sparc.c: Optimize retrieval of LMF address.

Fri May 21 08:00:12 EDT 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c:  handle alloca in methods with clauses.

Fri May 21 07:35:30 EDT 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: cleanups, off-by-one fixes, avoid recursive thunks.

2004-05-20  Lluis Sanchez Gual  <lluis@ximian.com>

	* mini.c: Delegate most of the abort signal work to 
	  mono_thread_request_interruption, which also handles Stop and Suspend
	  states.

2004-05-20  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c mini.h: Allow inlining of icall wrappers if the backend 
	supports the save/restore lmf opcodes.

2004-05-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_setup_jit_tls_data): Handle code generated
	by gcc-3.4 as well.

	* mini-x86.h mini-x86.c tramp-x86.c: Optimize lmf restoring code.

2004-05-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c (mini_method_compile): Only run abc removal pass on 
	methods which contain array accesses.

	* mini.c (CEE_LDTOKEN): Handle this instruction correctly on bb
	boundaries. Fixes #58537.

	* iltests.il: Add regression test for #58537.

2004-05-18  Patrik Torstensson <totte@hiddenpeaks.com>

	* mini-x86.c (mono_arch_local_regalloc): Last part of
	fix for bug #58633 (releasing register to early).

2004-05-18  Miguel de Icaza  <miguel@ximian.com>

	* basic-long.cs: Add new regression test.

2004-05-18  Patrik Torstensson <totte@hiddenpeaks.com>

	* mini-x86.c (mono_arch_local_regalloc): Avoid releasing a
	register too early on the chain.

2004-05-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (create_helper_signature): Use a helper function to reduce
	the code which needs to be written. Also set the calling convention of
	icalls on windows. Fixes #57840.

Tue May 18 11:05:18 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.h, exceptions-x86.c, exceptions-sparc.c, exceptions-s390.c,
	exceptions-ppc.c: added helper function to get the instruction address
	from a signal handler context.

2004-05-17 Ben Maurer  <bmaurer@users.sourceforge.net>

	* helpers.c: use g_get_tmp_dir. Invokes happyness 
	from gonzalo.

2004-05-17 Ben Maurer  <bmaurer@users.sourceforge.net>

	* helpers.c: Add new env variable to pass args to objdump.
	Specifically for those of us who love -Mintel. r=miguel, gonzalo.

2004-05-17  Radek Doulik  <rodo@ximian.com>

	* Makefile.am (common_sources): added abcremoval.h so it get
	disted and daily mono packages on go-mono.com will build again

2004-05-17  Massimiliano Mantione  <massi@ximian.com>

	* abcremoval.c: Fixed coding style, added copyright header.

	* abcremoval.h: Fixed style and moved prototype to mini.h, added copyright header.

	* mini.h: Added prototype for abc removal main function.

	* build_relations_propagation_table.pl: Added copyright header.

2004-05-16	Patrik Torstensson <totte@hiddenpeaks.com>

	* basic-long.cs: reg test for complex ceq_long bug.

2004-05-16	Patrik Torstensson <totte@hiddenpeaks.com>

	* mini-x86.c (mono_arch_local_regalloc): Correctly free 
	reg in long and clob case (bug #58343). Fixed/added comments.

2004-05-14 Ben Maurer  <bmaurer@users.sourceforge.net>

	* mini.c (mono_jit_runtime_invoke): Follow new convention
	of calling the invoke method with an function pointer.

2004-05-14  Zoltan Varga  <vargaz@freemail.hu>

	* ChangeLog: Fix author of memory leak patch.

Fri May 14 15:13:06 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: fix make dist as well...


2004-05-14  Massimiliano Mantione  <massi@ximian.com>

	* cfold.c: Made so that conversions from pointer to int4 are no-ops
	on archs where pointers are 4 bytes long.

	* Makefile.am: Added abcremoval.c source file.

	* abcremoval.c: Added abcremoval.c.

	* abcremoval.h: Added abcremoval.h.

	* build_relations_propagation_table.pl: Added build_relations_propagation_table.pl.

	* inssel.brg: Enabled bounds check removal.

	* mini.c: Added support for abcrem optimization.

	* mini.h: Added abcrem optimization label.

	* driver.c: Added support for abcrem optimization.

	* propagated_relations_table.def: Added propagated_relations_table.def.

Fri May 14 14:30:13 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c, cfold.c: fix style.

Fri May 14 14:28:22 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle issue with the low-level implementation of
	some long opcodes (bug #54209).

2004-05-13 Ben Maurer  <bmaurer@users.sourceforge.net>

	* basic.cs: test for my new cmov stuff.

2004-05-13	Patrik Torstensson

	* mini-x86.c: added OP_X86_COMPARE_MEMBASE_IMM peephole
	opt and added peephole documentation.

Thu May 13 11:41:49 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c: rewrote the generic trampoline code.

2004-05-11	Patrik Torstensson

	* mini-x86.c: optimize long shl/shr asm code (one less branch)

2004-05-11  Zoltan Varga  <vargaz@freemail.hu>

	* basic.cs basic-long.cs objects.cs: Make these compile under MS csc.

	* mini.h mini.c dominators.c: Applied patch from Derek Woo
	(derek@eecg.toronto.edu): Fix memory leaks in loop optimizations.

	* mini.c: Add new icalls for AsAny marshalling.

Tue May 11 16:00:38 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c, mini-ppc.c: more cleanups.

2004-05-11  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: no warnings.

Tue May 11 13:59:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini.c: use mono_resolve_patch_target ().

2004-05-11  Lluis Sanchez Gual  <lluis@ximian.com>

	* mini.c: In the thread abort signal handler, if the thread is in the
	process of being stoped, don't throw the Abort exception, just stop the
	thread.

Tue May 11 12:15:24 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c: removed old code.

Tue May 11 12:02:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-ppc.c, cfold.c: export mono_is_power_of_two().
	do some simple speed optimizations on ppc.

Mon May 10 17:21:00 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: fixes to handle large stack frames
	and large offsets in load/store.

2004-05-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_local_regalloc): Remove the previous fix, since
	it causes regressions.

2004-05-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c: Fix vararg support + add beginnings of sigaltstack
	support.

Fri May 7 13:25:50 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c: remove warnings.
	* inssel-x86.brg, inssel.brg, mini-x86.c, cfold.c: some simple
	speedups for unsafe code.

2004-05-07 Ben Maurer  <bmaurer@users.sourceforge.net>

	* inssel.brg: Optimize Stind.[ui][12]. r=zoltan.

2004-05-06  Zoltan Varga  <vargaz@freemail.hu>

	* basic-calls.cs: Add new regression test.

	* mini.c (mono_runtime_install_handlers): Use SA_ONSTACK since it is
	more portable.

	* mini.c (mono_method_to_ir): Handle opcode emulation for *_OVF opcodes.

	* mini-x86.c (mono_arch_local_regalloc): Free new_dest register when it
	is no longer used.

2004-05-06	Patrik Torstensson

	* mini-x86.[c|h], inssel-x86.brg, cpu-pentium.md, mini.c: enabled
	long reg allocation in any reg (not only eax:edx) and implemented 
	long shl/shr ops in asm instead of helpers.

2004-05-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.h: Fix warnings.

	* exceptions-sparc.c (mono_arch_find_jit_info): Pop unused lfm off the
	stack.

	* mini-exceptions.c (mono_handle_exception): Call the filter in a
	separate statement for clarity.

	* mini-sparc.c: Update status.

2004-05-04  Zoltan Varga  <vargaz@freemail.hu>

	* mini-exceptions.c (ves_icall_get_frame_info): Flush register windows
	here.

Mon May 3 22:58:51 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* inssel-ppc.brg: another small pre-release workaround:
	we don't do overflow detection for long_sub_un.

Sun May 2 20:12:22 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-ops, inssel-long32.brg: speedup ulong >> 32
	(also works around a weird ppc bug: 57957).

Sat May 1 16:56:10 EDT 2004 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c: trampoline fixes.

Fri Apr 30 15:54:26 EDT 2004	Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixed typos.

Thu Apr 29 20:15:41 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, exceptions-ppc.c: more code saves registers
	at the top of the stack. Fixed typos. Use a frame registers
	for all the methods with exception clauses.

Thu Apr 29 18:52:09 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: restore fp registers.

Thu Apr 29 18:26:56 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, exceptions-ppc.c: save the registers in reverse
	order from the stack top (moved the stack room to save the
	return value for trace after the param area). Fixed corruption
	in restoring registers on unwind.

Thu Apr 29 16:47:15 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: fixed unisgned -> double conversion.

Thu Apr 29 13:50:51 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c, mini-ppc.h, mini-ppc.c: fixed localloc
	and prolog/epilog for methods that use it. Allow
	enough param area room for varargs methods. Fix miguel's
	breakage in exception handling.

Thu Apr 29 12:06:51 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: run genmdesc only on current arch.

2004-04-29  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* exceptions-x86.c:
	* mini-x86.h: fix the build on windows.

2004-04-28  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am mini.h mini-exceptions.c mini-x86.h mini-sparc.h exceptions-sparc.c: Move parts of the sparc exception handling code to XP code.

	* exceptions-sparc.c exceptions-ppc.c exceptions-s390.c mini-ppc.h mini-s390.h mini-sparc.h: Fix up ports after changes.

	* mini-exceptions.c: New file.
	
	* mini.c mini-exceptions.c mini-x86.h exceptions-x86.c Makefile.am:
	Move some parts of the x86 exception handling code to an 
	arch-independent file so it can be shared with other ports.

Tue Apr 27 12:15:59 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* trace.c, cpu-g4.md, inssel-ppc.brg, mini-ppc.c: some fixes for FP code.

2004-04-26  David Waite  <mass@akuma.org>

	* driver.c: remove comma from end of enumeration declaration

2004-04-26  Jackson Harper  <jackson@ximian.com>

	* driver.c: parse config file before loading first assembly. This
	allows the user gac to be enabled/disabled. 
	
2004-04-23  Miguel de Icaza  <miguel@ximian.com>

	* mini-ppc.c (ppc_patch): Replaced the branch code patching with a
	simpler mechanism: we do not care what is encoded initially
	(branch absolute or relative), we care about the code and its
	target.  I kept the old code for reference for now.

	The new code tries first to determine if the jump is anywhere in
	the -/+32 absolute meg range, if it succeeds, it encodes using the
	absolute branch;  If not, it tried to find something in the
	relative range, if not, it uses the handle_thunk code. 

Fri Apr 23 14:20:40 EDT 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: use the correct ip register on macosx.

Thu Apr 22 13:23:16 EDT 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions.c, mini.c, mini-ppc.h: adapt code to macosx.

Thu Apr 22 18:08:37 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md: made the branch macros more flexible.
	Raise exception on integer divide by zero by hand since the hw
	doesn't support it. Handle NaNs in FP compares.

Thu Apr 22 16:10:31 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c, mini-ppc.h, mini.c: simplified some
	code reducing duplication between the platforms and enabled
	signal exception handling (on linux for now).

Wed Apr 21 12:27:48 EDT 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: more macosx support.

Wed Apr 21 16:38:28 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, mini-ppc.c, cpu-g4.md: enable bigmul optimization.

Wed Apr 21 16:20:32 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-ppc.c, cpu-g4.md: support for implicit exceptions.

2004-04-19 Ben Maurer  <bmaurer@users.sourceforge.net>

	* iltests.il: more tests.

2004-04-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-*.c (mono_arch_get_allocatable_int_vars): Skip written-only
	vars as well.

Mon Apr 19 19:39:47 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: some fixes to bootstrap mcs/corlib/etc.

2004-04-19  Zoltan Varga  <vargaz@freemail.hu>

	* liveness.c: Mark variables as volatile in all basic blocks reachable
	from exception clauses.

2004-04-18  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs (test_0_rethow_stacktrace): Make this work with
	inlining.

2004-04-18 Ben Maurer  <bmaurer@users.sourceforge.net>

	* iltests.il, basic.cs: more tests for regalloc.

2004-04-17 Ben Maurer  <bmaurer@users.sourceforge.net>

	* iltests.il: Some tests for register allocation modifications
	I have locally.

2004-04-16  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs: Add regression test for bug #56782.

	* exceptions-*.c (mono_arch_handle_exception): Do not overwrite the
	original stack trace if an exception is rethrown. Fixes #56782. Oh,
	the beauty of fixing the same thing in 5 different files...

2004-04-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Do not compute coverage for inlined
	methods.

2004-04-14  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Add support for STRWLPARRAY marshalling convention.

Wed Apr 14 18:15:55 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: missing fixes in mono_jit_walk_stack (need
	to init the context to setup the regs pointer).

Wed Apr 14 17:59:09 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: more exceptions work.

Wed Apr 14 17:46:22 CEST 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: avoid reusing the same MonoInst on multiple trees: this is
	not allowed.

2004-04-13  Miguel de Icaza  <miguel@ximian.com>

	* inssel-x86.brg (reg): Add new rules for add, sub and mul that
	can use the memory directly.

	* cpu-pentium.md: Update documentation from a post from Zoltan. 

	add x86_add_membase, x86_sub_membase, x86_mul_membase

2004-04-13  Miguel de Icaza  <miguel@ximian.com>

	* mini-ppc.c: Remove unused definitions FLOAT_REGS and
	GENERAL_REGS they were also hardcoded for all PPC ports.

	(add_general): Use PPC_NUM_REG_ARGS instead of GENERAL_REGS.

	Remove hard-coded limit for floating point registers, use
	PPC_LAST_FPARG_REG instead in MONO_TYPE_R4 and MONO_TYPE_R8.

	Notice that in MacOS X calling conventions you can fit a lot more
	floating point values in registers, so I should update the PInvoke
	test to excercise the passing of floating point values on the
	stack (currently broken).
	
2004-04-06  Miguel de Icaza  <miguel@ximian.com>

	* tramp-ppc.c (create_trampoline_code): Added
	JUMP_TRAMPOLINE_SIZE. 
	(ppc_magic_trampoline): Follow the pattern from
	x86_magic_trampoline: if code is set to zero, return. 
	(create_trampoline_code): Always pass MonoMethod to the jump
	trampoline, before it was passing a null.
	(mono_arch_create_jump_trampoline): Implement the jump stub, could
	share the code with mono_arch_create_jit_trampoline. 

	* mini-ppc.c (mono_arch_output_basic_block): CEE_JMP opcode
	implemented.
	(mono_arch_patch_code): MONO_PATCH_INFO_METHOD_JUMP patch type
	implemented.  

	* cpu-g4.md: Added length for jmp instruction, the worst case
	scenario is 92 bytes (4 mandatory bytes, potential 19 registers
	for save_lmf).

2004-04-08  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Add back unlink removed by mistake.

2004-04-07  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Only set bblock->real_offset when adding a new bblock, and
	before each IL instruction.

	* mini.c (CEE_BOX): Fix warnings.

2004-04-07  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: removed a few unused vars and extra whitespace.

2004-04-05 Ben Maurer  <bmaurer@users.sourceforge.net>

	* inssel.brg (MONO_EMIT_BOUNDS_CHECK): a new macro to emit bounds
	checks.
	(MONO_EMIT_BOUNDS_CHECK_IMM): the above, but when you know the
	index.
	(OP_GETCHR): use the above
	(CEE_LDELEMA): use the above.

	* inseel-x86.brg (MONO_EMIT_BOUNDS_CHECK): a faster and smaller
	version of the generic impl.
	(MONO_EMIT_BOUNDS_CHECK_IMM): the same
	(CEE_LDELEMA): use the above.

2004-04-05  Zoltan Varga  <vargaz@freemail.hu>

	* inssel-long32.brg (CEE_CONV_OVF_I8): Sign extend the i4 value to i8.
	Fixes #56317.

	* iltests.il: Added new regression test for #56317.

2004-04-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_setup_jit_tls_data): Use pthread_attr_get_np
	under NetBSD. Fixes #56450.

	* liveness.c (update_gen_kill_set): Fix previous patch.

2004-04-04  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini-x86.h: SA_STACK defined as SA_ONSTACK. Fixed build under NetBSD.

2004-04-02  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Avoid handle_loaded_temps in
	ldsfld and ldsflda.

	* inssel-sparc.brg: Add more optimizations.

	* mini-sparc.c: Replace multiply/divide with shifts if possible.

2004-04-01  Martin Baulig  <martin@ximian.com>

	* mini.c (handle_box): New static function; moved the
	implementation of CEE_BOX here.
	(mono_method_to_ir): Added `constrained_call' variable.
	(mono_method_to_ir:CEE_CONSTRAINED_): Set it.
	(mono_method_to_ir:CEE_CALL): If `constrained_call' is set, use
	mono_method_get_constrained() to get the method.

2004-04-01  Martin Baulig  <martin@ximian.com>

	* mini.c (TYPE_PARAM_TO_TYPE, TYPE_PARAM_TO_CLASS): Removed.
	(MTYPE_PARAM_TO_TYPE, MTYPE_PARAM_TO_CLASS): Removed.
	(mono_method_to_ir): We don't need these macros anymore since
	mono_class_get_full() already takes care of it.	

2004-03-31  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* aot.c: set aot_verbose to 0, fixed format string that caused sigsegv,
	use @function (as doesn't accept #function here) and check the return
	value of system and stop if fails.

2004-03-31  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: set the timeout to 2s when calling mono_domain_finalize.

2004-03-31  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ppc.c (mono_arch_patch_code): Fix ppc build.

	* inssel-sparc.brg mini-sparc.c aot.c: Implement AOT support.

	* inssel-long32.brg (OP_LNEG): Use ADC instead of ADD here. Fixes
	#56223.

	* basic-long.cs: Add test for negation of Int64.MinValue.

2004-03-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c: Update status.

	* mini-sparc.c tramp-sparc.c: Save lmf in trampolines.

	* exceptions-sparc.c: Fix return value in filters.

	* inssel-sparc.brg: Fix register allocation in some rules.

2004-03-28  Martin Baulig  <martin@ximian.com>

	* mini.c (mmono_method_to_ir): In CEE_STELEM, do a handle_stobj()
	if neccessary.	

2004-03-28  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_patch_code): Fix warnings.
	
	* mini-x86.c (mono_arch_output_basic_block): Fix CEE_MUL_OVF_UN if 
	dreg is not EAX. Thanks to Willibard Krenn for spotting this. Also
	remove unused conv_u4 opcode.

	* mini-x86.c: Remove valgrind workaround since it slows down things
	even when mono is not run under valgrind.

2004-03-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c: Update status.

	* inssel-sparc.brg: Add some optimizations.

	* inssel-sparc.brg mini-sparc.c: Rework branch instructions to allow
	future delay slot filling. Add support for varargs, tail calls and JMP.

	* inssel.brg mini-ops.h mini.c: Use OP_REFANYTYPE instead of 
	CEE_REFANYTYPE, since CEE_REFANYTYPE needs a prefix to be unique.

	* inssel.brg: Fix register allocation in OP_ARGLIST.

	* inssel.brg: Fix warnings.

2004-03-25  Martin Baulig  <martin@ximian.com>

	* mini.c (inflate_generic_field): Removed.
	(mini_get_method): Removed, use mono_get_method_full(),
	(mini_get_class): Removed, use mono_class_get_full().
	(mono_method_to_ir): Pass our generic context to
	mono_field_from_token().	

2004-03-25  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_get_class): Take a `MonoGenericContext *' instead
	of a `MonoMethod *'.
	(mini_get_method): Take a `MonoGenericContext *' instead
	of a `MonoMethod *'.
	(TYPE_PARAM_TO_TYPE, MTYPE_PARAM_TO_TYPE): mono_method_to_ir() has
	a new local variable called `generic_context' which holds the
	current `MonoGenericContext *'; use it to lookup things.

2004-03-24  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_get_class): New static method; if we're inside a
	generic instance, inflate the class if neccessary.
	(mono_method_to_ir): Use mini_get_class() instead of mono_class_get().

2004-03-24  Zoltan Varga  <vargaz@freemail.hu>

	* iltests.il: New regression test for #55976.

	* mini.c (mono_method_to_ir): Empty the stack in endfinally. Fixes
	#55976.

2004-03-23  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-sparc.c (mono_sparc_handle_exception): Remove debugging
	output.

2004-03-23  Zoltan Varga  <vargaz@freemail.hu>

	* liveness.c: Consider SSA stores as well as loads when making vars
	volatile.

	* exceptions.cs: New regression tests for register allocation.
	
2004-03-22  Lluis Sanchez Gual  <lluis@ximian.com>

	* mini-ppc.c, tramp-ppc.c: Added lock for accessing the domain code manager.
	* mini.c: Removed domain lock from mono_jit_compile_method_with_opt. Use
	  domain lock only to protect puntual access to data structures.
	  Added access lock for sighash, jit_icall_hash_name, 
	  jit_icall_hash_addr and domain->code_mp.

2004-03-20  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c: Print SIGSEGV handling method.

	* mini-x86.c (mono_arch_free_jit_tls_data): Add missing ifdef.

	* mini.c (setup_jit_tls_data): Handle case when this is called
	multiple times for a thread.

	* mini-x86.c cpu-pentium.md: Fix floating point branch opcodes so fbxx 
	is different from fbxx_un. Fixes #54303. Also use constants instead of
	magic numbers in a lot of places.

2004-03-19  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs: Fix cctor test when --regression is used.

Thu Mar 18 19:57:56 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, exceptions-ppc.c: basic exceptions support 
	for Linux/ppc.

Thu Mar 18 19:56:19 CET 2004 Paolo Molaro <lupus@ximian.com>

	* inssel-ppc.brg: fixed register assignments for some rules.

2004-03-17  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs: Add test for exceptions in static constructors.

	* mini.c (mono_jit_compile_method_with_out): Move the calling of
	static constructors outside the domain lock. Fixes #55720.

2004-03-17  Martin Baulig  <martin@ximian.com>

	* mini.c (get_generic_field_inst): Removed, this'll never happen.
	(inflate_generic_field): Take the `MonoMethod *' instead of the
	`MonoClass *' and added support for generic method.
	(mono_method_to_ir): In CEE_LDSFLD and CEE_STSFLD, assert we never
	have a `field->parent->gen_params', only inflate the field if it's
	an open constructed type.

2004-03-17  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-x86.c (mono_arch_handle_exception): Allocate a new
	exception object instead of the preconstructed ones.

2004-03-17  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: reverted changed to sigsegv_signal_handler commited
	accidentally in the previous patch.

2004-03-17  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c:
	(mono_method_to_ir): CEE_CALLVIRT, abort if no method. It hanged when
	running --aot with an old assembly.

2004-03-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_instrument_epilog): Fix handling of floating
	point values.

	* mini-sparc.c: Add support for v9 branches with prediction.

2004-03-15  Bernie Solomon  <bernard@ugsolutions.com>

	* mini.c (mini_init): #warning is GNUC only

	* mini-sparc.h: implement __builtin_frame_address
	and __builtin_return_address for Sun C compiler

2004-03-15  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-sparc.c (mono_arch_has_unwind_info): Add missing function.

2004-03-14  Zoltan Varga  <vargaz@freemail.hu>

	* basic-calls.cs: Add test for unaligned byref long argument passing.

	* mini-ops.h: Add sparcv9 compare and branch instructions.

	* inssel-sparc.brg mini-sparc.h mini-sparc.c cpu-sparc.md: Use some
	v9 instructions if we have a v9 cpu.

	* mini-sparc.c (mono_arch_get_global_int_regs): Use unused input
	registers for global allocation.

	* exceptions-sparc.c: Fixes.
	
2004-03-11  Zoltan Varga  <vargaz@freemail.hu>

	* liveness.c (mono_analyze_liveness): Optimized version.

	* inssel-sparc.brg cpu-sparc.md: Ongoing sparc work.

	* mini-sparc.h mini-sparc.c tramp-sparc.c exceptions-sparc.c: Ongoing
	sparc work.

	* basic-float.cs basic-calls.cs: New regression tests.

2004-03-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.h: Define SIGSEGV_ON_ALTSTACK only if we have a working
	sigaltstack implementation.

	* mini-x86.c (mono_arch_setup_jit_tls_data): Fix previous patch.
	
	* mini-x86.c (mono_arch_setup_jit_tls_data): Turn off the sigaltstack
	stuff if SIGSEGV_ON_ALTSTACK is not defined.

2004-03-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Fix warnings.
	
	* mini.c (mono_resolve_patch_target): New function which contains the
	arch independent part of the patching process.

	* mini-x86.c (mono_arch_patch_code): Move arch independent parts of the
	patching code to a separate function.

2004-03-09  Bernie Solomon  <bernard@ugsolutions.com>

	* mini.c (add_signal_handler): ifdef out on Windows

2004-03-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.h mini-sparc.c inssel-sparc.brg exceptions-sparc.c 
	cpu-sparc.md: Add exception handling support + other fixes.

	* driver.c: Print --help output to stdout. Fixes #55261. Also fix
	typed GC detection in --version.

	* basic.cs exceptions.cs: New regression tests.

	* mini.h mini-x86.h mini-ppc.h: Add MonoCompileArch structure where
	the arch specific code can store data during a compilation.

	* mini-ops.h: Add OP_SETFRET.

	* mini.c (mini_get_ldelema_ins): Instead of allways calling the same
	function, register a separate icall for each arity, so the icalls can
	get a wrapper.
	
	* mini.c (mono_print_tree): Print negative offsets in a more readable
	form.
	
	* mini.c: Make signal handling work on sparc.
	
	* mini.c (mini_init): Add emulation for lconv_to_r8_un.

	* inssel-long32.brg: Fix OP_LSUB_OVF_UN rule.

	* jit-icalls.c: Emulate truncl by aintl on solaris.

	* jit-icalls.c (mono_lconv_to_r8_un): New icall emulation function.

2004-03-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mini_init): fconv_to_ovf can raise exceptions.

2004-03-04  Lluis Sanchez Gual  <lluis@ximian.com>

	* mini.c: In CEE_ISINST and CEE_CASTCLASS, if the type is an interface or
	a MarshalByRef type, inline a method that performs the check, taking into
	account that the object can be a proxy. Also implemented tow new opcodes:
	CEE_MONO_CISINST and CEE_MONO_CCASTCLASS.
	* inssel.brg: Implemented two new opcodes, mini-ops.h: OP_CISINST and 
	OP_CCASTCLASS, which implement CEE_MONO_CISINST and CEE_MONO_CCASTCLASS.

Tue Mar 2 17:23:48 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: if a relative branch displacement is too big
	but it points to and area reachable with an absolute branch, 
	avoid the thunks.

Tue Mar 2 16:59:40 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: optimize small copies in cpblk.

2004-03-01  Zoltan Varga  <vargaz@freemail.hu>

	* basic-calls.cs basic-float.cs: New regression tests.

	* mini-sparc.c inssel-sparc.brg mini-ops.h: Access local variables at 
	negative offsets from %fp. Implement localloc. Fix local register 
	allocation. Fix the case when the this argument needs to be saved to
	the stack. Implement some missing opcodes.

2004-02-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mini_method_compile): Reenable global regalloc in methods
	with exception handlers.

	* linear-scan.c (mono_varlist_sort): Fix warning.

	* linear-scan.c (mono_linear_scan): Fix computation of used_regs.

	* mini-x86.c (mono_arch_regalloc_cost): Reenable precise computation of
	regalloc costs.

	* liveness.c: Make all variables uses in exception clauses volatile, to
	prevent them from being allocated to registers. Fixes #42136.

2004-02-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_regalloc_cost): Revert this change since it
	causes regressions.

	* mini.h linear-scan.c mini-x86.c mini-sparc.c mini-ppc.c: Add 'cfg'
	argument to mono_arch_regalloc_cost.

	* mini-x86.c (mono_arch_regalloc_cost): Compute regalloc costs 
	precisely.

2004-02-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini-x86.c mini-ppc.c mini-sparc.c linear-scan.c: 
	Make the cost of allocating a variable to a register arch dependent.

	* basic-calls.cs: Fix compilation of tests.
	
	* mini.h mini.c tramp-x86.c mini-x86.c: Add mono_running_on_valgrind ()
	helper function to cut back on the number of #ifdefs needed.

	* mini-ppc.c: Fix compilation.

	* basic-calls.cs: New regression tests.

	* mini-sparc.c (mono_sparc_is_virtual_call): New helper function.

	* tramp-sparc.c (create_specific_trampoline): Use g5 register instead
	of l0 since that is callee saved.

	* tramp-sparc.c (sparc_magic_trampoline): Apply unbox trampoline only
	to virtual calls.

	* mini-sparc.c: Ongoing work + flag virtual calls with a special kind 
	of delay instruction.

	* inssel.brg (OP_CHECK_THIS): Set tree->sreg1 and dreg correctly.

	* mini.h (MonoCallInst): Add 'virtual' flag.

	* inssel.brg (mini_emit_virtual_call): Set 'virtual' flag.

2004-02-23  Zoltan Varga  <vargaz@freemail.hu>

	* *.cs: New regression tests.

	* mini-sparc.c inssel-sparc.brg: Update after latest changes. Ongoing sparc 
	work.

	* mini.c (mono_runtime_install_handlers): Fix build.

	* mini.h (MonoJitTlsData): Add 'stack_size', 'signal_stack' and
	'signal_stack_size' members.

	* mini.h mini.c mini-x86.h mini-x86.c: Run sigsegv handlers on an 
	alternate signal stack.

	* exceptions-x86.c: Add stack overflow handling.

	* mini.h mini.c mini-x86.c mini-ppc.c trace.h trace.c: Move tracing 
	functions to arch independent code.

	* mini.c (mono_print_tree): Print more detailed info for load_membase
	opcodes.
	
2004-02-23  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_get_method): Set `gmethod->generic_inst'.

Sun Feb 22 22:25:19 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: fixed reg allocation for div/rem.

2004-02-22  Miguel de Icaza  <miguel@ximian.com>

	* driver.c (mono_main): Report some configuratio options on --version.

Fri Feb 20 11:01:44 PST 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixed clt.un, cgt.un. Optimized calls to functions
	low in the address space. Correctly flush memory in thunks where we
	output native code.

2004-02-20  Martin Baulig  <martin@ximian.com>

	* mini.c (mini_get_method): New static method; inflate all generic
	methods and methods in open generic instances.
	(mono_method_to_ir): Use mini_get_method() instead of mono_get_method().
	(ret_type_to_call_opcode): Added support for MONO_TYPE_GENERICINST.

2004-02-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-sparc.c (mono_arch_patch_code): Update after domain->code_mp changes.

	* tramp-sparc.c (mono_arch_create_jump_trampoline): Set ji->method.

2004-02-19  Bernie Solomon  <bernard@ugsolutions.com>

	* helpers.c (mono_disassemble_code): use Sun's dis if not using gcc

	* mini-sparc.c (flushi mono_arch_output_basic_block): make
	it compile using Sun's compiler.

2004-02-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini-ops.h inssel-sparc.brg cpu-sparc.md mini-sparc.h mini-sparc.c tramp-sparc.c exceptions-sparc.c: Sparc port, part I.

	* basic-calls.cs basic-float.cs basic-long.cs objects.cs: New regression tests.

Tue Feb 17 21:41:20 CET 2004 Paolo Molaro <lupus@ximian.com>

	* aot.c, mini-x86.c, mini.c: use the code manager instead of a mempool to hold native
	code.
	* mini-ppc.c: handle calls outside of the allowed range with thunks
	allocated using the code manager.
	* tramp-ppc.c: use the code manager to hold generated native code.
	Fixed the magic trampoline to just patch vtable entries.

2004-02-17  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg inssel-x86.brg: Move call(immediate) rules to the platform
	independent file.

2004-02-16  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-ppc.c (mono_arch_create_jump_trampoline): Fix compilation on
	PPC.

	* mini-x86.c: Call mono_arch_get_lmf_addr instead of mono_get_lmf_addr
	if we have a working __thread implementation.

	* mini-ops.h cpu-pentium.md mini-x86.c inssel-x86.brg: Remove 
	OP_CALL_IMM opcodes, since the CALL opcodes handles immediates as well.

2004-02-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c: Fix compilation under gcc 2.
	
2004-02-14  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_codegen): Avoid infinite loop when an icall wrapper
	contains a call to the wrapped function.

	* mini-ops.h cpu-pentium.md mini-x86.c inssel-x86.brg: Add 
	OP_<CALL>_IMM opcodes, and use them under X86.
	
	* mini.c (mono_jit_find_compiled_method): Fix warning.

	* cpu-pentium.md: Fix length of opcodes which use x86_alu_membase_imm.

	* jit-icalls.c (mono_ldftn_nosync): New JIT icall.

	* tramp-x86.c (mono_arch_create_jump_trampoline): Move arch independent
	functionality to mini.c.

	* mini.c (mono_create_jump_trampoline): New function to create a jump
	trampoline. Return a compiled method instead of a trampoline if it
	exists. Add a cache for jump trampolines.

	* mini.c (mono_jit_find_compiled_method): New function to return a
	compiled method if it exists.

	* mini-x86.c: Call mono_create_jump_trampoline instead of 
	mono_arch_create_jit_trampoline.

	* jit-icalls.c (mono_ldftn): Do not compile the method. Instead, return
	a jump trampoline. Fixes #52092.
	
2004-02-11  Zoltan Varga  <vargaz@freemail.hu>

	* debug-mini.c (mono_init_debugger): Remove call to mono_verify_corlib,
	which is not up-to-date. Add check_corlib_version () instead.

	* mini.c (mini_init): Call mono_thread_attach () so embedders do not 
	have to call it.
	
	* mini.c (mono_runtime_install_handlers): Remove check for valgrind
	since newer valgrind versions do not need it.

	* mini.c (mono_jit_compile_method_with_opt): New helper function to
	compile a method with a given set of optimizations.

	* mini.c: Compile icall wrappers on-demand instead of at startup.

	* mini-sparc.c mini-ppc.c: Call mono_icall_get_wrapper to obtain the
	wrapper for an icall.

2004-02-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Handle switch with non-empty stack. Fixes
	#54063.

	* iltests.il: Add test for non-empty stack before switch instruction.

2004-02-02  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Add support for new stringbuilder marshalling conventions.

	* mini.c (mono_method_to_ir): Fix stack management of generic CEE_BOX.

2004-02-01  Martin Baulig  <martin@ximian.com>

	* mini.c (MTYPE_PARAM_TO_TYPE): Method type arguments are stored
	in `ginst->mtype_argv'.

2004-01-31  Miguel de Icaza  <miguel@ximian.com>

	* mini.c: Add comments, replace CEE_XXX+128 with OP_XXX to
	facilitate grepping.

Wed Jan 28 14:04:58 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini.c: fixed buglet in initobj generic implementation for references.

Fri Jan 23 16:10:44 EST 2004 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: make the version script conditional.
	* jit-icalls.c: handle missing truncl().

2004-01-23  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs: Add more tests for double->int conversion.

	* jit-icalls.c (mono_fconv_ovf_i8): Call truncl before comparison, so
	we don't throw exceptions when converting 1.1 to a long. Fixes #53250.

Fri Jan 23 17:12:08 CET 2004 Paolo Molaro <lupus@ximian.com>

	* driver.c: make --verbose --version emit an error
	if the loaded corlib doesn't match the runtime version.

Mon Jan 19 17:44:50 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h: export ppc_patch().
	* mini-ppc.c: call convention fixes. Added assert in ppc_patch().
	* tramp-ppc.c: call convention fixes: Linux/PPC support should be
	on par or better than on MacOSX.

2004-01-19  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c tramp-x86.c tramp-sparc.c: Updated after changes to
	mono_lookup_pinvoke_call.

	* mini-x86.c: Under windows, the default pinvoke calling convention is
	stdcall. Fixes #52834.

	* mini.c (optimize_branches): Add an upper bound to the number of
	iterations to prevent infinite loops on strange loops. Fixes #53003.

2004-01-16  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg: Add vectors<->one dimensional array checking to CASTCLASS
	and ISINST. Fixes #52093.

	* objects.cs (test_0_vector_array_cast): New tests.
	
2004-01-15  Zoltan Varga  <vargaz@freemail.hu>

	* jit-icalls.c (helper_stelem_ref_check): New jit icall for array type
	checking in Array.Set ().

	* mini.c (method_to_ir): Add array type checking in Array.Set (). Fixes
	#52590.

	* object.cs (test_0_multi_array_cast): New regression test.

Thu Jan 15 16:30:24 CET 2004 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: fix build on Linux/PPC.

2004-01-14  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-x86.c (x86_magic_trampoline): Disable code patching when
	running under valgrind.
	(x86_magic_trampoline): Fix build bustage.

	* debug-mini.c: Modify the debug info serialize/deserialize code so it handles
	negative values as well. This is needed for the encoding of the line number
	info, since sometimes the line numbers are not in increasing order.

2004-01-13  Zoltan Varga  <vargaz@freemail.hu>

	* cpu-pentium.md (localloc): Increase the size of the localloc 
	instruction since it is a loop under Win32.

	* debug-mini.c (record_line_number): Get rid of unneccesary memory
	allocation.

2004-01-09  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-ppc.c exceptions-x86.c exceptions-sparc.c 
	tramp-x86.c tramp-ppc.c tramp-sparc.c: Applied patch from 
	Max Horn (max@quendi.de). Fix file names in comments.

2004-01-03  Zoltan Varga  <vargaz@freemail.hu>

	* ssa.c (mono_ssa_rename_vars): Allocate new_stack on the heap to
	avoid stack overflow.
	(replace_usage): Avoid uninitialized variable warnings.

	* mini.c (mono_method_to_ir): Avoid disabling SSA for array operations
	and taking the address of valuetype variables.

2004-01-03  Patrik Torstensson

	* mini-x86.c: renamed fpflags to flags in RegTrack, going to be used
	for other purposes than FP later on.

2004-01-02  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Prevent register allocation for arguments
	of tail calls.

Fri Jan 2 13:37:25 CET 2004 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini.c, inssel.brg: Object.GetType () speedup.

2003-12-30  Patrik Torstensson <p@rxc.se>

	* mini-x86.h: Decreased number of availiable fp regs.
	Solves corner cases with FP spilling.

2003-12-23  Patrik Torstensson <p@rxc.se>

	* mini-x86.c, mini-ops.h, cpu-pentium.md: Added support
	for floating point stack tracking / spilling on x86. 
	Fixes bug #49012.
	
	* basic-float.cs: added float mul overflow test.

2003-12-23  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Add workaround for bug #51126.

Sun Dec 21 19:53:16 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-ppc.c, mini-ppc.h: small cleanups and
	supports for cond branches that overflow the immediate
	overflow offset. mcs can compile simple programs.

Fri Dec 19 21:17:16 CET 2003 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: exception handling support wip:
	finally handlers get run on exception.

2003-12-19  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_get_method_inner): Avoid loading AOT code while 
	profiling.

Fri Dec 19 17:58:28 CET 2003 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md, mini-ppc.c, exceptions-ppc.c, mini-ppc.h:
	initial support for stack walking and unwinding.

2003-12-18  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (mono_main): Make corlib-out-of-sync message more 
	descriptive. Also remove verify_corlib call.

Wed Dec 17 15:31:41 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: make CEE_NEWARR calls and other emulated opcodes 
	not overlap with other call's arguments, too.

Wed Dec 17 12:49:23 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, mini-ppc.c, mini-sparc.c, mini-x86.c: 
	move to arch-specific code the choice of arch-specific
	intrinsics (from Laurent Morichetti (l_m@pacbell.net)).
	* mini.c: ensure emulation calls will not interleave
	with other calls.

Wed Dec 17 12:27:26 CET 2003 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c, basic-calls.cs: rework trampolines so that
	the magic trampoline stack frame is dropped before executing
	the new method.

Mon Dec 15 18:13:57 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md, inssel-ppc.brg: fixed some opcode lengths
	and integer to fp conversions. Added support for overflowing
	arguments on the stack. Reserve a couple more registers as temps.
	Added support for aot compilation (as output still needs to be
	tweaked, though).

Sat Dec 13 17:49:10 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, basic-long.cs: fix jumps to known labels.
	Don't overwrite return register in some corner cases.

2003-12-13  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c driver.c mini-x86.c mini-ppc.c aot.c: Do not run
	static constructors when AOT compiling.

	* driver.c (mono_main): Call mono_check_corlib_version.

Sat Dec 13 10:31:12 CET 2003 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md, basic.cs: fixed div target register.

Sat Dec 13 09:45:56 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, basic.cs: shl_imm fix with test.

Fri Dec 12 21:25:14 CET 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-ppc.brg, mini-ppc.h, mini-ppc.c: support for passing 
	structures by value. Misc fixes.
	* objects.cs: more tests.

Fri Dec 12 10:11:49 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: lconv.ovf.i implemented.

2003-12-10  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c:
	(mini_init): don't error out if someone already called g_thread_init.

Tue Dec 9 17:27:14 CET 2003 Paolo Molaro <lupus@ximian.com>

	* exceptions-x86.c, exceptions-ppc.c: allow the exception object
	to be any type per the spec. Fix abnormal memory usage when
	the same object is repeatedly thrown.

Tue Dec 9 15:39:54 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: check for overruns in IL code.

2003-12-09  Zoltan Varga  <vargaz@freemail.hu>

	* TODO: Add/remove some todo entries.

2003-12-08  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (mono_main): Call mono_verify_corlib.

2003-12-07  Lluis Sanchez Gual  <lluis@ximian.com>

	* inssel.brg: In CEE_ISINST and CEE_CASTCLASS, removed check for proxy. 
	This has been moved to mini.c
	* mini.c: in mono_method_to_ir, CEE_ISINST and CEE_CASTCLASS cases, if the
	type being casted is marshalbyref it could be a proxy, so instead of
	emitting the type check code, emit a call to a runtime method that will
	perform the check by calling CanCastTo if needed.

2003-12-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_emit_prolog): Fix stack space allocation for
	methods with large stack frames under Win32.

2003-12-04  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am: Distribute regression tests.

	* mini-x86.c (mono_arch_get_allocatable_int_vars): Sort the var list
	at the end instead of inserting each variable into the sorted list.

	* linear-scan.c (mono_varlist_sort): New helper function.
	
Wed Dec 3 20:46:28 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: ensure arguments and locals are within bounds.

Wed Dec 3 17:59:10 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md, basic.cs, basic-long.cs: more tests and 
	related fixes.

2003-12-03  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_cprop_copy_values): Fix crash.

	* aot.c: Set verbosity back to 0.
	
Wed Dec 3 15:42:27 CET 2003 Paolo Molaro <lupus@ximian.com>

	* regalloc.c: complete memory leak fix by Laurent Morichetti
	(l_m@pacbell.net).

2003-12-03  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (main_thread_handler): Revert the previous patch.

	* tramp-x86.c (x86_class_init_trampoline): Avoid patching when running
	under valgrind.

	* mini-x86.c (mono_arch_local_regalloc): Do not allocate transient
	memory from the memory pool.

	* driver.c (main_thread_handler): Turn on all optimizations when
	--aot is used.

	* mini.c (mono_find_jit_opcode_emulation): Turn emul_opcode_hash into
	an array for better performance.

	* regalloc.c (mono_regstate_assign): Fix memory leak.

	* debug-mini.c (mono_debug_serialize_debug_info): New function to
	serialize the debug info.

	* debug-mini.c (mono_debug_add_aot_method): New function to load the
	debug info from the serialized representation.

	* aot.c: Save debug info into the generated file and load it when 
	loading a method.

	* mini.h (MONO_AOT_FILE_VERSION): Bump version number.

Mon Dec 1 16:54:05 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, tramp-ppc.c: save FP arguments in the trampoline.
	More FP-related fixes.

Sun Nov 30 19:13:52 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md, inssel-ppc.brg: fixed finally handlers
	and register allocation buglet. Hello world now runs.

Fri Nov 28 23:03:05 CET 2003 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md, inssel-ppc.brg, mini-ppc.c: better long return support.
	* tramp-ppc.c: fixed class init trampoline.
	* inssel-ppc.brg, mini.c, jit-icalls.c, mini-ppc.h: more emulation.

Fri Nov 28 16:36:29 CET 2003 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md, inssel-ppc.brg, jit-icalls.c, mini-ppc.c, mini-ppc.h,
	mini.c: more ppc changes/fixes.

2003-11-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Fix tail calls with valuetype arguments.
	Also optimize the case when the arguments are the same in the caller 
	and in the callee.

	* iltests.il: Add tests for tail calls with valuetype arguments.

Thu Nov 27 21:06:37 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixes for struct return type.

Thu Nov 27 19:02:07 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, mini-x86.c, mini-ppc.c, mini-sparc.c: move 
	mono_spillvar_offset() to arch-specific code.

Thu Nov 27 18:30:42 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, mini-ppc.c: handle some different ABI call convention issues.

2003-11-27  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions-x86.c: Fix stack space leaks.
	
	* exceptions-x86.c (mono_arch_find_jit_info): Restore callee saved
	registers from the lmf if the method has save_lmf set.

2003-11-26  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-x86.c (x86_magic_trampoline): Avoid patching in the addresses
	of icall wrappers into InvokeInDomain, since these are now per-domain.

Wed Nov 26 20:15:04 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, mini-x86.h, mini.c, inssel-ppc.brg, jit-icalls.c:
	make some opcode emulation and intrinsic ops enabled/disabled 
	according to the architecture. More fixes.

Wed Nov 26 19:59:09 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, mini-sparc.c, cpu-g4.md: more bug fixes.

Wed Nov 26 19:18:29 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, inssel.brg, mini-x86.c, mini-ppc.c, mini-sparc.c: move
	arch-specific handling for 'this' and struct return type to
	arch-specific code.

2003-11-26  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* aot.c: prevent divide by zero error when reporting (it happened with
	Accessibility.dll).

2003-11-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (inst_switch): Remove unused macro.

2003-11-25  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* aot.c:
	(load_aot_module): free 'info->methods' and 'info' properly. No more
	"free(): invalid pointer blah" messages when you have an old aot
	compiled assembly.

2003-11-21  Lluis Sanchez Gual <lluis@ximian.com>

	* jit-icalls.c, mini.c: Added support for context static fields.

2003-11-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_blittable): Methods which set LastError are not 
	blittable either. Fixes #51108.
	
Tue Nov 18 16:41:37 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: flush icache.
	* cpu-g4.md, mini-ppc.c, inssel.brg: more fixes. Trace support.

2003-11-18  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_type_blittable): OBJECT is not blittable. Fixes #47842.

2003-11-17  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-x86.c (x86_class_init_trampoline): Make code patching thread
	safe on IA32.

	* mini-x86.c (mono_arch_call_opcode): Disable AOT for methods with 
	vararg calls.

	* inssel.brg (CEE_MKREFANY): Fix AOT case.

2003-11-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_local_regalloc): Fix regalloc for div 
	instruction when the result is discarded.

	* iltests.il (test_0_div_regalloc): New regression test.

	* arrays.cs: Fix compilation error.

Fri Nov 14 21:34:06 CET 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-x86.brg, inssel-float.brg, mini-ops.h: move x86-specific
	float rules to inssel-x86.brg: sane architectures with FP registers
	don't need to implement these rules.

Fri Nov 14 20:52:12 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c, cpu-g4.md, inssel-ppc.brg: updates and fixes to the ppc port.

Fri Nov 14 17:58:27 CET 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, inssel-long32.brg: fixed endianess issues in int64
	implementation of 32 bit systems.

Thu Nov 13 16:14:41 CET 2003 Paolo Molaro <lupus@ximian.com>

	* exceptions-ppc.c: fix build on Linux/ppc from Jeroen@xs4all.nl
	(Jeroen Zwartepoorte).

2003-11-12  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Use CEE_JMP only if the signature of
	the caller and the callee matches.
	
	* mini.c (mono_method_to_ir): Add comment.

	* mini-x86.c (mono_arch_output_basic_block): Use mono_signbit, since
	signbit is missing on some platforms.

2003-11-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (mono_arch_setup_jit_tls_data): New arch specific function.

	* mini.c (setup_jit_tls_data): Call the new function.
	
	* mini-x86.c mini-ppc.c mini-sparc.c: Define the new function.

	* mini-x86.c: Add experimental support for fast access to the lmf
	structure under NPTL/Linux 2.6.x.

2003-11-06  Martin Baulig  <martin@ximian.com>

	* ldscript: Make `GC_push_all_stack', `GC_start_blocking',
	`GC_end_blocking' and 'gc_thread_vtable' public; they're used by
	the debugger.

2003-11-02  Martin Baulig  <martin@ximian.com>

	* mini.c (inflate_generic_field): New static method.
	(mono_method_to_ir): In CEE_LDFLD and CEE_LDSFLD: if we're a
	generic instance and the field is declared in a generic type, call
	inflate_generic_field() to inflate it.  Fixes gen-28.cs.

2003-10-31  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c (mono_method_same_domain): New function to return
	whenever the caller and the callee are in the same domain.

	* tramp-x86.c (x86_magic_trampoline): Use the new function.	

2003-10-30  Martin Baulig  <martin@ximian.com>

	* mini.c (MTYPE_PARAM_TO_TYPE, MTYPE_PARAM_TO_CLASS): New macros;
	similar to TYPE_PARAM_TO_TYPE and TYPE_PARAM_TO_CLASS, but for
	method parameters.
	(mono_method_to_ir): Added support for MONO_TYPE_MVAR; similar to
	MONO_TYPE_VAR, we the actual types from MTYPE_PARAM_TO_CLASS().	

2003-10-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c mini-ops.h inssel.brg: Implement undeniable exception 
	propagation.

	* mini.c (sigusr1_signal_handler): Move creation of the thread abort
	object here, so it is in the correct appdomain etc.

2003-10-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_compile_method_inner): Lookup icalls here if not
	already done.
	(mono_method_to_ir): Avoid freeing the type created returned from
	mono_type_create_from_typespec, since it is put into an internal cache
	by the function. Fixes pointer.exe.

	* mini.c tramp-x86.c tramp-sparc.c tramp-ppc.c: Use the normal 
	trampolines for icalls and pinvokes as well. Fixes #33569.

2003-10-24  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Update after appdomain changes.

	* mini.c (mono_jit_compile_method_inner): Allways compile native
	method wrappers in the root domain, since there can only be one
	instance of them, whose address is stored in method->info.

2003-10-16  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_runtime_install_handlers): Get rid of the MONO_VALGRIND
	environment variable. Instead detect automatically whenever running
	under valgrind using the magic macro RUNNING_ON_VALGRIND from
	valgrind.h.

2003-10-16  Miguel de Icaza  <miguel@ximian.com>

	* trace.c, trace.h: New files that implement the new trace option
	parsing. 

	* driver.c: Document new --trace options.

	* exceptions-ppc.c, exceptions-x86.c, mini-ppc.c, mini-sparc.c,
	mini-x86.c: Apply:

	-       if (mono_jit_trace_calls)
	+       if (mono_jit_trace_calls != NULL && mono_trace_eval (method))

	* mini.h: prototypes.
	
2003-10-15  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Fix initialization of typedbyref locals.

	* mini.c inssel.brg: Implement typedefbyref opcodes.

	* mini.c (mono_jit_compile_method): Remove unused local variable.

	* mini.c (mono_jit_compile_method_inner): Ditto.
	
2003-10-12  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-x86.c (x86_class_init_trampoline): Fix build.
	
	* tramp-x86.c (x86_class_init_trampoline): Thread safety fixes.

2003-10-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_no_aot): Remove unused global variable.

	* mini.c: Thread safety fixes.

2003-10-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_create_class_init_trampoline): Add a lock around
	class_init_hash_addr.

	* arrays.cs (test_0_newarr_emulation): Add new regression test for
	#30073.

	* mini.c: Decompose the NEWARR instruction before decomposing its
	arguments. Fixes #30073.

2003-10-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_emit_epilog): Add support for stdcall calling
	convention.

2003-10-06  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_method_to_ir): Allow wrapper data for CEE_LDELEMA.

	* inssel-x86.brg (OP_LOCALLOC): Fix register assignment for localloc.

	* driver.c: Add support for compiling icall wrappers to --compile.

2003-10-05  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg: The empty value in class->interface_offsets is -1, not
	0. Fixes #49287.

2003-10-03  Zoltan Varga  <vargaz@freemail.hu>

	* objects.cs: New test for 'is' operator on an array of interfaces.

Wed Oct 1 19:40:02 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* tramp-ppc.c: update trampoline code to support jumps
	and class initialization.

2003-09-30  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_jit_compile_method): Fix reading of freed memory.

	* inssel.brg (OP_UNBOXCAST): Fix #46027.

	* inssel.brg (OP_UNBOX): Remove unused rule.

	* mini.h mini.c inssel-x86.brg: Allocate one SP variable for each
	region instead of one for each method. Fixes #47813.

2003-09-29  Zoltan Varga  <vargaz@freemail.hu>

	* exceptions.cs (test_0_nested_finally): New regression test for
	nested exception handlers.

	* mini.c (mono_jit_runtime_invoke): Fix for the previous fix.

	* mini.c (mono_method_to_ir): Avoid inlining tail calls.

	* mini.c (mono_method_to_ir): Fix tail recursion in the presence of 
	inlining.

	* mini.c (mono_method_check_inlining): Make the inlining limit 
	configurable by an environment variable.
	
	* mini.c (mono_jit_runtime_invoke): Add Gonzalo's fix for #36545.

	* mini.h: Bump AOT file version.

	* mini.h mini.c aot.c mini-x86.c: For relocations which refer to a 
	token, store the image along with the token, since the token might not 
	refer to the same image as the method containing the relocation, 
	because of inlining.

2003-09-27  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_precompile_assemblies): New function to compile
	all methods in all loaded assemblies.

	* mini.h driver.c: Added new optimization flag MONO_OPT_PRECOMP.

	* regalloc.h regalloc.c (MonoRegState): Change the type of 
	iassign and fassign to int*, since they can contain large negative
	values if the register is spilled. Also added some comments. Fixes
	#45817.

	* exceptions-x86.c (seh_handler): Fix handling of system exceptions
	under Win32. Fixes #42964.

2003-09-26  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (MONO_PATCH_INFO_WRAPPER): New patch type.

	* aot.c: Added support for AOT compiling methods which contain calls
	to wrappers. Currently, only remoting-invoke-with-check wrappers are
	handled.
	
	* driver.c (compile_all_methods): Run the compilation in a thread
	managed by mono. Fixes #44023.

	* mini.c (mono_codegen): Print full method name in verbose output.

	* mini-x86.c (mono_arch_patch_code): Fix warning.
	
	* mini-x86.c (mono_arch_patch_code): Allways create a trampoline for
	jumps, since the method we are jumping to might be domain-specific.

	* aot.c: Added support for MONO_PATCH_INFO_METHOD_JUMP.

Tue Sep 23 10:50:27 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: string chars are unsigned.

2003-09-15  Zoltan Varga  <vargaz@freemail.hu>

	* TODO: New todo item.

	* tramp-x86.c (x86_class_init_trampoline): New trampoline function
	which calls mono_runtime_class_init and patches the call site to
	avoid further calls.
	(mono_arch_create_class_init_trampoline): New arch specific function 
	to create a class init trampoline.
	(create_trampoline_code): Generalized so it can create
	class init trampolines as well.

	* mini.c (helper_sig_class_init_trampoline): New helper variable.
	(mono_create_class_init_trampoline): New function to create and cache
	class init trampolines.
	(mono_find_class_init_trampoline_by_addr): New function to lookup the
	vtable given the address of a class init trampoline. Used by the
	patching process.
	(mono_codegen): Generate a call to a trampoline instead of
	mono_runtime_class_init in LDSFLD[A].
	(mono_codegen): Add relocations for the new trampoline.
	
	* mini.h mini-x86.c aot.c: Added a new relocation type: 
	MONO_PATCH_INFO_CLASS_INIT.

	* mini.h: Bump AOT version number.

	* aot.c: Create a copy of the loaded code instead of using the original
	so methods which call each other will be close in memory, improving
	cache behaviour.
	
	* exceptions-x86.c (mono_arch_has_unwind_info): Back out the previous
	patch since it breaks the regression tests.
	
	* exceptions-x86.c (mono_arch_has_unwind_info): Added explicit check
	for the register saving instruction sequence since the 
	frame_state_for function in glibc 2.3.2 don't seem to detect it.

2003-09-14  Zoltan Varga  <vargaz@freemail.hu>

	* TODO: Fix todo item && remove another.

2003-09-12  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_patch_code): Fix tail calls broken by a
	previous checkin.

	* aot.c: Moved the check for MONO_LASTAOT into the initialization
	function of the module.

	* mini.h mini.c aot.c: Added a new optimization flag OPT_AOT for
	turning on/off the usage of AOT code. Got rid of mono_no_aot and the
	--no-aot command line option.

2003-09-11  Zoltan Varga  <vargaz@freemail.hu>

	* helpers.c (mono_disassemble_code): Make this work under cygwin. Patch
	by Bernie Solomon (bernard@ugsolutions.com).

	* inssel.brg: Refactor the interface offset table related code into
	its separate functions and add support for the AOT case.

2003-09-10  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_get_method_inner): Fix memory leak.
	
	* aot.c: Added mono_aot_verbose variable and made all debugging
	output depend on the value of this variable.

	* aot.c (mono_aot_get_method_inner): Avoid dynamic allocation of
	method_label and info_label.

	* mini.h mini-x86.c aot.c: Added a new relocation type 
	MONO_PATCH_INFO_IID for klass->interface_id.

	* mini.h mini.c driver.c aot.c: Changed mono_aot_get_method to return
	the MonoJitInfo structure.

	* mini.c (mono_jit_compile_method): Avoid using non-shared AOT in
	a non-root appdomain in shared mode.

Tue Sep 9 16:33:07 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* aot.c: make aot loader less verbose. Remove free of unused variable.

2003-09-08  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_aot_get_method_inner): Fix MONO_PATCH_INFO_IMAGE.

	* .cvsignore: Added *.dll.

	* mini.c (mono_print_tree_nl): New function callable while debugging.

	* mini.c (mono_print_code): Export this.

	* tramp-x86.c (x86_magic_trampoline): Tell valgrind to recompile the
	patched code.

2003-09-05  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h (MonoCompile): Added 'jit_info' field.

	* mini.c (mini_method_compile): Save the generated MonoJitInfo into
	the cfg structure, since it is needed by the AOT compiler.

	* mini.h (MONO_AOT_FILE_VERSION): Bump version number.

	* aot.c: A major rewrite. Changes include:
	- save exception tables for methods which have them.
	- cache failed lookups in aot_get_method () to avoid the (slow) calls 
	to g_module_symbol.
	- reworked the file format so it is now much smaller and needs
	fewer relocation entries.
	
2003-09-04  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (load_aot_module): Fix build bustage on platforms without
	Boehm GC.

2003-09-04  Martin Baulig  <martin@ximian.com>

	* Makefile.am (INCLUDES): Added $(LIBGC_CFLAGS).

2003-09-04  Zoltan Varga  <vargaz@freemail.hu>

	* TODO: Some new optimization ideas.

	* aot.c: Move AOT module loading logic here from mono_assembly_open.

	* aot.c: Save the optimization flags used to compile the code into
	the AOT module.

	* mini.h mini-x86.c mini.c aot.c: Added new types of relocations to
	support emitting domain specific code.
	
	* mini.h mini.c aot.c: Modified the JIT so the generated AOT code is 
	no longer domain neutral. It can be made domain neutral by compiling 
	with --optimize=shared.

	* aot.c (mono_aot_get_method_inner): Allow sharing of AOT methods
	between appdomains.

	* driver.c mini.h mini.c: New --no-aot debugging option which disables
	loading of AOT code.

	* inssel-x86.brg: Added missing AOTCONST -> OUTARG_VT rule.
	
	* tramp-x86.c (x86_magic_trampoline): Avoid patching the calling method
	if there is no domain neutrality information.

2003-09-01  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Emit a symbol containing the file 
	format version into the generated library.

	* mini-x86.c (mono_arch_patch_code): Do not emit the address of the
	callee method into the caller since one of them could be shared.

	* mini.h mini-x86.c aot.c: Added two new relocations so throwing
	system exceptions from AOT code now works.

	* tramp-x86.c (x86_magic_trampoline): Avoid patching the calling 
	method if it is domain neutral and the callee is not.

	* graph.c (cfg_emit_one_loop_level): Fix warning.

2003-08-30  Zoltan Varga  <vargaz@freemail.hu>

	* aot.c (mono_compile_assembly): Oops. Remove debugging cruft from
	last checkin.

2003-08-29  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mini_init): Call mono_marshal_init () explicitly since it
	is needed  by code which is executed before mono_runtime_init ().
	Thanks to Bernie Solomon (bernard@ugsolutions.com) for noticing this.
	
	* mini.c (mono_thread_abort): Fix warning.
	(mono_jit_compile_method): Call static constructor in the AOT case too.

	* aot.c (mono_compile_assembly): Fix warning.

2003-08-28  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c: register a SIGINT handler if MONO_DEBUG is defined.

2003-08-28  Zoltan Varga  <vargaz@freemail.hu>

	* inssel.brg (OP_UNBOXCAST): Add support for the AOT case.

	* cpu-pentium.md: Fix the length of call opcodes so they include the
	ESP restoring instruction. Fixes #47968.

2003-08-28  Martin Baulig  <martin@ximian.com>

	* mini-x86.c (mono_arch_call_opcode): Added support for
	MONO_TYPE_GENERICINST.

	* mini.c (check_call_signature): Added support for MONO_TYPE_GENERICINST.	

2003-08-27  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am (BUILT_SOURCES): Fix compilation on platforms without
	a JIT. Patch by Bernie Solomon (bernard@ugsolutions.com).

	* mini.c jit-icalls.c tramp-x86.c tramp-ppc.c tramp-sparc.c: Get rid of
	metadata_section.

2003-08-26  Martin Baulig  <martin@ximian.com>

	* mini.c (get_basic_blocks): Added `unsigned char **pos' argument;
	when reporting an error, set this to the actual error location.
	(mono_method_to_ir): Report the correct error location if
	get_basic_blocks() returned an error.

2003-08-25  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_type_blittable): OBJECT is not blittable.
	(mono_method_blittable): Methods which have marshalling descriptors
	are not blittable either. Fixes #47842.

2003-08-22  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c mini.c: Use an environment variable instead of a global 
	variable. Also fix the build.

	* mini.c (mini_init): Call g_thread_init () to make glib thread-safe. 
	Fixes #47682. Thanks to Laurent Morichetti (l_m@pacbell.net) for 
	reporting this.	

	* driver.c mini.c: Added --with-valgrind option to turn off some
	code which prevents mono from running under valgrind.

	* mini.c (mono_emit_call_args): Fixed warning.

	* mini.c (mono_emulate_opcode): Fixed warning.

Thu Aug 21 19:10:08 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: 64bit fixes from Laurent Morichetti <l_m@pacbell.net>.
	* linear-scan.c, mini-ppc.h, mini-sparc.h, mini-x86.h, mini.h,
	regalloc.c, regalloc.h: specify available registers in arch-specific
	code and support floats in the regallocator (patch by Laurent Morichetti 
	<l_m@pacbell.net>)

Wed Aug 20 19:02:22 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: mono_thread_current() can be called only after
	mono_runtime_init(): rearrange code to not call it early on.

Wed Aug 20 13:14:31 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: allocate jump tables in the code mempools.

Wed Aug 20 13:04:53 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h: make sure per-thread data allocated by the jit is
	freed.

2003-08-10  Miguel de Icaza  <miguel@ximian.com>

	* cpu-pentium.md (ldtoken): Change the length for mul.ovf.un from
	12 to 16.  This fixes bug #47453.


Thu Aug 7 15:59:35 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.c: fixed indexed load and unsigned compares.

2003-08-06  Lluis Sanchez Gual  <lluis@ximian.com>

	* mini.c: reenabled installation of handler for
	  thread abort signal.

Tue Aug 5 12:21:08 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* cprop.c, mini-x86.c, cpu-pentium.md: fix buglets spotted
	by Laurent Morichetti <l_m@pacbell.net>. Disabled local cprop
	until it's fixed and actually useful.

Mon Aug 4 12:12:26 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg: couple more opcodes implemented.

Thu Jul 31 22:43:02 EDT 2003 Mark Crichton <crichton@gimp.org>
	
	* mini-sparc.c: Even more opcodes implemeted.

Thu Jul 31 19:36:03 EDT 2003 Mark Crichton <crichton@gimp.org>

	* mini-sparc.c: More opcodes implemented.

Thu Jul 31 15:16:26 EDT 2003 Mark Crichton <crichton@gimp.org>

	* mini-sparc.c: More opcodes implemented.

Wed Jul 30 22:31:02 EDT 2003 Mark Crichton <crichton@gimp.org>

	* inssel-sparc.brg: Add some needed rules.  Direct
	copy from PPC.
	* Makefile.am: Use inssel-sparc.brg
	* exceptions-sparc.c: 0xdeadbeef/0xdecafbad to keep
	an assert happy for now.

Wed Jul 30 20:44:07 EDT 2003 Mark Crichton <crichton@gimp.org>

	* mini-sparc.c: Fixed compile errors.
	* exceptions-sparc.c: Same.  We now produce a mono binary 
	on sparc-linux.  Yea.

Wed Jul 30 14:10:12 EDT 2003 Mark Crichton <crichton@gimp.org>

	* mini-sparc.c: Renamed registers.  Also some macro cleanups.
	* exceptions-sparc.c, tramp-sparc.c: Various compile fixes.
	They compile, but do not work.

Wed Jul 30 17:52:41 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, cpu-sparc.md, exceptions-sparc.c, mini-sparc.c,
	mini-sparc.h, tramp-sparc.c: Beginning of sparc support
	from Mark Crichton <crichton@gimp.org> and Christopher Taylor
	(ct@gentoo.org).

Tue Jul 29 12:43:08 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: more opcodes implemented and better support for generics.

Fri Jul 25 18:51:45 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* cpu-g4.md, cpu-pentium.md: updates for new instructions.
	* mini.c, mini.h: first cut at generics support: some new instructions 
	added and changed the behaviour of some of the existing ones.

2003-07-21  Miguel de Icaza  <miguel@ximian.com>

	* mini.c: Removed definition of metadata_shared mutex here.

Tue Jul 22 15:21:24 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: make vararg calls work for instance methods.

Fri Jul 18 19:26:20 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, mini-x86.c, mini-ppc.c: mono_arch_call_opcode()
	returns the arguments in a separte list, now.

Fri Jul 18 13:16:18 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* aot.c, mini.c: updates for array type representation changes.

Fri Jul 18 11:28:28 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: register function to perform jit shutdown.

Thu Jul 17 16:02:41 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: use a faster allocator if possible.

Thu Jul 17 16:00:39 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* aot.c: some cleanups and portability changes.

Wed Jul 2 11:08:10 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: use faster allocation for CEE_BOX if possible.

Mon Jun 30 19:16:33 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-ops.h, inssel.brg, mini-x86.c: optimized access to fields.
	Moved inlined mempcy code to its own function so that is can be
	reused. Added an inline memset function as well (optimized initobj).
	* cpu-pentium.md, inssel-x86.brg: add and use lea_membase.

Fri Jun 27 11:19:10 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-ops.h, inssel.brg: optimized a couple of Array methods.

Wed Jun 25 13:19:25 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, mini.x86.c, mini-ppc.c: added facility so that
	arch code can setup the cpu for CLR execution, if needed.
	We use it on x86 to set the precision of FP operations.

Tue Jun 17 19:02:55 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: disable some optimizations if we can guess they'll cost too
	much for a given method.

2003-06-17  Zoltan Varga  <vargaz@freemail.hu>

	* mini.h mini.c: Rework last patch based on suggestions by Paolo.
	
2003-06-17  Zoltan Varga  <vargaz@freemail.hu>
	* mini.h mini.c mini-x86.c: Added instruction level coverage 
	info collection support.

Mon Jun 16 18:13:29 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c, mini-ppc.c, mini-x86.c, mini.c, mini.h: the coverage stuff
	is now implemented in the profiling API. Get rid of a couple of
	unnecessary global variables.

2003-06-15  Nick Drochak <ndrochak@gol.com>

	* basic-long.cs: tests for negative values for bigmul, and unsigned.
	* cpu-g4.md: add op_bigmul and op_bigmul_un
	* cpu_pentium.md: add op_bigmul_un
	* inssel-long32.brg: add rule for unsigned bigmul
	* mini-ops.h: define OP_BIGMUL_UN
	* mini-x86.c: THE BUG: handle (un)signed properly
	* mini.c: choose unsigned opcode if needed.
	This set of patches fixes bug #44291

2003-06-13  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (optimize_branches): improved to handle all kinds of
	conditional branches.

Wed Jun 11 18:01:06 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini.h, jit-icalls.c: speedup emulation of opcodes that
	don't raise exceptions.

Tue Jun 10 19:00:31 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* tramp-x86.c, tramp-ppc.c, debug-mini.c: move arch-specific code
	to arch-specific files.

2003-06-09  Martin Baulig  <martin@ximian.com>

	* Makefile.am (libs): Added $(LIBGC_LIBS).

Mon Jun 9 20:21:47 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* cpu-pentium.md, mini-x86.c: fix (well, actually implement) OP_TAN
	and OP_ATAN (fixes bug#44293).

Mon Jun 9 19:00:56 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, mini-x86.c: rename cpu description array to
	pentium_desc, since some compilers define the 'pentium' preprocessor
	symbol.

2003-05-28  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mini_select_instructions): add explicit branch if the
	following block is not the false target of a conditional branch -
	we need this with any optimization that reorder or remove bblocks

	* mini.c (optimize_branches): bug fixes

2003-06-06  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_method_to_ir): inline static readonly fields

	* ssa.c (fold_tree): start cfold support for long (very simple
	cases only)

	* cfold.c (mono_constant_fold_inst): opt. CEE_CONV_I8 (OP_ICONST)

Fri Jun 6 11:41:18 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: fixed memcpy (bug #44219).

2003-06-05  Dick Porter  <dick@ximian.com>

	* driver.c: Set the glib log levels to not abort if g_message
	recurses.

	g_set_prgname() has to happen before mini_init() so that the
	process handle gets the info.
	
Thu Jun 5 20:11:29 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: add intrins to the default optimizations to get wider
	exposure.

Wed Jun 4 19:47:57 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h: some large basic blocks will overflow a 16-bit
	integers for symbolic registers.

2003-06-04  Dietmar Maurer  <dietmar@ximian.com>

	* mini-x86.c (mono_arch_output_basic_block): revert previous fprem changes.
	(mono_arch_output_basic_block): fix bug 43499 

Wed Jun 4 13:13:52 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: kill duplicated definition of mono_debug_format.

Wed Jun 4 13:09:51 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, arrays.cs: fixed register allocation bug.

2003-06-04  Dietmar Maurer  <dietmar@ximian.com>

	* mini-x86.c (mono_arch_output_basic_block): use IEEE compatible fprem1

	* mini.c (mini_get_opcode_for_method): inline IEEERemainder

2003-06-04  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c:
	(print_method_from_ip): also print source location information if
	available.

2003-06-02  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_find_block_region): bug fix in region code
	(mini_method_compile): enable removing unreachable code again, but
	only in methods without exception clauses.

Fri May 30 18:40:24 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-ops.h, cpu-pentium.md, inssel.brg, mini-x86.c, mini.h:
	Implemented arglist opcode and handling of TypedReference type.
	Fixed x86 call convention when a structure is returned.
	Minimal support for calling static vararg methods.

2003-05-30  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mini_method_compile):  always remove unreachable code,
	because the code in them may be inconsistent  (access to dead
	variables for example).

Thu May 29 11:44:49 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c, debug-mini.c: warning fixes.

Wed May 28 11:19:15 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* Makefile.am, jit.h, mini.h: install header for embedding mono.

Tue May 27 17:56:12 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: thread-static fields are registered in mono_class_vtable(),
	so ensure the function is called before checking for them.

2003-05-27  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (optimize_branches): fix for bug 43586

	* jit-icalls.c (mono_llmult_ovf): added an additional check for
	overflow (fixes Bug #43639)

Tue May 27 11:33:53 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, objects.cs: allow the use of stobj for primitive types.

Tue May 27 10:33:53 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: be less strict about argument checking until we support
	running the verifier.

2003-05-27  Nick Drochak <ndrochak@gol.com>

	* basic-long.cs: tests for (ulong)int * (ulong)int also
	* mini.c: use the same trick for (ulong)int * (ulong)int

2003-05-27  Nick Drochak <ndrochak@gol.com>

	* basic-long.cs: add regression test for (long)int * (long)int
	* cpu-pentium.md: add op_bigmul specification
	* inssel-long32.brg: add OP_BIGMUL rule
	* mini-ops.h: add OP_BIGMUL
	* mini-x86.c: register allocator: handle case where src1 needs to be
	in EAX.
	* mini.c: substitute special BIGMUL opcode in the tree for 
	(long)int * (long)int

Mon May 26 20:20:13 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c: call the type ctor on field access if needed.

Mon May 26 15:21:21 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini.c, inssel.brg, exceptions.cs: validate arguments passed
	to a method (including results of ldelema, bug#43207).

2003-05-26  Dietmar Maurer  <dietmar@ximian.com>

	* graph.c (cfg_emit_one_loop_level): loop over all blocks. use
	colors to show exception handler blocks.

	* inssel-x86.brg (OP_OUTARG_VT): dont push zero sized structures
	(fix for pinvoke7.cs).

Mon May 26 12:11:53 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c: ensure correct initialization order for types that
	require it. Prepare for lazy compilation of jit icall wrappers.
	Provide a name for opcode emulation to reduce unneeded mallocing.

Fri May 23 16:08:54 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c: better register restoring code and profiling
	support for tail calls.

Fri May 23 15:30:53 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, driver.c: prepare for leaf methods optimization.

Fri May 23 15:28:32 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: get targets of branches before converting a method.

2003-05-23  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (optimize_branches): added some experimental code (disbaled) 

2003-05-22  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (optimize_branches): fix branch to branch optimization 

	* exceptions-x86.c (mono_arch_handle_exception): bug fix.

	* mini-x86.c (mono_arch_output_basic_block): cleanup up exception code

	* inssel-x86.brg: added OP_START_HANDLER, CEE_ENDFINALLY, OP_ENDFILTER

	* mini-x86.c (mono_arch_allocate_vars): only reserve space for lmf
	if needed.

2003-05-21  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_method_to_ir): call handle_loaded_temps before inlining.
	enable use of interface variables again.

	* mini-x86.c (mono_arch_get_allocatable_int_vars): dont allocate
	I1 to registers because there is no simply way to sign extend 8bit
	quantities in caller saved registers on x86.

	* inssel-float.brg: set costs of some rules to 2 so
	that monobure always select the arch. specific ones if supplied,
	regardless of the order we pass the files to monoburg.

Tue May 20 17:19:14 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-x86.c: since the magic trampoline for jumps
	can't patch the code directly, we do it as soon as the
	method gets compiled.

Tue May 20 16:02:52 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, mini.h: introduce a new patching method
	to support CEE_JMP and tail calls.
	* mini.c: obey tail.call. Don't precompile methods target
	of CEE_JMP.
	* tramp-x86.c: new trampoline code to handle methods
	reached through a jump.

2003-05-20  Dietmar Maurer  <dietmar@ximian.com>

	* mini-x86.c (mono_arch_get_allocatable_int_vars): allocate 8/16
	bit values to registers

2003-05-19  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_compile_get_interface_var): share interface
	variables if possible.

2003-05-16  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_init_debugger): New function to initialize
	the debugger.  This is not in the debugger since it needs to
	access some of mini's internals.

2003-05-16  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_method_to_ir): inlining fixes/cleanups

Fri May 16 13:27:23 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, mini-opts.h, inssel.brg: inline small memcpy
	for value type handling.

2003-05-16  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_method_to_ir): inline LDFLD/STFLD wrappers
	(mono_method_check_inlining): enable inlining of all kinds of wrappers

2003-05-15  Lluis Sanchez Gual  <lluis@ideary.com>

	* mini.c: fixed little bug in CEE_NEWOBJ case when calling
	  the constructor through a proxy.

Thu May 15 17:17:27 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* jit-icalls.c, inssel.brg: fixes to array element address
	calculations.

2003-05-15  Dietmar Maurer  <dietmar@ximian.com>

	* mini-x86.c (is_regsize_var): allocate pointer to registers

Thu May 15 13:04:02 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: fixed typo, added intrins to the set of optimizations
	tested with regressions.

Thu May 15 11:57:42 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ops.h, mini.c, inssel.brg: optimize access to 2D arrays.
	* jit-icalls.c, exceptions.cs: fixed index out of range checks, added
	test case.

2003-05-14  Dietmar Maurer  <dietmar@ximian.com>

	* inssel.brg: remove some common pop instructions without side effects

Wed May 14 12:40:31 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-x86.brg: fixed thinko in int to double conversions.

Wed May 14 12:01:58 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, jit-icalls.c: added runtime thread-static variable support.

Tue May 13 22:02:06 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg: two more missing instructions.

2003-05-13  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_emit_call_args): set the cil_code for all arguments
	if not already set.

2003-05-12  Zoltan Varga  <vargaz@freemail.hu>

	* mini-x86.c (mono_arch_output_basic_block): Handle negative zero
	correctly.

	* basic-float.cs: Added tests for negative zero.

Sun May 11 14:56:27 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg, basic-long.cs, exceptions.cs: handle
	a couple of missing operations for long casts, with test cases.

2003-05-11  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* exceptions-x86.c: fixed small leaks in mono_arch_handle_exception.

2003-05-09  Dietmar Maurer  <dietmar@ximian.com>

	* mini-x86.c (mono_arch_emit_prolog): avoid reallocs with better
	code size estimation.

2003-05-08  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_jit_create_remoting_trampoline): make it work with
	abstract methods (fix bug 42542)

	* aot.c: add ability to handle array types
	
2003-05-08  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c: Call the _specific versions of the object allocation
	functions if possible.

Tue May 6 17:18:33 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: call setlocale ().

Tue May 6 14:38:22 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini.c, aot.c, debug-mini.c, exceptions.c: build fixes for
	windows build.

2003-05-05  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (optimize_branches): dont touch code inside exception clauses (fix bug 38136)

	* exceptions-x86.c (ves_icall_get_frame_info): also skip remoting
	wrappers (fix bug 42122)

2003-05-04  Martin Baulig  <martin@ximian.com>

	* mini.h (mono_jit_init, mono_jit_cleanup): Added prototypes.

	* driver.c: s/MONO_OPT_SAHRED/MONO_OPT_SHARED/g.
	s/mini_set_defaults/mono_set_defaults/g.

2003-05-04  Martin Baulig  <martin@ximian.com>

	* driver.c: s/mini_parse_default_optimizations/mono_parse_default_optimizations/g.

Sun May 4 11:48:08 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg: add missing lreg: OP_LCONV_TO_U8 (lreg) rule
	(reported by Don Roberts).

Fri May 2 18:36:45 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: temporarily work around two bugs for this release.

Fri May 2 17:37:29 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: avoid linking libmono with GMODULE_LIBS, because
	that contains -export-dynamic and it makes using the ld script
	useless.
	* mini.h, main.c, driver.c: s/mini_main/mono_main/g.

Fri May 2 12:52:32 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.h, mini-x86.c, driver.c: disable optimizations not available on a
	specific cpu.

Thu May 1 15:28:21 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: make sure leave calls all the needed finally blocks,
	even when the target jumps out of multiple exception clauses.

Thu May 1 15:18:26 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* ldscript, Makefile.am: add linker script to reduce the number of
	exported symbols (should also fix the issues with libwine defining
	some of the same symbols in io-layer).

2003-05-01  Zoltan Varga  <vargaz@freemail.hu>

	* driver.c (mini_main): Avoid assertion when no file name is given on 
	the command line.

Wed Apr 30 15:33:11 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: added --version/-V command line option.
	Added the inline optimization in the regression tests.

Wed Apr 30 15:16:02 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c, basic-calls.cs: when inlining, save arguments to locals according 
	to the type in the method signature (fixes bug#42134).

Wed Apr 30 12:38:44 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: when inlining, check this is not null only when needed (bug #42135).

Wed Apr 30 11:44:36 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-ppc.h, tramp-pcc.c: type fixes from Max Horn <max@quendi.de>.

2003-04-30  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* driver.c: fixed bug #42100.

2003-04-29  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_method_to_ir): UNBOX need to CAST objects first

Mon Apr 28 17:03:14 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: moved most of the code required to do inlining to its own
	function so it can be reused. Inline also ctors if appropriate.

2003-04-28  Zoltan Varga  <vargaz@freemail.hu>

	* Makefile.am: Link with -export-dynamic so shared libs loaded by
	the runtime can call mono API functions.

2003-04-27  Martin Baulig  <martin@ximian.com>

	* debug-mini.c (mono_debug_init_method): Added
	`guint32 breakpoint_id' argument; if the method has a breakpoint,
	send a notification to the debugger.

	* mini.c (mono_method_to_ir): Don't insert a breakpoint if we're
	running in the Mono Debugger, just pass the breakpoint number to
	mono_debug_init_method().

	* tramp-x86.c, tramp-ppc.c: Removed the breakpoint trampolines.

Sun Apr 27 13:18:04 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: allow some more unsafe compares.

Sat Apr 26 11:55:41 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini-x86.c, Makefile.am: make distcheck works (partially from
	a patch by Richard Lee <r.h.lee@attbi.com>).
	* regset.c, regset.h: removed, they are unused.

2003-04-25  Dick Porter  <dick@ximian.com>

	* driver.c: Usage reports the name as 'mono' not 'mini'
	* exceptions-x86.c: Build and run on freebsd

Thu Apr 24 17:09:03 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: install the program with the 'mono' name and
	the library as libmono instead of mini and libmini.

Thu Apr 24 17:08:07 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: provide the APIs for the embedding interface of the old jit.

2003-04-23  Dietmar Maurer  <dietmar@ximian.com>

	* jit-icalls.c (helper_stelem_ref): impl. (fix bug 41775)

2003-04-23  Martin Baulig  <martin@ximian.com>

	* tramp-x86.c, tramp-ppc.c: Reenable the debugger breakpoint interface.

	* driver.c: Added `--debug' command line argument to enable
	debugging support.

2003-04-23  Martin Baulig  <martin@ximian.com>

	* debug.[ch]: Removed.  The code is now in
	../metadata/mono-debug.[ch] and mono-debug-debugger.[ch].

	* debug-stabs.c, debug-dwarf2.c: Removed; nobody used this for the
	last six months.

2003-04-22  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_method_to_ir): set the cil_code address (fix bug 41525)

2003-04-17  Gonzalo Paniagua Javier <gonzalo@ximian.com>

	* mini.c:
	(mini_cleanup): moved mono_runtime_cleanup call after the call to
	mono_domain_finalize.
	(mini_method_compile): use mono_method_profile* if the the option is
	enabled.

2003-04-17  Zoltan Varga  <vargaz@freemail.hu>

	* tramp-x86.c (mono_arch_create_jit_trampoline): Subsitute synchronized
	methods with their wrapper.

	* tramp-ppc.c (mono_arch_create_jit_trampoline): Subsitute synchronized
	methods with their wrapper.

	* jit-icalls.c (mono_ldvirtfn): Subsitute synchronized methods with
	their wrapper.

	* mini.c (mono_method_to_ir): Subsitute synchronized methods with their
	wrapper.

	* mini.c (mono_method_check_inlining): Avoid inlining synchronized
	methods.

2003-04-17  Dietmar Maurer  <dietmar@ximian.com>

	* exceptions-x86.c (mono_arch_handle_exception): fix for bug 36252

2003-04-16  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mono_compile_create_var): use g_malloc/g_realloc instead
	of the mempool. This is slightly faster and uses less memory

Wed Apr 16 12:53:10 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: avoid O(n) allocation for variables.

Tue Apr 15 19:13:41 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: handle items on the stack after inlining methods.

Tue Apr 15 14:17:57 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: make the method->opcode optimization dependent
	on MONO_OPT_INSTRINS and do it lazily.

Tue Apr 15 14:15:39 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: print overall results at the end of regression run.

Tue Apr 15 11:18:46 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel.brg: don't overwrite symbolic registers.

Mon Apr 14 17:41:34 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-x86.brg: fix conversion from long to float.

2003-04-11  Dietmar Maurer  <dietmar@ximian.com>

	* mini.c (mini_init): use an opcode for get_Chars (OP_GETCHR)

2003-04-10  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c (mono_type_blittable): MONO_TYPE_OBJECT is blittable.

	* driver.c: Added --print-vtable option as in the old JIT.

Thu Apr 10 17:43:49 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel-long32.brg, exceptions.cs: fix conversions from long, too.

Thu Apr 10 16:27:43 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* inssel.brg, basic.cs: fixed checked conversions to byte and short.

2003-04-09  Zoltan Varga  <vargaz@freemail.hu>

	* mini.c regalloc.c regalloc.h: Fix memory leak.

2003-04-09  Dietmar Maurer  <dietmar@ximian.com>

	* aot.c (mono_aot_get_method): register all used strings

Wed Apr 9 15:22:18 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* mini.c: always intern strings references with ldstr at compile time.

Tue Apr 8 11:41:26 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* Makefile.am: add BUILT_SOURCES.

Mon Apr 7 16:31:34 CEST 2003 Paolo Molaro <lupus@ximian.com>

	* driver.c: give a better error message when the assembly to execute
	doesn't have an entry point.

2003-04-07  Dietmar Maurer  <dietmar@ximian.com>

	* Makefile.am: added hack for automake

	* mono/mini/mini.c (mono_save_args): always copy arguments to keep
	correct sematics.

	* mono/mini/ssa.c (mono_ssa_avoid_copies): don't optimize calls

22003-04-07  Martin Baulig  <martin@ximian.com>

	* Makefile.am: Added Makefile.am.

	* debugger-main.c: Removed, this is now in the debugger where it
	belongs.

	* mini.pc.in: Call this package `mini' for the moment.















